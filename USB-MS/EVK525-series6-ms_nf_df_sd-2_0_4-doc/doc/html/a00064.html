<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: nf_unusual.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>nf_unusual.c File Reference</h1><code>#include &quot;<a class="el" href="a00140.html">config.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00136.html">conf_nf.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00158.html">nf.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00162.html">nf_drv.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00164.html">nf_mngt.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00145.html">lib_mcu/debug.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for nf_unusual.c:</div>
<div class="dynsection">
</div>

<p>
<a href="a00165.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#0fdac67c9ed489e39f926b8ee5de93f5">_TRACE_</a>&nbsp;&nbsp;&nbsp;(DISABLE)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#971fe751244bf854be000aa5fd67c5e7">OFST</a>&nbsp;&nbsp;&nbsp;(2*(i_dev + u16_tmp*NF_N_DEVICES))</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">__no_init volatile <br>
xdata <a class="el" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> <br>
nf_send_cmd&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a> (0x3900)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">__no_init volatile <br>
xdata <a class="el" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> <br>
nf_send_add&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#ff4a6a86f2406225109047414f102af0">At</a> (0x3A00)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">__no_init volatile <br>
xdata <a class="el" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_data&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#d37fc34ecd5131dc50dd6fe5ebdcef53">At</a> (0x3800)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#61dbbd370e63df5414083790a6f50b58">ut_nfc_erase_all</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#00f06ce988c51eb7f1b0ffac47c1e605">nf_init_buffer</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Clears the internal buffer.  <a href="#00f06ce988c51eb7f1b0ffac47c1e605"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#88cf2da70da57c7efa94e590f5eb096f">nf_scan</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Scan the memory and looks for sub-LUT, free-blocks block and recovery blocks.  <a href="#88cf2da70da57c7efa94e590f5eb096f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#8d5fe4e1006879a77583ee71ca95f902">nf_rebuild</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#940348c8e5e33ed3bf281df02a29a39c">is_nf_invalid</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#37eae1e822625455c74c1cf5bb71fa95">nf_fetch_free_block</a> (<a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i_dev)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the first free block seen, scanning downstream.  <a href="#37eae1e822625455c74c1cf5bb71fa95"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#4cb35ca11603f17d6237063f1cc31ea9">nf_refine_index</a> (<a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_addr, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> inc, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> pattern)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Refines the position of the 'block' index according to a particular pattern.  <a href="#4cb35ca11603f17d6237063f1cc31ea9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#7fa3ba35a1436fa32cc3a53d079dedc0">nf_init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the nand flash memory driver.  <a href="#7fa3ba35a1436fa32cc3a53d079dedc0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#b3c26aadc0e38a2d67aac9080152777a">nf_verify_resume</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Ensure that the memory is in a good state before starting to use it.  <a href="#b3c26aadc0e38a2d67aac9080152777a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#4111df3ea1a2e262cdc7b853bad4543f">nf_cleanup_memory</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cleanup the memory by erasing all the management blocks.  <a href="#4111df3ea1a2e262cdc7b853bad4543f"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#a77d29865677c8e97bbd578eac48be3f">g_n_blocks</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a> [((2048)+(2048)/32)]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_BIT_ bit&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#7b20377b71b59870430cfa0c4af29ad6">g_is_found_lut</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#f5410b60e6a7a37b85ae6a764fc46212">g_is_found_fbb</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#af999b811df9c6926deef493ff81350c">g_n_real_sub_lut</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#188dac7e34a46f2f187c65c450036b6f">g_curr_block_addr</a> [NF_N_DEVICES]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a> [16]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a> [(NF_N_DEVICES *(8 *1024)/(512/2))]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a> [(NF_N_DEVICES *(8 *1024)/(512/2))]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static _MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#ccbc4d68a750c60b473ffde4930be9e9">s_nfd_rev</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static _MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#ffddafa9cf10bed6f566c4ece73acf51">s_n_quarantine_blocks</a> [NF_N_DEVICES]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <br>
_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#b26fce863bb856df1bd4eaa22e5c750e">s_n_invalid_blocks</a> [NF_N_DEVICES]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a> [NF_N_DEVICES]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_FAST_ <a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a> [NF_N_DEVICES]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_FAST_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_MEDFAST_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00002.html">Cache_lut</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00001.html">Cache_fbb</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00064.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a></td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This file contains the high level management for nand-flash memory devices which are rarely used. The code is put in a bank in order to save code space.<p>
<ul>
<li>Compiler: IAR EWAVR and GNU GCC for AVR</li><li>Supported devices: AT90USB1287, AT90USB1286, AT90USB647, AT90USB646</li></ul>
<p>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support and FAQ: <a href="http://support.atmel.no/">http://support.atmel.no/</a> </dd></dl>

<p>Definition in file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="0fdac67c9ed489e39f926b8ee5de93f5"></a><!-- doxytag: member="nf_unusual.c::_TRACE_" ref="0fdac67c9ed489e39f926b8ee5de93f5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define _TRACE_&nbsp;&nbsp;&nbsp;(DISABLE)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00052">52</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="971fe751244bf854be000aa5fd67c5e7"></a><!-- doxytag: member="nf_unusual.c::OFST" ref="971fe751244bf854be000aa5fd67c5e7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define OFST&nbsp;&nbsp;&nbsp;(2*(i_dev + u16_tmp*NF_N_DEVICES))          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Referenced by <a class="el" href="a00165.html#l00490">nf_rebuild()</a>.</p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="59f6771bf0f4ec58f6e75d456625a3a3"></a><!-- doxytag: member="nf_unusual.c::At" ref="59f6771bf0f4ec58f6e75d456625a3a3" args="(0x3900)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__no_init volatile xdata <a class="el" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_send_cmd At           </td>
          <td>(</td>
          <td class="paramtype">0x3900&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="ff4a6a86f2406225109047414f102af0"></a><!-- doxytag: member="nf_unusual.c::At" ref="ff4a6a86f2406225109047414f102af0" args="(0x3A00)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__no_init volatile xdata <a class="el" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_send_add At           </td>
          <td>(</td>
          <td class="paramtype">0x3A00&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="d37fc34ecd5131dc50dd6fe5ebdcef53"></a><!-- doxytag: member="nf_unusual.c::At" ref="d37fc34ecd5131dc50dd6fe5ebdcef53" args="(0x3800)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">__no_init volatile xdata <a class="el" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_data At           </td>
          <td>(</td>
          <td class="paramtype">0x3800&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="61dbbd370e63df5414083790a6f50b58"></a><!-- doxytag: member="nf_unusual.c::ut_nfc_erase_all" ref="61dbbd370e63df5414083790a6f50b58" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ut_nfc_erase_all           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00920">920</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00159.html#l00606">NF_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, and <a class="el" href="a00161.html#l00302">nfc_erase_block()</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00921"></a>00921 {
<a name="l00922"></a>00922    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   i_dev  =0;
<a name="l00923"></a>00923    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  i_block=0;
<a name="l00924"></a>00924    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  page_addr;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926    <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; i_dev++ )
<a name="l00927"></a>00927    {
<a name="l00928"></a>00928       <span class="comment">// Select the devices</span>
<a name="l00929"></a>00929       <span class="comment">//</span>
<a name="l00930"></a>00930       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932       <span class="keywordflow">for</span>( i_block=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> ; i_block&lt;<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> ; i_block++ )
<a name="l00933"></a>00933       {
<a name="l00934"></a>00934          page_addr= (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)i_block&lt;&lt;<a class="code" href="a00058.html#0d6042ad6ee7e6bae51e87c0f2f14807">NF_SHIFT_BLOCK_PAGE</a>;
<a name="l00935"></a>00935          <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( page_addr, <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> ) ;
<a name="l00936"></a>00936       }
<a name="l00937"></a>00937    }
<a name="l00938"></a>00938 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="00f06ce988c51eb7f1b0ffac47c1e605"></a><!-- doxytag: member="nf_unusual.c::nf_init_buffer" ref="00f06ce988c51eb7f1b0ffac47c1e605" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void nf_init_buffer           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Clears the internal buffer. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>nothing </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00130">130</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00164.html#l00082">NF_FULL_PAGE_BUFFER_SIZE</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00490">nf_rebuild()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00131"></a>00131 {
<a name="l00132"></a>00132    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l00133"></a>00133    <span class="keywordflow">for</span> ( u16_tmp=<a class="code" href="a00063.html#f80c4ce07be5eb80f1fa7e96dd19aa8a">NF_FULL_PAGE_BUFFER_SIZE</a> ; u16_tmp!=0 ; u16_tmp-=2 )
<a name="l00134"></a>00134    {
<a name="l00135"></a>00135       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp-1]=0xFF;
<a name="l00136"></a>00136       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp-2]=0xFF;
<a name="l00137"></a>00137    }
<a name="l00138"></a>00138 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="88cf2da70da57c7efa94e590f5eb096f"></a><!-- doxytag: member="nf_unusual.c::nf_scan" ref="88cf2da70da57c7efa94e590f5eb096f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_scan           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Scan the memory and looks for sub-LUT, free-blocks block and recovery blocks. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a status: PASS if the scan has been succesfully executed; FAIL if the scan encountered any problem </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00303">303</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00067">FAIL</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00162.html#l00415">G_OFST_BLK_STATUS</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00165.html#l00894">nf_refine_index()</a>, <a class="el" href="a00164.html#l00084">NF_SUBLUT_SIZE</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00349">NFC_BLK_ID_DATA</a>, <a class="el" href="a00162.html#l00348">NFC_BLK_ID_FBB</a>, <a class="el" href="a00162.html#l00350">NFC_BLK_ID_QUARANTINE</a>, <a class="el" href="a00162.html#l00346">NFC_BLK_ID_SUBLUT</a>, <a class="el" href="a00162.html#l00364">NFC_OFST_6_FBB_VALID</a>, <a class="el" href="a00161.html#l00333">nfc_read_spare_byte()</a>, <a class="el" href="a00162.html#l00344">NFC_SPARE_OFST_1_BLK_ID</a>, <a class="el" href="a00162.html#l00352">NFC_SPARE_OFST_2_BYTE_2</a>, <a class="el" href="a00162.html#l00353">NFC_SPARE_OFST_3_BYTE_3</a>, <a class="el" href="a00162.html#l00357">NFC_SPARE_OFST_4_BYTE_4</a>, <a class="el" href="a00162.html#l00363">NFC_SPARE_OFST_6_LBA</a>, <a class="el" href="a00162.html#l00361">NFC_SPARE_OFST_EXPORT</a>, <a class="el" href="a00133.html#l00066">PASS</a>, <a class="el" href="a00164.html#l00115">S_MNGT_DEV</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00102">trace_hex()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, <a class="el" href="a00144.html#l00072">trace_u32()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00304"></a>00304 {
<a name="l00305"></a>00305    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>          i_dev  =0;
<a name="l00306"></a>00306    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>         i_block=0;
<a name="l00307"></a>00307    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>          n_quarantine_blocks=0;
<a name="l00308"></a>00308    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>         n_invalid_blocks=0;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a> =(<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)-1;
<a name="l00311"></a>00311    <a class="code" href="a00062.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a>      =(<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>/<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 
<a name="l00314"></a>00314    <span class="comment">// Initialize the recovery structure. This should be done by the startup !</span>
<a name="l00315"></a>00315    <span class="comment">//</span>
<a name="l00316"></a>00316    <a class="code" href="a00064.html#7b20377b71b59870430cfa0c4af29ad6">g_is_found_lut</a>  =<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00317"></a>00317    <a class="code" href="a00064.html#f5410b60e6a7a37b85ae6a764fc46212">g_is_found_fbb</a>  =<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00318"></a>00318    <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>         =<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00319"></a>00319    <a class="code" href="a00064.html#af999b811df9c6926deef493ff81350c">g_n_real_sub_lut</a>=0;
<a name="l00320"></a>00320 
<a name="l00321"></a>00321    <span class="comment">// Scan all the devices and looks for:</span>
<a name="l00322"></a>00322    <span class="comment">// - the sub-LUT blocks</span>
<a name="l00323"></a>00323    <span class="comment">// - the recovery block</span>
<a name="l00324"></a>00324    <span class="comment">// - the free-blocks block</span>
<a name="l00325"></a>00325    <span class="comment">//</span>
<a name="l00326"></a>00326    <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; i_dev++ )
<a name="l00327"></a>00327    {
<a name="l00328"></a>00328       n_invalid_blocks   = 0;
<a name="l00329"></a>00329       n_quarantine_blocks= 0;
<a name="l00330"></a>00330       <a class="code" href="a00064.html#188dac7e34a46f2f187c65c450036b6f">g_curr_block_addr</a>[i_dev]= <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> -1; <span class="comment">// points on the last block</span>
<a name="l00331"></a>00331 
<a name="l00332"></a>00332       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"Device "</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(i_dev); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\r"</span>);
<a name="l00333"></a>00333       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335       <span class="keywordflow">for</span>( i_block=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> ; i_block&lt;<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> ; i_block++ )
<a name="l00336"></a>00336       {
<a name="l00337"></a>00337          <a class="code" href="a00060.html#37641716cd31a827e214a2d0ec1f5c66" title="Reads the number spare bytes specified and stores them in a array.">nfc_read_spare_byte</a>( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>, 16, <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block) );
<a name="l00338"></a>00338          <span class="keywordflow">if</span> ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#e0e77dabaa2dc4bdde63fa552f44e745">G_OFST_BLK_STATUS</a>]!=0xFF )
<a name="l00339"></a>00339          {
<a name="l00340"></a>00340             n_invalid_blocks +=1 ;
<a name="l00341"></a>00341             <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" ("</span>); <a class="code" href="a00043.html#38868090cbfb5610c03d7a472f161c35" title="Fonction used to display a byte value in the decimal form (16 bits) on OCD/Serial...">trace_u32</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"): bad Block\n\r"</span>);
<a name="l00342"></a>00342             <span class="keywordflow">continue</span>; <span class="comment">// The block is bad</span>
<a name="l00343"></a>00343          }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345          <span class="keywordflow">if</span>(( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]!=<a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a>     )
<a name="l00346"></a>00346          &amp;&amp; ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]!=<a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a>        )
<a name="l00347"></a>00347          &amp;&amp; ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]!=<a class="code" href="a00061.html#f19a6cf6b26673dc36867d41b8eefed0">NFC_BLK_ID_QUARANTINE</a> )
<a name="l00348"></a>00348          &amp;&amp; ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]!=<a class="code" href="a00061.html#2e268e2bf7f16ea1e30a5ff354e06fd7">NFC_BLK_ID_DATA</a>       ))
<a name="l00349"></a>00349          {
<a name="l00350"></a>00350             n_invalid_blocks +=1;
<a name="l00351"></a>00351             <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" ("</span>); <a class="code" href="a00043.html#38868090cbfb5610c03d7a472f161c35" title="Fonction used to display a byte value in the decimal form (16 bits) on OCD/Serial...">trace_u32</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"): Unknown\n\r"</span>);
<a name="l00352"></a>00352             <span class="keywordflow">continue</span>;
<a name="l00353"></a>00353          }
<a name="l00354"></a>00354          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]==<a class="code" href="a00061.html#f19a6cf6b26673dc36867d41b8eefed0">NFC_BLK_ID_QUARANTINE</a> )
<a name="l00355"></a>00355          {
<a name="l00356"></a>00356             n_quarantine_blocks +=1;
<a name="l00357"></a>00357             <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" ("</span>); <a class="code" href="a00043.html#38868090cbfb5610c03d7a472f161c35" title="Fonction used to display a byte value in the decimal form (16 bits) on OCD/Serial...">trace_u32</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"): Quarantine\n\r"</span>);
<a name="l00358"></a>00358             <span class="keywordflow">continue</span>;
<a name="l00359"></a>00359          }
<a name="l00360"></a>00360          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]==<a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a> )
<a name="l00361"></a>00361          {
<a name="l00362"></a>00362             n_invalid_blocks +=1;
<a name="l00363"></a>00363             <span class="keywordflow">if</span> ( i_dev==<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a> )
<a name="l00364"></a>00364             {
<a name="l00365"></a>00365                <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> sub_lut_id                   = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#89ad3db087517a60f80aef41609e1caf">NFC_SPARE_OFST_2_BYTE_2</a>];
<a name="l00366"></a>00366                <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>                     = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#a36ea238247cfc24264d4fd936b53e08">NFC_SPARE_OFST_4_BYTE_4</a>];
<a name="l00367"></a>00367                <a class="code" href="a00064.html#7b20377b71b59870430cfa0c4af29ad6">g_is_found_lut</a> = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00368"></a>00368                <a class="code" href="a00064.html#af999b811df9c6926deef493ff81350c">g_n_real_sub_lut</a>++;
<a name="l00369"></a>00369                <a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a>[sub_lut_id] = i_block;
<a name="l00370"></a>00370                <span class="keywordflow">if</span> ( sub_lut_id==(<a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>-1) )
<a name="l00371"></a>00371                {
<a name="l00372"></a>00372                   <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a>)= <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ];
<a name="l00373"></a>00373                   <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a>)= <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1];
<a name="l00374"></a>00374                }
<a name="l00375"></a>00375                <a class="code" href="a00062.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[sub_lut_id]= <a class="code" href="a00064.html#4cb35ca11603f17d6237063f1cc31ea9" title="Refines the position of the &amp;#39;block&amp;#39; index according to a particular pattern...">nf_refine_index</a>(i_block, 1, <a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a>);
<a name="l00376"></a>00376                <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" ("</span>); <a class="code" href="a00043.html#38868090cbfb5610c03d7a472f161c35" title="Fonction used to display a byte value in the decimal form (16 bits) on OCD/Serial...">trace_u32</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"): SUB-LUT (id "</span>);<a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(sub_lut_id);<a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" ofst "</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(<a class="code" href="a00062.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[sub_lut_id]); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">")\n\r"</span>);
<a name="l00377"></a>00377                continue ;
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379             <span class="keywordflow">else</span>
<a name="l00380"></a>00380             {  <span class="comment">// LUT found on bad NF</span>
<a name="l00381"></a>00381                <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00382"></a>00382                <span class="keywordflow">break</span>;
<a name="l00383"></a>00383             }
<a name="l00384"></a>00384          }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>]==<a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a> )
<a name="l00387"></a>00387          {
<a name="l00388"></a>00388             n_invalid_blocks +=1;
<a name="l00389"></a>00389             <span class="keywordflow">if</span> ( i_dev==<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a> )
<a name="l00390"></a>00390             {
<a name="l00391"></a>00391                <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==<a class="code" href="a00064.html#f5410b60e6a7a37b85ae6a764fc46212">g_is_found_fbb</a> )
<a name="l00392"></a>00392                {
<a name="l00393"></a>00393                   <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">// already found</span>
<a name="l00394"></a>00394                   <span class="keywordflow">break</span>;
<a name="l00395"></a>00395                }
<a name="l00396"></a>00396                <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>  = i_block;
<a name="l00397"></a>00397                <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a> = <a class="code" href="a00064.html#4cb35ca11603f17d6237063f1cc31ea9" title="Refines the position of the &amp;#39;block&amp;#39; index according to a particular pattern...">nf_refine_index</a>(i_block, 1, <a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a>);
<a name="l00398"></a>00398                <a class="code" href="a00060.html#37641716cd31a827e214a2d0ec1f5c66" title="Reads the number spare bytes specified and stores them in a array.">nfc_read_spare_byte</a>( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>, 16, <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block) + (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)<a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a> );     <span class="comment">// Reload</span>
<a name="l00399"></a>00399                <span class="keywordflow">if</span>( <a class="code" href="a00061.html#6fd751d12dbd6e385f256152224b6635">NFC_OFST_6_FBB_VALID</a>!=<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>] )
<a name="l00400"></a>00400                {
<a name="l00401"></a>00401                   <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; <span class="comment">// FBB not valid. Force rebuild</span>
<a name="l00402"></a>00402                   <span class="keywordflow">break</span>;
<a name="l00403"></a>00403                }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405                <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>)   = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#89ad3db087517a60f80aef41609e1caf">NFC_SPARE_OFST_2_BYTE_2</a>];
<a name="l00406"></a>00406                <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>)   = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>];
<a name="l00407"></a>00407                <a class="code" href="a00064.html#ccbc4d68a750c60b473ffde4930be9e9">s_nfd_rev</a>              = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#a36ea238247cfc24264d4fd936b53e08">NFC_SPARE_OFST_4_BYTE_4</a>];
<a name="l00408"></a>00408                <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>) = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#391ff58f6f81da0da062a288ed96d847">NFC_SPARE_OFST_EXPORT</a>];
<a name="l00409"></a>00409                <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>) = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#391ff58f6f81da0da062a288ed96d847">NFC_SPARE_OFST_EXPORT</a>+1];
<a name="l00410"></a>00410                <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"      g_n_free_blocks="</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00411"></a>00411                <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"      g_n_export_blocks="</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00412"></a>00412                <a class="code" href="a00064.html#f5410b60e6a7a37b85ae6a764fc46212">g_is_found_fbb</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00413"></a>00413                <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" ("</span>); <a class="code" href="a00043.html#38868090cbfb5610c03d7a472f161c35" title="Fonction used to display a byte value in the decimal form (16 bits) on OCD/Serial...">trace_u32</a>(i_block); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"): FBB (ofst "</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a> ); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">")\n\r"</span>);
<a name="l00414"></a>00414                continue ;
<a name="l00415"></a>00415             }
<a name="l00416"></a>00416             <span class="keywordflow">else</span>
<a name="l00417"></a>00417             {
<a name="l00418"></a>00418                <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00419"></a>00419                <span class="keywordflow">break</span>;
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421          }
<a name="l00422"></a>00422       } <span class="comment">// for ( i_block</span>
<a name="l00423"></a>00423 
<a name="l00424"></a>00424       <span class="comment">// A fatal error on one device is enough to cleanup all the devices !</span>
<a name="l00425"></a>00425       <span class="comment">//</span>
<a name="l00426"></a>00426       <a class="code" href="a00064.html#b26fce863bb856df1bd4eaa22e5c750e">s_n_invalid_blocks</a>[   i_dev]= n_invalid_blocks;
<a name="l00427"></a>00427       <a class="code" href="a00064.html#ffddafa9cf10bed6f566c4ece73acf51">s_n_quarantine_blocks</a>[i_dev]= n_quarantine_blocks;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429       <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==<a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a> ) { <span class="keywordflow">break</span>; }
<a name="l00430"></a>00430    } <span class="comment">// for ( i_dev</span>
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    <span class="keywordflow">return</span> (<a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>==<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) ? <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>: <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00433"></a>00433 } <span class="comment">// nf_scan</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="8d5fe4e1006879a77583ee71ca95f902"></a><!-- doxytag: member="nf_unusual.c::nf_rebuild" ref="8d5fe4e1006879a77583ee71ca95f902" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_rebuild           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Rebuild the memory and create LUT, Recovery and Free-blocks blocks.<p>
TBD<p>
It uses s_n_invalid_blocks (number of invalid blocks) and g_curr_block_addr (current block address of each device).<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a status: PASS if there are no error; FAIL a programmation error occured: the block is marked as bad. The function must be recall. </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00490">490</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00133.html#l00315">Align_down</a>, <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00133.html#l00067">FAIL</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00162.html#l00415">G_OFST_BLK_STATUS</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00287">Max</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00164.html#l00089">N_SUBLUT</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00163.html#l01558">nf_copy_tail()</a>, <a class="el" href="a00165.html#l00847">nf_fetch_free_block()</a>, <a class="el" href="a00165.html#l00130">nf_init_buffer()</a>, <a class="el" href="a00164.html#l00064">NF_LOW_N_FREE_THRESHOLD</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00164.html#l00077">NF_PAGE_BUFFER_SIZE</a>, <a class="el" href="a00159.html#l00605">NF_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00164.html#l00083">NF_SHIFT_SUBLUT_PHYS</a>, <a class="el" href="a00162.html#l00416">NF_SPARE_POS</a>, <a class="el" href="a00164.html#l00084">NF_SUBLUT_SIZE</a>, <a class="el" href="a00163.html#l01417">nf_write_fbb()</a>, <a class="el" href="a00163.html#l01213">nf_write_lut()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00349">NFC_BLK_ID_DATA</a>, <a class="el" href="a00161.html#l00302">nfc_erase_block()</a>, <a class="el" href="a00161.html#l00255">nfc_mark_bad_block()</a>, <a class="el" href="a00162.html#l00355">NFC_OFST_3_DATA_DST</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00162.html#l00110">Nfc_rd_data_fetch_next</a>, <a class="el" href="a00161.html#l00333">nfc_read_spare_byte()</a>, <a class="el" href="a00162.html#l00344">NFC_SPARE_OFST_1_BLK_ID</a>, <a class="el" href="a00162.html#l00353">NFC_SPARE_OFST_3_BYTE_3</a>, <a class="el" href="a00162.html#l00363">NFC_SPARE_OFST_6_LBA</a>, <a class="el" href="a00064.html#971fe751244bf854be000aa5fd67c5e7">OFST</a>, <a class="el" href="a00133.html#l00066">PASS</a>, <a class="el" href="a00164.html#l00115">S_MNGT_DEV</a>, <a class="el" href="a00164.html#l00106">S_SHIFT_LOG_BLOCK_SECTOR</a>, <a class="el" href="a00162.html#l00337">SIZE_BLOCK_PAGE</a>, <a class="el" href="a00162.html#l00338">SIZE_PAGE_SECTOR</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00102">trace_hex()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, <a class="el" href="a00144.html#l00126">trace_hex32()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00491"></a>00491 {
<a name="l00492"></a>00492    <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> status_bool=<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00493"></a>00493    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>        b_duplicate;
<a name="l00494"></a>00494    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   i_sub_lut;
<a name="l00495"></a>00495    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   i_dev  =0;
<a name="l00496"></a>00496    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  i_block=0;
<a name="l00497"></a>00497    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  u16_tmp;
<a name="l00498"></a>00498    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  sub_lut_log_sz;
<a name="l00499"></a>00499    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  log_block_addr;
<a name="l00500"></a>00500    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  log_block_addr_min;
<a name="l00501"></a>00501    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  log_block_addr_max;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    <span class="comment">// Refine the computation</span>
<a name="l00504"></a>00504    <span class="comment">//</span>
<a name="l00505"></a>00505    <a class="code" href="a00064.html#b26fce863bb856df1bd4eaa22e5c750e">s_n_invalid_blocks</a>[<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>] +=
<a name="l00506"></a>00506       1                                        <span class="comment">// Need a block for the Free-blocks block</span>
<a name="l00507"></a>00507    +  (<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>)/<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a> <span class="comment">// and one for each sub-LUT</span>
<a name="l00508"></a>00508    ;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    <span class="comment">// Take the max number of invalid blocks of each devices</span>
<a name="l00511"></a>00511    <span class="comment">//</span>
<a name="l00512"></a>00512    u16_tmp=<a class="code" href="a00064.html#b26fce863bb856df1bd4eaa22e5c750e">s_n_invalid_blocks</a>[0] ;
<a name="l00513"></a>00513    <span class="keywordflow">for</span> ( i_dev=1 ; i_dev&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; i_dev++ )
<a name="l00514"></a>00514    {
<a name="l00515"></a>00515       u16_tmp=<a class="code" href="a00032.html#4886a8f966a69949cefc46a6a3468006">Max</a>( u16_tmp, <a class="code" href="a00064.html#b26fce863bb856df1bd4eaa22e5c750e">s_n_invalid_blocks</a>[i_dev] );
<a name="l00516"></a>00516    }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518    <span class="comment">// Take the max number of quarantine blocks of each devices</span>
<a name="l00519"></a>00519    <span class="comment">//</span>
<a name="l00520"></a>00520    i_sub_lut=<a class="code" href="a00064.html#ffddafa9cf10bed6f566c4ece73acf51">s_n_quarantine_blocks</a>[0] ;
<a name="l00521"></a>00521    <span class="keywordflow">for</span> ( i_dev=1 ; i_dev&lt;NF_N_DEVICES ; i_dev++ )
<a name="l00522"></a>00522    {
<a name="l00523"></a>00523       i_sub_lut=<a class="code" href="a00032.html#4886a8f966a69949cefc46a6a3468006">Max</a>( i_sub_lut, <a class="code" href="a00064.html#ffddafa9cf10bed6f566c4ece73acf51">s_n_quarantine_blocks</a>[i_dev] );
<a name="l00524"></a>00524    }
<a name="l00525"></a>00525 
<a name="l00526"></a>00526    sub_lut_log_sz = (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)NF_N_DEVICES*(<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> -<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> -u16_tmp);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    <span class="comment">// Finally compute the number of exportable physical blocks and free blocks</span>
<a name="l00529"></a>00529    <span class="comment">//</span>
<a name="l00530"></a>00530    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp&lt;(<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> -<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a>) );
<a name="l00531"></a>00531    <a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>= (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)( ((<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)( (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)sub_lut_log_sz ) * 1000) / 1024);
<a name="l00532"></a>00532    <a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>= <a class="code" href="a00032.html#1070d94a69b4e1955ac1723b4f382095">Align_down</a>( <a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>, NF_N_DEVICES);
<a name="l00533"></a>00533 
<a name="l00534"></a>00534    <a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>  = (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)sub_lut_log_sz - <a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>;
<a name="l00535"></a>00535    <a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a> -= (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)NF_N_DEVICES*i_sub_lut;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537    <span class="keywordflow">if</span>( <a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>&lt;=<a class="code" href="a00063.html#714ce5649e72db34c2ef646c284321ae">NF_LOW_N_FREE_THRESHOLD</a> )
<a name="l00538"></a>00538    {
<a name="l00539"></a>00539       <span class="keywordflow">while</span>(1); <span class="comment">// TBD</span>
<a name="l00540"></a>00540    }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>&gt;0 );
<a name="l00543"></a>00543    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>&lt;(1L&lt;&lt;<a class="code" href="a00058.html#b9439f9226b0ff5799893b83bd7fc54b">NF_SHIFT_PAGE_BYTE</a>) ); <span class="comment">// limit the free blocks in order to fit in 1 page</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545    <span class="comment">// Compute the number of needed sub-LUT</span>
<a name="l00546"></a>00546    <span class="comment">// Affect to each management block a free block address</span>
<a name="l00547"></a>00547    <span class="comment">//</span>
<a name="l00548"></a>00548    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l00549"></a>00549    <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a> = <a class="code" href="a00064.html#37eae1e822625455c74c1cf5bb71fa95" title="Returns the first free block seen, scanning downstream.">nf_fetch_free_block</a>(<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l00550"></a>00550    <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a> ), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00551"></a>00551    <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>= 0;
<a name="l00552"></a>00552    u16_tmp    = <a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>;
<a name="l00553"></a>00553 <span class="comment">//#error il faut positionner les index(LUT, FBB, RCV...)</span>
<a name="l00554"></a>00554    <span class="keywordflow">while</span>(1)
<a name="l00555"></a>00555    {
<a name="l00556"></a>00556       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>&lt;<a class="code" href="a00063.html#28826e9d277e2bdd262d82d6caf78f29">N_SUBLUT</a> );
<a name="l00557"></a>00557       <a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a> [<a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>]=<a class="code" href="a00064.html#37eae1e822625455c74c1cf5bb71fa95" title="Returns the first free block seen, scanning downstream.">nf_fetch_free_block</a>(<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l00558"></a>00558       <a class="code" href="a00062.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[<a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>]=0;
<a name="l00559"></a>00559       <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a> [<a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>] ), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00560"></a>00560       <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>++;
<a name="l00561"></a>00561       <span class="keywordflow">if</span>( u16_tmp&gt;<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a> )  u16_tmp-=<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>;
<a name="l00562"></a>00562       <span class="keywordflow">else</span>                          <span class="keywordflow">break</span>;
<a name="l00563"></a>00563    }
<a name="l00564"></a>00564    <a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a>=u16_tmp/NF_N_DEVICES;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566    <span class="comment">// Build the sub-LUTs</span>
<a name="l00567"></a>00567    <span class="comment">//</span>
<a name="l00568"></a>00568    <span class="keywordflow">for</span> ( i_sub_lut=0 ; i_sub_lut&lt;<a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a> ;  )
<a name="l00569"></a>00569    {
<a name="l00570"></a>00570       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  n_sublut_in_buf = g_n_sub_lut - i_sub_lut; <span class="comment">// Count remaining sublut to build</span>
<a name="l00571"></a>00571 
<a name="l00572"></a>00572       log_block_addr_max =
<a name="l00573"></a>00573       log_block_addr_min = (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)i_sub_lut&lt;&lt;(<a class="code" href="a00063.html#fec3c6701415feaba7c4549f19f43946">NF_SHIFT_SUBLUT_PHYS</a>-NF_SHIFT_N_DEVICES); <span class="comment">// first included</span>
<a name="l00574"></a>00574 
<a name="l00575"></a>00575       <span class="keywordflow">if</span>( n_sublut_in_buf&gt;(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>/(2*<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>)) )
<a name="l00576"></a>00576       {
<a name="l00577"></a>00577          n_sublut_in_buf = <a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>/(2*<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>);
<a name="l00578"></a>00578          log_block_addr_max += ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)n_sublut_in_buf)*<a class="code" href="a00062.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a>; <span class="comment">// last not included</span>
<a name="l00579"></a>00579       }
<a name="l00580"></a>00580       <span class="keywordflow">else</span>
<a name="l00581"></a>00581       {
<a name="l00582"></a>00582          log_block_addr_max += ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)n_sublut_in_buf-1)*<a class="code" href="a00062.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a> +<a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a>; <span class="comment">// last not included</span>
<a name="l00583"></a>00583       }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585       <a class="code" href="a00064.html#00f06ce988c51eb7f1b0ffac47c1e605" title="Clears the internal buffer.">nf_init_buffer</a>();
<a name="l00586"></a>00586 
<a name="l00587"></a>00587       <span class="comment">// Report affected logical blocks</span>
<a name="l00588"></a>00588       <span class="comment">//</span>
<a name="l00589"></a>00589       u16_tmp=<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>/NF_N_DEVICES; <span class="comment">// Number of logical blocks used for the mass storage</span>
<a name="l00590"></a>00590 
<a name="l00591"></a>00591       b_duplicate=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593       <span class="keywordflow">for</span> ( i_dev=0 ; i_dev&lt;NF_N_DEVICES ; i_dev++ )
<a name="l00594"></a>00594       {
<a name="l00595"></a>00595          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597          <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev]=0xFFFF;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599          <span class="keywordflow">for</span> ( i_block=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> ; i_block&lt;<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> ; i_block++ )
<a name="l00600"></a>00600          {
<a name="l00601"></a>00601             <a class="code" href="a00060.html#37641716cd31a827e214a2d0ec1f5c66" title="Reads the number spare bytes specified and stores them in a array.">nfc_read_spare_byte</a>( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>, 8, <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block) );
<a name="l00602"></a>00602             <span class="keywordflow">if</span>(( 0xFF           !=<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#e0e77dabaa2dc4bdde63fa552f44e745">G_OFST_BLK_STATUS</a>          ] ) <span class="comment">// The block is bad</span>
<a name="l00603"></a>00603             || ( <a class="code" href="a00061.html#2e268e2bf7f16ea1e30a5ff354e06fd7">NFC_BLK_ID_DATA</a>!=<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>    ] ) <span class="comment">// or is not a data block</span>
<a name="l00604"></a>00604             || (  ( 0xFF        ==<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>       ] ) <span class="comment">// or is not affected</span>
<a name="l00605"></a>00605                &amp;&amp; ( 0xFF        ==<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[NFC_SPARE_OFST_6_LBA+1     ] )
<a name="l00606"></a>00606                )
<a name="l00607"></a>00607             ) {
<a name="l00608"></a>00608                <span class="keywordflow">continue</span>;
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611             <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(log_block_addr) = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[NFC_SPARE_OFST_6_LBA  ];
<a name="l00612"></a>00612             <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(log_block_addr) = <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[NFC_SPARE_OFST_6_LBA+1];
<a name="l00613"></a>00613 
<a name="l00614"></a>00614             <span class="keywordflow">if</span>( log_block_addr&gt;=u16_tmp )
<a name="l00615"></a>00615             {  <span class="comment">// The LBA seems bad: it does not fit in any LUT. This happens when unplugging the player.</span>
<a name="l00616"></a>00616                <span class="comment">// Block is erased.</span>
<a name="l00617"></a>00617                <span class="comment">// Anyway, stay in the loop to track similar problems.</span>
<a name="l00618"></a>00618                <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00619"></a>00619                status_bool=<a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00620"></a>00620             }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622             <span class="keywordflow">if</span>(( log_block_addr&gt;=log_block_addr_min )
<a name="l00623"></a>00623             &amp;&amp; ( log_block_addr&lt; log_block_addr_max ))
<a name="l00624"></a>00624             {
<a name="l00625"></a>00625                <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> ofst=2*((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)i_dev + (log_block_addr%((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>/2/NF_N_DEVICES))*NF_N_DEVICES) ;
<a name="l00626"></a>00626                <span class="keywordflow">if</span>(
<a name="l00627"></a>00627                   ( 0xFF==<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst    ] )
<a name="l00628"></a>00628                &amp;&amp; ( 0xFF==<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst +1 ] )
<a name="l00629"></a>00629                )
<a name="l00630"></a>00630                {  <span class="comment">// no redundant phys blocks</span>
<a name="l00631"></a>00631                   <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(      ( ofst +1 ) &lt; <a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a> );
<a name="l00632"></a>00632                   <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst    ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(i_block);
<a name="l00633"></a>00633                   <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst +1 ] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(i_block);
<a name="l00634"></a>00634                }
<a name="l00635"></a>00635                <span class="keywordflow">else</span>
<a name="l00636"></a>00636                {  <span class="comment">// A duplicated logical block is detected. This happens when unplugging the player.</span>
<a name="l00637"></a>00637                   <span class="comment">// Anyway, stay in the loop to track any other redundant blocks, for that sub-LUT.</span>
<a name="l00638"></a>00638                   <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> tmp_addr;
<a name="l00639"></a>00639                   <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(tmp_addr)=<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst    ];
<a name="l00640"></a>00640                   <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(tmp_addr)=<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst +1 ];
<a name="l00641"></a>00641                   <span class="comment">//trace("Dupl "); trace_hex32(tmp_addr); trace("-"); trace_hex32(i_block);; trace("\n\r");</span>
<a name="l00642"></a>00642 
<a name="l00643"></a>00643                   <span class="keywordflow">if</span>(0xFFFF!=<a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev])
<a name="l00644"></a>00644                   {  <span class="comment">// !!! There are more than 1 duplicated block on the device. This should never happen...</span>
<a name="l00645"></a>00645                      <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(<a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev]), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00646"></a>00646                      <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00647"></a>00647                   }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649                   b_duplicate=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00650"></a>00650                   <a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>=log_block_addr;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652                   <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(
<a name="l00653"></a>00653                      <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block)
<a name="l00654"></a>00654                   ,  <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>
<a name="l00655"></a>00655                   );
<a name="l00656"></a>00656                   <span class="keywordflow">if</span>( <a class="code" href="a00061.html#98a49853a649a262cd8c415d568e92f3">NFC_OFST_3_DATA_DST</a>!=<a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() )
<a name="l00657"></a>00657                   {
<a name="l00658"></a>00658                      <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"1. Src block="</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00659"></a>00659                      <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"1. Dst block="</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(tmp_addr); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00660"></a>00660                      <span class="comment">//nfc_print_block(i_block, 0);</span>
<a name="l00661"></a>00661                      <span class="comment">//nfc_print_block(tmp_addr, 0);</span>
<a name="l00662"></a>00662                      <span class="comment">//while(1);</span>
<a name="l00663"></a>00663                      <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev]=i_block;                        <span class="comment">// source block</span>
<a name="l00664"></a>00664                      <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[i_dev] = <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( tmp_addr ); <span class="comment">// recipient block</span>
<a name="l00665"></a>00665                   }
<a name="l00666"></a>00666                   <span class="keywordflow">else</span>
<a name="l00667"></a>00667                   {
<a name="l00668"></a>00668                      <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"2. Src block="</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(tmp_addr); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00669"></a>00669                      <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"2. Dst block="</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(i_block); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00670"></a>00670                      <span class="comment">//nfc_print_block(tmp_addr, 0);</span>
<a name="l00671"></a>00671                      <span class="comment">//nfc_print_block(i_block, 0);</span>
<a name="l00672"></a>00672                      <span class="comment">//while(1);</span>
<a name="l00673"></a>00673                      <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev]= tmp_addr ;                     <span class="comment">// source block</span>
<a name="l00674"></a>00674                      <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst    ]=<a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(i_block);
<a name="l00675"></a>00675                      <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ ofst +1 ]=<a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(i_block);
<a name="l00676"></a>00676                      <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[i_dev] = <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( i_block );  <span class="comment">// recipient block</span>
<a name="l00677"></a>00677                   }
<a name="l00678"></a>00678                }
<a name="l00679"></a>00679             }
<a name="l00680"></a>00680          } <span class="comment">// for ( i_block ../..</span>
<a name="l00681"></a>00681       } <span class="comment">// for ( i_dev ../..</span>
<a name="l00682"></a>00682 
<a name="l00683"></a>00683       <span class="keywordflow">if</span>( b_duplicate )
<a name="l00684"></a>00684       {
<a name="l00685"></a>00685          <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i_page;
<a name="l00686"></a>00686          <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i_sect;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"recovery\n\r"</span>);
<a name="l00689"></a>00689          <span class="comment">// Test that recovery can be done</span>
<a name="l00690"></a>00690          <span class="keywordflow">for</span> ( i_dev=0 ; i_dev&lt;NF_N_DEVICES ; i_dev++ )
<a name="l00691"></a>00691          {
<a name="l00692"></a>00692             <span class="keywordflow">if</span>( 0xFFFF==<a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev] )
<a name="l00693"></a>00693             {  <span class="comment">// !Ooops... we can not recover from that case since there are duplication</span>
<a name="l00694"></a>00694                <span class="comment">// only on on device</span>
<a name="l00695"></a>00695                <span class="keywordflow">for</span> ( i_dev=0 ; i_dev&lt;NF_N_DEVICES ; i_dev++ )
<a name="l00696"></a>00696                {
<a name="l00697"></a>00697                   <span class="keywordflow">if</span>( 0xFFFF!=<a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev] )
<a name="l00698"></a>00698                   {
<a name="l00699"></a>00699                      <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(<a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[i_dev]), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00700"></a>00700                   }
<a name="l00701"></a>00701                }
<a name="l00702"></a>00702                <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00703"></a>00703             }
<a name="l00704"></a>00704          }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706          <span class="comment">// Initialize variable for nf_copy_tail</span>
<a name="l00707"></a>00707          <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>=0;
<a name="l00708"></a>00708          <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>= ((<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) &lt;&lt; <a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710          <span class="comment">// Look for last written sector</span>
<a name="l00711"></a>00711          <span class="keywordflow">for</span>( i_page=0 ; i_page&lt;<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> ; i_page++ )
<a name="l00712"></a>00712          {
<a name="l00713"></a>00713             <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);  <span class="comment">// open the current device</span>
<a name="l00714"></a>00714             <span class="keywordflow">for</span>( i_sect=0 ; i_sect&lt;<a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a> ; i_sect++ )
<a name="l00715"></a>00715             {
<a name="l00716"></a>00716                <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(
<a name="l00717"></a>00717                   <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>]
<a name="l00718"></a>00718                ,  <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)i_sect)*16) + NFC_SPARE_OFST_6_LBA
<a name="l00719"></a>00719                );
<a name="l00720"></a>00720                <span class="keywordflow">if</span>(( 0xFF==<a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() )
<a name="l00721"></a>00721                &amp;&amp; ( 0xFF==<a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() ))
<a name="l00722"></a>00722                   <span class="keywordflow">goto</span> recovery_exit;
<a name="l00723"></a>00723                <span class="keywordflow">else</span>
<a name="l00724"></a>00724                {
<a name="l00725"></a>00725                   <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>++;
<a name="l00726"></a>00726                   <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_last_log_sector="</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00727"></a>00727                }
<a name="l00728"></a>00728             }
<a name="l00729"></a>00729             <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]++;                                                   <span class="comment">// update the current physical page of the current device</span>
<a name="l00730"></a>00730             g_curr_dev_id++;                                                                     <span class="comment">// update the current device</span>
<a name="l00731"></a>00731             <span class="keywordflow">if</span>( g_curr_dev_id==NF_N_DEVICES ) { g_curr_dev_id=0; }
<a name="l00732"></a>00732             <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_curr_dev_id="</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(g_curr_dev_id); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00733"></a>00733             <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_phys_page_addr="</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00734"></a>00734          }
<a name="l00735"></a>00735 recovery_exit:
<a name="l00736"></a>00736          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"recovery stop on g_last_log_sector="</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00737"></a>00737          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_curr_dev_id="</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(g_curr_dev_id); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00738"></a>00738          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_phys_page_addr="</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00739"></a>00739          <span class="comment">//while(1);</span>
<a name="l00740"></a>00740          <a class="code" href="a00062.html#a38cbc2641b27ca8fe33b40dbfdd7486">nf_copy_tail</a>();
<a name="l00741"></a>00741          <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00742"></a>00742       }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744       <span class="comment">// At least one redundant have been found: the LUT must be rebuilt since the fetch of free block</span>
<a name="l00745"></a>00745       <span class="comment">// may not have seen that affected block (redundant) are in fact free.</span>
<a name="l00746"></a>00746       <span class="keywordflow">if</span>( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>!=status_bool ) { <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>; }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748       <span class="comment">// Affect a free physical block to the logical block</span>
<a name="l00749"></a>00749       <span class="comment">//</span>
<a name="l00750"></a>00750       <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;NF_N_DEVICES ; i_dev++ )
<a name="l00751"></a>00751       {
<a name="l00752"></a>00752          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754          <span class="keywordflow">for</span>(u16_tmp=0
<a name="l00755"></a>00755          ;   u16_tmp&lt;(log_block_addr_max-log_block_addr_min)
<a name="l00756"></a>00756          ;   u16_tmp++ )
<a name="l00757"></a>00757          {
<a name="l00758"></a>00758             <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> ofst=2*((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)i_dev + u16_tmp*NF_N_DEVICES);
<a name="l00759"></a>00759             <span class="keywordflow">if</span>(( 0xFF==<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ofst  ] )
<a name="l00760"></a>00760             &amp;&amp; ( 0xFF==<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ofst+1] ))
<a name="l00761"></a>00761             {
<a name="l00762"></a>00762                i_block=<a class="code" href="a00064.html#37eae1e822625455c74c1cf5bb71fa95" title="Returns the first free block seen, scanning downstream.">nf_fetch_free_block</a>(i_dev);
<a name="l00763"></a>00763                <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(       ofst+1&lt;<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>);
<a name="l00764"></a>00764                <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ofst  ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(i_block);
<a name="l00765"></a>00765                <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[ofst+1] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(i_block);
<a name="l00766"></a>00766             }
<a name="l00767"></a>00767          }
<a name="l00768"></a>00768       } <span class="comment">// for ( i_dev ../..</span>
<a name="l00769"></a>00769 
<a name="l00770"></a>00770       <span class="comment">// Each sub-LUT will fit in a physical page and will be of the same size</span>
<a name="l00771"></a>00771       <span class="comment">// except the last one which contains less</span>
<a name="l00772"></a>00772       <span class="comment">//</span>
<a name="l00773"></a>00773       <span class="keywordflow">for</span>( ; n_sublut_in_buf!=0 ; n_sublut_in_buf--, i_sub_lut++ )
<a name="l00774"></a>00774       {
<a name="l00775"></a>00775          sub_lut_log_sz= ( i_sub_lut==(g_n_sub_lut-1) ) ? <a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a> : <a class="code" href="a00062.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a> ;
<a name="l00776"></a>00776 
<a name="l00777"></a>00777          <span class="comment">// Write the sub-LUT in the page</span>
<a name="l00778"></a>00778          <span class="comment">//</span>
<a name="l00779"></a>00779          status_bool = <a class="code" href="a00062.html#4033ef04a3cbd39dc9d6071c6d7c2a9b" title="Writes a LUT in memory from a buffer.">nf_write_lut</a>(i_sub_lut%(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>/(2*<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>)), i_sub_lut, sub_lut_log_sz);
<a name="l00780"></a>00780          <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>!=status_bool )
<a name="l00781"></a>00781          {
<a name="l00782"></a>00782             <a class="code" href="a00060.html#baa6a09d1819325c231e3735177a2179" title="Mark a block as &amp;#39;invalid&amp;#39; by clearing it entirely.">nfc_mark_bad_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a>[i_sub_lut] ) );
<a name="l00783"></a>00783             <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00784"></a>00784          }
<a name="l00785"></a>00785       }
<a name="l00786"></a>00786    }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788 <span class="comment">//#error: si recovery, il faut effacer la lut en question. Il faut donc la reconstruire.</span>
<a name="l00789"></a>00789 <span class="comment">//        Pour cela, il faut trouver des blocs libres.</span>
<a name="l00790"></a>00790 <span class="comment">// 1ere methode: effacer aussi le free-blocks block et le reconstruire, ainsi que la sub-LUT</span>
<a name="l00791"></a>00791 <span class="comment">// 2eme methode: marquer les free block pour les reconnaitre et reconstruire la sub lut</span>
<a name="l00792"></a>00792 
<a name="l00793"></a>00793    <span class="comment">// Build the free-blocks block</span>
<a name="l00794"></a>00794    <span class="comment">// First, fill the internal buffer with the free blocks</span>
<a name="l00795"></a>00795    <span class="comment">//</span>
<a name="l00796"></a>00796    <span class="keywordflow">for</span> ( i_dev=0 ; i_dev&lt;NF_N_DEVICES ; i_dev++ )
<a name="l00797"></a>00797    {
<a name="l00798"></a>00798       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800       <span class="keywordflow">for</span> ( u16_tmp=0 ; u16_tmp&lt;(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>/NF_N_DEVICES) ; u16_tmp++ )
<a name="l00801"></a>00801       {
<a name="l00802"></a>00802          <span class="comment">// This define is better than using a variable that holds the expression...</span>
<a name="l00803"></a>00803 <span class="preprocessor">         #define OFST   (2*(i_dev + u16_tmp*NF_N_DEVICES))</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>         i_block=<a class="code" href="a00064.html#37eae1e822625455c74c1cf5bb71fa95" title="Returns the first free block seen, scanning downstream.">nf_fetch_free_block</a>(i_dev);
<a name="l00805"></a>00805          <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00806"></a>00806          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(       OFST   &lt;<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>);
<a name="l00807"></a>00807          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(       OFST +1&lt;<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>);
<a name="l00808"></a>00808          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( i_block&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l00809"></a>00809          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( i_block&lt; G_N_BLOCKS       );
<a name="l00810"></a>00810          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00064.html#971fe751244bf854be000aa5fd67c5e7">OFST</a>   ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(i_block);
<a name="l00811"></a>00811          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00064.html#971fe751244bf854be000aa5fd67c5e7">OFST</a> +1] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(i_block);
<a name="l00812"></a>00812 <span class="preprocessor">         #undef OFST</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span>      }
<a name="l00814"></a>00814    }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816    <span class="comment">// Then write the buffer in the free-blocks block</span>
<a name="l00817"></a>00817    <span class="comment">// Note that the list of free-blocks holds on one page only; the</span>
<a name="l00818"></a>00818    <span class="comment">// algo is thus made for both 512B and 2kB pages.</span>
<a name="l00819"></a>00819    <span class="comment">//</span>
<a name="l00820"></a>00820    <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>=0;
<a name="l00821"></a>00821    status_bool = <a class="code" href="a00062.html#020f4fb7d7d55f3fad9c368ac04cabf3" title="Writes the Free-blocks block into the Nand Flash.">nf_write_fbb</a>();
<a name="l00822"></a>00822    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>!=status_bool )
<a name="l00823"></a>00823    {
<a name="l00824"></a>00824       <a class="code" href="a00060.html#baa6a09d1819325c231e3735177a2179" title="Mark a block as &amp;#39;invalid&amp;#39; by clearing it entirely.">nfc_mark_bad_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a> ) );
<a name="l00825"></a>00825       <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00826"></a>00826    }
<a name="l00827"></a>00827 
<a name="l00828"></a>00828 <span class="comment">//#error Effacer les free blocks !!!!!!</span>
<a name="l00829"></a>00829 <span class="comment">//#error il faut determiner s_lut_index[all] pour les sub-lut existantes</span>
<a name="l00830"></a>00830 <span class="comment">//#error si il existe un bloc de recovery, alors la lut associe n'est plus valide</span>
<a name="l00831"></a>00831 <span class="comment">//#error rendre parametrable la taille du buffer (actuellement 2k). Si &lt;512 et no partial prog: fatal error</span>
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <span class="comment">//nf_init_buffer(); // Cleanup the buffer</span>
<a name="l00834"></a>00834    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00835"></a>00835 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="940348c8e5e33ed3bf281df02a29a39c"></a><!-- doxytag: member="nf_unusual.c::is_nf_invalid" ref="940348c8e5e33ed3bf281df02a29a39c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> is_nf_invalid           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Test if the memory needs to be rebuilt.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>recovery_params</em>&nbsp;</td><td>internal structure used to hold the last pointer position</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a status: TRUE if the memory has to be rebuilt; FALSE if the memory holds all the management blocks </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00444">444</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00358">NFC_OFST_4_FBB_DRIVER_RELEASE</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00445"></a>00445 {
<a name="l00446"></a>00446    <span class="keywordflow">if</span>( <span class="comment">// If we do not find everything</span>
<a name="l00447"></a>00447       ( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>==<a class="code" href="a00064.html#7b20377b71b59870430cfa0c4af29ad6">g_is_found_lut</a> )
<a name="l00448"></a>00448    || ( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>==<a class="code" href="a00064.html#f5410b60e6a7a37b85ae6a764fc46212">g_is_found_fbb</a> )
<a name="l00449"></a>00449    ) {
<a name="l00450"></a>00450       <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00451"></a>00451    }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453    <span class="comment">// Test LUT coherency</span>
<a name="l00454"></a>00454    <span class="comment">//</span>
<a name="l00455"></a>00455    <span class="keywordflow">if</span>(( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>       ==<a class="code" href="a00064.html#7b20377b71b59870430cfa0c4af29ad6">g_is_found_lut</a>   )
<a name="l00456"></a>00456    &amp;&amp; ( <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>!=<a class="code" href="a00064.html#af999b811df9c6926deef493ff81350c">g_n_real_sub_lut</a> ))
<a name="l00457"></a>00457    {
<a name="l00458"></a>00458       <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00459"></a>00459    }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 <span class="comment">//#error se proteger si le nombre de devices changent alors que lut, recovery et free blocs sont dj crs sur le bloc MNGT.</span>
<a name="l00462"></a>00462    <span class="keywordflow">if</span> ( (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)-1==<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>     ) { <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; }
<a name="l00463"></a>00463    <span class="keywordflow">if</span> (       0==<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>     ) { <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; }
<a name="l00464"></a>00464    <span class="keywordflow">if</span> ( (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)-1==<a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a> ) { <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>; }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <span class="comment">// Test Nand Flash driver release.</span>
<a name="l00467"></a>00467    <span class="comment">//</span>
<a name="l00468"></a>00468    <span class="keywordflow">if</span> ( <a class="code" href="a00064.html#ccbc4d68a750c60b473ffde4930be9e9">s_nfd_rev</a>!=<a class="code" href="a00061.html#5df984b9f7ef87bb85401f4fb7978908">NFC_OFST_4_FBB_DRIVER_RELEASE</a> )
<a name="l00469"></a>00469    {
<a name="l00470"></a>00470       <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00471"></a>00471    }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <span class="keywordflow">return</span> <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>;
<a name="l00474"></a>00474 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="37eae1e822625455c74c1cf5bb71fa95"></a><!-- doxytag: member="nf_unusual.c::nf_fetch_free_block" ref="37eae1e822625455c74c1cf5bb71fa95" args="(U8 i_dev)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> nf_fetch_free_block           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>i_dev</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns the first free block seen, scanning downstream. 
<p>
It uses g_curr_block_addr (current block address of each device).<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>i_dev</em>&nbsp;</td><td>device number on which we look for a free block</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>the physical block number </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00847">847</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00415">G_OFST_BLK_STATUS</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00162.html#l00349">NFC_BLK_ID_DATA</a>, <a class="el" href="a00162.html#l00348">NFC_BLK_ID_FBB</a>, <a class="el" href="a00162.html#l00346">NFC_BLK_ID_SUBLUT</a>, <a class="el" href="a00161.html#l00302">nfc_erase_block()</a>, <a class="el" href="a00161.html#l00333">nfc_read_spare_byte()</a>, <a class="el" href="a00162.html#l00344">NFC_SPARE_OFST_1_BLK_ID</a>, <a class="el" href="a00162.html#l00363">NFC_SPARE_OFST_6_LBA</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00490">nf_rebuild()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00848"></a>00848 {
<a name="l00849"></a>00849 
<a name="l00850"></a>00850    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_addr= <a class="code" href="a00064.html#188dac7e34a46f2f187c65c450036b6f">g_curr_block_addr</a>[i_dev];
<a name="l00851"></a>00851 
<a name="l00852"></a>00852    <span class="keywordflow">while</span> ( block_addr&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> )
<a name="l00853"></a>00853    {
<a name="l00854"></a>00854       <a class="code" href="a00060.html#37641716cd31a827e214a2d0ec1f5c66" title="Reads the number spare bytes specified and stores them in a array.">nfc_read_spare_byte</a>( <a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>, 8, <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( block_addr ) );
<a name="l00855"></a>00855       <span class="keywordflow">if</span>(( 0xFF           ==<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#e0e77dabaa2dc4bdde63fa552f44e745">G_OFST_BLK_STATUS</a>          ] ) <span class="comment">// the block is valid</span>
<a name="l00856"></a>00856       &amp;&amp; ( <a class="code" href="a00061.html#2e268e2bf7f16ea1e30a5ff354e06fd7">NFC_BLK_ID_DATA</a>==<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>    ] ) <span class="comment">// the block is a data block</span>
<a name="l00857"></a>00857       &amp;&amp; ( 0xFF           ==<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>       ] ) <span class="comment">// and is not affected</span>
<a name="l00858"></a>00858       &amp;&amp; ( 0xFF           ==<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[NFC_SPARE_OFST_6_LBA+1     ] ))
<a name="l00859"></a>00859       {
<a name="l00860"></a>00860          <span class="comment">// Since we rebuild the flash, we should not see any of these blocks</span>
<a name="l00861"></a>00861          <span class="comment">//</span>
<a name="l00862"></a>00862          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a>!=<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[NFC_SPARE_OFST_1_BLK_ID] );
<a name="l00863"></a>00863          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a>   !=<a class="code" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[NFC_SPARE_OFST_1_BLK_ID] );
<a name="l00864"></a>00864 
<a name="l00865"></a>00865          <span class="comment">// Find a free and valid block addr. Store the current position</span>
<a name="l00866"></a>00866          <span class="comment">//</span>
<a name="l00867"></a>00867          <a class="code" href="a00064.html#188dac7e34a46f2f187c65c450036b6f">g_curr_block_addr</a>[i_dev] = block_addr-1;
<a name="l00868"></a>00868          <span class="keywordflow">return</span> block_addr;
<a name="l00869"></a>00869       }
<a name="l00870"></a>00870       block_addr-=1 ;
<a name="l00871"></a>00871    }
<a name="l00872"></a>00872    <span class="comment">// This situation is dramatic: it should never happen !</span>
<a name="l00873"></a>00873    <span class="comment">// Force Rebuild on next startup</span>
<a name="l00874"></a>00874    <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a> ), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00875"></a>00875    <span class="keywordflow">while</span>(1);
<a name="l00876"></a>00876    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> ) ; <span class="comment">// Not enough free blocks: fatal error!</span>
<a name="l00877"></a>00877 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="4cb35ca11603f17d6237063f1cc31ea9"></a><!-- doxytag: member="nf_unusual.c::nf_refine_index" ref="4cb35ca11603f17d6237063f1cc31ea9" args="(U16 block_addr, U8 inc, U8 pattern)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nf_refine_index           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>block_addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>inc</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>pattern</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Refines the position of the 'block' index according to a particular pattern. 
<p>
This allow to find exactely where are stored the last sub-LUT, Free_blocks or Recovery entry. The index is roughly initialized at the beginning of the block that holds the 'pattern' at the location 1 of the spare zone. The function parses the block until the pattern is no more found.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>block_addr</em>&nbsp;</td><td>physical block address </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>inc</em>&nbsp;</td><td>increment </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pattern</em>&nbsp;</td><td>pattern which is scanned</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>the offset (in page) of the last valid entry in the block </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00894">894</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00162.html#l00413">G_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00162.html#l00416">NF_SPARE_POS</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00162.html#l00109">Nfc_rd_data</a>, <a class="el" href="a00162.html#l00344">NFC_SPARE_OFST_1_BLK_ID</a>, and <a class="el" href="a00162.html#l00337">SIZE_BLOCK_PAGE</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00303">nf_scan()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00898"></a>00898 {
<a name="l00899"></a>00899    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_tmp;
<a name="l00900"></a>00900    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> val=0;
<a name="l00901"></a>00901    <span class="keywordflow">do</span>
<a name="l00902"></a>00902    {
<a name="l00903"></a>00903       val+= inc; <span class="comment">// Assume that the pattern has already be seen previously</span>
<a name="l00904"></a>00904       <span class="keywordflow">if</span>( val&gt;=<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> )
<a name="l00905"></a>00905          { <span class="keywordflow">break</span>; }
<a name="l00906"></a>00906       <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(
<a name="l00907"></a>00907          <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(block_addr) + val
<a name="l00908"></a>00908       ,  <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#1e3d88079128d3118806d979fc2012c0">NFC_SPARE_OFST_1_BLK_ID</a>
<a name="l00909"></a>00909       );
<a name="l00910"></a>00910       u8_tmp = <a class="code" href="a00061.html#3a9602476f480441b912a7de88d440ed">Nfc_rd_data</a>();
<a name="l00911"></a>00911    } <span class="keywordflow">while</span>( pattern==u8_tmp );
<a name="l00912"></a>00912    val-= inc; <span class="comment">// come back to last valid entry</span>
<a name="l00913"></a>00913    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( val&lt;(1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) ); <span class="comment">// The offset shall not be outside the block</span>
<a name="l00914"></a>00914    <span class="keywordflow">return</span> val;
<a name="l00915"></a>00915 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="7fa3ba35a1436fa32cc3a53d079dedc0"></a><!-- doxytag: member="nf_unusual.c::nf_init" ref="7fa3ba35a1436fa32cc3a53d079dedc0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initializes the nand flash memory driver. 
<p>
The device identification is performed to initialize the driver accordingly<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00151">151</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>, <a class="el" href="a00163.html#l00100">g_ofst_blk_status</a>, <a class="el" href="a00162.html#l00413">G_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00163.html#l00099">g_shift_block_page</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00163.html#l00098">g_shift_page_byte</a>, <a class="el" href="a00162.html#l00409">Is_nf_2k</a>, <a class="el" href="a00162.html#l00411">Is_nf_512</a>, <a class="el" href="a00159.html#l00606">NF_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00159.html#l00605">NF_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00158.html#l00102">NF_SHIFT_SECTOR_BYTE</a>, <a class="el" href="a00163.html#l00103">s_shift_log_block_sector</a>, <a class="el" href="a00163.html#l00102">s_shift_log_page_sector</a>, <a class="el" href="a00164.html#l00104">S_SHIFT_SECTOR_BYTE</a>, and <a class="el" href="a00163.html#l00101">s_shift_sector_byte</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00152"></a>00152 {
<a name="l00153"></a>00153    <a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a>=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00154"></a>00154 <span class="comment">//   s_pending_write=FALSE;</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE)</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#error Check this init...</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>   <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a>             = NF_N_ZONES;
<a name="l00159"></a>00159    <a class="code" href="a00061.html#a77d29865677c8e97bbd578eac48be3f">g_n_blocks</a>            = NF_N_BLOCKS;
<a name="l00160"></a>00160    <a class="code" href="a00061.html#be82d871b5e412806adb94589b4b7f2e">g_shift_block_page</a>    = <a class="code" href="a00058.html#0d6042ad6ee7e6bae51e87c0f2f14807">NF_SHIFT_BLOCK_PAGE</a>;
<a name="l00161"></a>00161    <a class="code" href="a00061.html#12e3a20682ed5032e788a57882f8256f">g_shift_page_byte</a>     = <a class="code" href="a00058.html#b9439f9226b0ff5799893b83bd7fc54b">NF_SHIFT_PAGE_BYTE</a>;
<a name="l00162"></a>00162    <a class="code" href="a00062.html#d24848f009aa80a9e062513b93f73493">s_shift_sector_byte</a>   = <a class="code" href="a00057.html#a85df997eb2d3c6ade9bedd30d51fdc9">NF_SHIFT_SECTOR_BYTE</a>;
<a name="l00163"></a>00163    <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>        = NF_N_ROW_CYCLES;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165    <span class="keywordflow">if</span> ( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() ) <span class="comment">// 2KB pages</span>
<a name="l00166"></a>00166    {
<a name="l00167"></a>00167       <a class="code" href="a00061.html#b466843403d37526c75306381a6807c7">g_ofst_blk_status</a>     = 0;
<a name="l00168"></a>00168    }
<a name="l00169"></a>00169    <span class="keywordflow">if</span> ( <a class="code" href="a00061.html#d1213b7a82a55a9d9addaef5cd33ee69">Is_nf_512</a>() ) <span class="comment">// 512B pages</span>
<a name="l00170"></a>00170    {
<a name="l00171"></a>00171       <a class="code" href="a00061.html#b466843403d37526c75306381a6807c7">g_ofst_blk_status</a>     = 5;
<a name="l00172"></a>00172    }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    <a class="code" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a>  = <a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a> + NF_SHIFT_N_DEVICES;
<a name="l00175"></a>00175    <a class="code" href="a00062.html#7dfe2973a57e7e1ad70f55f70bbcef87">s_shift_log_block_sector</a> = <a class="code" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a> + <a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>;
<a name="l00176"></a>00176 <span class="preprocessor">#endif</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>
<a name="l00178"></a>00178    <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#afb99de7ef6fcb1b033ecda78ea6de3d">ctrl</a>.<a class="code" href="a00002.html#682f042876e5c6151971f573e9edace2">valid</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>; <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#afb99de7ef6fcb1b033ecda78ea6de3d">ctrl</a>.<a class="code" href="a00002.html#437f7770ddf9f42e886ac70d2d4febdd">dirty</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00179"></a>00179    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8a52216548fb199e1956d27fcf999427">valid</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>; <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8435e2b050da6630b6f0798591d1501f">dirty</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00180"></a>00180    <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>= 0xFFFFFFFF;
<a name="l00181"></a>00181 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="b3c26aadc0e38a2d67aac9080152777a"></a><!-- doxytag: member="nf_unusual.c::nf_verify_resume" ref="b3c26aadc0e38a2d67aac9080152777a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_verify_resume           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Ensure that the memory is in a good state before starting to use it. 
<p>
The function will scan the memory, test if the memory is valid, clean it if it has to and rebuild all the management blocks. This function shall be called prior to any use of the memory after a power-up.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a status: PASS if the command has been succesfully executed; FAIL else </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00196">196</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00067">FAIL</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00165.html#l00444">is_nf_invalid()</a>, <a class="el" href="a00164.html#l00121">Nf_check_fbb</a>, <a class="el" href="a00164.html#l00122">Nf_check_lut</a>, <a class="el" href="a00165.html#l00250">nf_cleanup_memory()</a>, <a class="el" href="a00165.html#l00490">nf_rebuild()</a>, <a class="el" href="a00165.html#l00303">nf_scan()</a>, <a class="el" href="a00133.html#l00066">PASS</a>, <a class="el" href="a00133.html#l00261">TRUE</a>, and <a class="el" href="a00165.html#l00920">ut_nfc_erase_all()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00197"></a>00197 {
<a name="l00198"></a>00198    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_nb_loop;
<a name="l00199"></a>00199    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> status_bool;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="preprocessor">#if (ERASING_ALL==ENABLE)</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>   <a class="code" href="a00064.html#61dbbd370e63df5414083790a6f50b58">ut_nfc_erase_all</a>();
<a name="l00204"></a>00204 <span class="preprocessor">#endif</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>   
<a name="l00206"></a>00206    status_bool = <a class="code" href="a00064.html#88cf2da70da57c7efa94e590f5eb096f" title="Scan the memory and looks for sub-LUT, free-blocks block and recovery blocks.">nf_scan</a>();
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    <span class="keywordflow">if</span>(( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>!=status_bool )
<a name="l00209"></a>00209    || ( <a class="code" href="a00064.html#940348c8e5e33ed3bf281df02a29a39c">is_nf_invalid</a>()   )  <span class="comment">// The NF is not cleanly built</span>
<a name="l00210"></a>00210    ) {
<a name="l00211"></a>00211       <span class="comment">// The NF seems not cleanly built, or not built at all.</span>
<a name="l00212"></a>00212       <span class="comment">//</span>
<a name="l00213"></a>00213       u8_nb_loop = 0;
<a name="l00214"></a>00214       <span class="keywordflow">while</span>( 1 )
<a name="l00215"></a>00215       {
<a name="l00216"></a>00216          u8_nb_loop++;
<a name="l00217"></a>00217          <span class="keywordflow">if</span>( u8_nb_loop &gt; 2 )
<a name="l00218"></a>00218          {
<a name="l00219"></a>00219             status_bool=<a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00220"></a>00220             <span class="keywordflow">break</span>;  <span class="comment">// Error NF access or control</span>
<a name="l00221"></a>00221          }
<a name="l00222"></a>00222          <a class="code" href="a00063.html#4111df3ea1a2e262cdc7b853bad4543f" title="Cleanup the memory by erasing all the management blocks.">nf_cleanup_memory</a>();
<a name="l00223"></a>00223          <span class="keywordflow">if</span>( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> != <a class="code" href="a00064.html#88cf2da70da57c7efa94e590f5eb096f" title="Scan the memory and looks for sub-LUT, free-blocks block and recovery blocks.">nf_scan</a>() )
<a name="l00224"></a>00224             <span class="keywordflow">continue</span>;
<a name="l00225"></a>00225          <span class="keywordflow">if</span>( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> != <a class="code" href="a00064.html#8d5fe4e1006879a77583ee71ca95f902">nf_rebuild</a>() )
<a name="l00226"></a>00226             <span class="keywordflow">continue</span>;
<a name="l00227"></a>00227          status_bool = <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00228"></a>00228          <span class="keywordflow">break</span>;
<a name="l00229"></a>00229       }
<a name="l00230"></a>00230    }
<a name="l00231"></a>00231    <span class="keywordflow">if</span> (status_bool==<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>)
<a name="l00232"></a>00232    {
<a name="l00233"></a>00233       <a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a> = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00234"></a>00234       <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l00235"></a>00235       <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l00236"></a>00236    }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238    <span class="keywordflow">return</span> status_bool;
<a name="l00239"></a>00239 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="4111df3ea1a2e262cdc7b853bad4543f"></a><!-- doxytag: member="nf_unusual.c::nf_cleanup_memory" ref="4111df3ea1a2e262cdc7b853bad4543f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_cleanup_memory           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Cleanup the memory by erasing all the management blocks. 
<p>
The sub-LUT blocks, the recovery block and the free-blocks block will be erased on any devices.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="a00165.html#l00250">250</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00067">FAIL</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00162.html#l00416">NF_SPARE_POS</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00348">NFC_BLK_ID_FBB</a>, <a class="el" href="a00162.html#l00346">NFC_BLK_ID_SUBLUT</a>, <a class="el" href="a00161.html#l00203">nfc_check_status()</a>, <a class="el" href="a00161.html#l00302">nfc_erase_block()</a>, <a class="el" href="a00161.html#l00255">nfc_mark_bad_block()</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00162.html#l00109">Nfc_rd_data</a>, <a class="el" href="a00162.html#l00110">Nfc_rd_data_fetch_next</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00251"></a>00251 {
<a name="l00252"></a>00252    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   i_dev  =0;
<a name="l00253"></a>00253    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  i_block=0;
<a name="l00254"></a>00254    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   block_valid;
<a name="l00255"></a>00255    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   block_id;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="comment">// Scan all the devices and looks for:</span>
<a name="l00258"></a>00258    <span class="comment">// - the sub-LUT</span>
<a name="l00259"></a>00259    <span class="comment">// - the recovery block</span>
<a name="l00260"></a>00260    <span class="comment">// - the free-blocks block</span>
<a name="l00261"></a>00261    <span class="comment">//</span>
<a name="l00262"></a>00262    <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; i_dev++ )
<a name="l00263"></a>00263    {
<a name="l00264"></a>00264       <span class="comment">// Select the devices</span>
<a name="l00265"></a>00265       <span class="comment">//</span>
<a name="l00266"></a>00266       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268       <span class="keywordflow">for</span>( i_block=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> ; i_block&lt;<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> ; i_block++ )
<a name="l00269"></a>00269       {
<a name="l00270"></a>00270 
<a name="l00271"></a>00271          <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>);
<a name="l00272"></a>00272          block_valid = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l00273"></a>00273          block_id    = <a class="code" href="a00061.html#3a9602476f480441b912a7de88d440ed">Nfc_rd_data</a>()           ;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275          <span class="keywordflow">if</span> ( block_valid!=0xFF )
<a name="l00276"></a>00276          {
<a name="l00277"></a>00277             <span class="keywordflow">continue</span>; <span class="comment">// The block is bad</span>
<a name="l00278"></a>00278          }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280          <span class="keywordflow">if</span>(( <a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a>==block_id )
<a name="l00281"></a>00281          || ( <a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a>   ==block_id ))
<a name="l00282"></a>00282          {
<a name="l00283"></a>00283             <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> ) ;
<a name="l00284"></a>00284             <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>==<a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>() )
<a name="l00285"></a>00285             {
<a name="l00286"></a>00286                <a class="code" href="a00060.html#baa6a09d1819325c231e3735177a2179" title="Mark a block as &amp;#39;invalid&amp;#39; by clearing it entirely.">nfc_mark_bad_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block) );
<a name="l00287"></a>00287             }
<a name="l00288"></a>00288          }
<a name="l00289"></a>00289       } <span class="comment">// for( i_block...</span>
<a name="l00290"></a>00290    } <span class="comment">// for( i_dev...</span>
<a name="l00291"></a>00291 } <span class="comment">// nf_cleanup_memory</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="61fea0ce6f891274490f59384e7a21de"></a><!-- doxytag: member="nf_unusual.c::g_n_zones" ref="61fea0ce6f891274490f59384e7a21de" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="a77d29865677c8e97bbd578eac48be3f"></a><!-- doxytag: member="nf_unusual.c::g_n_blocks" ref="a77d29865677c8e97bbd578eac48be3f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#a77d29865677c8e97bbd578eac48be3f">g_n_blocks</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="1caaea08067b99087b57de6ede8dc1d4"></a><!-- doxytag: member="nf_unusual.c::g_page_buffer" ref="1caaea08067b99087b57de6ede8dc1d4" args="[((2048)+(2048)/32)]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[((2048)+(2048)/32)]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00133">133</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="26346bee46d0d3fc1cda3b51ccefea3c"></a><!-- doxytag: member="nf_unusual.c::g_nf_init" ref="26346bee46d0d3fc1cda3b51ccefea3c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_BIT_ bit <a class="el" href="a00064.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00141">141</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="477092babd29a2c8bf51ace28ec46984"></a><!-- doxytag: member="nf_unusual.c::g_last_sub_lut_log_sz" ref="477092babd29a2c8bf51ace28ec46984" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00147">147</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="5540efb50ff0bf7a6144558f6dc5c579"></a><!-- doxytag: member="nf_unusual.c::g_sub_lut_log_sz" ref="5540efb50ff0bf7a6144558f6dc5c579" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00146">146</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="7b20377b71b59870430cfa0c4af29ad6"></a><!-- doxytag: member="nf_unusual.c::g_is_found_lut" ref="7b20377b71b59870430cfa0c4af29ad6" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="el" href="a00064.html#7b20377b71b59870430cfa0c4af29ad6">g_is_found_lut</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00082">82</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="f5410b60e6a7a37b85ae6a764fc46212"></a><!-- doxytag: member="nf_unusual.c::g_is_found_fbb" ref="f5410b60e6a7a37b85ae6a764fc46212" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="el" href="a00064.html#f5410b60e6a7a37b85ae6a764fc46212">g_is_found_fbb</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00083">83</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="62179699f6fc4d72c57daeab0e6d93b4"></a><!-- doxytag: member="nf_unusual.c::g_fatal" ref="62179699f6fc4d72c57daeab0e6d93b4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="el" href="a00064.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00107">107</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="af999b811df9c6926deef493ff81350c"></a><!-- doxytag: member="nf_unusual.c::g_n_real_sub_lut" ref="af999b811df9c6926deef493ff81350c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#af999b811df9c6926deef493ff81350c">g_n_real_sub_lut</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00085">85</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="188dac7e34a46f2f187c65c450036b6f"></a><!-- doxytag: member="nf_unusual.c::g_curr_block_addr" ref="188dac7e34a46f2f187c65c450036b6f" args="[NF_N_DEVICES]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#188dac7e34a46f2f187c65c450036b6f">g_curr_block_addr</a>[NF_N_DEVICES]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00086">86</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="5916bc2643bb147ae80a54bdd521b867"></a><!-- doxytag: member="nf_unusual.c::g_byte" ref="5916bc2643bb147ae80a54bdd521b867" args="[16]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#5916bc2643bb147ae80a54bdd521b867">g_byte</a>[16]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00087">87</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="b0117365e494c0e841a78464f9d26db3"></a><!-- doxytag: member="nf_unusual.c::g_n_sub_lut" ref="b0117365e494c0e841a78464f9d26db3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00145">145</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="d7432ad6a5432e1eaab6ec356ea36595"></a><!-- doxytag: member="nf_unusual.c::g_lut_block_addr" ref="d7432ad6a5432e1eaab6ec356ea36595" args="[(NF_N_DEVICES *(8 *1024)/(512/2))]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a>[(NF_N_DEVICES *(8 *1024)/(512/2))]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00150">150</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="97866e5e933474938c38cd599ee85d3c"></a><!-- doxytag: member="nf_unusual.c::g_lut_block_index" ref="97866e5e933474938c38cd599ee85d3c" args="[(NF_N_DEVICES *(8 *1024)/(512/2))]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[(NF_N_DEVICES *(8 *1024)/(512/2))]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00151">151</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="ccbc4d68a750c60b473ffde4930be9e9"></a><!-- doxytag: member="nf_unusual.c::s_nfd_rev" ref="ccbc4d68a750c60b473ffde4930be9e9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#ccbc4d68a750c60b473ffde4930be9e9">s_nfd_rev</a><code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00091">91</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="0a552b7ccb9f33999ade419ec56f6f6b"></a><!-- doxytag: member="nf_unusual.c::g_nf_first_block" ref="0a552b7ccb9f33999ade419ec56f6f6b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00117">117</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="ffddafa9cf10bed6f566c4ece73acf51"></a><!-- doxytag: member="nf_unusual.c::s_n_quarantine_blocks" ref="ffddafa9cf10bed6f566c4ece73acf51" args="[NF_N_DEVICES]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#ffddafa9cf10bed6f566c4ece73acf51">s_n_quarantine_blocks</a>[NF_N_DEVICES]<code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00093">93</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="b26fce863bb856df1bd4eaa22e5c750e"></a><!-- doxytag: member="nf_unusual.c::s_n_invalid_blocks" ref="b26fce863bb856df1bd4eaa22e5c750e" args="[NF_N_DEVICES]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#b26fce863bb856df1bd4eaa22e5c750e">s_n_invalid_blocks</a>[NF_N_DEVICES]<code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00165.html#l00094">94</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="b81e89341b6c9fc2a9c43f2d15f58f3d"></a><!-- doxytag: member="nf_unusual.c::g_n_export_blocks" ref="b81e89341b6c9fc2a9c43f2d15f58f3d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00143">143</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="c7986c38b60264dc6123cc4e2923680c"></a><!-- doxytag: member="nf_unusual.c::g_n_free_blocks" ref="c7986c38b60264dc6123cc4e2923680c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00144">144</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="6e9c9f3ede7e115a0c22ab8c0b315590"></a><!-- doxytag: member="nf_unusual.c::g_fbb_block_addr" ref="6e9c9f3ede7e115a0c22ab8c0b315590" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00148">148</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="3703ab21f7019db569a8e08575e55670"></a><!-- doxytag: member="nf_unusual.c::g_fbb_block_index" ref="3703ab21f7019db569a8e08575e55670" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00149">149</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="2bc0562eb7d70332b01be5df48432466"></a><!-- doxytag: member="nf_unusual.c::g_last_log_sector" ref="2bc0562eb7d70332b01be5df48432466" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> <a class="el" href="a00064.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00158">158</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="f4ca354f5f4da2cf8714d86c99840fa7"></a><!-- doxytag: member="nf_unusual.c::g_copy_src" ref="f4ca354f5f4da2cf8714d86c99840fa7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> <a class="el" href="a00064.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00116">116</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="94ac20e6203a5a5cd4af24cc2b84879f"></a><!-- doxytag: member="nf_unusual.c::g_block_to_kill" ref="94ac20e6203a5a5cd4af24cc2b84879f" args="[NF_N_DEVICES]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[NF_N_DEVICES]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00161">161</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="3bf34b5d35614f365127da4dbab52998"></a><!-- doxytag: member="nf_unusual.c::g_phys_page_addr" ref="3bf34b5d35614f365127da4dbab52998" args="[NF_N_DEVICES]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_FAST_ <a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> <a class="el" href="a00064.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[NF_N_DEVICES]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00162">162</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="a94e9abd9d0bc654cff101b858b05b3d"></a><!-- doxytag: member="nf_unusual.c::g_curr_dev_id" ref="a94e9abd9d0bc654cff101b858b05b3d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_FAST_ <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00064.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00155">155</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="5e2bdb520dead632ea38327b3ce2d876"></a><!-- doxytag: member="nf_unusual.c::g_log_block_id" ref="5e2bdb520dead632ea38327b3ce2d876" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_MEDFAST_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00064.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00142">142</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="34b0c74ff891c7c0b314cc27a7fb1307"></a><!-- doxytag: member="nf_unusual.c::g_cache_lut" ref="34b0c74ff891c7c0b314cc27a7fb1307" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00002.html">Cache_lut</a> <a class="el" href="a00064.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00129">129</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<a class="anchor" name="7a88492231eef53d1724201b68b964bd"></a><!-- doxytag: member="nf_unusual.c::g_cache_fbb" ref="7a88492231eef53d1724201b68b964bd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00001.html">Cache_fbb</a> <a class="el" href="a00064.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00130">130</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

</div>
</div><p>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 14 13:14:22 2009 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
