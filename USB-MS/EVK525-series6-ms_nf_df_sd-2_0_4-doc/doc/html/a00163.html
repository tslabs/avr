<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: nf_mngt.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>nf_mngt.c</h1><a href="a00062.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file is prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">/* Copyright (c) 2009 Atmel Corporation. All rights reserved.</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00020"></a>00020 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
<a name="l00023"></a>00023 <span class="comment"> * this list of conditions and the following disclaimer.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00026"></a>00026 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00027"></a>00027 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * 3. The name of Atmel may not be used to endorse or promote products derived</span>
<a name="l00030"></a>00030 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * 4. This software may only be redistributed and used in connection with an Atmel</span>
<a name="l00033"></a>00033 <span class="comment"> * AVR product.</span>
<a name="l00034"></a>00034 <span class="comment"> *</span>
<a name="l00035"></a>00035 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED</span>
<a name="l00036"></a>00036 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00037"></a>00037 <span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE EXPRESSLY AND</span>
<a name="l00038"></a>00038 <span class="comment"> * SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT,</span>
<a name="l00039"></a>00039 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00040"></a>00040 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00041"></a>00041 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00042"></a>00042 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00043"></a>00043 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00044"></a>00044 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00045"></a>00045 <span class="comment"> */</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="comment">// TODO: remplacer les s_shift_xxx en (1&lt;&lt;s_shift_xxx): et ainsi faire des DIV/MUL plutot que des shift</span>
<a name="l00048"></a>00048 <span class="comment">// TODO: decomposer g_phys_page_addr en s_phys_block et s_phys_page (offset dans le block)</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">//_____  I N C L U D E S ___________________________________________________</span>
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="a00062.html#0fdac67c9ed489e39f926b8ee5de93f5">00052</a> <span class="preprocessor">#define _TRACE_        (DISABLE)</span>
<a name="l00053"></a><a class="code" href="a00062.html#96af1033eb0728bcd48a240125276098">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define NF_ECC_MNGT    (DISABLE)</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="a00039.html">config.h</a>"</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include "<a class="code" href="a00035.html">conf_nf.h</a>"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "<a class="code" href="a00057.html">nf.h</a>"</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include "<a class="code" href="a00061.html">nf_drv.h</a>"</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include "<a class="code" href="a00063.html">nf_mngt.h</a>"</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include "<a class="code" href="a00087.html">lib_mcu/usb/usb_drv.h</a>"</span>            <span class="comment">/* usb driver definition */</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include "<a class="code" href="a00044.html">lib_mcu/debug.h</a>"</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#ifndef __GNUC__</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>  <span class="keyword">extern</span> __no_init <span class="keyword">volatile</span> xdata <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_send_cmd <a class="code" href="a00060.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a>(<a class="code" href="a00061.html#b25def4db76056c0fb628017a8745cb9">NF_CMD_LATCH_ENABLE_ADD</a>);  <span class="comment">// Command</span>
<a name="l00066"></a>00066   <span class="keyword">extern</span> __no_init <span class="keyword">volatile</span> xdata <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_send_add <a class="code" href="a00060.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a>(<a class="code" href="a00061.html#52171333a19206727fd5cf8dd22764a1">NF_ADD_LATCH_ENABLE_ADD</a>);  <span class="comment">// Address</span>
<a name="l00067"></a>00067   <span class="keyword">extern</span> __no_init <span class="keyword">volatile</span> xdata <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_data <a class="code" href="a00060.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a>(<a class="code" href="a00061.html#2c64a0b3ce78ea21cc2b1a6d1c881011">NF_ADDRESS_CMD_DATA</a>);          <span class="comment">// Data</span>
<a name="l00068"></a>00068 <span class="preprocessor">#else</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>  <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nf_send_cmd __attribute__ ((section (<span class="stringliteral">".nf_cmd"</span>)));
<a name="l00070"></a>00070   <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nf_send_add __attribute__ ((section (<span class="stringliteral">".nf_add"</span>)));
<a name="l00071"></a>00071   <span class="keyword">extern</span> <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nf_data     __attribute__ ((section (<span class="stringliteral">".nf_dat"</span>)));
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="comment">//_____ D E F I N I T I O N ________________________________________________</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">//#error Attention au modulo, call uidiv, uldiv, ...</span>
<a name="l00078"></a>00078 <span class="comment">//Se servir plus souvent du Random Data Input pour le code 2K (création de LUT)</span>
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="preprocessor">#if( NF_BAD_CONFIG==(FALSE) )</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>
<a name="l00082"></a>00082 <span class="comment">//_____ M A C R O S ________________________________________________________</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">//_____ P R I V A T E    D E C L A R A T I O N _____________________________</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="comment">// Static definition, which can be optimized by the compiler</span>
<a name="l00088"></a>00088 <span class="comment">//</span>
<a name="l00089"></a>00089 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE) || (defined NF_AUTO_DETECT_2KB) ||(defined NF_AUTO_DETECT_512B)</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>        <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>    <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a>               ; <span class="comment">// number of zones (=1024 blocks) per device</span>
<a name="l00091"></a>00091 <span class="keyword">extern</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>       <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  <a class="code" href="a00061.html#a77d29865677c8e97bbd578eac48be3f">g_n_blocks</a>              ; <span class="comment">// number of blocks per device</span>
<a name="l00092"></a>00092 <span class="keyword">extern</span> <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>          ; <span class="comment">// number of row cycles to access a page of the NF memory</span>
<a name="l00093"></a>00093 <span class="keyword">extern</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>        <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>    <a class="code" href="a00061.html#704f58e28283f1a6539d4ebcf52d2be8">g_copy_back_cont</a>        ; <span class="comment">// 0 = copy back not supported, N = number of    CONTINUE subdivision contraint on copyback</span>
<a name="l00094"></a>00094 <span class="keyword">extern</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>        <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>    <a class="code" href="a00061.html#ccd4688c7bedb0ceeb4b3b4d4a78c92a">g_copy_back_discont</a>     ; <span class="comment">// 0 = copy back not supported, N = number of DISCONTINUE subdivision contraint on copyback</span>
<a name="l00095"></a>00095 <span class="preprocessor">#endif</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00097"></a>00097 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE)</span>
<a name="l00098"></a><a class="code" href="a00062.html#12e3a20682ed5032e788a57882f8256f">00098</a> <span class="preprocessor"></span>       <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00061.html#12e3a20682ed5032e788a57882f8256f">g_shift_page_byte</a>       ; <span class="comment">// (1&lt;&lt;n) size of page,   unit in bytes</span>
<a name="l00099"></a><a class="code" href="a00062.html#be82d871b5e412806adb94589b4b7f2e">00099</a>        <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00061.html#be82d871b5e412806adb94589b4b7f2e">g_shift_block_page</a>      ; <span class="comment">// (1&lt;&lt;n) size of physical block,  unit in pages</span>
<a name="l00100"></a><a class="code" href="a00062.html#b466843403d37526c75306381a6807c7">00100</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00061.html#b466843403d37526c75306381a6807c7">g_ofst_blk_status</a>       ; <span class="comment">// Offset of Block Status information in spare zone</span>
<a name="l00101"></a><a class="code" href="a00062.html#d24848f009aa80a9e062513b93f73493">00101</a> <span class="keyword">static</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00062.html#d24848f009aa80a9e062513b93f73493">s_shift_sector_byte</a>     ; <span class="comment">// (1&lt;&lt;n) size of sector, unit in bytes</span>
<a name="l00102"></a><a class="code" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">00102</a> <span class="keyword">static</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a> ; <span class="comment">// (1&lt;&lt;n) size of logical   page,  unit in sectors</span>
<a name="l00103"></a><a class="code" href="a00062.html#7dfe2973a57e7e1ad70f55f70bbcef87">00103</a> <span class="keyword">static</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>       <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00062.html#7dfe2973a57e7e1ad70f55f70bbcef87">s_shift_log_block_sector</a>; <span class="comment">// (1&lt;&lt;n) size of logical  block,  unit in sectors</span>
<a name="l00104"></a>00104 <span class="preprocessor">#endif</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="a00064.html#62179699f6fc4d72c57daeab0e6d93b4">00107</a>        <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>       ; <span class="comment">// Used in LUT/FBB building and ECC management...</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="a00062.html#20874a420e6102174c88e80522624a22">00110</a> <span class="keyword">static</span> <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="code" href="a00062.html#20874a420e6102174c88e80522624a22">s_mem</a>         ;
<a name="l00111"></a>00111 <span class="preprocessor">#if (defined ATMEL_WARNING)</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span><span class="preprocessor">#  warning In waiting for a recoding of the control_access module.</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00114"></a><a class="code" href="a00062.html#f373954acd1f3cc6e5394c0e6fa4d642">00114</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="code" href="a00062.html#f373954acd1f3cc6e5394c0e6fa4d642">s_start</a>       ;
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="a00064.html#f4ca354f5f4da2cf8714d86c99840fa7">00116</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  <a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>                         ; <span class="comment">// Used to copy NF pages (source page)</span>
<a name="l00117"></a><a class="code" href="a00064.html#0a552b7ccb9f33999ade419ec56f6f6b">00117</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  <a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a>=0                 ; <span class="comment">// Block addr of the beginning of dynamic area</span>
<a name="l00118"></a>00118 
<a name="l00119"></a><a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c">00119</a> <span class="keyword">typedef</span> <span class="keyword">enum</span>
<a name="l00120"></a>00120 {
<a name="l00121"></a><a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2cdb9a1812cd73d7ac682d8e6ad22856f4">00121</a>    <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2cdb9a1812cd73d7ac682d8e6ad22856f4">STATE_READ_INIT</a>=0       <span class="comment">// The very first open_read must be done</span>
<a name="l00122"></a><a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c5ff7f35f4d26e3ef300c6970220d940a">00122</a> ,  <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c5ff7f35f4d26e3ef300c6970220d940a">STATE_READ_RESUME_PAGE</a>  <span class="comment">// A page has been read</span>
<a name="l00123"></a><a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c70a0e9b399de4a423fcf6840cd14388d">00123</a> ,  <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c70a0e9b399de4a423fcf6840cd14388d">STATE_WRITE_INIT</a>        <span class="comment">// The very first open_write must be done</span>
<a name="l00124"></a><a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c748ac01f3369078c77c1b57780bdd88f">00124</a> ,  <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c748ac01f3369078c77c1b57780bdd88f">STATE_WRITE_RESUME_PAGE</a> <span class="comment">// A page has been written</span>
<a name="l00125"></a><a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c79ae1582c50ffdc26c332345ede75d7c">00125</a> ,  <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>          <span class="comment">// The read or write session is over.</span>
<a name="l00126"></a>00126 } <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c">Nf_state</a>;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="a00064.html#34b0c74ff891c7c0b314cc27a7fb1307">00129</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00002.html">Cache_lut</a> <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>; <span class="comment">// LUT cache</span>
<a name="l00130"></a><a class="code" href="a00064.html#7a88492231eef53d1724201b68b964bd">00130</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00001.html">Cache_fbb</a> <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>; <span class="comment">// Free-Blocks block cache</span>
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="a00064.html#1caaea08067b99087b57de6ede8dc1d4">00133</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00063.html#f80c4ce07be5eb80f1fa7e96dd19aa8a">NF_FULL_PAGE_BUFFER_SIZE</a>] ; <span class="comment">// Used to bufferize a page</span>
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">// Dynamic variables</span>
<a name="l00136"></a>00136 <span class="comment">//</span>
<a name="l00137"></a><a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">00137</a> <span class="keyword">static</span> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>       <a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">s_save_log_addr</a>              ; <span class="comment">// Used for Stand-by / Restart operations</span>
<a name="l00138"></a>00138 <span class="comment">//static _MEM_TYPE_SLOW_    U16       s_save_n_sector              ; // Used for Stand-by / Restart operations</span>
<a name="l00139"></a>00139 <span class="comment">//static _MEM_TYPE_SLOW_    U32       s_save2_log_addr             ; // Used for Stand-by / Restart operations</span>
<a name="l00140"></a>00140 <span class="comment">//static _MEM_TYPE_SLOW_    U16       s_save2_n_sector             ; // Used for Stand-by / Restart operations</span>
<a name="l00141"></a><a class="code" href="a00064.html#26346bee46d0d3fc1cda3b51ccefea3c">00141</a>        <a class="code" href="a00032.html#7e018ab3e0664c67f572d5ea1a487b7b">_MEM_TYPE_BIT_</a>     bit       <a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a>                    ; <span class="comment">// Boolean set when driver is initialized</span>
<a name="l00142"></a><a class="code" href="a00064.html#5e2bdb520dead632ea38327b3ce2d876">00142</a>        <a class="code" href="a00032.html#dcd997c76f95854090b17513c4ef3891">_MEM_TYPE_MEDFAST_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>               ; <span class="comment">// Logical Block address</span>
<a name="l00143"></a><a class="code" href="a00064.html#b81e89341b6c9fc2a9c43f2d15f58f3d">00143</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>=0xFFFF     ; <span class="comment">// Number of physical blocks exported for mass-storage use</span>
<a name="l00144"></a><a class="code" href="a00064.html#c7986c38b60264dc6123cc4e2923680c">00144</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>              ; <span class="comment">// Number of free physical blocks</span>
<a name="l00145"></a><a class="code" href="a00064.html#b0117365e494c0e841a78464f9d26db3">00145</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>        <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>                  ; <span class="comment">// Holds the number of sub-Lut</span>
<a name="l00146"></a><a class="code" href="a00064.html#5540efb50ff0bf7a6144558f6dc5c579">00146</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#5540efb50ff0bf7a6144558f6dc5c579">g_sub_lut_log_sz</a>             ; <span class="comment">// Size of the sub-LUT. Unit in number of logical blocks</span>
<a name="l00147"></a><a class="code" href="a00064.html#477092babd29a2c8bf51ace28ec46984">00147</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#477092babd29a2c8bf51ace28ec46984">g_last_sub_lut_log_sz</a>        ; <span class="comment">// Size of the last sub-LUT. Unit in number of logical blocks</span>
<a name="l00148"></a><a class="code" href="a00064.html#6e9c9f3ede7e115a0c22ab8c0b315590">00148</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>             ; <span class="comment">// Free-Blocks block address</span>
<a name="l00149"></a><a class="code" href="a00064.html#3703ab21f7019db569a8e08575e55670">00149</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>        <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>            ; <span class="comment">// Free-Blocks block index</span>
<a name="l00150"></a><a class="code" href="a00064.html#d7432ad6a5432e1eaab6ec356ea36595">00150</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a> [ <a class="code" href="a00063.html#28826e9d277e2bdd262d82d6caf78f29">N_SUBLUT</a> ]; <span class="comment">// LUT block address</span>
<a name="l00151"></a><a class="code" href="a00064.html#97866e5e933474938c38cd599ee85d3c">00151</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>        <a class="code" href="a00062.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[ <a class="code" href="a00063.html#28826e9d277e2bdd262d82d6caf78f29">N_SUBLUT</a> ]; <span class="comment">// LUT index, unit in (LUT size/page size)</span>
<a name="l00152"></a>00152 
<a name="l00153"></a><a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">00153</a> <span class="keyword">static</span> <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>                  ; <span class="comment">// Holds the number of sectors to read/write</span>
<a name="l00154"></a><a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">00154</a> <span class="keyword">static</span> <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>        <a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>            ; <span class="comment">// Holds the number of sectors read after each page</span>
<a name="l00155"></a><a class="code" href="a00064.html#a94e9abd9d0bc654cff101b858b05b3d">00155</a>        <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>        <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>                ; <span class="comment">// Holds the current device number that is used</span>
<a name="l00156"></a><a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">00156</a> <span class="keyword">static</span> <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a>                ; <span class="comment">// Holds the position in the page</span>
<a name="l00157"></a><a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">00157</a> <span class="keyword">static</span> <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>       <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a>            ; <span class="comment">// Holds the logical sector number</span>
<a name="l00158"></a><a class="code" href="a00064.html#2bc0562eb7d70332b01be5df48432466">00158</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>       <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> =0xFFFFFFFF; <span class="comment">// Holds the last logical sector number on which a Write has been done</span>
<a name="l00159"></a><a class="code" href="a00062.html#9c4b75f9b5c440a5afb34503f8a548a0">00159</a> <span class="keyword">static</span> <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c">Nf_state</a>  <a class="code" href="a00062.html#9c4b75f9b5c440a5afb34503f8a548a0">s_state</a>                      ; <span class="comment">// Holds the current state of the driver</span>
<a name="l00160"></a>00160 
<a name="l00161"></a><a class="code" href="a00064.html#94ac20e6203a5a5cd4af24cc2b84879f">00161</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>       <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[ <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>]    ; <span class="comment">// Holds the blocks number which will be erased</span>
<a name="l00162"></a><a class="code" href="a00064.html#3bf34b5d35614f365127da4dbab52998">00162</a>        <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>       <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>]    ; <span class="comment">// Holds the current phys page number for each device</span>
<a name="l00163"></a>00163 
<a name="l00164"></a><a class="code" href="a00062.html#c0a2374cd78287e46a8ad264f901d7d2">00164</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>       <a class="code" href="a00062.html#c0a2374cd78287e46a8ad264f901d7d2">g_save_phys_page_addr</a>             ; <span class="comment">// Holds the previous phys page number</span>
<a name="l00165"></a><a class="code" href="a00062.html#ad9773ba6b2f525e74aae742dca29401">00165</a>        <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>        <a class="code" href="a00062.html#ad9773ba6b2f525e74aae742dca29401">g_save_curr_dev_id</a>                ; <span class="comment">// Holds the previous device number that is used</span>
<a name="l00166"></a>00166 
<a name="l00167"></a><a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">00167</a>        <a class="code" href="a00032.html#bf669e579471cadcf68d9ffc440e68b1">_MEM_TYPE_FAST_</a>    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>       <a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>             ; <span class="comment">// Holds the previous phys page number</span>
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1">00169</a> <span class="keyword">typedef</span> <span class="keyword">enum</span>
<a name="l00170"></a>00170 {
<a name="l00171"></a><a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">00171</a>    <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a>  <span class="comment">// make simple translation.</span>
<a name="l00172"></a><a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f15ffd3a77015345013d1c3e932346ad1a">00172</a> ,  <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f15ffd3a77015345013d1c3e932346ad1a">NF_TRANS_FLUSH</a>   <span class="comment">// make simple translation. Force flush of LUT and FBB caches.</span>
<a name="l00173"></a><a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1e38cd8e23792344b6c802f0d80d97ef8">00173</a> ,  <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1e38cd8e23792344b6c802f0d80d97ef8">NF_TRANS_SWAP</a>    <span class="comment">// Swap blocks LUT &lt;-&gt; FBB</span>
<a name="l00174"></a>00174 } <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1">Nf_translate_mode</a>;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="comment">//_____ P R I V A T E    F U N C T I O N S _________________________________</span>
<a name="l00178"></a>00178 <span class="comment">//</span>
<a name="l00179"></a>00179 <span class="keyword">static</span> <span class="keywordtype">void</span>        <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1">Nf_translate_mode</a> mode );
<a name="l00180"></a>00180 <span class="keyword">static</span> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(    bit check_pending_write );
<a name="l00181"></a>00181 <span class="keyword">static</span> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>(   bit check_pending_write );
<a name="l00182"></a>00182 <span class="keyword">static</span> <span class="keywordtype">void</span>        <a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac" title="Reload the LUT cache memory, starting from the specified logical block number given...">nf_cache_lut_refill</a>( <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> log_block_id  );
<a name="l00183"></a>00183 <span class="keyword">static</span> <span class="keywordtype">void</span>        <a class="code" href="a00062.html#c029fba5c62db088a077b69802d61f91" title="Flushes the LUT cache into a new LUT entry.">nf_cache_lut_flush</a>( <span class="keywordtype">void</span>  );
<a name="l00184"></a>00184 <span class="keyword">static</span> <span class="keywordtype">void</span>        <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>( <span class="keywordtype">void</span> );
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>                 <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>(<span class="keywordtype">void</span>);
<a name="l00187"></a>00187 <span class="keywordtype">void</span>               <a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015" title="This function transfers USB data to the NF page The number of sectors to be read...">nf_write_sector_from_usb</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>);
<a name="l00188"></a>00188 <span class="keywordtype">void</span>               <a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8" title="This function transfers a page content (NF) to the USB macro The number of sectors...">nf_read_sector_to_usb</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>);
<a name="l00189"></a>00189 <span class="keywordtype">void</span>               <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="comment">//_____ F U N C T I O N S __________________________________________________</span>
<a name="l00192"></a>00192 <span class="comment">//</span>
<a name="l00193"></a>00193 
<a name="l00202"></a><a class="code" href="a00063.html#5bc1ea382d755aa7efeffbd008c3347a">00202</a> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#5bc1ea382d755aa7efeffbd008c3347a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify</a>( <span class="keywordtype">void</span> )
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204    <span class="keywordflow">if</span> ( g_nf_init ) <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206    <span class="keywordflow">return</span> <a class="code" href="a00063.html#b3c26aadc0e38a2d67aac9080152777a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify_resume</a>();
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00218"></a><a class="code" href="a00063.html#842d42e30e0ae29382313535b396163c">00218</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> <a class="code" href="a00062.html#842d42e30e0ae29382313535b396163c" title="Initializes the NF driver on the first USB Test Unit Ready.">nf_test_unit_ready</a> ( <span class="keywordtype">void</span> )
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220   <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> tmp_bool;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00224"></a>00224 <span class="preprocessor">#endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>
<a name="l00226"></a>00226    tmp_bool = <a class="code" href="a00062.html#5bc1ea382d755aa7efeffbd008c3347a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify</a>();
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00230"></a>00230 <span class="preprocessor">#endif</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>
<a name="l00232"></a>00232    <span class="keywordflow">return</span> ( tmp_bool==<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> ) ? <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> : <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 
<a name="l00243"></a><a class="code" href="a00063.html#90632665455271ff8941f40e905643c3">00243</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> <a class="code" href="a00062.html#5f95a4eb670bcd8a77961f65e8fcb330" title="Returns the address of the last valid logical sector.">nf_read_capacity</a> (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  *u32_nb_sector )
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245   <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> status_bool;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00249"></a>00249 <span class="preprocessor">#endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>
<a name="l00251"></a>00251    status_bool = <a class="code" href="a00062.html#5bc1ea382d755aa7efeffbd008c3347a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify</a>();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00255"></a>00255 <span class="preprocessor">#endif</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>
<a name="l00257"></a>00257    *u32_nb_sector = <a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>()-1;
<a name="l00258"></a>00258    <span class="keywordflow">return</span> ( status_bool==<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> ) ? <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> : <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>;
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="a00063.html#025a42a5797bf8f4ae78f5e0cddc0842">00262</a> <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>  <a class="code" href="a00062.html#025a42a5797bf8f4ae78f5e0cddc0842">nf_wr_protect</a> ( <span class="keywordtype">void</span> )
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264     <span class="keywordflow">return</span> <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="a00063.html#0034234ddcc3a96d3427630292f3b8db">00267</a> <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>  <a class="code" href="a00062.html#0034234ddcc3a96d3427630292f3b8db">nf_removal</a> ( <span class="keywordtype">void</span> )
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <span class="keywordflow">return</span> <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00281"></a>00281 <span class="preprocessor">#if 0</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>*  <a class="code" href="a00063.html#15475d6193583f87740f8dfa6219772b">nf_get_buffer_addr</a>         ( <span class="keywordtype">void</span> ) { <span class="keywordflow">return</span> g_page_buffer; }
<a name="l00283"></a>00283 <span class="preprocessor">#endif</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>
<a name="l00285"></a>00285 
<a name="l00296"></a><a class="code" href="a00063.html#f935b5cf31febdb455f0b157944ae27b">00296</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  <a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>      ( <span class="keywordtype">void</span> )
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <span class="keywordflow">return</span>
<a name="l00299"></a>00299       (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_n_export_blocks
<a name="l00300"></a>00300    &lt;&lt; (<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> +<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> -<a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>)
<a name="l00301"></a>00301    ;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="a00063.html#f713bee0ed464d2bfa6876cd9d4ef296">00306</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_addr)
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308    <span class="keywordflow">return</span> (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)block_addr&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 
<a name="l00320"></a><a class="code" href="a00063.html#1c583c1d616f3af3e57ebe914cf747e9">00320</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> <a class="code" href="a00062.html#1c583c1d616f3af3e57ebe914cf747e9" title="This function initializes the Nand Flash for a read operation.">nf_read_10</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> log_sector , <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> n_sectors)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  status;
<a name="l00323"></a>00323   
<a name="l00324"></a>00324    <span class="keywordflow">if</span> ( !g_nf_init )
<a name="l00325"></a>00325       <span class="keywordflow">while</span>(1);   <span class="comment">// You shall call once mem_test_unit_ready() before.</span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <span class="comment">// Test that the logical sector address is valid</span>
<a name="l00328"></a>00328    <span class="comment">//</span>
<a name="l00329"></a>00329    <span class="keywordflow">if</span> ( 0==n_sectors )                                   { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>; }
<a name="l00330"></a>00330    <span class="keywordflow">if</span> ( (log_sector+n_sectors)&gt;<a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>; }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00334"></a>00334 <span class="preprocessor">#endif</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span>
<a name="l00336"></a>00336    s_n_sectors       = n_sectors;
<a name="l00337"></a>00337    s_curr_log_sector = log_sector;
<a name="l00338"></a>00338    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"rd;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(s_curr_log_sector); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(s_n_sectors); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00339"></a>00339    s_save_log_addr   = log_sector + n_sectors;
<a name="l00340"></a>00340    g_fatal           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00341"></a>00341    s_mem             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00342"></a>00342    s_start           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="comment">// First read operation</span>
<a name="l00345"></a>00345    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l00346"></a>00346    <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00347"></a>00347    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);
<a name="l00348"></a>00348    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( g_phys_page_addr[g_curr_dev_id], s_curr_n_byte );
<a name="l00349"></a>00349    <a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8" title="This function transfers a page content (NF) to the USB macro The number of sectors...">nf_read_sector_to_usb</a>(s_nb_sectors_step);
<a name="l00350"></a>00350    status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l00351"></a>00351 
<a name="l00352"></a>00352    <span class="comment">// Next read operations</span>
<a name="l00353"></a>00353    <span class="keywordflow">while</span> (status == <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)    <span class="comment">// exit when last page read</span>
<a name="l00354"></a>00354    {
<a name="l00355"></a>00355       <span class="keywordflow">if</span> (!(<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_next_phys_page_addr) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>-1))    <span class="comment">// new block</span>
<a name="l00356"></a>00356       &amp;&amp; (g_curr_dev_id==0                                  ))    <span class="comment">// on device 0. Should this case be implicit ? If yes, we can remove it.</span>
<a name="l00357"></a>00357       {
<a name="l00358"></a>00358          <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00359"></a>00359       }
<a name="l00360"></a>00360       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);
<a name="l00361"></a>00361       <a class="code" href="a00061.html#c8447f3352f9d30b0a9eb506378d3cc9" title="Opens a page for read.">Nfc_open_page_read</a>( g_next_phys_page_addr, s_curr_n_byte ); <span class="comment">// Use macro for fast execution</span>
<a name="l00362"></a>00362       <a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8" title="This function transfers a page content (NF) to the USB macro The number of sectors...">nf_read_sector_to_usb</a>(s_nb_sectors_step);                   <span class="comment">// read the concerned sectors of the selected page</span>
<a name="l00363"></a>00363       status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();                             <span class="comment">// check if last page or not</span>
<a name="l00364"></a>00364    }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00370"></a>00370 <span class="preprocessor">#endif</span>
<a name="l00371"></a>00371 <span class="preprocessor"></span>
<a name="l00372"></a>00372    <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>;
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00384"></a><a class="code" href="a00063.html#fd80e982702f51b6ad94632856b980e1">00384</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> <a class="code" href="a00062.html#fd80e982702f51b6ad94632856b980e1" title="This function initializes the Nand Flash for a write operation.">nf_write_10</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> log_sector , <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> n_sectors)
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> status;
<a name="l00387"></a>00387   <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> tmp_bool;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    <span class="comment">// Test that the logical sector address is valid</span>
<a name="l00390"></a>00390    <span class="keywordflow">if</span> ( 0==n_sectors )                                   { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>; }
<a name="l00391"></a>00391    <span class="keywordflow">if</span> ( (log_sector+n_sectors)&gt;<a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>; }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00395"></a>00395 <span class="preprocessor">#endif</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>
<a name="l00397"></a>00397    s_n_sectors       = n_sectors;
<a name="l00398"></a>00398    s_curr_log_sector = log_sector;
<a name="l00399"></a>00399    s_save_log_addr   = log_sector + n_sectors;
<a name="l00400"></a>00400    g_fatal           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00401"></a>00401    s_mem             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00402"></a>00402    s_start           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"wr;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(s_curr_log_sector); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(s_n_sectors); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00405"></a>00405    
<a name="l00406"></a>00406    <span class="comment">// First write operation</span>
<a name="l00407"></a>00407    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l00408"></a>00408    <span class="keywordflow">if</span>(( s_curr_log_sector==g_last_log_sector )                                           <span class="comment">// New write is just after to the last write</span>
<a name="l00409"></a>00409    &amp;&amp; (!(  ( 0==((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_last_log_sector &amp; ( ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>)) -1)))   <span class="comment">// Not on a logical block boundary</span>
<a name="l00410"></a>00410       &amp;&amp; ( g_curr_dev_id==0                                                        ))))
<a name="l00411"></a>00411    {
<a name="l00412"></a>00412       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"continue"</span>);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00413"></a>00413       <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a> );
<a name="l00414"></a>00414       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);  <span class="comment">// open the current device</span>
<a name="l00415"></a>00415       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( g_next_phys_page_addr, s_curr_n_byte );
<a name="l00416"></a>00416    }
<a name="l00417"></a>00417    <span class="keywordflow">else</span>
<a name="l00418"></a>00418    {      
<a name="l00419"></a>00419       <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421    <a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015" title="This function transfers USB data to the NF page The number of sectors to be read...">nf_write_sector_from_usb</a>(s_nb_sectors_step);    <span class="comment">// s_nb_sectors_step has been calculated in nf_translate()</span>
<a name="l00422"></a>00422    <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l00423"></a>00423    {
<a name="l00424"></a>00424       <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>))-s_nb_sectors_step, s_nb_sectors_step);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l00425"></a>00425    }
<a name="l00426"></a>00426    <span class="keywordflow">else</span>
<a name="l00427"></a>00427    {
<a name="l00428"></a>00428      <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, 1);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l00429"></a>00429    }
<a name="l00430"></a>00430    g_last_log_sector  = s_curr_log_sector + s_nb_sectors_step;    <span class="comment">// Memorize next logical sector to be managed</span>
<a name="l00431"></a>00431    status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l00432"></a>00432 
<a name="l00433"></a>00433    <span class="comment">// Next write operations</span>
<a name="l00434"></a>00434    <span class="keywordflow">while</span> (status == <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)    <span class="comment">// exit when operation finished</span>
<a name="l00435"></a>00435    {
<a name="l00436"></a>00436       <span class="keywordflow">if</span>(!(<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_next_phys_page_addr) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>-1))  <span class="comment">// new block</span>
<a name="l00437"></a>00437       &amp;&amp; (g_curr_dev_id==0                                  )) <span class="comment">// on device 0.</span>
<a name="l00438"></a>00438       {
<a name="l00439"></a>00439          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>); <span class="comment">// Program the page</span>
<a name="l00440"></a>00440          <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>();
<a name="l00441"></a>00441          <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l00442"></a>00442       }
<a name="l00443"></a>00443       <span class="keywordflow">else</span>
<a name="l00444"></a>00444       {
<a name="l00445"></a>00445          <span class="keywordflow">if</span>( <a class="code" href="a00061.html#b4233cf2358424060e6586b4ca401213">G_CACHE_PROG</a> )
<a name="l00446"></a>00446          {
<a name="l00447"></a>00447             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g4bd39b96f3be4d842abc784c09b16659" title="Cache program (fast) command (2KB).">NF_CACHE_PROGRAM_CMD</a>);
<a name="l00448"></a>00448          }<span class="keywordflow">else</span>{
<a name="l00449"></a>00449             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l00450"></a>00450          }
<a name="l00451"></a>00451          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);
<a name="l00452"></a>00452          <a class="code" href="a00061.html#74dba9394ac015f89cb1c42131a239b5" title="Opens a page for write.">Nfc_open_page_write</a>( g_next_phys_page_addr, s_curr_n_byte ); <span class="comment">// Use macro for fast execution</span>
<a name="l00453"></a>00453       }
<a name="l00454"></a>00454       <a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015" title="This function transfers USB data to the NF page The number of sectors to be read...">nf_write_sector_from_usb</a>(s_nb_sectors_step);
<a name="l00455"></a>00455       <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l00456"></a>00456       {
<a name="l00457"></a>00457          <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, s_nb_sectors_step);
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459       <span class="keywordflow">else</span>
<a name="l00460"></a>00460       {
<a name="l00461"></a>00461          <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, 1);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l00462"></a>00462       }
<a name="l00463"></a>00463       g_last_log_sector  = s_curr_log_sector + s_nb_sectors_step;    <span class="comment">// Memorize next logical sector to be managed</span>
<a name="l00464"></a>00464       status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();  <span class="comment">// check if last block or not</span>
<a name="l00465"></a>00465    }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    tmp_bool = <a class="code" href="a00062.html#d45465832eded4b9de5dfa9b095482bd" title="This function must be called when a write10 operation (from USB) is finished Last...">nf_dfc_write_stop</a>(0);   <span class="comment">// ends write operations with "nf_dfc_write_stop(0)" that save the current environnement</span>
<a name="l00468"></a>00468    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00472"></a>00472 <span class="preprocessor">#endif</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span>
<a name="l00474"></a>00474    <span class="keywordflow">return</span> tmp_bool;
<a name="l00475"></a>00475 }
<a name="l00476"></a>00476 
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="comment">//_____ P R I V A T E    F U N C T I O N S _________________________________</span>
<a name="l00481"></a>00481 <span class="comment">//</span>
<a name="l00482"></a>00482 
<a name="l00490"></a><a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82">00490</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>(<span class="keywordtype">void</span>)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492    <span class="keywordflow">if</span> ( <span class="comment">// Are we processing the last page ?</span>
<a name="l00493"></a>00493       (  (s_curr_log_sector &amp; (<a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>-1))
<a name="l00494"></a>00494       +  s_n_sectors
<a name="l00495"></a>00495       )
<a name="l00496"></a>00496    &lt;  <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>
<a name="l00497"></a>00497    ) {
<a name="l00498"></a>00498       s_state = <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>;
<a name="l00499"></a>00499       <span class="keywordflow">return</span> <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00500"></a>00500    }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502    <span class="comment">// Update position variables</span>
<a name="l00503"></a>00503    s_n_sectors       -= s_nb_sectors_step;
<a name="l00504"></a>00504    s_curr_log_sector += s_nb_sectors_step;
<a name="l00505"></a>00505    s_curr_n_byte = 0;
<a name="l00506"></a>00506    <span class="keywordflow">if</span> (s_n_sectors &lt; <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>)
<a name="l00507"></a>00507      s_nb_sectors_step = (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>) (s_n_sectors);   <span class="comment">// next page must be read as partial (not all sectors remaining)</span>
<a name="l00508"></a>00508    <span class="keywordflow">else</span>
<a name="l00509"></a>00509      s_nb_sectors_step = <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>;     <span class="comment">// next page to be read considered as entire (all sectors requested)</span>
<a name="l00510"></a>00510 
<a name="l00511"></a>00511    <span class="comment">// Save current parameters</span>
<a name="l00512"></a>00512    g_save_curr_dev_id    = g_curr_dev_id;
<a name="l00513"></a>00513    g_save_phys_page_addr = g_phys_page_addr[g_curr_dev_id];
<a name="l00514"></a>00514 
<a name="l00515"></a>00515    <span class="comment">// Fetch the next device id</span>
<a name="l00516"></a>00516    <span class="comment">//</span>
<a name="l00517"></a>00517    g_phys_page_addr[g_curr_dev_id]+=1;
<a name="l00518"></a>00518    g_curr_dev_id ++;
<a name="l00519"></a>00519    <span class="keywordflow">if</span>( g_curr_dev_id==<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ) { g_curr_dev_id=0; }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521    g_next_phys_page_addr = g_phys_page_addr[g_curr_dev_id];
<a name="l00522"></a>00522 
<a name="l00523"></a>00523    <span class="keywordflow">if</span>( s_n_sectors==0 )    <span class="comment">// Operation complete !</span>
<a name="l00524"></a>00524    {
<a name="l00525"></a>00525      s_state = <a class="code" href="a00062.html#1f8118c7ac27ec7c0f5bb6642c17db2c79ae1582c50ffdc26c332345ede75d7c">STATE_COMPLETE</a>;
<a name="l00526"></a>00526      <span class="keywordflow">return</span> <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00527"></a>00527    }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529    <span class="keywordflow">return</span> <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 
<a name="l00540"></a><a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8">00540</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8" title="This function transfers a page content (NF) to the USB macro The number of sectors...">nf_read_sector_to_usb</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_sectors)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542  <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> j;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544    <span class="keywordflow">for</span> (j = 8*nb_sectors; j != 0; j--)                      <span class="comment">// 8 * 64 bytes = 512 bytes</span>
<a name="l00545"></a>00545    {
<a name="l00546"></a>00546       Disable_interrupt();
<a name="l00547"></a>00547 
<a name="l00548"></a>00548       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());                         <span class="comment">// read 64 bytes from card</span>
<a name="l00549"></a>00549       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00550"></a>00550       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00551"></a>00551       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00552"></a>00552       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00553"></a>00553       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00554"></a>00554       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00555"></a>00555       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00556"></a>00556       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00557"></a>00557       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00558"></a>00558       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00559"></a>00559       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00560"></a>00560       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00561"></a>00561       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00562"></a>00562       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00563"></a>00563       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00564"></a>00564       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00565"></a>00565       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00566"></a>00566       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00567"></a>00567       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00568"></a>00568       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00569"></a>00569       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00570"></a>00570       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00571"></a>00571       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00572"></a>00572       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00573"></a>00573       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00574"></a>00574       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00575"></a>00575       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00576"></a>00576       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00577"></a>00577       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00578"></a>00578       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00579"></a>00579       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00580"></a>00580       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00581"></a>00581       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00582"></a>00582       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00583"></a>00583       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00584"></a>00584       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00585"></a>00585       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00586"></a>00586       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00587"></a>00587       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00588"></a>00588       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00589"></a>00589       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00590"></a>00590       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00591"></a>00591       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00592"></a>00592       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00593"></a>00593       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00594"></a>00594       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00595"></a>00595       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00596"></a>00596       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00597"></a>00597       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00598"></a>00598       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00599"></a>00599       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00600"></a>00600       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00601"></a>00601       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00602"></a>00602       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00603"></a>00603       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00604"></a>00604       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00605"></a>00605       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00606"></a>00606       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00607"></a>00607       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00608"></a>00608       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00609"></a>00609       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00610"></a>00610       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00611"></a>00611       <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>());
<a name="l00612"></a>00612       Enable_interrupt();
<a name="l00613"></a>00613 
<a name="l00614"></a>00614       <a class="code" href="a00118.html#g5369d57fde2684237cc527f6b555ebf5" title="sends IN">Usb_send_in</a>();                            <span class="comment">// validate transfer</span>
<a name="l00615"></a>00615       <span class="keywordflow">while</span>(<a class="code" href="a00118.html#g1b470916df610d8750a5a5916976e687" title="tests if endpoint write allowed">Is_usb_write_enabled</a>()==<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l00616"></a>00616       {
<a name="l00617"></a>00617          <span class="keywordflow">if</span>(!<a class="code" href="a00118.html#g0f52bbafba70190a44a789befbc82a46" title="tests if the current endpoint is enabled">Is_usb_endpoint_enabled</a>())
<a name="l00618"></a>00618             <span class="keywordflow">return</span>; <span class="comment">// USB Reset</span>
<a name="l00619"></a>00619       }
<a name="l00620"></a>00620    }
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 
<a name="l00624"></a>00624 
<a name="l00632"></a><a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015">00632</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015" title="This function transfers USB data to the NF page The number of sectors to be read...">nf_write_sector_from_usb</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_sectors)
<a name="l00633"></a>00633 {
<a name="l00634"></a>00634    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> j;
<a name="l00635"></a>00635    <span class="keywordflow">for</span> (j = 8*nb_sectors ; j != 0 ; j--)        <span class="comment">// 8 * 64 bytes = 512 bytes</span>
<a name="l00636"></a>00636    {
<a name="l00637"></a>00637       <span class="keywordflow">while</span>(!<a class="code" href="a00118.html#g8e3f7189783aa06dacc91d232ab94afb" title="tests if endpoint read allowed">Is_usb_read_enabled</a>())
<a name="l00638"></a>00638       {
<a name="l00639"></a>00639          <span class="keywordflow">if</span>(!<a class="code" href="a00118.html#g0f52bbafba70190a44a789befbc82a46" title="tests if the current endpoint is enabled">Is_usb_endpoint_enabled</a>())
<a name="l00640"></a>00640            <span class="keywordflow">return</span>; <span class="comment">// USB Reset</span>
<a name="l00641"></a>00641       }
<a name="l00642"></a>00642       Disable_interrupt();                      <span class="comment">// Global disable.</span>
<a name="l00643"></a>00643 
<a name="l00644"></a>00644       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());              <span class="comment">// write 64 bytes to the card</span>
<a name="l00645"></a>00645       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00646"></a>00646       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00647"></a>00647       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00648"></a>00648       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00649"></a>00649       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00650"></a>00650       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00651"></a>00651       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00652"></a>00652       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00653"></a>00653       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00654"></a>00654       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00655"></a>00655       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00656"></a>00656       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00657"></a>00657       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00658"></a>00658       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00659"></a>00659       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00660"></a>00660       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00661"></a>00661       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00662"></a>00662       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00663"></a>00663       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00664"></a>00664       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00665"></a>00665       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00666"></a>00666       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00667"></a>00667       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00668"></a>00668       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00669"></a>00669       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00670"></a>00670       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00671"></a>00671       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00672"></a>00672       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00673"></a>00673       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00674"></a>00674       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00675"></a>00675       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00676"></a>00676       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00677"></a>00677       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00678"></a>00678       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00679"></a>00679       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00680"></a>00680       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00681"></a>00681       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00682"></a>00682       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00683"></a>00683       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00684"></a>00684       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00685"></a>00685       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00686"></a>00686       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00687"></a>00687       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00688"></a>00688       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00689"></a>00689       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00690"></a>00690       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00691"></a>00691       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00692"></a>00692       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00693"></a>00693       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00694"></a>00694       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00695"></a>00695       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00696"></a>00696       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00697"></a>00697       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00698"></a>00698       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00699"></a>00699       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00700"></a>00700       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00701"></a>00701       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00702"></a>00702       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00703"></a>00703       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00704"></a>00704       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00705"></a>00705       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00706"></a>00706       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00707"></a>00707       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00708"></a>00708 
<a name="l00709"></a>00709       <a class="code" href="a00118.html#g2bcdff32843bb358fa2f99d3d98452cd" title="acks reveive OUT">Usb_ack_receive_out</a>();           <span class="comment">// USB EPOUT read acknowledgement.</span>
<a name="l00710"></a>00710       Enable_interrupt();              <span class="comment">// Global re-enable.</span>
<a name="l00711"></a>00711    }
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 
<a name="l00724"></a><a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463">00724</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> sect_start, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_sect)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726    <span class="comment">// Calculate first spare zone address</span>
<a name="l00727"></a>00727    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i;
<a name="l00728"></a>00728    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr = <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)sect_start)*16;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730   <span class="comment">// Send command + address if 2kb' page model</span>
<a name="l00731"></a>00731    <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l00732"></a>00732    {
<a name="l00733"></a>00733       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l00734"></a>00734       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (byte_addr)%256 );
<a name="l00735"></a>00735       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (byte_addr)/256 );
<a name="l00736"></a>00736    }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738    <span class="comment">// Send data (spare zone x sectors written)</span>
<a name="l00739"></a>00739    <span class="keywordflow">for</span>( i=nb_sect ; i!=0 ; i-- )
<a name="l00740"></a>00740    {
<a name="l00741"></a>00741       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 ); <span class="comment">// 0- [FW] block is valid (for 2048 compatibility)</span>
<a name="l00742"></a>00742       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#2e268e2bf7f16ea1e30a5ff354e06fd7">NFC_BLK_ID_DATA</a>      ); <span class="comment">// 1- [FW] Free-blocks block</span>
<a name="l00743"></a>00743       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0                    ); <span class="comment">// 2- [HW] ECC is valid</span>
<a name="l00744"></a>00744       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#98a49853a649a262cd8c415d568e92f3">NFC_OFST_3_DATA_DST</a>  ); <span class="comment">// 3- [SW] Source block (recovery) (HW capability not used)</span>
<a name="l00745"></a>00745       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#ee5e2777710c4535183e1791a4dfdc64">NFC_SPARE_DATA_VALID</a> ); <span class="comment">// 4- [FW] Data is valid</span>
<a name="l00746"></a>00746       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 ); <span class="comment">// 5- [FW] block is valid (for 512 compatibility)</span>
<a name="l00747"></a>00747       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id)  ); <span class="comment">// 6- [HW] LBA</span>
<a name="l00748"></a>00748       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id)  ); <span class="comment">// 7- [HW] LBA</span>
<a name="l00749"></a>00749       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 ); <span class="comment">// 8-9-10- [HW] ECC2</span>
<a name="l00750"></a>00750       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 );
<a name="l00751"></a>00751       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 );
<a name="l00752"></a>00752       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 ); <span class="comment">// 11-12-    [HW] LBA</span>
<a name="l00753"></a>00753       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 );
<a name="l00754"></a>00754       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 );
<a name="l00755"></a>00755       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 );
<a name="l00756"></a>00756       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF                 ); <span class="comment">// 13-14-15- [HW] ECC1</span>
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 
<a name="l00770"></a><a class="code" href="a00063.html#4278d426a2907921c797422de0a14247">00770</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> <a class="code" href="a00062.html#d45465832eded4b9de5dfa9b095482bd" title="This function must be called when a write10 operation (from USB) is finished Last...">nf_dfc_write_stop</a>( <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_nb_sector_remaining ) <span class="comment">// function that stops the dfc interface of the memory</span>
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>); <span class="comment">// Program the page</span>
<a name="l00773"></a>00773    <span class="comment">// Note that if the page is not completely filled in yet but still programmed, the next copy tail will allow partial page program</span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775    <span class="comment">// retreive exact logical/physical position (in case that transfer</span>
<a name="l00776"></a>00776    <span class="comment">// did not perform the exact number of sectors)</span>
<a name="l00777"></a>00777    s_curr_log_sector = s_save_log_addr - u16_nb_sector_remaining;
<a name="l00778"></a>00778    <span class="keywordflow">if</span>( 0!=u16_nb_sector_remaining )
<a name="l00779"></a>00779    {
<a name="l00780"></a>00780       <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a> );
<a name="l00781"></a>00781    }
<a name="l00782"></a>00782    g_last_log_sector  = s_curr_log_sector; <span class="comment">// Memorize next logical sector to be managed</span>
<a name="l00783"></a>00783 
<a name="l00784"></a>00784    <span class="comment">// Test if transfer stop at end of logical blocks.</span>
<a name="l00785"></a>00785    <span class="keywordflow">if</span>( s_n_sectors==0 )
<a name="l00786"></a>00786    {
<a name="l00787"></a>00787       <span class="keywordflow">if</span>(!(<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_next_phys_page_addr) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>-1))  <span class="comment">// new block</span>
<a name="l00788"></a>00788       &amp;&amp; (g_curr_dev_id==0                                  )) <span class="comment">// on device 0.</span>
<a name="l00789"></a>00789      {
<a name="l00790"></a>00790          <span class="comment">// Delete old blocks</span>
<a name="l00791"></a>00791          <span class="comment">//</span>
<a name="l00792"></a>00792          <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>();
<a name="l00793"></a>00793       }
<a name="l00794"></a>00794    }
<a name="l00795"></a>00795    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_dfc_write_stop;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(g_last_log_sector); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    <span class="comment">// Ensure that all internal programming are complete, since we are</span>
<a name="l00798"></a>00798    <span class="comment">// using cache programming (WP may be asserted for icons or fonts</span>
<a name="l00799"></a>00799    <span class="comment">// loading). Moreover, on some NFs (ST, Samsung)</span>
<a name="l00800"></a>00800    <span class="comment">// it is necessary to reset the devices after copy-back commands</span>
<a name="l00801"></a>00801    <span class="comment">// If not, strange behaviour may happen: no busy when opening</span>
<a name="l00802"></a>00802    <span class="comment">// a page for reading...</span>
<a name="l00803"></a>00803    <a class="code" href="a00060.html#ec96d29ad256f2dfc2ebfceddf08d6a9" title="Reset all the NF devices.">nfc_reset_nands</a>( <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ); <span class="comment">// Reset all the NF devices</span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805    <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l00806"></a>00806    <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l00807"></a>00807 
<a name="l00808"></a>00808    <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>;
<a name="l00809"></a>00809 } <span class="comment">// end of nf_dfc_write_stop</span>
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 
<a name="l00819"></a><a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563">00819</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>( <span class="keywordtype">void</span> )
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  i;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823    <span class="comment">// Delete old blocks</span>
<a name="l00824"></a>00824    <span class="comment">//</span>
<a name="l00825"></a>00825    <span class="keywordflow">for</span> ( i=0 ; i&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; i++ )
<a name="l00826"></a>00826    {
<a name="l00827"></a>00827       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i);
<a name="l00828"></a>00828       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_erase_old_blocks;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_block_to_kill[i]);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00829"></a>00829       <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(g_block_to_kill[i]), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00830"></a>00830    }
<a name="l00831"></a>00831 }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 
<a name="l00845"></a>00845 <span class="comment">//#error finaliser l'activation du CE[dev]</span>
<a name="l00846"></a>00846 <span class="comment">//#error attention a l'horloge CLK read et CLK write</span>
<a name="l00847"></a><a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a">00847</a> <span class="keyword">static</span> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>( bit check_pending_write )
<a name="l00848"></a>00848 {
<a name="l00849"></a>00849    <span class="keywordflow">if</span>(( check_pending_write   )
<a name="l00850"></a>00850    &amp;&amp; ( 0xFFFFFFFF!=g_last_log_sector ))
<a name="l00851"></a>00851    {
<a name="l00852"></a>00852       <a class="code" href="a00062.html#a38cbc2641b27ca8fe33b40dbfdd7486">nf_copy_tail</a>();
<a name="l00853"></a>00853    }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855    <span class="comment">// Both LUT and FBB caches are flushed. Why?</span>
<a name="l00856"></a>00856    <span class="comment">// - Avoid LUT/FBB caches flush and refill during audio playback</span>
<a name="l00857"></a>00857    <span class="comment">// - Avoid recovery on power-on</span>
<a name="l00858"></a>00858    <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f15ffd3a77015345013d1c3e932346ad1a">NF_TRANS_FLUSH</a> );
<a name="l00859"></a>00859 
<a name="l00860"></a>00860    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 
<a name="l00880"></a><a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f">00880</a> <span class="keyword">static</span> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( bit check_pending_write )
<a name="l00881"></a>00881 {
<a name="l00882"></a>00882    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp;
<a name="l00883"></a>00883    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_curr_page;
<a name="l00884"></a>00884    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_last_page;
<a name="l00885"></a>00885    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887    <span class="keywordflow">if</span>(( check_pending_write   )
<a name="l00888"></a>00888    &amp;&amp; ( 0xFFFFFFFF!=g_last_log_sector ))
<a name="l00889"></a>00889    {
<a name="l00890"></a>00890       <a class="code" href="a00062.html#a38cbc2641b27ca8fe33b40dbfdd7486">nf_copy_tail</a>();
<a name="l00891"></a>00891    }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893    <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1e38cd8e23792344b6c802f0d80d97ef8">NF_TRANS_SWAP</a> );
<a name="l00894"></a>00894 
<a name="l00895"></a>00895    <span class="comment">// both FBB and LUT blocks are invalid</span>
<a name="l00896"></a>00896    <span class="comment">// Mark FBB only. Warning: Partial Prog</span>
<a name="l00897"></a>00897    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l00898"></a>00898    <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>(
<a name="l00899"></a>00899       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_fbb_block_addr )  <span class="comment">// base address</span>
<a name="l00900"></a>00900    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_fbb_block_index               <span class="comment">// offset to Free-blocks block entry</span>
<a name="l00901"></a>00901    ,  <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a> );
<a name="l00902"></a>00902    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#368c0bb974ad49ad58ab016d8a7f93bb">NFC_OFST_6_FBB_INVALID</a> );                         <span class="comment">// 6- FBB-LUTs are invalid</span>
<a name="l00903"></a>00903    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a> );                            <span class="comment">// Warning: Partial Programming</span>
<a name="l00904"></a>00904 
<a name="l00905"></a>00905    <span class="comment">// Mark sources blocks (recovery). Warning: Partial Prog</span>
<a name="l00906"></a>00906    <span class="keywordflow">for</span>( u8_tmp=0 ; u8_tmp&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l00907"></a>00907    {
<a name="l00908"></a>00908       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, u8_tmp);
<a name="l00909"></a>00909       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>(
<a name="l00910"></a>00910          <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_block_to_kill[u8_tmp] )
<a name="l00911"></a>00911       ,  <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a> );
<a name="l00912"></a>00912       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#7c529432302c1504305d86773d1ae0a7">NFC_OFST_3_DATA_SRC</a> );                         <span class="comment">// 3- [SW] Mark as source block (recovery) (HW capability not used)</span>
<a name="l00913"></a>00913       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a> );                         <span class="comment">// Warning: Partial Programming</span>
<a name="l00914"></a>00914    }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916    <span class="comment">// Copy the head of the buffer</span>
<a name="l00917"></a>00917    <span class="comment">//</span>
<a name="l00918"></a>00918    <span class="comment">// for each logical page (current included)</span>
<a name="l00919"></a>00919    u8_last_page= (s_curr_log_sector &gt;&gt;<a class="code" href="a00063.html#b66eee9a9e0d27e395572c4977e2718a">S_SHIFT_LOG_PAGE_SECTOR</a>) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1);
<a name="l00920"></a>00920    <span class="keywordflow">for</span>(  u8_curr_page=0
<a name="l00921"></a>00921    ;     u8_curr_page &lt;= u8_last_page
<a name="l00922"></a>00922    ;     u8_curr_page++ )
<a name="l00923"></a>00923    {
<a name="l00924"></a>00924       <span class="comment">// If the last page (current)</span>
<a name="l00925"></a>00925       <span class="keywordflow">if</span> ( u8_last_page==u8_curr_page ) { u8_tmp = g_curr_dev_id; } <span class="comment">// then copy this physical page only for the device before the current device</span>
<a name="l00926"></a>00926       <span class="keywordflow">else</span>                              { u8_tmp = NF_N_DEVICES;  } <span class="comment">// else copy this physical page for all device</span>
<a name="l00927"></a>00927 
<a name="l00928"></a>00928       <span class="keywordflow">while</span>( u8_tmp!=0 ) <span class="comment">// for each device</span>
<a name="l00929"></a>00929       {
<a name="l00930"></a>00930          u8_tmp--;
<a name="l00931"></a>00931          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, u8_tmp);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933          g_copy_src= <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_block_to_kill[u8_tmp] ) + u8_curr_page;
<a name="l00934"></a>00934          <a class="code" href="a00062.html#79e27718d9bc988607f630c2ff410848" title="Copy a NF page to a new one.">nf_copy</a>(g_phys_page_addr[u8_tmp]);
<a name="l00935"></a>00935          g_phys_page_addr[u8_tmp]++;
<a name="l00936"></a>00936       }
<a name="l00937"></a>00937       <span class="comment">// end of loop, for each device</span>
<a name="l00938"></a>00938    }
<a name="l00939"></a>00939    <span class="comment">// end of loop, for each logical page</span>
<a name="l00940"></a>00940 
<a name="l00941"></a>00941    u16_tmp=
<a name="l00942"></a>00942       (<a class="code" href="a00061.html#eb269843d27f183677d85ee457233918">SIZE_SECTOR_BYTE</a>)                          <span class="comment">// size (unit byte) of the sector (spare zone excluded)</span>
<a name="l00943"></a>00943    *  (  s_curr_log_sector                        <span class="comment">// current sector in physical page</span>
<a name="l00944"></a>00944       &amp;  (<a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a> -1)
<a name="l00945"></a>00945       );
<a name="l00946"></a>00946 
<a name="l00947"></a>00947    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);
<a name="l00948"></a>00948    <span class="keywordflow">if</span>( u16_tmp )
<a name="l00949"></a>00949    {
<a name="l00950"></a>00950       <span class="comment">//** copy the head of the current physical page</span>
<a name="l00951"></a>00951       <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_block_to_kill[g_curr_dev_id] ) + u8_last_page, 0 );
<a name="l00952"></a>00952       <span class="comment">// copy the head page of the old block in buffer</span>
<a name="l00953"></a>00953       <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(g_page_buffer, (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(u16_tmp/16));
<a name="l00954"></a>00954    }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956    <span class="comment">// copy the buffer in the head page of the new block</span>
<a name="l00957"></a>00957    <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( g_phys_page_addr[g_curr_dev_id], 0 );
<a name="l00958"></a>00958 
<a name="l00959"></a>00959    <span class="comment">// write the first byte to the current byte position in the physical page</span>
<a name="l00960"></a>00960    <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(g_page_buffer, (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(u16_tmp/16));
<a name="l00961"></a>00961    <span class="comment">// END of the copy head</span>
<a name="l00962"></a>00962 
<a name="l00963"></a>00963    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00964"></a>00964 } <span class="comment">// nf_open_write</span>
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 
<a name="l00980"></a><a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac">00980</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac" title="Reload the LUT cache memory, starting from the specified logical block number given...">nf_cache_lut_refill</a>(<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> log_block_id)
<a name="l00981"></a>00981 {
<a name="l00982"></a>00982    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp;
<a name="l00983"></a>00983    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  sub_lut_id;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr;
<a name="l00986"></a>00986    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr;
<a name="l00987"></a>00987    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> sub_lut_log_sz;    <span class="comment">// size of the sub-LUT. Unit in logical blocks.</span>
<a name="l00988"></a>00988    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> sub_lut_log_first; <span class="comment">// number of the first logical block of the sub-lut.</span>
<a name="l00989"></a>00989 
<a name="l00990"></a>00990    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.ctrl.dirty==<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> ); <span class="comment">// No refill if the cache is dirty</span>
<a name="l00991"></a>00991 
<a name="l00992"></a>00992    sub_lut_id        = log_block_id&gt;&gt;(    <a class="code" href="a00063.html#fec3c6701415feaba7c4549f19f43946">NF_SHIFT_SUBLUT_PHYS</a> - NF_SHIFT_N_DEVICES);
<a name="l00993"></a>00993    sub_lut_log_sz    = ( sub_lut_id==(g_n_sub_lut-1) ? g_last_sub_lut_log_sz : g_sub_lut_log_sz );
<a name="l00994"></a>00994    sub_lut_log_first = (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)sub_lut_id&lt;&lt;( <a class="code" href="a00063.html#fec3c6701415feaba7c4549f19f43946">NF_SHIFT_SUBLUT_PHYS</a> - NF_SHIFT_N_DEVICES);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_lut_refill;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_lut_block_addr[sub_lut_id]);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00997"></a>00997 
<a name="l00998"></a>00998    <span class="keywordflow">if</span> (sub_lut_log_sz&lt;<a class="code" href="a00035.html#0b121d0e013389737ee8c1739c19735a">NF_CACHE_LUT_LOG_SZ</a>)
<a name="l00999"></a>00999    {  <span class="comment">// The cache is bigger than the sub LUT</span>
<a name="l01000"></a>01000       g_cache_lut.first = log_block_id;                               <span class="comment">// First included</span>
<a name="l01001"></a>01001       g_cache_lut.last  = log_block_id + (sub_lut_log_sz-1);          <span class="comment">// Last included</span>
<a name="l01002"></a>01002    }
<a name="l01003"></a>01003    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (log_block_id+<a class="code" href="a00035.html#0b121d0e013389737ee8c1739c19735a">NF_CACHE_LUT_LOG_SZ</a>) &lt;= (sub_lut_log_first+sub_lut_log_sz) )
<a name="l01004"></a>01004    {  <span class="comment">// The cache is done starting from the logical block number</span>
<a name="l01005"></a>01005       g_cache_lut.first = log_block_id;                               <span class="comment">// First included</span>
<a name="l01006"></a>01006       g_cache_lut.last  = log_block_id + (<a class="code" href="a00035.html#0b121d0e013389737ee8c1739c19735a">NF_CACHE_LUT_LOG_SZ</a>-1);     <span class="comment">// Last included</span>
<a name="l01007"></a>01007    }
<a name="l01008"></a>01008    <span class="keywordflow">else</span>
<a name="l01009"></a>01009    {  <span class="comment">// The cache is done starting from the last logical block of the sub-LUT</span>
<a name="l01010"></a>01010       g_cache_lut.last  = sub_lut_log_first +sub_lut_log_sz -1;       <span class="comment">// Last included</span>
<a name="l01011"></a>01011       g_cache_lut.first = g_cache_lut.last - (<a class="code" href="a00035.html#0b121d0e013389737ee8c1739c19735a">NF_CACHE_LUT_LOG_SZ</a>-1); <span class="comment">// First included</span>
<a name="l01012"></a>01012    }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01015"></a>01015 
<a name="l01016"></a>01016    page_addr =
<a name="l01017"></a>01017       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_lut_block_addr[sub_lut_id]) <span class="comment">// base address</span>
<a name="l01018"></a>01018    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)(g_lut_block_index[sub_lut_id])           <span class="comment">// offset to sub-LUT</span>
<a name="l01019"></a>01019    ;
<a name="l01020"></a>01020    byte_addr = ( (g_cache_lut.first-sub_lut_log_first)*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*2 ); <span class="comment">// logical position of the block</span>
<a name="l01021"></a>01021    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;<a class="code" href="a00061.html#d68699283962590b223fb226e78739c5">SIZE_PAGE_BYTE</a> );
<a name="l01022"></a>01022 
<a name="l01023"></a>01023    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, byte_addr);
<a name="l01024"></a>01024    <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(page_addr); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(byte_addr);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01025"></a>01025    <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;(g_cache_lut.last+1-g_cache_lut.first)*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01026"></a>01026    { <span class="comment">// fill the cache buffer</span>
<a name="l01027"></a>01027       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_tmp&lt;<a class="code" href="a00063.html#2df50aa01ce5b4700edbd9d48534d662">CACHE_LUT_SIZE</a>);
<a name="l01028"></a>01028       <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_cache_lut.mem[u8_tmp]) = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01029"></a>01029       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_cache_lut.mem[u8_tmp]) = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01030"></a>01030       <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_cache_lut.mem[u8_tmp]);
<a name="l01031"></a>01031       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"-"</span>);
<a name="l01032"></a>01032       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.mem[u8_tmp]&gt;=g_nf_first_block );
<a name="l01033"></a>01033       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.mem[u8_tmp]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01034"></a>01034    }
<a name="l01035"></a>01035    <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01036"></a>01036    g_cache_lut.ctrl.valid = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01037"></a>01037 } <span class="comment">// end of nf_cache_lut_refill</span>
<a name="l01038"></a>01038 
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 
<a name="l01049"></a><a class="code" href="a00063.html#524dde7169bece3f9ce79e1c56d7412b">01049</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>(<span class="keywordtype">void</span>)
<a name="l01050"></a>01050 {
<a name="l01051"></a>01051    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp;
<a name="l01052"></a>01052    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr;
<a name="l01053"></a>01053    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(g_cache_fbb.ctrl.dirty==<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>); <span class="comment">// No refill if the cache is dirty</span>
<a name="l01056"></a>01056    g_cache_fbb.p   = 0;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_fbb_refill;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_fbb_block_addr);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01059"></a>01059 
<a name="l01060"></a>01060    <span class="comment">// Ensure that the cache is bigger than the real number of free blocks</span>
<a name="l01061"></a>01061    <span class="comment">//</span>
<a name="l01062"></a>01062    g_cache_fbb.max = <a class="code" href="a00032.html#9e04209162ea72f9985338596262b657">Min</a>(<a class="code" href="a00035.html#0ce1ce03181970b15e3d306dd9e827bb">NF_CACHE_FBB_LOG_SZ</a>, (g_n_free_blocks&gt;&gt;NF_SHIFT_N_DEVICES) ); <span class="comment">// Last included</span>
<a name="l01063"></a>01063 
<a name="l01064"></a>01064    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066    page_addr =
<a name="l01067"></a>01067       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_fbb_block_addr  ) <span class="comment">// base address</span>
<a name="l01068"></a>01068    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_fbb_block_index               <span class="comment">// offset to Free-blocks block entry</span>
<a name="l01069"></a>01069    ;
<a name="l01070"></a>01070    byte_addr=0;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(page_addr, 0);
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;g_cache_fbb.max*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01075"></a>01075    { <span class="comment">// fill the cache buffer</span>
<a name="l01076"></a>01076       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_tmp&lt;<a class="code" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a>);
<a name="l01077"></a>01077       <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_cache_fbb.mem[u8_tmp]) = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01078"></a>01078       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_cache_fbb.mem[u8_tmp]) = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01079"></a>01079       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[u8_tmp]&gt;=g_nf_first_block );
<a name="l01080"></a>01080       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[u8_tmp]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01081"></a>01081       byte_addr+=2;
<a name="l01082"></a>01082       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;<a class="code" href="a00061.html#d68699283962590b223fb226e78739c5">SIZE_PAGE_BYTE</a>); <span class="comment">// Should stay in the page. Algo limitation.</span>
<a name="l01083"></a>01083    }
<a name="l01084"></a>01084    g_cache_fbb.ctrl.valid = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01085"></a>01085 } <span class="comment">// end of nf_cache_fbb_refill</span>
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 
<a name="l01099"></a><a class="code" href="a00062.html#c029fba5c62db088a077b69802d61f91">01099</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00062.html#c029fba5c62db088a077b69802d61f91" title="Flushes the LUT cache into a new LUT entry.">nf_cache_lut_flush</a>( <span class="keywordtype">void</span>  )
<a name="l01100"></a>01100 {
<a name="l01101"></a>01101    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  page_addr;
<a name="l01102"></a>01102    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  byte_addr;
<a name="l01103"></a>01103    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  sub_lut_log_sz;
<a name="l01104"></a>01104    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   sub_lut_id;
<a name="l01105"></a>01105    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   u8_tmp;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_lut.ctrl.valid);
<a name="l01108"></a>01108    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_lut.ctrl.dirty);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110    sub_lut_id     = g_cache_lut.first&gt;&gt;(<a class="code" href="a00063.html#fec3c6701415feaba7c4549f19f43946">NF_SHIFT_SUBLUT_PHYS</a>-NF_SHIFT_N_DEVICES);
<a name="l01111"></a>01111    sub_lut_log_sz = ( sub_lut_id==(g_n_sub_lut-1) ) ? g_last_sub_lut_log_sz : g_sub_lut_log_sz ;
<a name="l01112"></a>01112 
<a name="l01113"></a>01113    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_lut_flush;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_lut_block_addr[sub_lut_id]);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01114"></a>01114 
<a name="l01115"></a>01115    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01116"></a>01116 
<a name="l01117"></a>01117    page_addr=
<a name="l01118"></a>01118       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_lut_block_addr[sub_lut_id] )  <span class="comment">// base address</span>
<a name="l01119"></a>01119    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)(g_lut_block_index[sub_lut_id])             <span class="comment">// offset to sub-LUT</span>
<a name="l01120"></a>01120    ;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, 0);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124    <span class="keywordflow">for</span> ( byte_addr=0 <span class="comment">/* used as block address! */</span> ; byte_addr&lt;(sub_lut_log_sz*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>) ; )
<a name="l01125"></a>01125    {  <span class="comment">// Read the LUT stored in Nand</span>
<a name="l01126"></a>01126       g_page_buffer[2*byte_addr   ] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01127"></a>01127       g_page_buffer[2*byte_addr +1] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01128"></a>01128 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01129"></a>01129 <span class="preprocessor"></span>      <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= g_page_buffer[2*byte_addr   ];
<a name="l01130"></a>01130       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= g_page_buffer[2*byte_addr +1];
<a name="l01131"></a>01131       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=g_nf_first_block );
<a name="l01132"></a>01132       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01133"></a>01133 <span class="preprocessor">#endif</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span>      byte_addr ++;
<a name="l01135"></a>01135    }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137    <span class="comment">// Modify the page</span>
<a name="l01138"></a>01138    <span class="comment">//</span>
<a name="l01139"></a>01139    byte_addr = <span class="comment">// logical position of the block</span>
<a name="l01140"></a>01140       (  g_cache_lut.first                               <span class="comment">// Absolute logical block number...</span>
<a name="l01141"></a>01141       &amp;  ( (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>/<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> -1)          <span class="comment">// ...Modulo the number of logical block in a LUT</span>
<a name="l01142"></a>01142       )
<a name="l01143"></a>01143    *  <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*2;
<a name="l01144"></a>01144 
<a name="l01145"></a>01145    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;2048 );
<a name="l01146"></a>01146 
<a name="l01147"></a>01147    <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;(g_cache_lut.last+1-g_cache_lut.first)*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01148"></a>01148    {  <span class="comment">// flush the cache buffer in the buffer</span>
<a name="l01149"></a>01149       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_tmp&lt;<a class="code" href="a00063.html#2df50aa01ce5b4700edbd9d48534d662">CACHE_LUT_SIZE</a> );
<a name="l01150"></a>01150       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>-1) );
<a name="l01151"></a>01151       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.mem[u8_tmp]&gt;=g_nf_first_block );
<a name="l01152"></a>01152       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.mem[u8_tmp]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01153"></a>01153       g_page_buffer[byte_addr++] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_cache_lut.mem[u8_tmp]) ;
<a name="l01154"></a>01154       g_page_buffer[byte_addr++] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_cache_lut.mem[u8_tmp]) ;
<a name="l01155"></a>01155    }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157    <span class="comment">// Program the page</span>
<a name="l01158"></a>01158    <span class="comment">//</span>
<a name="l01159"></a>01159    g_lut_block_index[sub_lut_id]++;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161    <span class="keywordflow">if</span> ( g_lut_block_index[sub_lut_id] ==  (1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) )
<a name="l01162"></a>01162    { <span class="comment">// Need a new block for the flush</span>
<a name="l01163"></a>01163       <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_swap;
<a name="l01164"></a>01164 
<a name="l01165"></a>01165       <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>==g_cache_fbb.ctrl.valid ) { <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>(); }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167 <span class="preprocessor">#define U16_FBB_OFST   ((U16)NF_N_DEVICES*g_cache_fbb.p + S_MNGT_DEV)</span>
<a name="l01168"></a>01168 <span class="preprocessor"></span>      <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[<a class="code" href="a00062.html#38827ae1e62d31a9e6b25aa27bb6230f">U16_FBB_OFST</a>]&gt;=g_nf_first_block );
<a name="l01169"></a>01169       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[<a class="code" href="a00062.html#38827ae1e62d31a9e6b25aa27bb6230f">U16_FBB_OFST</a>]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01170"></a>01170       u16_swap                      = g_lut_block_addr[ sub_lut_id] ;
<a name="l01171"></a>01171       g_lut_block_addr[ sub_lut_id] = g_cache_fbb.mem[<a class="code" href="a00062.html#38827ae1e62d31a9e6b25aa27bb6230f">U16_FBB_OFST</a>] ;
<a name="l01172"></a>01172       g_cache_fbb.mem[<a class="code" href="a00062.html#38827ae1e62d31a9e6b25aa27bb6230f">U16_FBB_OFST</a>] = u16_swap ;
<a name="l01173"></a>01173       g_lut_block_index[sub_lut_id] = 0;
<a name="l01174"></a>01174 <span class="preprocessor">#undef U16_FBB_OFST</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>
<a name="l01176"></a>01176       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_lut_flush;swap;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_lut_block_addr[sub_lut_id]);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01177"></a>01177       g_cache_fbb.ctrl.dirty=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01178"></a>01178 
<a name="l01179"></a>01179       <a class="code" href="a00062.html#4033ef04a3cbd39dc9d6071c6d7c2a9b" title="Writes a LUT in memory from a buffer.">nf_write_lut</a>(0, sub_lut_id, sub_lut_log_sz); <span class="comment">// TODO: we should test the status returned</span>
<a name="l01180"></a>01180 
<a name="l01181"></a>01181       <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( u16_swap ), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l01182"></a>01182 
<a name="l01183"></a>01183       g_cache_fbb.p++;
<a name="l01184"></a>01184       <span class="keywordflow">if</span>( g_cache_fbb.p==(g_cache_fbb.max-1) )
<a name="l01185"></a>01185       { <span class="comment">// Only 1 remaining entry in FBB cache</span>
<a name="l01186"></a>01186          <a class="code" href="a00062.html#4eb467f47ee05e8b863e8da657db4c2f" title="Flushes the FBB cache into a new FBB entry.">nf_cache_fbb_flush</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> ); <span class="comment">// No dirty test, since we know that the cache is dirty</span>
<a name="l01187"></a>01187          <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>();
<a name="l01188"></a>01188       }
<a name="l01189"></a>01189    }
<a name="l01190"></a>01190    <span class="keywordflow">else</span>
<a name="l01191"></a>01191    {
<a name="l01192"></a>01192       <a class="code" href="a00062.html#4033ef04a3cbd39dc9d6071c6d7c2a9b" title="Writes a LUT in memory from a buffer.">nf_write_lut</a>(0, sub_lut_id, sub_lut_log_sz); <span class="comment">// TODO: we should test the status returned</span>
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    g_cache_lut.ctrl.dirty=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197    <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l01198"></a>01198    <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l01199"></a>01199 } <span class="comment">// end of nf_cache_lut_flush</span>
<a name="l01200"></a>01200 
<a name="l01201"></a>01201 
<a name="l01202"></a>01202 
<a name="l01203"></a>01203 
<a name="l01204"></a>01204 
<a name="l01213"></a><a class="code" href="a00063.html#4033ef04a3cbd39dc9d6071c6d7c2a9b">01213</a> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#4033ef04a3cbd39dc9d6071c6d7c2a9b" title="Writes a LUT in memory from a buffer.">nf_write_lut</a>(
<a name="l01214"></a>01214    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  pos
<a name="l01215"></a>01215 ,  <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  i_sub_lut
<a name="l01216"></a>01216 ,  <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> sub_lut_log_sz)
<a name="l01217"></a>01217 {
<a name="l01218"></a>01218    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  block_addr; <span class="comment">// Physical block number</span>
<a name="l01219"></a>01219    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * p_buf=g_page_buffer + (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)pos*((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>));
<a name="l01220"></a>01220 
<a name="l01221"></a>01221    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01222"></a>01222    <span class="comment">// The buffer is built as:</span>
<a name="l01223"></a>01223    <span class="comment">// |    512    |    512    |    512    |    512    |</span>
<a name="l01224"></a>01224    <span class="comment">//</span>
<a name="l01225"></a>01225    <span class="comment">// The page is built as:</span>
<a name="l01226"></a>01226    <span class="comment">// |    512    |    512    |    512    |    512    |SZ|</span>
<a name="l01227"></a>01227    <span class="comment">//</span>
<a name="l01228"></a>01228    <span class="comment">// The LUT fits in a physical page.</span>
<a name="l01229"></a>01229    <span class="comment">//</span>
<a name="l01230"></a>01230    <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>(
<a name="l01231"></a>01231       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_lut_block_addr[i_sub_lut] ) <span class="comment">// base address</span>
<a name="l01232"></a>01232    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)(g_lut_block_index[i_sub_lut])            <span class="comment">// offset to sub-LUT</span>
<a name="l01233"></a>01233    ,  0 );
<a name="l01234"></a>01234 
<a name="l01235"></a>01235    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_write_lut;"</span>);<a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_lut_block_addr[i_sub_lut]); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_lut_block_index[i_sub_lut]);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01236"></a>01236    <span class="keywordflow">for</span>( block_addr=0 ; block_addr&lt;((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-1)) ; block_addr+=1 )
<a name="l01237"></a>01237    {
<a name="l01238"></a>01238       <span class="keywordflow">if</span> ( block_addr&lt;(sub_lut_log_sz*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>) )
<a name="l01239"></a>01239       {
<a name="l01240"></a>01240 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01241"></a>01241 <span class="preprocessor"></span>         <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(           ( block_addr*2)&lt;(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>-1) );
<a name="l01242"></a>01242          <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= p_buf[ block_addr*2   ] ;
<a name="l01243"></a>01243          <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= p_buf[ block_addr*2 +1] ;
<a name="l01244"></a>01244          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=g_nf_first_block );
<a name="l01245"></a>01245          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01246"></a>01246 <span class="preprocessor">#endif</span>
<a name="l01247"></a>01247 <span class="preprocessor"></span>         <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( p_buf[ block_addr*2   ] );
<a name="l01248"></a>01248          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( p_buf[ block_addr*2 +1] );
<a name="l01249"></a>01249          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(p_buf[ block_addr*2   ]);
<a name="l01250"></a>01250          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(p_buf[ block_addr*2 +1]);
<a name="l01251"></a>01251          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"-"</span>);
<a name="l01252"></a>01252       }
<a name="l01253"></a>01253       <span class="keywordflow">else</span>
<a name="l01254"></a>01254       {
<a name="l01255"></a>01255          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01256"></a>01256          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01257"></a>01257          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"FFFF-"</span>);
<a name="l01258"></a>01258       }
<a name="l01259"></a>01259    }
<a name="l01260"></a>01260    <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01261"></a>01261 
<a name="l01262"></a>01262    <span class="comment">// Write the spare information</span>
<a name="l01263"></a>01263    <span class="comment">//</span>
<a name="l01264"></a>01264    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF              );                              <span class="comment">// 0- block is valid (for 2048 compatibility)</span>
<a name="l01265"></a>01265    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a> );                              <span class="comment">// 1- sub-LUT</span>
<a name="l01266"></a>01266    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( i_sub_lut         );                              <span class="comment">// 2- sub-LUT id</span>
<a name="l01267"></a>01267    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF              );                              <span class="comment">// 3- unused</span>
<a name="l01268"></a>01268    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( g_n_sub_lut       );                              <span class="comment">// 4- number of sub-LUT</span>
<a name="l01269"></a>01269    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF              );                              <span class="comment">// 5- block is valid (for 512 compatibility)</span>
<a name="l01270"></a>01270    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(sub_lut_log_sz) );                            <span class="comment">// 6-7 Number of log blocks in sub-LUT</span>
<a name="l01271"></a>01271    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(sub_lut_log_sz) );
<a name="l01272"></a>01272    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 8-9-10-   ECC2</span>
<a name="l01273"></a>01273    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                      <span class="comment">// 11-12-    LBA</span>
<a name="l01274"></a>01274    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 13-14-15- ECC1</span>
<a name="l01275"></a>01275 
<a name="l01276"></a>01276    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a> );
<a name="l01277"></a>01277    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>==<a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>; }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l01280"></a>01280 } <span class="comment">// end of nf_write_lut</span>
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 
<a name="l01295"></a><a class="code" href="a00063.html#5fb0e3f2e7220e43f6185c10231d09c8">01295</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#4eb467f47ee05e8b863e8da657db4c2f" title="Flushes the FBB cache into a new FBB entry.">nf_cache_fbb_flush</a>( <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> b_ecc_err )
<a name="l01296"></a>01296 {
<a name="l01297"></a>01297    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  page_addr;
<a name="l01298"></a>01298    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  byte_addr;
<a name="l01299"></a>01299    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_delete=0;
<a name="l01300"></a>01300    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  u16_tmp;
<a name="l01301"></a>01301    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   u8_tmp;
<a name="l01302"></a>01302    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   u8_pos;
<a name="l01303"></a>01303    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> bool_delete=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_fbb.ctrl.valid);
<a name="l01306"></a>01306    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_fbb.ctrl.dirty);
<a name="l01307"></a>01307    <span class="comment">// Assert(g_cache_fbb.p==(g_cache_fbb.max-1)); This is no more the case for ECC error not correctable</span>
<a name="l01308"></a>01308 
<a name="l01309"></a>01309    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_fbb_flush;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_fbb_block_addr);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01312"></a>01312 
<a name="l01313"></a>01313    page_addr=
<a name="l01314"></a>01314       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_fbb_block_addr  )  <span class="comment">// base address</span>
<a name="l01315"></a>01315    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_fbb_block_index                <span class="comment">// offset to page</span>
<a name="l01316"></a>01316    ;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    g_fbb_block_index++;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320    <span class="keywordflow">if</span> ( g_fbb_block_index ==  (1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>)/(1&lt;&lt;0) )
<a name="l01321"></a>01321    {  <span class="comment">// Need to recycle the FBB block itself, using a free-block ! This is always possible</span>
<a name="l01322"></a>01322       <span class="comment">// since there is always a free block (.p=.max-1) specially for that purpose.</span>
<a name="l01323"></a>01323       byte_addr = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*g_cache_fbb.p + <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01324"></a>01324 
<a name="l01325"></a>01325       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[byte_addr]&gt;=g_nf_first_block );
<a name="l01326"></a>01326       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[byte_addr]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01327"></a>01327       u16_delete                 = g_fbb_block_addr           ;
<a name="l01328"></a>01328       g_fbb_block_addr           = g_cache_fbb.mem[byte_addr] ;
<a name="l01329"></a>01329       g_cache_fbb.mem[byte_addr] = u16_delete;
<a name="l01330"></a>01330       g_fbb_block_index = 0;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_fbb_flush;swap;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_fbb_block_addr);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01333"></a>01333       
<a name="l01334"></a>01334       <span class="comment">// g_cache_fbb.ctrl.dirty=TRUE; This is already the case !</span>
<a name="l01335"></a>01335 
<a name="l01336"></a>01336       g_cache_fbb.p++;
<a name="l01337"></a>01337       bool_delete=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01338"></a>01338    }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340    <span class="keywordflow">if</span>( !b_ecc_err )  { u8_pos = g_cache_fbb.p;   }
<a name="l01341"></a>01341    <span class="keywordflow">else</span>              { u8_pos = g_cache_fbb.max; }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343    byte_addr = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*2*u8_pos);
<a name="l01344"></a>01344 
<a name="l01345"></a>01345    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;<a class="code" href="a00061.html#d68699283962590b223fb226e78739c5">SIZE_PAGE_BYTE</a> );
<a name="l01346"></a>01346 
<a name="l01347"></a>01347    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, byte_addr);
<a name="l01348"></a>01348 
<a name="l01349"></a>01349    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.p&lt;=(g_n_free_blocks/<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>) );
<a name="l01350"></a>01350    <span class="keywordflow">for</span> (
<a name="l01351"></a>01351       u16_tmp=0
<a name="l01352"></a>01352    ;  u16_tmp&lt;((g_n_free_blocks/<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>)-u8_pos)*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*2
<a name="l01353"></a>01353    ; )
<a name="l01354"></a>01354    {  <span class="comment">// Move the free-blocks after &lt;pos&gt; to the beginning of the buffer.</span>
<a name="l01355"></a>01355       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp&lt;(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>-3) );
<a name="l01356"></a>01356       g_page_buffer[u16_tmp++] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01357"></a>01357       g_page_buffer[u16_tmp++] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01358"></a>01358 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span>      <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= g_page_buffer[u16_tmp-2];
<a name="l01360"></a>01360       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= g_page_buffer[u16_tmp-1];
<a name="l01361"></a>01361       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=g_nf_first_block );
<a name="l01362"></a>01362       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01363"></a>01363 <span class="preprocessor">#endif</span>
<a name="l01364"></a>01364 <span class="preprocessor"></span>   }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366    <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;(u8_pos*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>); u8_tmp++ )
<a name="l01367"></a>01367    {  <span class="comment">// Then add the cache content</span>
<a name="l01368"></a>01368       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_tmp &lt; <a class="code" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a> );
<a name="l01369"></a>01369       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp&lt; <a class="code" href="a00063.html#f80c4ce07be5eb80f1fa7e96dd19aa8a">NF_FULL_PAGE_BUFFER_SIZE</a> );
<a name="l01370"></a>01370 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span>      <span class="comment">// When coming from ECC 2-bits error, an entry has been removed</span>
<a name="l01372"></a>01372       <span class="comment">// from the cache, so the last entry is 0xffff</span>
<a name="l01373"></a>01373       <span class="keywordflow">if</span>( !b_ecc_err )
<a name="l01374"></a>01374       {
<a name="l01375"></a>01375          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[u8_tmp]&gt;=g_nf_first_block );
<a name="l01376"></a>01376          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[u8_tmp]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01377"></a>01377       }
<a name="l01378"></a>01378 <span class="preprocessor">#endif</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>      g_page_buffer[u16_tmp++] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_cache_fbb.mem[u8_tmp]);
<a name="l01380"></a>01380       g_page_buffer[u16_tmp++] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_cache_fbb.mem[u8_tmp]);
<a name="l01381"></a>01381    }
<a name="l01382"></a>01382 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span>   <span class="comment">// Ensure that, when there is no fbb recycle, the blocks in the cache at</span>
<a name="l01384"></a>01384    <span class="comment">// position p are identical to the blocks in the beginning of the new line.</span>
<a name="l01385"></a>01385    <span class="keywordflow">if</span>( (<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>==bool_delete) &amp;&amp; ( !b_ecc_err ))
<a name="l01386"></a>01386    {
<a name="l01387"></a>01387       <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01388"></a>01388       {
<a name="l01389"></a>01389          <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= g_page_buffer[u8_tmp*2   ];
<a name="l01390"></a>01390          <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= g_page_buffer[u8_tmp*2 +1];
<a name="l01391"></a>01391          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>==g_cache_fbb.mem[(g_cache_fbb.p)*NF_N_DEVICES + u8_tmp] );
<a name="l01392"></a>01392       }
<a name="l01393"></a>01393    }
<a name="l01394"></a>01394 <span class="preprocessor">#endif</span>
<a name="l01395"></a>01395 <span class="preprocessor"></span>
<a name="l01396"></a>01396    <a class="code" href="a00062.html#020f4fb7d7d55f3fad9c368ac04cabf3" title="Writes the Free-blocks block into the Nand Flash.">nf_write_fbb</a>(); <span class="comment">// Should test the result</span>
<a name="l01397"></a>01397    <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( b_ecc_err );
<a name="l01398"></a>01398    <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l01399"></a>01399 
<a name="l01400"></a>01400    <span class="keywordflow">if</span>( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==bool_delete )
<a name="l01401"></a>01401    {
<a name="l01402"></a>01402       <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( u16_delete ), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l01403"></a>01403    }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp==(g_n_free_blocks*2) ); <span class="comment">// All the list should have been processed</span>
<a name="l01406"></a>01406    g_cache_fbb.ctrl.dirty=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01407"></a>01407 } <span class="comment">// end of nf_cache_fbb_flush</span>
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 
<a name="l01410"></a>01410 
<a name="l01417"></a><a class="code" href="a00063.html#020f4fb7d7d55f3fad9c368ac04cabf3">01417</a> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00062.html#020f4fb7d7d55f3fad9c368ac04cabf3" title="Writes the Free-blocks block into the Nand Flash.">nf_write_fbb</a>( <span class="keywordtype">void</span> )
<a name="l01418"></a>01418 {
<a name="l01419"></a>01419    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01422"></a>01422    <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>(
<a name="l01423"></a>01423       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_fbb_block_addr )  <span class="comment">// base address</span>
<a name="l01424"></a>01424    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_fbb_block_index               <span class="comment">// offset to Free-blocks block entry</span>
<a name="l01425"></a>01425    , 0 );
<a name="l01426"></a>01426    <span class="keywordflow">for</span> ( u16_tmp=0 ; u16_tmp&lt;((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-1)) ; )
<a name="l01427"></a>01427    {
<a name="l01428"></a>01428       <span class="keywordflow">if</span> ( u16_tmp&lt;g_n_free_blocks )
<a name="l01429"></a>01429       {
<a name="l01430"></a>01430          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( g_page_buffer[2*u16_tmp   ] );
<a name="l01431"></a>01431          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( g_page_buffer[2*u16_tmp +1] );
<a name="l01432"></a>01432       }
<a name="l01433"></a>01433       <span class="keywordflow">else</span>
<a name="l01434"></a>01434       {
<a name="l01435"></a>01435          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01436"></a>01436          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01437"></a>01437       }
<a name="l01438"></a>01438       u16_tmp++;
<a name="l01439"></a>01439    }
<a name="l01440"></a>01440    <span class="comment">// Write the spare information</span>
<a name="l01441"></a>01441    <span class="comment">//</span>
<a name="l01442"></a>01442    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                                           <span class="comment">// 0- block is valid (for 2048 compatibility)</span>
<a name="l01443"></a>01443    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a> );                                 <span class="comment">// 1- Free-blocks block</span>
<a name="l01444"></a>01444    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_n_free_blocks));                            <span class="comment">// 2-3 Number of free blocks</span>
<a name="l01445"></a>01445    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_n_free_blocks));
<a name="l01446"></a>01446    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#5df984b9f7ef87bb85401f4fb7978908">NFC_OFST_4_FBB_DRIVER_RELEASE</a> );                  <span class="comment">// 4- Nand-Flash driver ID</span>
<a name="l01447"></a>01447    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                                           <span class="comment">// 5- block is valid (for 512 compatibility)</span>
<a name="l01448"></a>01448    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#6fd751d12dbd6e385f256152224b6635">NFC_OFST_6_FBB_VALID</a> );                           <span class="comment">// 6- FBB-LUTs valid</span>
<a name="l01449"></a>01449    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                                           <span class="comment">// 7- Unused</span>
<a name="l01450"></a>01450    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 8-9-10-   Unused</span>
<a name="l01451"></a>01451    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_n_export_blocks));                          <span class="comment">// 11-12- Number of exported blocks</span>
<a name="l01452"></a>01452    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_n_export_blocks));
<a name="l01453"></a>01453    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 13-14-15- Unused</span>
<a name="l01454"></a>01454 
<a name="l01455"></a>01455    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a> );
<a name="l01456"></a>01456    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>==<a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>; }
<a name="l01457"></a>01457    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l01458"></a>01458 } <span class="comment">// end of nf_write_fbb</span>
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 
<a name="l01461"></a>01461 
<a name="l01462"></a>01462 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01463"></a><a class="code" href="a00062.html#c9c878ced2e50015d7bfdadba72bf2ed">01463</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00062.html#c9c878ced2e50015d7bfdadba72bf2ed">nf_check_fbb</a>( <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> b_ecc_err )
<a name="l01464"></a>01464 {
<a name="l01465"></a>01465    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01468"></a>01468    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_check_fbb\n\r"</span>);
<a name="l01469"></a>01469    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_fbb_block_addr "</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(g_fbb_block_addr);
<a name="l01470"></a>01470    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\rs_fbb_block_index= "</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(g_fbb_block_index); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\r"</span>);
<a name="l01471"></a>01471    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(
<a name="l01472"></a>01472       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_fbb_block_addr )  <span class="comment">// base address</span>
<a name="l01473"></a>01473    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_fbb_block_index               <span class="comment">// offset to Free-blocks block entry</span>
<a name="l01474"></a>01474    , 0 );
<a name="l01475"></a>01475    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"n free blocks: "</span>); <a class="code" href="a00043.html#973a3432cf935c436606df801320b2f3" title="Fonction used to display a 16-bit value in the decimal form on OCD/Serial Debug Interface...">trace_u16</a>(g_n_free_blocks); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01476"></a>01476    <span class="keywordflow">for</span> ( u16_tmp=0 ; u16_tmp&lt;g_n_free_blocks ; )
<a name="l01477"></a>01477    {
<a name="l01478"></a>01478 <span class="preprocessor">#if (_TRACE_==ENABLE)</span>
<a name="l01479"></a>01479 <span class="preprocessor"></span>      <span class="keywordflow">if</span>( u16_tmp&gt;=2048 ) <span class="keywordflow">break</span>;
<a name="l01480"></a>01480       <span class="keywordflow">if</span>( !(u16_tmp% 8) ) {
<a name="l01481"></a>01481          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\r"</span>);
<a name="l01482"></a>01482          <a class="code" href="a00043.html#973a3432cf935c436606df801320b2f3" title="Fonction used to display a 16-bit value in the decimal form on OCD/Serial Debug Interface...">trace_u16</a>(u16_tmp);
<a name="l01483"></a>01483       }
<a name="l01484"></a>01484 <span class="preprocessor">#endif</span>
<a name="l01485"></a>01485 <span class="preprocessor"></span>      <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01486"></a>01486       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01487"></a>01487       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" 0x"</span>); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>) ); <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>) );
<a name="l01488"></a>01488       <span class="comment">// When coming from ECC 2-bits error, an entry has been removed</span>
<a name="l01489"></a>01489       <span class="comment">// from the cache, so the last entry is 0xffff</span>
<a name="l01490"></a>01490       <span class="keywordflow">if</span>( !b_ecc_err )
<a name="l01491"></a>01491       {
<a name="l01492"></a>01492          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=g_nf_first_block );
<a name="l01493"></a>01493          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01494"></a>01494       }
<a name="l01495"></a>01495 <span class="preprocessor">#if 0</span>
<a name="l01496"></a>01496 <span class="preprocessor"></span>      This tests have been commented out: when the cache are dirty, we can not just check the memory
<a name="l01497"></a>01497       with possible <span class="keyword">protected</span> block address (fbb, lut).
<a name="l01498"></a>01498       Ex: FBB is dirty, a recycle have been done between on of the free block and g_lut_block_addr[x].
<a name="l01499"></a>01499       In the FBB memory, the (<span class="keyword">new</span>) lut address is still present, even <span class="keywordflow">if</span> it is not the <span class="keywordflow">case</span> in the cache.
<a name="l01500"></a>01500       <span class="keywordflow">if</span> ( (u16_tmp%<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>)==<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a> )
<a name="l01501"></a>01501       { <span class="comment">// Check dangerous address collision for NF_MNGT only</span>
<a name="l01502"></a>01502          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>!=g_fbb_block_addr );
<a name="l01503"></a>01503          <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;g_n_sub_lut ; u8_tmp++ ) {
<a name="l01504"></a>01504             <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>!=g_lut_block_addr[u8_tmp] );
<a name="l01505"></a>01505          }
<a name="l01506"></a>01506       }
<a name="l01507"></a>01507 <span class="preprocessor">#endif</span>
<a name="l01508"></a>01508 <span class="preprocessor"></span>      u16_tmp++;
<a name="l01509"></a>01509    }
<a name="l01510"></a>01510    <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01511"></a>01511 } <span class="comment">// nf_check_fbb</span>
<a name="l01512"></a>01512 
<a name="l01513"></a>01513 
<a name="l01514"></a><a class="code" href="a00062.html#0aac9e104db7a0ae59bf807994c344cc">01514</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00062.html#0aac9e104db7a0ae59bf807994c344cc">nf_check_lut</a>( <span class="keywordtype">void</span> )
<a name="l01515"></a>01515 {
<a name="l01516"></a>01516    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l01517"></a>01517    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  sub_lut_id;
<a name="l01518"></a>01518    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> sub_lut_log_sz;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01521"></a>01521    <span class="keywordflow">for</span> ( sub_lut_id=0 ; sub_lut_id&lt;g_n_sub_lut ; sub_lut_id++ )
<a name="l01522"></a>01522    {
<a name="l01523"></a>01523       <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(
<a name="l01524"></a>01524          <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_lut_block_addr[sub_lut_id] ) <span class="comment">// base address</span>
<a name="l01525"></a>01525       +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)g_lut_block_index[sub_lut_id]              <span class="comment">// offset to LUT block entry</span>
<a name="l01526"></a>01526       , 0 );
<a name="l01527"></a>01527 
<a name="l01528"></a>01528       sub_lut_log_sz = ( sub_lut_id==(g_n_sub_lut-1) ) ? g_last_sub_lut_log_sz : g_sub_lut_log_sz ;
<a name="l01529"></a>01529       <span class="keywordflow">for</span> ( u16_tmp=0 ; u16_tmp&lt;(sub_lut_log_sz*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>) ; )
<a name="l01530"></a>01530       {
<a name="l01531"></a>01531          <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01532"></a>01532          <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01533"></a>01533          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=g_nf_first_block );
<a name="l01534"></a>01534          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01535"></a>01535 <span class="preprocessor">#if 0</span>
<a name="l01536"></a>01536 <span class="preprocessor"></span>         <span class="keywordflow">if</span> ( (u16_tmp%<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>)==<a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a> )
<a name="l01537"></a>01537          { <span class="comment">// Check dangerous address collision for NF_MNGT only</span>
<a name="l01538"></a>01538             <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>!=g_fbb_block_addr );
<a name="l01539"></a>01539             <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;g_n_sub_lut ; u8_tmp++ ) {
<a name="l01540"></a>01540                <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>!=g_lut_block_addr[u8_tmp] );
<a name="l01541"></a>01541             }
<a name="l01542"></a>01542          }
<a name="l01543"></a>01543 <span class="preprocessor">#endif</span>
<a name="l01544"></a>01544 <span class="preprocessor"></span>         u16_tmp++;
<a name="l01545"></a>01545       }
<a name="l01546"></a>01546    }
<a name="l01547"></a>01547 }
<a name="l01548"></a>01548 <span class="preprocessor">#endif</span>
<a name="l01549"></a>01549 <span class="preprocessor"></span>
<a name="l01550"></a>01550 
<a name="l01551"></a>01551 
<a name="l01552"></a>01552 <span class="comment">// Here are the variable supposed to be initialized:</span>
<a name="l01553"></a>01553 <span class="comment">//    g_curr_dev_id</span>
<a name="l01554"></a>01554 <span class="comment">//    s_curr_log_sector</span>
<a name="l01555"></a>01555 <span class="comment">//    g_block_to_kill[] block addr</span>
<a name="l01556"></a>01556 <span class="comment">//    g_phys_page_addr[] page addr</span>
<a name="l01557"></a>01557 <span class="comment">//</span>
<a name="l01558"></a><a class="code" href="a00063.html#a38cbc2641b27ca8fe33b40dbfdd7486">01558</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#a38cbc2641b27ca8fe33b40dbfdd7486">nf_copy_tail</a>(<span class="keywordtype">void</span>)
<a name="l01559"></a>01559 {
<a name="l01560"></a>01560    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp;
<a name="l01561"></a>01561                    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp2;
<a name="l01562"></a>01562    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l01563"></a>01563    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565    <span class="comment">// Test if we do not reach the end of the logical block</span>
<a name="l01566"></a>01566    <span class="comment">//</span>
<a name="l01567"></a>01567    <span class="keywordflow">if</span>( 0!=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_last_log_sector &amp; ( ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>)) -1)) )
<a name="l01568"></a>01568    {
<a name="l01569"></a>01569       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_copy_tail;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(g_last_log_sector); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01570"></a>01570       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#1807031055d9d07f3229cb8d826d3ffc">Is_not_nf_512</a>() )
<a name="l01571"></a>01571       {  <span class="comment">// Following is not possible on 512B Nand</span>
<a name="l01572"></a>01572 
<a name="l01573"></a>01573          u8_tmp = <span class="comment">// current offset sector in the current page</span>
<a name="l01574"></a>01574             <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_last_log_sector)
<a name="l01575"></a>01575          &amp;  ( <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>-1 )
<a name="l01576"></a>01576          ;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578          u8_tmp2 = <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a> -u8_tmp;
<a name="l01579"></a>01579          <span class="keywordflow">if</span>( 0!=u8_tmp )
<a name="l01580"></a>01580          {  <span class="comment">// Copy the rest of the current line</span>
<a name="l01581"></a>01581 
<a name="l01582"></a>01582             byte_addr=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp) * (<a class="code" href="a00061.html#eb269843d27f183677d85ee457233918">SIZE_SECTOR_BYTE</a>);
<a name="l01583"></a>01583             <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);  <span class="comment">// open the current device</span>
<a name="l01584"></a>01584             <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(                                                       <span class="comment">// Open the old block at :</span>
<a name="l01585"></a>01585                   <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_block_to_kill[g_curr_dev_id] )                   <span class="comment">// adresse of the beginning of the old block</span>
<a name="l01586"></a>01586                +  (<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_phys_page_addr[g_curr_dev_id])&amp;(<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1))        <span class="comment">// current offset page in the old and new block</span>
<a name="l01587"></a>01587             ,  byte_addr );                                                           <span class="comment">// current offset sector in the current page</span>
<a name="l01588"></a>01588             <span class="comment">// for each sector in the physical page</span>
<a name="l01589"></a>01589             u16_tmp = u8_tmp2 * <a class="code" href="a00061.html#eb269843d27f183677d85ee457233918">SIZE_SECTOR_BYTE</a>;
<a name="l01590"></a>01590             g_last_log_sector += u8_tmp2;                                             <span class="comment">// update the current logical sector</span>
<a name="l01591"></a>01591 
<a name="l01592"></a>01592             <span class="comment">// read the sector of the old page</span>
<a name="l01593"></a>01593             <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(g_page_buffer+byte_addr, u16_tmp/16 );
<a name="l01594"></a>01594 
<a name="l01595"></a>01595             <span class="comment">// Read the associated spare zone</span>
<a name="l01596"></a>01596             byte_addr= <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp)*16);
<a name="l01597"></a>01597             <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(                                                       <span class="comment">// Open the old block at :</span>
<a name="l01598"></a>01598                   <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_block_to_kill[g_curr_dev_id] )                   <span class="comment">// adresse of the beginning of the old block</span>
<a name="l01599"></a>01599                +  (<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_phys_page_addr[g_curr_dev_id])&amp;(<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1))        <span class="comment">// current offset page in the old and new block</span>
<a name="l01600"></a>01600             ,  byte_addr );                                                           <span class="comment">// current offset sector in the current page</span>
<a name="l01601"></a>01601             <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(g_page_buffer+byte_addr, u8_tmp2 );
<a name="l01602"></a>01602 
<a name="l01603"></a>01603             byte_addr=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp) * (SIZE_SECTOR_BYTE);
<a name="l01604"></a>01604             <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( <span class="comment">// Open the new block at the current position</span>
<a name="l01605"></a>01605                g_phys_page_addr[g_curr_dev_id]
<a name="l01606"></a>01606             ,  byte_addr );
<a name="l01607"></a>01607 
<a name="l01608"></a>01608             <span class="comment">// write the sector in the new page</span>
<a name="l01609"></a>01609             <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(g_page_buffer+byte_addr, (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(u16_tmp/16) );
<a name="l01610"></a>01610 
<a name="l01611"></a>01611             <span class="comment">// write the associated spare zone</span>
<a name="l01612"></a>01612             byte_addr=<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp)*16);
<a name="l01613"></a>01613             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01614"></a>01614             <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (byte_addr)%256 );
<a name="l01615"></a>01615             <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (byte_addr)/256 );
<a name="l01616"></a>01616             <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(g_page_buffer+byte_addr, u8_tmp2 );
<a name="l01617"></a>01617             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l01618"></a>01618 
<a name="l01619"></a>01619             g_phys_page_addr[g_curr_dev_id]++;                                                   <span class="comment">// update the current physical page of the current device</span>
<a name="l01620"></a>01620             g_curr_dev_id++;                                                                     <span class="comment">// update the current device</span>
<a name="l01621"></a>01621             <span class="keywordflow">if</span>( g_curr_dev_id==<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ) { g_curr_dev_id=0; }
<a name="l01622"></a>01622          }
<a name="l01623"></a>01623       }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625       <span class="comment">// then copy the rest of the logical block</span>
<a name="l01626"></a>01626       <span class="comment">//</span>
<a name="l01627"></a>01627       <span class="keywordflow">while</span>( 0!=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_last_log_sector &amp; (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>))-1)) )
<a name="l01628"></a>01628       {
<a name="l01629"></a>01629          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);  <span class="comment">// open the current device</span>
<a name="l01630"></a>01630 
<a name="l01631"></a>01631          g_copy_src=
<a name="l01632"></a>01632             <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(g_block_to_kill[g_curr_dev_id])                     <span class="comment">// adresse of the beginning of the old block</span>
<a name="l01633"></a>01633          +  (<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(g_phys_page_addr[g_curr_dev_id])&amp;(<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1))        <span class="comment">// current offset page in the old and new block</span>
<a name="l01634"></a>01634          ;
<a name="l01635"></a>01635          <a class="code" href="a00062.html#79e27718d9bc988607f630c2ff410848" title="Copy a NF page to a new one.">nf_copy</a>(g_phys_page_addr[g_curr_dev_id]);
<a name="l01636"></a>01636          g_phys_page_addr[g_curr_dev_id]++;
<a name="l01637"></a>01637 
<a name="l01638"></a>01638          g_last_log_sector+=<a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>;                            <span class="comment">// update the current logical sector</span>
<a name="l01639"></a>01639          g_curr_dev_id++;                                                          <span class="comment">// update the current device</span>
<a name="l01640"></a>01640          <span class="keywordflow">if</span>( g_curr_dev_id==<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ) { g_curr_dev_id=0; }
<a name="l01641"></a>01641       }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643       <span class="comment">// Delete old blocks</span>
<a name="l01644"></a>01644       <span class="comment">//</span>
<a name="l01645"></a>01645       <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>();
<a name="l01646"></a>01646    }<span class="keywordflow">else</span>{
<a name="l01647"></a>01647       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_copy_tail empty??;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(g_last_log_sector); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01648"></a>01648    }
<a name="l01649"></a>01649    g_last_log_sector= 0xFFFFFFFF;
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 
<a name="l01653"></a>01653 
<a name="l01663"></a><a class="code" href="a00063.html#c42a9f16a81ddbdfc167ee679d2a7edf">01663</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>* datbuf, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> loop)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * tempbuf = datbuf;
<a name="l01666"></a>01666   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i = loop;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668   <span class="keywordflow">while</span> (i != 0)
<a name="l01669"></a>01669   {
<a name="l01670"></a>01670      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01671"></a>01671      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01672"></a>01672      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01673"></a>01673      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01674"></a>01674      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01675"></a>01675      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01676"></a>01676      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01677"></a>01677      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01678"></a>01678      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01679"></a>01679      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01680"></a>01680      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01681"></a>01681      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01682"></a>01682      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01683"></a>01683      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01684"></a>01684      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01685"></a>01685      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01686"></a>01686      i--;
<a name="l01687"></a>01687   }
<a name="l01688"></a>01688 }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690 
<a name="l01691"></a>01691 
<a name="l01699"></a><a class="code" href="a00063.html#28ecafcc5c460745e3f2fc478bcd8757">01699</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a>* datbuf, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> loop)
<a name="l01700"></a>01700 {
<a name="l01701"></a>01701   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * tempbuf = datbuf;
<a name="l01702"></a>01702   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i = loop;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704   <span class="keywordflow">while</span> (i != 0)
<a name="l01705"></a>01705   {
<a name="l01706"></a>01706      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01707"></a>01707      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01708"></a>01708      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01709"></a>01709      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01710"></a>01710      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01711"></a>01711      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01712"></a>01712      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01713"></a>01713      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01714"></a>01714      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01715"></a>01715      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01716"></a>01716      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01717"></a>01717      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01718"></a>01718      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01719"></a>01719      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01720"></a>01720      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01721"></a>01721      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01722"></a>01722      i--;
<a name="l01723"></a>01723   }
<a name="l01724"></a>01724 }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 
<a name="l01743"></a><a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f">01743</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1">Nf_translate_mode</a> mode )
<a name="l01744"></a>01744 {
<a name="l01745"></a>01745    <a class="code" href="a00032.html#dcd997c76f95854090b17513c4ef3891">_MEM_TYPE_MEDFAST_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp   = (s_curr_log_sector &amp; (<a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a> -1) );
<a name="l01746"></a>01746    <a class="code" href="a00032.html#dcd997c76f95854090b17513c4ef3891">_MEM_TYPE_MEDFAST_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_shift;
<a name="l01747"></a>01747    <a class="code" href="a00032.html#dcd997c76f95854090b17513c4ef3891">_MEM_TYPE_MEDFAST_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_curr_page;
<a name="l01748"></a>01748    <a class="code" href="a00032.html#dcd997c76f95854090b17513c4ef3891">_MEM_TYPE_MEDFAST_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_last_page;
<a name="l01749"></a>01749 
<a name="l01750"></a>01750    <span class="comment">// Here begins the translation:</span>
<a name="l01751"></a>01751    <span class="comment">// logical sector number (s_curr_log_sector):</span>
<a name="l01752"></a>01752    <span class="comment">//</span>
<a name="l01753"></a>01753    <span class="comment">// -&gt; logical block number       (g_log_block_id)</span>
<a name="l01754"></a>01754    <span class="comment">// -&gt; device number              (g_curr_dev_id)</span>
<a name="l01755"></a>01755    <span class="comment">// -&gt; position in page           (s_curr_n_byte)</span>
<a name="l01756"></a>01756    <span class="comment">// -&gt; nb of sectors in first page(s_nb_sectors_step)</span>
<a name="l01757"></a>01757    <span class="comment">//</span>
<a name="l01758"></a>01758    g_log_block_id    =  s_curr_log_sector &gt;&gt; <a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>;
<a name="l01759"></a>01759    g_curr_dev_id     = (s_curr_log_sector &gt;&gt; (<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>)) % <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>;
<a name="l01760"></a>01760    s_curr_n_byte     = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp) &lt;&lt; <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>;
<a name="l01761"></a>01761    s_nb_sectors_step = <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a> - u8_tmp;
<a name="l01762"></a>01762    s_nb_sectors_step = <a class="code" href="a00032.html#9e04209162ea72f9985338596262b657">Min</a>(s_n_sectors, s_nb_sectors_step); <span class="comment">// Adapt if nb sector to read is lower than a page</span>
<a name="l01763"></a>01763 
<a name="l01764"></a>01764 <span class="comment">//   Nfc_put_lba(g_log_block_id);</span>
<a name="l01765"></a>01765 
<a name="l01766"></a>01766    <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l01767"></a>01767    <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l01768"></a>01768 
<a name="l01769"></a>01769    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_lut.ctrl.valid )
<a name="l01770"></a>01770    {
<a name="l01771"></a>01771       <span class="keywordflow">if</span>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f15ffd3a77015345013d1c3e932346ad1a">NF_TRANS_FLUSH</a>==mode )
<a name="l01772"></a>01772       {
<a name="l01773"></a>01773          <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_lut.ctrl.dirty )
<a name="l01774"></a>01774          {
<a name="l01775"></a>01775             <a class="code" href="a00062.html#c029fba5c62db088a077b69802d61f91" title="Flushes the LUT cache into a new LUT entry.">nf_cache_lut_flush</a>();
<a name="l01776"></a>01776             <a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac" title="Reload the LUT cache memory, starting from the specified logical block number given...">nf_cache_lut_refill</a>(g_log_block_id);
<a name="l01777"></a>01777          }
<a name="l01778"></a>01778       }
<a name="l01779"></a>01779 
<a name="l01780"></a>01780       <span class="keywordflow">if</span>(( g_log_block_id&lt;g_cache_lut.first )
<a name="l01781"></a>01781       || ( g_log_block_id&gt;g_cache_lut.last  ))
<a name="l01782"></a>01782       { <span class="comment">// MISS: need to refill the cache</span>
<a name="l01783"></a>01783 
<a name="l01784"></a>01784          <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_lut.ctrl.dirty ) { <a class="code" href="a00062.html#c029fba5c62db088a077b69802d61f91" title="Flushes the LUT cache into a new LUT entry.">nf_cache_lut_flush</a>(); }
<a name="l01785"></a>01785          <a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac" title="Reload the LUT cache memory, starting from the specified logical block number given...">nf_cache_lut_refill</a>(g_log_block_id);
<a name="l01786"></a>01786       }
<a name="l01787"></a>01787    }
<a name="l01788"></a>01788    <span class="keywordflow">else</span> { <a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac" title="Reload the LUT cache memory, starting from the specified logical block number given...">nf_cache_lut_refill</a>(g_log_block_id); } <span class="comment">// The cache is not valid. Just re-fill it.</span>
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 
<a name="l01792"></a>01792    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_fbb.ctrl.valid )
<a name="l01793"></a>01793    {
<a name="l01794"></a>01794       <span class="keywordflow">if</span>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f15ffd3a77015345013d1c3e932346ad1a">NF_TRANS_FLUSH</a>==mode )
<a name="l01795"></a>01795       {
<a name="l01796"></a>01796          <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_fbb.ctrl.dirty )
<a name="l01797"></a>01797          {
<a name="l01798"></a>01798             <a class="code" href="a00062.html#4eb467f47ee05e8b863e8da657db4c2f" title="Flushes the FBB cache into a new FBB entry.">nf_cache_fbb_flush</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l01799"></a>01799             <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>();
<a name="l01800"></a>01800          }
<a name="l01801"></a>01801       }
<a name="l01802"></a>01802    }
<a name="l01803"></a>01803    <span class="keywordflow">else</span> { <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>(); }
<a name="l01804"></a>01804 
<a name="l01805"></a>01805 
<a name="l01806"></a>01806 
<a name="l01807"></a>01807    u8_curr_page = (g_log_block_id-g_cache_lut.first)*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>;
<a name="l01808"></a>01808    u8_last_page = (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_cache_fbb.p*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>;
<a name="l01809"></a>01809 
<a name="l01810"></a>01810    <span class="keywordflow">for</span>( u8_tmp=0 ; u8_tmp&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++, u8_curr_page++, u8_last_page++)
<a name="l01811"></a>01811    {
<a name="l01812"></a>01812       <span class="keywordflow">if</span>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1e38cd8e23792344b6c802f0d80d97ef8">NF_TRANS_SWAP</a>==mode )
<a name="l01813"></a>01813       {
<a name="l01814"></a>01814          <a class="code" href="a00062.html#1a579e74d337851734361358c99c603e" title="Swap 2 blocks from the LUT and the FBB.">nf_swap</a>(u8_tmp, u8_curr_page, u8_last_page);
<a name="l01815"></a>01815       }
<a name="l01816"></a>01816 
<a name="l01817"></a>01817       g_phys_page_addr[u8_tmp] = <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( g_cache_lut.mem[u8_curr_page] ); <span class="comment">// ... Then adapt it to page number</span>
<a name="l01818"></a>01818    }
<a name="l01819"></a>01819 
<a name="l01820"></a>01820    <span class="keywordflow">if</span>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f1e38cd8e23792344b6c802f0d80d97ef8">NF_TRANS_SWAP</a>==mode )
<a name="l01821"></a>01821    {
<a name="l01822"></a>01822       g_cache_fbb.p++;
<a name="l01823"></a>01823       <span class="keywordflow">if</span>( g_cache_fbb.p==(g_cache_fbb.max-1) )
<a name="l01824"></a>01824       { <span class="comment">// Only 1 remaining entry in FBB cache</span>
<a name="l01825"></a>01825          <a class="code" href="a00062.html#4eb467f47ee05e8b863e8da657db4c2f" title="Flushes the FBB cache into a new FBB entry.">nf_cache_fbb_flush</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> ); <span class="comment">// No dirty test, since we know that the cache is dirty</span>
<a name="l01826"></a>01826          <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>();
<a name="l01827"></a>01827       }
<a name="l01828"></a>01828    }
<a name="l01829"></a>01829    <span class="keywordflow">else</span>
<a name="l01830"></a>01830    {
<a name="l01831"></a>01831       <span class="comment">// Build the physical memory address</span>
<a name="l01832"></a>01832       <span class="comment">//</span>
<a name="l01833"></a>01833       u8_shift =                                          <span class="comment">// page offset is</span>
<a name="l01834"></a>01834          ( s_curr_log_sector &gt;&gt; <a class="code" href="a00063.html#b66eee9a9e0d27e395572c4977e2718a">S_SHIFT_LOG_PAGE_SECTOR</a> ) <span class="comment">// convert sector id to page id</span>
<a name="l01835"></a>01835       &amp;  ( <a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>  -1                          ) <span class="comment">// modulo number of phys pages in a phys block</span>
<a name="l01836"></a>01836       ;
<a name="l01837"></a>01837 
<a name="l01838"></a>01838       <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01839"></a>01839       {
<a name="l01840"></a>01840          <span class="keywordflow">if</span> ( u8_tmp&lt;g_curr_dev_id ) { g_phys_page_addr[u8_tmp] +=  u8_shift + 1 ; } <span class="comment">// already read</span>
<a name="l01841"></a>01841          <span class="keywordflow">else</span>                        { g_phys_page_addr[u8_tmp] +=  u8_shift     ; } <span class="comment">// to be read</span>
<a name="l01842"></a>01842       }
<a name="l01843"></a>01843    }
<a name="l01844"></a>01844 
<a name="l01845"></a>01845    g_next_phys_page_addr=g_phys_page_addr[g_curr_dev_id];
<a name="l01846"></a>01846    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_translate;g_phys_page_addr["</span>); <a class="code" href="a00043.html#d4bede103a48a856e8360af858be6c7a" title="Fonction used to display a byte value in the decimal form on OCD/Serial Debug Interface...">trace_u8</a>(g_curr_dev_id); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"] = "</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(g_phys_page_addr[g_curr_dev_id]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01847"></a>01847 }
<a name="l01848"></a>01848 
<a name="l01849"></a>01849 
<a name="l01850"></a>01850 
<a name="l01859"></a><a class="code" href="a00063.html#79e27718d9bc988607f630c2ff410848">01859</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#79e27718d9bc988607f630c2ff410848" title="Copy a NF page to a new one.">nf_copy</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> copy_dst )
<a name="l01860"></a>01860 {
<a name="l01861"></a>01861    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> b_copy_fast;
<a name="l01862"></a>01862    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   zone_A, zone_B;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864    <span class="comment">// Compute the possibility of fast copy</span>
<a name="l01865"></a>01865    <span class="keywordflow">if</span>( 0 == <a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a> )
<a name="l01866"></a>01866    {
<a name="l01867"></a>01867       b_copy_fast = 0;     <span class="comment">// never possible</span>
<a name="l01868"></a>01868    }
<a name="l01869"></a>01869    <span class="keywordflow">else</span>
<a name="l01870"></a>01870    {
<a name="l01871"></a>01871       <span class="keywordflow">if</span>( (1 == <a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>) &amp;&amp; (1==<a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>) )
<a name="l01872"></a>01872       {
<a name="l01873"></a>01873          b_copy_fast = 1;  <span class="comment">// always possible</span>
<a name="l01874"></a>01874       }
<a name="l01875"></a>01875       <span class="keywordflow">else</span>
<a name="l01876"></a>01876       {
<a name="l01877"></a>01877          <span class="comment">// Check block address</span>
<a name="l01878"></a>01878          b_copy_fast = 1;  <span class="comment">// by default possible</span>
<a name="l01879"></a>01879          <span class="keywordflow">if</span>( 1 != <a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a> )
<a name="l01880"></a>01880          {
<a name="l01881"></a>01881 <span class="comment">/*</span>
<a name="l01882"></a>01882 <span class="comment">            zone_A = (g_copy_src&gt;&gt;G_SHIFT_BLOCK_PAGE) / ((U16)G_N_BLOCKS/G_COPY_BACK_CONT);</span>
<a name="l01883"></a>01883 <span class="comment">            zone_B = (copy_dst  &gt;&gt;G_SHIFT_BLOCK_PAGE) / ((U16)G_N_BLOCKS/G_COPY_BACK_CONT);</span>
<a name="l01884"></a>01884 <span class="comment">*/</span>
<a name="l01885"></a>01885             <span class="comment">// block_zone = page add / number of page / 1024</span>
<a name="l01886"></a>01886             <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l01887"></a>01887             {
<a name="l01888"></a>01888                <span class="comment">// block_zone = (page add &gt;&gt; (G_SHIFT_BLOCK_PAGE + 10)) / (G_N_ZONES/G_COPY_BACK_CONT);</span>
<a name="l01889"></a>01889                <span class="comment">// block_zone = ((page add &gt;&gt; 16) * G_COPY_BACK_CONT) / G_N_ZONES;</span>
<a name="l01890"></a>01890                zone_A = (<a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(g_copy_src)*<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>)/<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01891"></a>01891                zone_B = (<a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(copy_dst  )*<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>)/<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01892"></a>01892             }<span class="keywordflow">else</span>{
<a name="l01893"></a>01893                <span class="comment">// block_zone = page add &gt;&gt; (G_SHIFT_BLOCK_PAGE + 10) / (G_N_ZONES/G_COPY_BACK_CONT);</span>
<a name="l01894"></a>01894                zone_A = ((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(g_copy_src&gt;&gt;(<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> + 10)) *<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>) /<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01895"></a>01895                zone_B = ((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(copy_dst  &gt;&gt;(<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> + 10)) *<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>) /<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01896"></a>01896             }
<a name="l01897"></a>01897             <span class="keywordflow">if</span>( zone_A != zone_B )
<a name="l01898"></a>01898                b_copy_fast = 0;     <span class="comment">// no possible</span>
<a name="l01899"></a>01899          }
<a name="l01900"></a>01900          <span class="keywordflow">if</span>( 1 != <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a> )
<a name="l01901"></a>01901          {
<a name="l01902"></a>01902 <span class="comment">// define mandatory to delete compile error on MODULO 0</span>
<a name="l01903"></a>01903 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE) || (NF_AUTO_DETECT_2KB==TRUE) || (NF_AUTO_DETECT_512B==TRUE)</span>
<a name="l01904"></a>01904 <span class="preprocessor"></span>            zone_A = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_copy_src&gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01905"></a>01905             zone_B = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)copy_dst  &gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01906"></a>01906 <span class="preprocessor">#elif ( G_COPY_BACK_DISCONT != 0 )</span>
<a name="l01907"></a>01907 <span class="preprocessor"></span>            zone_A = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_copy_src&gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01908"></a>01908             zone_B = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)copy_dst  &gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01909"></a>01909 <span class="preprocessor">#endif</span>
<a name="l01910"></a>01910 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( zone_A != zone_B )
<a name="l01911"></a>01911                b_copy_fast = 0;     <span class="comment">// no possible</span>
<a name="l01912"></a>01912          }
<a name="l01913"></a>01913       }
<a name="l01914"></a>01914    }
<a name="l01915"></a>01915       
<a name="l01916"></a>01916    <span class="comment">// Start copy</span>
<a name="l01917"></a>01917    <span class="keywordflow">if</span>( !b_copy_fast )
<a name="l01918"></a>01918    {
<a name="l01919"></a>01919       <span class="comment">// copy the page of the old block in buffer</span>
<a name="l01920"></a>01920       <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( g_copy_src, 0 );
<a name="l01921"></a>01921       <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(                                <span class="comment">// Works by packet of 16 bytes</span>
<a name="l01922"></a>01922          g_page_buffer
<a name="l01923"></a>01923       ,     ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-4))     <span class="comment">// Data zone (Page size / 16)</span>
<a name="l01924"></a>01924          +  ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-5-4))); <span class="comment">// Spare zone (Page size / 32 / 16)</span>
<a name="l01925"></a>01925 
<a name="l01926"></a>01926       <span class="comment">// Add LBA markers to help recovery function</span>
<a name="l01927"></a>01927       <span class="comment">// Need to explain a bit why LBA are written: </span>
<a name="l01928"></a>01928       <span class="comment">// nf_copy is called from copy_head and copy_tail.</span>
<a name="l01929"></a>01929       <span class="comment">// - copy_head: need to write all the LBA of the pages to help recovery finding</span>
<a name="l01930"></a>01930       <span class="comment">//   where the last sector is written.</span>
<a name="l01931"></a>01931       <span class="comment">//   Moreover, in case that nf_copy is called from copy_head and source block at page 0</span>
<a name="l01932"></a>01932       <span class="comment">//   does not contain LBA.</span>
<a name="l01933"></a>01933       <span class="comment">// - copy_tail: no need to mark the last LBA of the last page to identify the source</span>
<a name="l01934"></a>01934       <span class="comment">//   block since we use another method</span>
<a name="l01935"></a>01935       g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>] = <a class="code" href="a00061.html#98a49853a649a262cd8c415d568e92f3">NFC_OFST_3_DATA_DST</a>;  <span class="comment">// 3- [SW] Source block (recovery) (HW capability not used)</span>
<a name="l01936"></a>01936       g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>   ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id);  <span class="comment">// 6- LBA</span>
<a name="l01937"></a>01937       g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1 ] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id);  <span class="comment">// 7- LBA</span>
<a name="l01938"></a>01938       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l01939"></a>01939       {
<a name="l01940"></a>01940          g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ] =
<a name="l01941"></a>01941          g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ] =
<a name="l01942"></a>01942          g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id);  <span class="comment">// 6- LBA</span>
<a name="l01943"></a>01943          g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1] =
<a name="l01944"></a>01944          g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1] =
<a name="l01945"></a>01945          g_page_buffer[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id);  <span class="comment">// 7- LBA</span>
<a name="l01946"></a>01946       }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948       <span class="comment">// copy the buffer in the page of the new block</span>
<a name="l01949"></a>01949       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( copy_dst, 0 );
<a name="l01950"></a>01950       <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(                                <span class="comment">// Works by packet of 16 bytes</span>
<a name="l01951"></a>01951          g_page_buffer
<a name="l01952"></a>01952       ,     ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-4))       <span class="comment">// Data zone (Page size / 16)</span>
<a name="l01953"></a>01953          +  ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-5-4)));  <span class="comment">// Spare zone (Page size / 32 / 16)</span>
<a name="l01954"></a>01954       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l01955"></a>01955    }
<a name="l01956"></a>01956    <span class="keywordflow">else</span>
<a name="l01957"></a>01957    {
<a name="l01958"></a>01958       <a class="code" href="a00060.html#b9ba38cddb62690e76858546804fac2c" title="Prepare a copy-back session.">nfc_copy_back_init</a>( g_copy_src );
<a name="l01959"></a>01959 
<a name="l01960"></a>01960       <a class="code" href="a00061.html#ac6eab632f7d904222094b7994cda033">Nfc_unprotect_all_flash</a>();                              <span class="comment">// WP may be actif due to block protection</span>
<a name="l01961"></a>01961       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01962"></a>01962       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>)%256 );
<a name="l01963"></a>01963       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>)/256 );
<a name="l01964"></a>01964       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(copy_dst) );
<a name="l01965"></a>01965       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#2d1e45154b07481f0579ecc725e4edff">LSB1</a>(copy_dst) );
<a name="l01966"></a>01966       <span class="keywordflow">if</span> ( 3==<a class="code" href="a00061.html#26193f60c442075fc7fdf8022b04c489">G_N_ROW_CYCLES</a> )
<a name="l01967"></a>01967       {
<a name="l01968"></a>01968          <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(copy_dst) );
<a name="l01969"></a>01969       }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971       <span class="comment">// Remove Source block mask</span>
<a name="l01972"></a>01972       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#98a49853a649a262cd8c415d568e92f3">NFC_OFST_3_DATA_DST</a> );
<a name="l01973"></a>01973 
<a name="l01974"></a>01974       <span class="comment">// Add LBA markers to help recovery function</span>
<a name="l01975"></a>01975       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01976"></a>01976       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01977"></a>01977       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01978"></a>01978       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id) );
<a name="l01979"></a>01979       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id) );
<a name="l01980"></a>01980 
<a name="l01981"></a>01981       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l01982"></a>01982       {
<a name="l01983"></a>01983          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01984"></a>01984          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01985"></a>01985          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01986"></a>01986          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id) );
<a name="l01987"></a>01987          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id) );
<a name="l01988"></a>01988 
<a name="l01989"></a>01989          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01990"></a>01990          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01991"></a>01991          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01992"></a>01992          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id) );
<a name="l01993"></a>01993          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id) );
<a name="l01994"></a>01994 
<a name="l01995"></a>01995          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01996"></a>01996          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01997"></a>01997          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01998"></a>01998          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(g_log_block_id) );
<a name="l01999"></a>01999          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(g_log_block_id) );
<a name="l02000"></a>02000       }
<a name="l02001"></a>02001       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l02002"></a>02002    }
<a name="l02003"></a>02003 }
<a name="l02004"></a>02004 
<a name="l02005"></a>02005 
<a name="l02006"></a>02006 
<a name="l02021"></a><a class="code" href="a00063.html#1a579e74d337851734361358c99c603e">02021</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#1a579e74d337851734361358c99c603e" title="Swap 2 blocks from the LUT and the FBB.">nf_swap</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> dev_id, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_ofst_lut, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_ofst_fbb)
<a name="l02022"></a>02022 {
<a name="l02023"></a>02023    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( dev_id      &lt; <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>  );
<a name="l02024"></a>02024    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_ofst_lut &lt; <a class="code" href="a00063.html#2df50aa01ce5b4700edbd9d48534d662">CACHE_LUT_SIZE</a>);
<a name="l02025"></a>02025    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_ofst_fbb &lt; <a class="code" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a>);
<a name="l02026"></a>02026    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.mem[u8_ofst_lut]  &gt;=g_nf_first_block );
<a name="l02027"></a>02027    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_lut.mem[u8_ofst_lut]  &lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l02028"></a>02028    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[u8_ofst_fbb]  &gt;=g_nf_first_block );
<a name="l02029"></a>02029    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( g_cache_fbb.mem[u8_ofst_fbb]  &lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l02030"></a>02030    g_block_to_kill[dev_id     ] = g_cache_lut.mem[u8_ofst_lut] ;
<a name="l02031"></a>02031    g_cache_lut.mem[u8_ofst_lut] = g_cache_fbb.mem[u8_ofst_fbb] ;
<a name="l02032"></a>02032    g_cache_fbb.mem[u8_ofst_fbb] = g_block_to_kill[dev_id]      ;
<a name="l02033"></a>02033    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_cache_lut.mem["</span>); <a class="code" href="a00043.html#d4bede103a48a856e8360af858be6c7a" title="Fonction used to display a byte value in the decimal form on OCD/Serial Debug Interface...">trace_u8</a>(u8_ofst_lut); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"] = "</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(g_cache_lut.mem[u8_ofst_lut]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l02034"></a>02034    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_cache_fbb.mem["</span>); <a class="code" href="a00043.html#d4bede103a48a856e8360af858be6c7a" title="Fonction used to display a byte value in the decimal form on OCD/Serial Debug Interface...">trace_u8</a>(u8_ofst_fbb); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"] = "</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(g_cache_fbb.mem[u8_ofst_fbb]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l02035"></a>02035 
<a name="l02036"></a>02036    <span class="comment">// both FBB and LUT caches becomes invalid</span>
<a name="l02037"></a>02037    g_cache_lut.ctrl.dirty=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02038"></a>02038    g_cache_fbb.ctrl.dirty=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02039"></a>02039 }
<a name="l02040"></a>02040 
<a name="l02041"></a>02041 
<a name="l02042"></a>02042 
<a name="l02053"></a><a class="code" href="a00103.html#g87115186b2421730a22b3e9383d1a6c9">02053</a> <span class="keywordtype">void</span> <a class="code" href="a00103.html#g87115186b2421730a22b3e9383d1a6c9" title="This function perform a last copy tail if required, when USB enters suspend or is...">nf_usb_stop</a>(<span class="keywordtype">void</span>)
<a name="l02054"></a>02054 {
<a name="l02055"></a>02055 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02056"></a>02056 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l02057"></a>02057 <span class="preprocessor">#endif</span>
<a name="l02058"></a>02058 <span class="preprocessor"></span>
<a name="l02059"></a>02059    <span class="keywordflow">if</span> ( 0xFFFFFFFF!=g_last_log_sector )
<a name="l02060"></a>02060    {
<a name="l02061"></a>02061       <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l02062"></a>02062       <a class="code" href="a00062.html#a38cbc2641b27ca8fe33b40dbfdd7486">nf_copy_tail</a>();
<a name="l02063"></a>02063 
<a name="l02064"></a>02064       <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_lut.ctrl.dirty )
<a name="l02065"></a>02065       { 
<a name="l02066"></a>02066          <a class="code" href="a00062.html#c029fba5c62db088a077b69802d61f91" title="Flushes the LUT cache into a new LUT entry.">nf_cache_lut_flush</a>();
<a name="l02067"></a>02067          <a class="code" href="a00062.html#a41b7176d88738a2110b2f2e840f73ac" title="Reload the LUT cache memory, starting from the specified logical block number given...">nf_cache_lut_refill</a>(0);
<a name="l02068"></a>02068       }
<a name="l02069"></a>02069       <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==g_cache_fbb.ctrl.dirty )
<a name="l02070"></a>02070       {
<a name="l02071"></a>02071          <a class="code" href="a00062.html#4eb467f47ee05e8b863e8da657db4c2f" title="Flushes the FBB cache into a new FBB entry.">nf_cache_fbb_flush</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l02072"></a>02072          <a class="code" href="a00062.html#524dde7169bece3f9ce79e1c56d7412b" title="Reload the FBB cache memory, starting from 0.">nf_cache_fbb_refill</a>();
<a name="l02073"></a>02073       }
<a name="l02074"></a>02074       <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l02075"></a>02075    }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02078"></a>02078 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l02079"></a>02079 <span class="preprocessor">#endif</span>
<a name="l02080"></a>02080 <span class="preprocessor"></span>}
<a name="l02081"></a>02081 <span class="preprocessor">#endif // NF_BAD_CONFIG</span>
<a name="l02082"></a>02082 <span class="preprocessor"></span>
<a name="l02083"></a>02083 
<a name="l02084"></a>02084 
<a name="l02085"></a>02085 
<a name="l02086"></a>02086 
<a name="l02087"></a>02087 <span class="comment">//_________________D E B U G    F U N C T I O N S __________________________________</span>
<a name="l02088"></a>02088 <span class="comment">// Only required for debug purpose</span>
<a name="l02089"></a>02089 
<a name="l02090"></a>02090 <span class="comment">// Erase all the blocks of the memory</span>
<a name="l02091"></a><a class="code" href="a00062.html#916bbdc9efb5cfec2294c72f4d6fa598">02091</a> <span class="keywordtype">void</span> <a class="code" href="a00062.html#916bbdc9efb5cfec2294c72f4d6fa598">nf_erase_all_blocks</a>(<span class="keywordtype">void</span>)
<a name="l02092"></a>02092 {
<a name="l02093"></a>02093   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i_block;
<a name="l02094"></a>02094 
<a name="l02095"></a>02095   <span class="keywordflow">for</span> (i_block = <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> ; i_block != 0 ; i_block--)
<a name="l02096"></a>02096   {
<a name="l02097"></a>02097     <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l02098"></a>02098   }
<a name="l02099"></a>02099 }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101 <span class="comment">//_________________R A M   A C C E S S   F U N C T I O N S _____________________</span>
<a name="l02102"></a>02102 
<a name="l02103"></a>02103 
<a name="l02117"></a><a class="code" href="a00063.html#c0569fdce920e24874d30f1b25dfe3c8">02117</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a>    <a class="code" href="a00062.html#c0569fdce920e24874d30f1b25dfe3c8" title="This fonction initialise the memory for a write operation from ram buffer.">nf_ram_2_nf</a>(<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> addr, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)
<a name="l02118"></a>02118 {
<a name="l02119"></a>02119   <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> tmp_bool;
<a name="l02120"></a>02120   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l02121"></a>02121 
<a name="l02122"></a>02122 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02123"></a>02123 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l02124"></a>02124 <span class="preprocessor">#endif</span>
<a name="l02125"></a>02125 <span class="preprocessor"></span>
<a name="l02126"></a>02126    s_n_sectors       = 1;
<a name="l02127"></a>02127    s_curr_log_sector = addr;
<a name="l02128"></a>02128    s_save_log_addr   = addr + 1;
<a name="l02129"></a>02129    g_fatal           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02130"></a>02130    s_mem             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02131"></a>02131    s_start           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02132"></a>02132 
<a name="l02133"></a>02133    <span class="comment">// First write operation</span>
<a name="l02134"></a>02134    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l02135"></a>02135    <span class="keywordflow">if</span>(( s_curr_log_sector==g_last_log_sector )                                           <span class="comment">// New write is just after to the last write</span>
<a name="l02136"></a>02136    &amp;&amp; (!(  ( 0==((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)g_last_log_sector &amp; ( ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>)) -1)))   <span class="comment">// Not on a logical block boundary</span>
<a name="l02137"></a>02137       &amp;&amp; ( g_curr_dev_id==0                                                        ))))
<a name="l02138"></a>02138    {
<a name="l02139"></a>02139       <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a> );
<a name="l02140"></a>02140       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);  <span class="comment">// open the current device</span>
<a name="l02141"></a>02141       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( g_next_phys_page_addr, s_curr_n_byte );
<a name="l02142"></a>02142    }
<a name="l02143"></a>02143    <span class="keywordflow">else</span>
<a name="l02144"></a>02144    {      
<a name="l02145"></a>02145       <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l02146"></a>02146    }
<a name="l02147"></a>02147    
<a name="l02148"></a>02148    <span class="keywordflow">for</span>(i=0;i&lt;512;i++)
<a name="l02149"></a>02149    {
<a name="l02150"></a>02150       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*ram);
<a name="l02151"></a>02151       ram++;
<a name="l02152"></a>02152    }
<a name="l02153"></a>02153 
<a name="l02154"></a>02154    <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l02155"></a>02155    {
<a name="l02156"></a>02156       <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>))-s_nb_sectors_step, s_nb_sectors_step);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l02157"></a>02157    }
<a name="l02158"></a>02158    <span class="keywordflow">else</span>
<a name="l02159"></a>02159    {
<a name="l02160"></a>02160      <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, 1);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l02161"></a>02161    }
<a name="l02162"></a>02162    <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l02163"></a>02163 
<a name="l02164"></a>02164    tmp_bool = <a class="code" href="a00062.html#d45465832eded4b9de5dfa9b095482bd" title="This function must be called when a write10 operation (from USB) is finished Last...">nf_dfc_write_stop</a>(0);   <span class="comment">// ends write operations with "nf_dfc_write_stop(0)" that save the current environnement</span>
<a name="l02165"></a>02165    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02168"></a>02168 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l02169"></a>02169 <span class="preprocessor">#endif</span>
<a name="l02170"></a>02170 <span class="preprocessor"></span>
<a name="l02171"></a>02171    <span class="keywordflow">return</span> tmp_bool;
<a name="l02172"></a>02172 }
<a name="l02173"></a>02173 
<a name="l02186"></a><a class="code" href="a00063.html#18cf312e26c74a2f8ff049bf172a56d4">02186</a> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a>    <a class="code" href="a00062.html#18cf312e26c74a2f8ff049bf172a56d4" title="This fonction read 1 sector from NF to ram buffer.">nf_nf_2_ram</a>(<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> addr, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)
<a name="l02187"></a>02187 {
<a name="l02188"></a>02188   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l02189"></a>02189 
<a name="l02190"></a>02190 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02191"></a>02191 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l02192"></a>02192 <span class="preprocessor">#endif</span>
<a name="l02193"></a>02193 <span class="preprocessor"></span>
<a name="l02194"></a>02194    s_n_sectors       = 1;
<a name="l02195"></a>02195    s_curr_log_sector = addr;
<a name="l02196"></a>02196    s_save_log_addr   = addr + 1;
<a name="l02197"></a>02197    g_fatal           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02198"></a>02198    s_mem             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02199"></a>02199    s_start           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02200"></a>02200 
<a name="l02201"></a>02201    <span class="comment">// First read operation</span>
<a name="l02202"></a>02202    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l02203"></a>02203    <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02204"></a>02204    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);
<a name="l02205"></a>02205    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( g_phys_page_addr[g_curr_dev_id], s_curr_n_byte );
<a name="l02206"></a>02206    s_nb_sectors_step = (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)                              <span class="comment">// determine number of sectors to be read</span>
<a name="l02207"></a>02207                        (<a class="code" href="a00032.html#9e04209162ea72f9985338596262b657">Min</a>(                             <span class="comment">// on this first page</span>
<a name="l02208"></a>02208                              1,
<a name="l02209"></a>02209                              ((1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>))-(s_curr_n_byte &gt;&gt; 9))
<a name="l02210"></a>02210                            )
<a name="l02211"></a>02211                        );
<a name="l02212"></a>02212    
<a name="l02213"></a>02213    Disable_interrupt();  
<a name="l02214"></a>02214    <span class="keywordflow">for</span>(i=0;i&lt;512;i++)
<a name="l02215"></a>02215    {
<a name="l02216"></a>02216       *ram=<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>();
<a name="l02217"></a>02217       ram++;
<a name="l02218"></a>02218    }
<a name="l02219"></a>02219    Enable_interrupt();  
<a name="l02220"></a>02220    <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l02221"></a>02221    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l02222"></a>02222 
<a name="l02223"></a>02223 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02224"></a>02224 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l02225"></a>02225 <span class="preprocessor">#endif</span>
<a name="l02226"></a>02226 <span class="preprocessor"></span>
<a name="l02227"></a>02227    <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>;   
<a name="l02228"></a>02228 }
<a name="l02229"></a>02229 
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 14 13:14:18 2009 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
