<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: nf_mngt.h File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>nf_mngt.h File Reference</h1><code>#include &quot;<a class="el" href="a00140.html">config.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00136.html">conf_nf.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00158.html">nf.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00143.html">modules/control_access/ctrl_status.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00162.html">nf_drv.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for nf_mngt.h:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dynsection">
</div>

<p>
<a href="a00164.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00002.html">Cache_lut</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00001.html">Cache_fbb</a></td></tr>

<tr><td colspan="2"><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#f207755082cb7bb8864b85d95f7fb427">NF_BLK_RCV_NO_RECOVERY</a>&nbsp;&nbsp;&nbsp;0xA5</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#3cc1d460022d2bb25b955d00742b0eb7">NF_BLK_RCV_PENDING_RECOVERY</a>&nbsp;&nbsp;&nbsp;0x5A</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#714ce5649e72db34c2ef646c284321ae">NF_LOW_N_FREE_THRESHOLD</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;2048</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#f80c4ce07be5eb80f1fa7e96dd19aa8a">NF_FULL_PAGE_BUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;( (NF_PAGE_BUFFER_SIZE) + (NF_PAGE_BUFFER_SIZE)/32 )</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#fec3c6701415feaba7c4549f19f43946">NF_SHIFT_SUBLUT_PHYS</a>&nbsp;&nbsp;&nbsp;( (G_SHIFT_PAGE_BYTE)-1 )</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#bd398c181df0934d401cafd7447ddd10">NF_SUBLUT_SIZE</a>&nbsp;&nbsp;&nbsp;( 1L&lt;&lt;(NF_SHIFT_SUBLUT_PHYS) )</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#5f257c64502cfaa99ca2a1c1b20ef777">NF_N_MAX_BLOCKS</a>&nbsp;&nbsp;&nbsp;(8*1024)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#28826e9d277e2bdd262d82d6caf78f29">N_SUBLUT</a>&nbsp;&nbsp;&nbsp;(NF_N_DEVICES*NF_N_MAX_BLOCKS/(512/2))</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>&nbsp;&nbsp;&nbsp;<a class="el" href="a00062.html#d24848f009aa80a9e062513b93f73493">s_shift_sector_byte</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#b66eee9a9e0d27e395572c4977e2718a">S_SHIFT_LOG_PAGE_SECTOR</a>&nbsp;&nbsp;&nbsp;<a class="el" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>&nbsp;&nbsp;&nbsp;<a class="el" href="a00062.html#7dfe2973a57e7e1ad70f55f70bbcef87">s_shift_log_block_sector</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>&nbsp;&nbsp;&nbsp;((NF_N_DEVICES)-1)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>(x)&nbsp;&nbsp;&nbsp;nf_check_fbb(x)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>()&nbsp;&nbsp;&nbsp;nf_check_lut()</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#2df50aa01ce5b4700edbd9d48534d662">CACHE_LUT_SIZE</a>&nbsp;&nbsp;&nbsp;(NF_CACHE_LUT_LOG_SZ*NF_N_DEVICES)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a>&nbsp;&nbsp;&nbsp;(NF_CACHE_FBB_LOG_SZ*NF_N_DEVICES)</td></tr>

<tr><td colspan="2"><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e">Nf_sense</a> { <a class="el" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e281d51825490a7f8e95b88a77f03de71">NF_READ</a> = 0, 
<a class="el" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7eedcb0e56907fd3195f3cad2e2d1607aa">NF_WRITE</a>
 }</td></tr>

<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#c9c878ced2e50015d7bfdadba72bf2ed">nf_check_fbb</a> (<a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> b_ecc_err)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#0aac9e104db7a0ae59bf807994c344cc">nf_check_lut</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#842d42e30e0ae29382313535b396163c">nf_test_unit_ready</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the NF driver on the first USB Test Unit Ready.  <a href="#842d42e30e0ae29382313535b396163c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#90632665455271ff8941f40e905643c3">nf_read_capacity</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> *)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns the address of the last valid logical sector.  <a href="#90632665455271ff8941f40e905643c3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#025a42a5797bf8f4ae78f5e0cddc0842">nf_wr_protect</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#0034234ddcc3a96d3427630292f3b8db">nf_removal</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#3b284e8f087a2c3001198b97bd721e53">nf_10</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> addr, <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> nb_sector, <a class="el" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e">Nf_sense</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#7990ecd39062bd090edc8a64938b0e2f">nf_dfc_read_resume</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#beeec1cfcc2701c2ab11e119fa3b1a41">nf_dfc_write_resume</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#09b6c47dfda1881476ee6e32a402c9eb">nf_dfc_read_stop</a> (<a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> remaining_sectors)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#4278d426a2907921c797422de0a14247">nf_dfc_write_stop</a> (<a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> remaining_sectors)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function must be called when a write10 operation (from USB) is finished Last page written is programmed and environment is saved.  <a href="#4278d426a2907921c797422de0a14247"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#5c506bec40bbca03b0cffa8ef7cd7e11">nf_dfc_read_standby</a> (<a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#dd49676601c79bc6c52b85e5e8a60561">nf_dfc_read_restart</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#f935b5cf31febdb455f0b157944ae27b">nf_get_sectors_number</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Returns a pointer on the internal buffer address.  <a href="#f935b5cf31febdb455f0b157944ae27b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#15475d6193583f87740f8dfa6219772b">nf_get_buffer_addr</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#7fa3ba35a1436fa32cc3a53d079dedc0">nf_init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Initializes the nand flash memory driver.  <a href="#7fa3ba35a1436fa32cc3a53d079dedc0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#5bc1ea382d755aa7efeffbd008c3347a">nf_verify</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Ensure that the memory is in a good state before starting to use it.  <a href="#5bc1ea382d755aa7efeffbd008c3347a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#b3c26aadc0e38a2d67aac9080152777a">nf_verify_resume</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Ensure that the memory is in a good state before starting to use it.  <a href="#b3c26aadc0e38a2d67aac9080152777a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#4111df3ea1a2e262cdc7b853bad4543f">nf_cleanup_memory</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Cleanup the memory by erasing all the management blocks.  <a href="#4111df3ea1a2e262cdc7b853bad4543f"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#28ecafcc5c460745e3f2fc478bcd8757">nf_upload</a> (<a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> _MEM_TYPE_SLOW_ *, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Upload packets of 16 bytes from the NAND Flash to RAM.  <a href="#28ecafcc5c460745e3f2fc478bcd8757"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#c42a9f16a81ddbdfc167ee679d2a7edf">nf_download</a> (<a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> _MEM_TYPE_SLOW_ *, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Download packets of 16 bytes from RAM to the NAND Flash.  <a href="#c42a9f16a81ddbdfc167ee679d2a7edf"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a> (<a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_addr)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#ae85309c46a253ef08a961b99657ede0">nf_ecc_mngt</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#f41b35e9c4b10553fb3877f8c394188c">nf_sync</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#79e27718d9bc988607f630c2ff410848">nf_copy</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> copy_dst)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Copy a NF page to a new one.  <a href="#79e27718d9bc988607f630c2ff410848"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#4033ef04a3cbd39dc9d6071c6d7c2a9b">nf_write_lut</a> (<a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> pos, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i_sub_lut, <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> sub_lut_log_sz)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Writes a LUT in memory from a buffer.  <a href="#4033ef04a3cbd39dc9d6071c6d7c2a9b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#020f4fb7d7d55f3fad9c368ac04cabf3">nf_write_fbb</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Writes the Free-blocks block into the Nand Flash.  <a href="#020f4fb7d7d55f3fad9c368ac04cabf3"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#524dde7169bece3f9ce79e1c56d7412b">nf_cache_fbb_refill</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reload the FBB cache memory, starting from 0.  <a href="#524dde7169bece3f9ce79e1c56d7412b"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#1a579e74d337851734361358c99c603e">nf_swap</a> (<a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> dev_id, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_ofst_lut, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_ofst_fbb)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Swap 2 blocks from the LUT and the FBB.  <a href="#1a579e74d337851734361358c99c603e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#5fb0e3f2e7220e43f6185c10231d09c8">nf_cache_fbb_flush</a> (<a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Flushes the FBB cache into a new FBB entry.  <a href="#5fb0e3f2e7220e43f6185c10231d09c8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#8a8cd7007fd3561ea61f83641f7d3278">nf_recovery</a> (<a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_1, <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_2)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#a38cbc2641b27ca8fe33b40dbfdd7486">nf_copy_tail</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#1c583c1d616f3af3e57ebe914cf747e9">nf_read_10</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> log_sector, <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> n_sectors)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function initializes the Nand Flash for a read operation.  <a href="#1c583c1d616f3af3e57ebe914cf747e9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#fd80e982702f51b6ad94632856b980e1">nf_write_10</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> log_sector, <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> n_sectors)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function initializes the Nand Flash for a write operation.  <a href="#fd80e982702f51b6ad94632856b980e1"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#c0569fdce920e24874d30f1b25dfe3c8">nf_ram_2_nf</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> addr, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction initialise the memory for a write operation from ram buffer.  <a href="#c0569fdce920e24874d30f1b25dfe3c8"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#18cf312e26c74a2f8ff049bf172a56d4">nf_nf_2_ram</a> (<a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> addr, <a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This fonction read 1 sector from NF to ram buffer.  <a href="#18cf312e26c74a2f8ff049bf172a56d4"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a></td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This file is the header file for the high level management of the nand flash memory devices.<p>
<ul>
<li>Compiler: IAR EWAVR and GNU GCC for AVR</li><li>Supported devices: AT90USB1287, AT90USB1286, AT90USB647, AT90USB646</li></ul>
<p>
<dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support and FAQ: <a href="http://support.atmel.no/">http://support.atmel.no/</a> </dd></dl>

<p>Definition in file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="f207755082cb7bb8864b85d95f7fb427"></a><!-- doxytag: member="nf_mngt.h::NF_BLK_RCV_NO_RECOVERY" ref="f207755082cb7bb8864b85d95f7fb427" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_BLK_RCV_NO_RECOVERY&nbsp;&nbsp;&nbsp;0xA5          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00061">61</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

</div>
</div><p>
<a class="anchor" name="3cc1d460022d2bb25b955d00742b0eb7"></a><!-- doxytag: member="nf_mngt.h::NF_BLK_RCV_PENDING_RECOVERY" ref="3cc1d460022d2bb25b955d00742b0eb7" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_BLK_RCV_PENDING_RECOVERY&nbsp;&nbsp;&nbsp;0x5A          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00062">62</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

</div>
</div><p>
<a class="anchor" name="714ce5649e72db34c2ef646c284321ae"></a><!-- doxytag: member="nf_mngt.h::NF_LOW_N_FREE_THRESHOLD" ref="714ce5649e72db34c2ef646c284321ae" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_LOW_N_FREE_THRESHOLD&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00064">64</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00490">nf_rebuild()</a>.</p>

</div>
</div><p>
<a class="anchor" name="274b9bbe013bba444abdaed38d651735"></a><!-- doxytag: member="nf_mngt.h::NF_PAGE_BUFFER_SIZE" ref="274b9bbe013bba444abdaed38d651735" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_PAGE_BUFFER_SIZE&nbsp;&nbsp;&nbsp;2048          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00077">77</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00165.html#l00490">nf_rebuild()</a>, and <a class="el" href="a00163.html#l01213">nf_write_lut()</a>.</p>

</div>
</div><p>
<a class="anchor" name="f80c4ce07be5eb80f1fa7e96dd19aa8a"></a><!-- doxytag: member="nf_mngt.h::NF_FULL_PAGE_BUFFER_SIZE" ref="f80c4ce07be5eb80f1fa7e96dd19aa8a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_FULL_PAGE_BUFFER_SIZE&nbsp;&nbsp;&nbsp;( (NF_PAGE_BUFFER_SIZE) + (NF_PAGE_BUFFER_SIZE)/32 )          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00082">82</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, and <a class="el" href="a00165.html#l00130">nf_init_buffer()</a>.</p>

</div>
</div><p>
<a class="anchor" name="fec3c6701415feaba7c4549f19f43946"></a><!-- doxytag: member="nf_mngt.h::NF_SHIFT_SUBLUT_PHYS" ref="fec3c6701415feaba7c4549f19f43946" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_SHIFT_SUBLUT_PHYS&nbsp;&nbsp;&nbsp;( (G_SHIFT_PAGE_BYTE)-1 )          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00083">83</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00163.html#l00980">nf_cache_lut_refill()</a>, and <a class="el" href="a00165.html#l00490">nf_rebuild()</a>.</p>

</div>
</div><p>
<a class="anchor" name="bd398c181df0934d401cafd7447ddd10"></a><!-- doxytag: member="nf_mngt.h::NF_SUBLUT_SIZE" ref="bd398c181df0934d401cafd7447ddd10" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_SUBLUT_SIZE&nbsp;&nbsp;&nbsp;( 1L&lt;&lt;(NF_SHIFT_SUBLUT_PHYS) )          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00084">84</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00165.html#l00490">nf_rebuild()</a>, and <a class="el" href="a00165.html#l00303">nf_scan()</a>.</p>

</div>
</div><p>
<a class="anchor" name="5f257c64502cfaa99ca2a1c1b20ef777"></a><!-- doxytag: member="nf_mngt.h::NF_N_MAX_BLOCKS" ref="5f257c64502cfaa99ca2a1c1b20ef777" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NF_N_MAX_BLOCKS&nbsp;&nbsp;&nbsp;(8*1024)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00088">88</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

</div>
</div><p>
<a class="anchor" name="28826e9d277e2bdd262d82d6caf78f29"></a><!-- doxytag: member="nf_mngt.h::N_SUBLUT" ref="28826e9d277e2bdd262d82d6caf78f29" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define N_SUBLUT&nbsp;&nbsp;&nbsp;(NF_N_DEVICES*NF_N_MAX_BLOCKS/(512/2))          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00089">89</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00490">nf_rebuild()</a>.</p>

</div>
</div><p>
<a class="anchor" name="b7b418925e68e7dc40aa9a74613cb6ee"></a><!-- doxytag: member="nf_mngt.h::S_SHIFT_SECTOR_BYTE" ref="b7b418925e68e7dc40aa9a74613cb6ee" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define S_SHIFT_SECTOR_BYTE&nbsp;&nbsp;&nbsp;<a class="el" href="a00062.html#d24848f009aa80a9e062513b93f73493">s_shift_sector_byte</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00104">104</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l00296">nf_get_sectors_number()</a>, <a class="el" href="a00165.html#l00151">nf_init()</a>, <a class="el" href="a00163.html#l02186">nf_nf_2_ram()</a>, <a class="el" href="a00163.html#l02117">nf_ram_2_nf()</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, and <a class="el" href="a00163.html#l00384">nf_write_10()</a>.</p>

</div>
</div><p>
<a class="anchor" name="b66eee9a9e0d27e395572c4977e2718a"></a><!-- doxytag: member="nf_mngt.h::S_SHIFT_LOG_PAGE_SECTOR" ref="b66eee9a9e0d27e395572c4977e2718a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define S_SHIFT_LOG_PAGE_SECTOR&nbsp;&nbsp;&nbsp;<a class="el" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00105">105</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l00880">nf_open_write()</a>, and <a class="el" href="a00163.html#l01743">nf_translate()</a>.</p>

</div>
</div><p>
<a class="anchor" name="fdb4a2af55e4352eff66adadabebac1d"></a><!-- doxytag: member="nf_mngt.h::S_SHIFT_LOG_BLOCK_SECTOR" ref="fdb4a2af55e4352eff66adadabebac1d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define S_SHIFT_LOG_BLOCK_SECTOR&nbsp;&nbsp;&nbsp;<a class="el" href="a00062.html#7dfe2973a57e7e1ad70f55f70bbcef87">s_shift_log_block_sector</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00106">106</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01558">nf_copy_tail()</a>, <a class="el" href="a00163.html#l02117">nf_ram_2_nf()</a>, <a class="el" href="a00165.html#l00490">nf_rebuild()</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, and <a class="el" href="a00163.html#l00384">nf_write_10()</a>.</p>

</div>
</div><p>
<a class="anchor" name="85f227c39b86316cd59782313371c343"></a><!-- doxytag: member="nf_mngt.h::S_MNGT_DEV" ref="85f227c39b86316cd59782313371c343" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define S_MNGT_DEV&nbsp;&nbsp;&nbsp;((NF_N_DEVICES)-1)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00115">115</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, <a class="el" href="a00163.html#l01049">nf_cache_fbb_refill()</a>, <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00163.html#l00980">nf_cache_lut_refill()</a>, <a class="el" href="a00163.html#l01463">nf_check_fbb()</a>, <a class="el" href="a00163.html#l01514">nf_check_lut()</a>, <a class="el" href="a00163.html#l00880">nf_open_write()</a>, <a class="el" href="a00165.html#l00490">nf_rebuild()</a>, <a class="el" href="a00165.html#l00303">nf_scan()</a>, <a class="el" href="a00163.html#l01417">nf_write_fbb()</a>, and <a class="el" href="a00163.html#l01213">nf_write_lut()</a>.</p>

</div>
</div><p>
<a class="anchor" name="3a7e8fdae8fd67e400d1e05c4c40610f"></a><!-- doxytag: member="nf_mngt.h::Nf_check_fbb" ref="3a7e8fdae8fd67e400d1e05c4c40610f" args="(x)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define Nf_check_fbb          </td>
          <td>(</td>
          <td class="paramtype">x&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%">&nbsp;&nbsp;&nbsp;nf_check_fbb(x)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00121">121</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00163.html#l00770">nf_dfc_write_stop()</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, and <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>

</div>
</div><p>
<a class="anchor" name="d57b5bafad3a69fe6f786312acd3d0f1"></a><!-- doxytag: member="nf_mngt.h::Nf_check_lut" ref="d57b5bafad3a69fe6f786312acd3d0f1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define Nf_check_lut          </td>
          <td>(</td>
&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%">&nbsp;&nbsp;&nbsp;nf_check_lut()</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00122">122</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00163.html#l00770">nf_dfc_write_stop()</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, and <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>

</div>
</div><p>
<a class="anchor" name="2df50aa01ce5b4700edbd9d48534d662"></a><!-- doxytag: member="nf_mngt.h::CACHE_LUT_SIZE" ref="2df50aa01ce5b4700edbd9d48534d662" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CACHE_LUT_SIZE&nbsp;&nbsp;&nbsp;(NF_CACHE_LUT_LOG_SZ*NF_N_DEVICES)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00137">137</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00163.html#l00980">nf_cache_lut_refill()</a>, and <a class="el" href="a00163.html#l02021">nf_swap()</a>.</p>

</div>
</div><p>
<a class="anchor" name="4385406f8199c1f4bc1db06d58e4bf6e"></a><!-- doxytag: member="nf_mngt.h::CACHE_FBB_SIZE" ref="4385406f8199c1f4bc1db06d58e4bf6e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CACHE_FBB_SIZE&nbsp;&nbsp;&nbsp;(NF_CACHE_FBB_LOG_SZ*NF_N_DEVICES)          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00150">150</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, <a class="el" href="a00163.html#l01049">nf_cache_fbb_refill()</a>, and <a class="el" href="a00163.html#l02021">nf_swap()</a>.</p>

</div>
</div><p>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="ba98ad90dee97fdb6a9b9f2007ddde7e"></a><!-- doxytag: member="nf_mngt.h::Nf_sense" ref="ba98ad90dee97fdb6a9b9f2007ddde7e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e">Nf_sense</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<dl compact><dt><b>Enumerator: </b></dt><dd>
<table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" name="ba98ad90dee97fdb6a9b9f2007ddde7e281d51825490a7f8e95b88a77f03de71"></a><!-- doxytag: member="NF_READ" ref="ba98ad90dee97fdb6a9b9f2007ddde7e281d51825490a7f8e95b88a77f03de71" args="" -->NF_READ</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" name="ba98ad90dee97fdb6a9b9f2007ddde7eedcb0e56907fd3195f3cad2e2d1607aa"></a><!-- doxytag: member="NF_WRITE" ref="ba98ad90dee97fdb6a9b9f2007ddde7eedcb0e56907fd3195f3cad2e2d1607aa" args="" -->NF_WRITE</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>Definition at line <a class="el" href="a00164.html#l00154">154</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00155"></a>00155 {
<a name="l00156"></a>00156    <a class="code" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e281d51825490a7f8e95b88a77f03de71">NF_READ</a>=0
<a name="l00157"></a>00157 ,  <a class="code" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7eedcb0e56907fd3195f3cad2e2d1607aa">NF_WRITE</a>
<a name="l00158"></a>00158 } <a class="code" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e">Nf_sense</a>;
</pre></div>
<p>

</div>
</div><p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="c9c878ced2e50015d7bfdadba72bf2ed"></a><!-- doxytag: member="nf_mngt.h::nf_check_fbb" ref="c9c878ced2e50015d7bfdadba72bf2ed" args="(Bool b_ecc_err)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void nf_check_fbb           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td>
          <td class="paramname"> <em>b_ecc_err</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="0aac9e104db7a0ae59bf807994c344cc"></a><!-- doxytag: member="nf_mngt.h::nf_check_lut" ref="0aac9e104db7a0ae59bf807994c344cc" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void nf_check_lut           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="842d42e30e0ae29382313535b396163c"></a><!-- doxytag: member="nf_mngt.h::nf_test_unit_ready" ref="842d42e30e0ae29382313535b396163c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_test_unit_ready           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initializes the NF driver on the first USB Test Unit Ready. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>CTRL_GOOD if ok, CTRL_NO_PRESENT in case of problems. </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00218">218</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00143.html#l00062">CTRL_FAIL</a>, <a class="el" href="a00143.html#l00061">CTRL_GOOD</a>, <a class="el" href="a00163.html#l00202">nf_verify()</a>, <a class="el" href="a00161.html#l00185">nf_XMCR_disable()</a>, <a class="el" href="a00161.html#l00172">nf_XMCR_enable()</a>, and <a class="el" href="a00133.html#l00066">PASS</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00219"></a>00219 {
<a name="l00220"></a>00220   <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> tmp_bool;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00224"></a>00224 <span class="preprocessor">#endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>
<a name="l00226"></a>00226    tmp_bool = <a class="code" href="a00062.html#5bc1ea382d755aa7efeffbd008c3347a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify</a>();
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00230"></a>00230 <span class="preprocessor">#endif</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>
<a name="l00232"></a>00232    <span class="keywordflow">return</span> ( tmp_bool==<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> ) ? <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> : <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>;
<a name="l00233"></a>00233 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="90632665455271ff8941f40e905643c3"></a><!-- doxytag: member="nf_mngt.h::nf_read_capacity" ref="90632665455271ff8941f40e905643c3" args="(U32 *)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_read_capacity           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> *&nbsp;</td>
          <td class="paramname"> <em>u32_nb_sector</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns the address of the last valid logical sector. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>CTRL_GOOD if ok, CTRL_NO_PRESENT in case of problems. </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00243">243</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00143.html#l00062">CTRL_FAIL</a>, <a class="el" href="a00143.html#l00061">CTRL_GOOD</a>, <a class="el" href="a00163.html#l00296">nf_get_sectors_number()</a>, <a class="el" href="a00163.html#l00202">nf_verify()</a>, <a class="el" href="a00161.html#l00185">nf_XMCR_disable()</a>, <a class="el" href="a00161.html#l00172">nf_XMCR_enable()</a>, and <a class="el" href="a00133.html#l00066">PASS</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00244"></a>00244 {
<a name="l00245"></a>00245   <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> status_bool;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00249"></a>00249 <span class="preprocessor">#endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>
<a name="l00251"></a>00251    status_bool = <a class="code" href="a00062.html#5bc1ea382d755aa7efeffbd008c3347a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify</a>();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00255"></a>00255 <span class="preprocessor">#endif</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>
<a name="l00257"></a>00257    *u32_nb_sector = <a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>()-1;
<a name="l00258"></a>00258    <span class="keywordflow">return</span> ( status_bool==<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> ) ? <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a> : <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>;
<a name="l00259"></a>00259 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="025a42a5797bf8f4ae78f5e0cddc0842"></a><!-- doxytag: member="nf_mngt.h::nf_wr_protect" ref="025a42a5797bf8f4ae78f5e0cddc0842" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> nf_wr_protect           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00262">262</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00260">FALSE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00263"></a>00263 {
<a name="l00264"></a>00264     <span class="keywordflow">return</span> <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00265"></a>00265 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="0034234ddcc3a96d3427630292f3b8db"></a><!-- doxytag: member="nf_mngt.h::nf_removal" ref="0034234ddcc3a96d3427630292f3b8db" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> nf_removal           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00267">267</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <span class="keywordflow">return</span> <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00270"></a>00270 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="3b284e8f087a2c3001198b97bd721e53"></a><!-- doxytag: member="nf_mngt.h::nf_10" ref="3b284e8f087a2c3001198b97bd721e53" args="(U32 addr, U16 nb_sector, Nf_sense)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_10           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td>
          <td class="paramname"> <em>addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>nb_sector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00063.html#ba98ad90dee97fdb6a9b9f2007ddde7e">Nf_sense</a>&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="7990ecd39062bd090edc8a64938b0e2f"></a><!-- doxytag: member="nf_mngt.h::nf_dfc_read_resume" ref="7990ecd39062bd090edc8a64938b0e2f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_dfc_read_resume           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="beeec1cfcc2701c2ab11e119fa3b1a41"></a><!-- doxytag: member="nf_mngt.h::nf_dfc_write_resume" ref="beeec1cfcc2701c2ab11e119fa3b1a41" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_dfc_write_resume           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="09b6c47dfda1881476ee6e32a402c9eb"></a><!-- doxytag: member="nf_mngt.h::nf_dfc_read_stop" ref="09b6c47dfda1881476ee6e32a402c9eb" args="(U16 remaining_sectors)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_dfc_read_stop           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>remaining_sectors</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="4278d426a2907921c797422de0a14247"></a><!-- doxytag: member="nf_mngt.h::nf_dfc_write_stop" ref="4278d426a2907921c797422de0a14247" args="(U16 remaining_sectors)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_dfc_write_stop           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>u16_nb_sector_remaining</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function must be called when a write10 operation (from USB) is finished Last page written is programmed and environment is saved. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>log_sector</em>&nbsp;</td><td>Logical sector address to start read </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>Number of sectors to transfer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>CTRL_GOOD if ok, CTRL_FAIL if read outside memory </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00770">770</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00143.html#l00061">CTRL_GOOD</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00133.html#l00207">LSB0</a>, <a class="el" href="a00164.html#l00121">Nf_check_fbb</a>, <a class="el" href="a00164.html#l00122">Nf_check_lut</a>, <a class="el" href="a00163.html#l00819">nf_erase_old_blocks()</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00162.html#l00299">NF_PAGE_PROGRAM_CMD</a>, <a class="el" href="a00163.html#l00171">NF_TRANS_NORMAL</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, <a class="el" href="a00161.html#l00152">nfc_reset_nands()</a>, <a class="el" href="a00162.html#l00107">Nfc_set_cmd</a>, <a class="el" href="a00162.html#l00337">SIZE_BLOCK_PAGE</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00126">trace_hex32()</a>, and <a class="el" href="a00144.html#l00131">trace_nl()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00771"></a>00771 {
<a name="l00772"></a>00772    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>); <span class="comment">// Program the page</span>
<a name="l00773"></a>00773    <span class="comment">// Note that if the page is not completely filled in yet but still programmed, the next copy tail will allow partial page program</span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775    <span class="comment">// retreive exact logical/physical position (in case that transfer</span>
<a name="l00776"></a>00776    <span class="comment">// did not perform the exact number of sectors)</span>
<a name="l00777"></a>00777    <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> = <a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">s_save_log_addr</a> - u16_nb_sector_remaining;
<a name="l00778"></a>00778    <span class="keywordflow">if</span>( 0!=u16_nb_sector_remaining )
<a name="l00779"></a>00779    {
<a name="l00780"></a>00780       <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a> );
<a name="l00781"></a>00781    }
<a name="l00782"></a>00782    <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>  = <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a>; <span class="comment">// Memorize next logical sector to be managed</span>
<a name="l00783"></a>00783 
<a name="l00784"></a>00784    <span class="comment">// Test if transfer stop at end of logical blocks.</span>
<a name="l00785"></a>00785    <span class="keywordflow">if</span>( <a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>==0 )
<a name="l00786"></a>00786    {
<a name="l00787"></a>00787       <span class="keywordflow">if</span>(!(<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>-1))  <span class="comment">// new block</span>
<a name="l00788"></a>00788       &amp;&amp; (<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>==0                                  )) <span class="comment">// on device 0.</span>
<a name="l00789"></a>00789      {
<a name="l00790"></a>00790          <span class="comment">// Delete old blocks</span>
<a name="l00791"></a>00791          <span class="comment">//</span>
<a name="l00792"></a>00792          <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>();
<a name="l00793"></a>00793       }
<a name="l00794"></a>00794    }
<a name="l00795"></a>00795    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_dfc_write_stop;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    <span class="comment">// Ensure that all internal programming are complete, since we are</span>
<a name="l00798"></a>00798    <span class="comment">// using cache programming (WP may be asserted for icons or fonts</span>
<a name="l00799"></a>00799    <span class="comment">// loading). Moreover, on some NFs (ST, Samsung)</span>
<a name="l00800"></a>00800    <span class="comment">// it is necessary to reset the devices after copy-back commands</span>
<a name="l00801"></a>00801    <span class="comment">// If not, strange behaviour may happen: no busy when opening</span>
<a name="l00802"></a>00802    <span class="comment">// a page for reading...</span>
<a name="l00803"></a>00803    <a class="code" href="a00060.html#ec96d29ad256f2dfc2ebfceddf08d6a9" title="Reset all the NF devices.">nfc_reset_nands</a>( <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ); <span class="comment">// Reset all the NF devices</span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805    <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l00806"></a>00806    <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l00807"></a>00807 
<a name="l00808"></a>00808    <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>;
<a name="l00809"></a>00809 } <span class="comment">// end of nf_dfc_write_stop</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="5c506bec40bbca03b0cffa8ef7cd7e11"></a><!-- doxytag: member="nf_mngt.h::nf_dfc_read_standby" ref="5c506bec40bbca03b0cffa8ef7cd7e11" args="(U16)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_dfc_read_standby           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="dd49676601c79bc6c52b85e5e8a60561"></a><!-- doxytag: member="nf_mngt.h::nf_dfc_read_restart" ref="dd49676601c79bc6c52b85e5e8a60561" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_dfc_read_restart           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f935b5cf31febdb455f0b157944ae27b"></a><!-- doxytag: member="nf_mngt.h::nf_get_sectors_number" ref="f935b5cf31febdb455f0b157944ae27b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> nf_get_sectors_number           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Returns a pointer on the internal buffer address. 
<p>
This function is used for test only.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>pointer on an internal buffer of 2112 bytes. Returns the total number of sectors that can be used on the memory.</dd></dl>
This number is computed during the power on, after a scan of the memory.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Number of sectors. </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00296">296</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00162.html#l00413">G_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, and <a class="el" href="a00164.html#l00104">S_SHIFT_SECTOR_BYTE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00297"></a>00297 {
<a name="l00298"></a>00298    <span class="keywordflow">return</span>
<a name="l00299"></a>00299       (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>
<a name="l00300"></a>00300    &lt;&lt; (<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> +<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> -<a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>)
<a name="l00301"></a>00301    ;
<a name="l00302"></a>00302 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="15475d6193583f87740f8dfa6219772b"></a><!-- doxytag: member="nf_mngt.h::nf_get_buffer_addr" ref="15475d6193583f87740f8dfa6219772b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>* nf_get_buffer_addr           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="7fa3ba35a1436fa32cc3a53d079dedc0"></a><!-- doxytag: member="nf_mngt.h::nf_init" ref="7fa3ba35a1436fa32cc3a53d079dedc0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Initializes the nand flash memory driver. 
<p>
The device identification is performed to initialize the driver accordingly<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00151">151</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>Referenced by <a class="el" href="a00153.html#l00151">main()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00152"></a>00152 {
<a name="l00153"></a>00153    <a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a>=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00154"></a>00154 <span class="comment">//   s_pending_write=FALSE;</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE)</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#error Check this init...</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>   <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a>             = NF_N_ZONES;
<a name="l00159"></a>00159    <a class="code" href="a00061.html#a77d29865677c8e97bbd578eac48be3f">g_n_blocks</a>            = NF_N_BLOCKS;
<a name="l00160"></a>00160    <a class="code" href="a00061.html#be82d871b5e412806adb94589b4b7f2e">g_shift_block_page</a>    = <a class="code" href="a00058.html#0d6042ad6ee7e6bae51e87c0f2f14807">NF_SHIFT_BLOCK_PAGE</a>;
<a name="l00161"></a>00161    <a class="code" href="a00061.html#12e3a20682ed5032e788a57882f8256f">g_shift_page_byte</a>     = <a class="code" href="a00058.html#b9439f9226b0ff5799893b83bd7fc54b">NF_SHIFT_PAGE_BYTE</a>;
<a name="l00162"></a>00162    <a class="code" href="a00062.html#d24848f009aa80a9e062513b93f73493">s_shift_sector_byte</a>   = <a class="code" href="a00057.html#a85df997eb2d3c6ade9bedd30d51fdc9">NF_SHIFT_SECTOR_BYTE</a>;
<a name="l00163"></a>00163    <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>        = NF_N_ROW_CYCLES;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165    <span class="keywordflow">if</span> ( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() ) <span class="comment">// 2KB pages</span>
<a name="l00166"></a>00166    {
<a name="l00167"></a>00167       <a class="code" href="a00061.html#b466843403d37526c75306381a6807c7">g_ofst_blk_status</a>     = 0;
<a name="l00168"></a>00168    }
<a name="l00169"></a>00169    <span class="keywordflow">if</span> ( <a class="code" href="a00061.html#d1213b7a82a55a9d9addaef5cd33ee69">Is_nf_512</a>() ) <span class="comment">// 512B pages</span>
<a name="l00170"></a>00170    {
<a name="l00171"></a>00171       <a class="code" href="a00061.html#b466843403d37526c75306381a6807c7">g_ofst_blk_status</a>     = 5;
<a name="l00172"></a>00172    }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    <a class="code" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a>  = <a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a> + NF_SHIFT_N_DEVICES;
<a name="l00175"></a>00175    <a class="code" href="a00062.html#7dfe2973a57e7e1ad70f55f70bbcef87">s_shift_log_block_sector</a> = <a class="code" href="a00062.html#f7c6ed8d34849f6bcf479fd89482a561">s_shift_log_page_sector</a> + <a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>;
<a name="l00176"></a>00176 <span class="preprocessor">#endif</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>
<a name="l00178"></a>00178    <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#afb99de7ef6fcb1b033ecda78ea6de3d">ctrl</a>.<a class="code" href="a00002.html#682f042876e5c6151971f573e9edace2">valid</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>; <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#afb99de7ef6fcb1b033ecda78ea6de3d">ctrl</a>.<a class="code" href="a00002.html#437f7770ddf9f42e886ac70d2d4febdd">dirty</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00179"></a>00179    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8a52216548fb199e1956d27fcf999427">valid</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>; <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8435e2b050da6630b6f0798591d1501f">dirty</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00180"></a>00180    <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>= 0xFFFFFFFF;
<a name="l00181"></a>00181 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="5bc1ea382d755aa7efeffbd008c3347a"></a><!-- doxytag: member="nf_mngt.h::nf_verify" ref="5bc1ea382d755aa7efeffbd008c3347a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_verify           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Ensure that the memory is in a good state before starting to use it. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a status: PASS if the command has been succesfully executed; FAIL else </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00202">202</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>, and <a class="el" href="a00133.html#l00066">PASS</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00203"></a>00203 {
<a name="l00204"></a>00204    <span class="keywordflow">if</span> ( <a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a> ) <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206    <span class="keywordflow">return</span> <a class="code" href="a00063.html#b3c26aadc0e38a2d67aac9080152777a" title="Ensure that the memory is in a good state before starting to use it.">nf_verify_resume</a>();
<a name="l00207"></a>00207 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="b3c26aadc0e38a2d67aac9080152777a"></a><!-- doxytag: member="nf_mngt.h::nf_verify_resume" ref="b3c26aadc0e38a2d67aac9080152777a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_verify_resume           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Ensure that the memory is in a good state before starting to use it. 
<p>
The function will scan the memory, test if the memory is valid, clean it if it has to and rebuild all the management blocks. This function shall be called prior to any use of the memory after a power-up.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>a status: PASS if the command has been succesfully executed; FAIL else </dd></dl>

<p>Definition at line <a class="el" href="a00165.html#l00196">196</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l00202">nf_verify()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00197"></a>00197 {
<a name="l00198"></a>00198    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_nb_loop;
<a name="l00199"></a>00199    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> status_bool;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="preprocessor">#if (ERASING_ALL==ENABLE)</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>   <a class="code" href="a00064.html#61dbbd370e63df5414083790a6f50b58">ut_nfc_erase_all</a>();
<a name="l00204"></a>00204 <span class="preprocessor">#endif</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>   
<a name="l00206"></a>00206    status_bool = <a class="code" href="a00064.html#88cf2da70da57c7efa94e590f5eb096f" title="Scan the memory and looks for sub-LUT, free-blocks block and recovery blocks.">nf_scan</a>();
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    <span class="keywordflow">if</span>(( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>!=status_bool )
<a name="l00209"></a>00209    || ( <a class="code" href="a00064.html#940348c8e5e33ed3bf281df02a29a39c">is_nf_invalid</a>()   )  <span class="comment">// The NF is not cleanly built</span>
<a name="l00210"></a>00210    ) {
<a name="l00211"></a>00211       <span class="comment">// The NF seems not cleanly built, or not built at all.</span>
<a name="l00212"></a>00212       <span class="comment">//</span>
<a name="l00213"></a>00213       u8_nb_loop = 0;
<a name="l00214"></a>00214       <span class="keywordflow">while</span>( 1 )
<a name="l00215"></a>00215       {
<a name="l00216"></a>00216          u8_nb_loop++;
<a name="l00217"></a>00217          <span class="keywordflow">if</span>( u8_nb_loop &gt; 2 )
<a name="l00218"></a>00218          {
<a name="l00219"></a>00219             status_bool=<a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>;
<a name="l00220"></a>00220             <span class="keywordflow">break</span>;  <span class="comment">// Error NF access or control</span>
<a name="l00221"></a>00221          }
<a name="l00222"></a>00222          <a class="code" href="a00063.html#4111df3ea1a2e262cdc7b853bad4543f" title="Cleanup the memory by erasing all the management blocks.">nf_cleanup_memory</a>();
<a name="l00223"></a>00223          <span class="keywordflow">if</span>( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> != <a class="code" href="a00064.html#88cf2da70da57c7efa94e590f5eb096f" title="Scan the memory and looks for sub-LUT, free-blocks block and recovery blocks.">nf_scan</a>() )
<a name="l00224"></a>00224             <span class="keywordflow">continue</span>;
<a name="l00225"></a>00225          <span class="keywordflow">if</span>( <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a> != <a class="code" href="a00064.html#8d5fe4e1006879a77583ee71ca95f902">nf_rebuild</a>() )
<a name="l00226"></a>00226             <span class="keywordflow">continue</span>;
<a name="l00227"></a>00227          status_bool = <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l00228"></a>00228          <span class="keywordflow">break</span>;
<a name="l00229"></a>00229       }
<a name="l00230"></a>00230    }
<a name="l00231"></a>00231    <span class="keywordflow">if</span> (status_bool==<a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>)
<a name="l00232"></a>00232    {
<a name="l00233"></a>00233       <a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a> = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00234"></a>00234       <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l00235"></a>00235       <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l00236"></a>00236    }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238    <span class="keywordflow">return</span> status_bool;
<a name="l00239"></a>00239 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="4111df3ea1a2e262cdc7b853bad4543f"></a><!-- doxytag: member="nf_mngt.h::nf_cleanup_memory" ref="4111df3ea1a2e262cdc7b853bad4543f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_cleanup_memory           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Cleanup the memory by erasing all the management blocks. 
<p>
The sub-LUT blocks, the recovery block and the free-blocks block will be erased on any devices.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="a00165.html#l00250">250</a> of file <a class="el" href="a00165.html">nf_unusual.c</a>.</p>

<p>Referenced by <a class="el" href="a00165.html#l00196">nf_verify_resume()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00251"></a>00251 {
<a name="l00252"></a>00252    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   i_dev  =0;
<a name="l00253"></a>00253    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  i_block=0;
<a name="l00254"></a>00254    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   block_valid;
<a name="l00255"></a>00255    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   block_id;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="comment">// Scan all the devices and looks for:</span>
<a name="l00258"></a>00258    <span class="comment">// - the sub-LUT</span>
<a name="l00259"></a>00259    <span class="comment">// - the recovery block</span>
<a name="l00260"></a>00260    <span class="comment">// - the free-blocks block</span>
<a name="l00261"></a>00261    <span class="comment">//</span>
<a name="l00262"></a>00262    <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; i_dev++ )
<a name="l00263"></a>00263    {
<a name="l00264"></a>00264       <span class="comment">// Select the devices</span>
<a name="l00265"></a>00265       <span class="comment">//</span>
<a name="l00266"></a>00266       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268       <span class="keywordflow">for</span>( i_block=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> ; i_block&lt;<a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a> ; i_block++ )
<a name="l00269"></a>00269       {
<a name="l00270"></a>00270 
<a name="l00271"></a>00271          <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>);
<a name="l00272"></a>00272          block_valid = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l00273"></a>00273          block_id    = <a class="code" href="a00061.html#3a9602476f480441b912a7de88d440ed">Nfc_rd_data</a>()           ;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275          <span class="keywordflow">if</span> ( block_valid!=0xFF )
<a name="l00276"></a>00276          {
<a name="l00277"></a>00277             <span class="keywordflow">continue</span>; <span class="comment">// The block is bad</span>
<a name="l00278"></a>00278          }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280          <span class="keywordflow">if</span>(( <a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a>==block_id )
<a name="l00281"></a>00281          || ( <a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a>   ==block_id ))
<a name="l00282"></a>00282          {
<a name="l00283"></a>00283             <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> ) ;
<a name="l00284"></a>00284             <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>==<a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>() )
<a name="l00285"></a>00285             {
<a name="l00286"></a>00286                <a class="code" href="a00060.html#baa6a09d1819325c231e3735177a2179" title="Mark a block as &amp;#39;invalid&amp;#39; by clearing it entirely.">nfc_mark_bad_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(i_block) );
<a name="l00287"></a>00287             }
<a name="l00288"></a>00288          }
<a name="l00289"></a>00289       } <span class="comment">// for( i_block...</span>
<a name="l00290"></a>00290    } <span class="comment">// for( i_dev...</span>
<a name="l00291"></a>00291 } <span class="comment">// nf_cleanup_memory</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="28ecafcc5c460745e3f2fc478bcd8757"></a><!-- doxytag: member="nf_mngt.h::nf_upload" ref="28ecafcc5c460745e3f2fc478bcd8757" args="(U8 _MEM_TYPE_SLOW_ *, U8)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_upload           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>datbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>loop</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Upload packets of 16 bytes from the NAND Flash to RAM. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>U8</em>&nbsp;</td><td>* datbuf pointer to RAM U8 loop number of 16 bytes packets</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l01699">1699</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, and <a class="el" href="a00162.html#l00095">Nf_rd_byte</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01700"></a>01700 {
<a name="l01701"></a>01701   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * tempbuf = datbuf;
<a name="l01702"></a>01702   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i = loop;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704   <span class="keywordflow">while</span> (i != 0)
<a name="l01705"></a>01705   {
<a name="l01706"></a>01706      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01707"></a>01707      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01708"></a>01708      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01709"></a>01709      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01710"></a>01710      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01711"></a>01711      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01712"></a>01712      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01713"></a>01713      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01714"></a>01714      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01715"></a>01715      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01716"></a>01716      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01717"></a>01717      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01718"></a>01718      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01719"></a>01719      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01720"></a>01720      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01721"></a>01721      *(tempbuf) = <a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>(); tempbuf++;
<a name="l01722"></a>01722      i--;
<a name="l01723"></a>01723   }
<a name="l01724"></a>01724 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="c42a9f16a81ddbdfc167ee679d2a7edf"></a><!-- doxytag: member="nf_mngt.h::nf_download" ref="c42a9f16a81ddbdfc167ee679d2a7edf" args="(U8 _MEM_TYPE_SLOW_ *, U8)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_download           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> _MEM_TYPE_SLOW_ *&nbsp;</td>
          <td class="paramname"> <em>datbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>loop</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Download packets of 16 bytes from RAM to the NAND Flash. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>U8</em>&nbsp;</td><td>* datbuf pointer to RAM U8 loop number of 16 bytes packets</td></tr>
  </table>
</dl>
&lt;global parameters&gt;=""&gt;<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l01663">1663</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, and <a class="el" href="a00162.html#l00096">Nf_wr_byte</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01664"></a>01664 {
<a name="l01665"></a>01665   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * tempbuf = datbuf;
<a name="l01666"></a>01666   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i = loop;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668   <span class="keywordflow">while</span> (i != 0)
<a name="l01669"></a>01669   {
<a name="l01670"></a>01670      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01671"></a>01671      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01672"></a>01672      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01673"></a>01673      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01674"></a>01674      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01675"></a>01675      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01676"></a>01676      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01677"></a>01677      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01678"></a>01678      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01679"></a>01679      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01680"></a>01680      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01681"></a>01681      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01682"></a>01682      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01683"></a>01683      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01684"></a>01684      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01685"></a>01685      <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*(tempbuf)); tempbuf++;
<a name="l01686"></a>01686      i--;
<a name="l01687"></a>01687   }
<a name="l01688"></a>01688 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f713bee0ed464d2bfa6876cd9d4ef296"></a><!-- doxytag: member="nf_mngt.h::nf_block_2_page" ref="f713bee0ed464d2bfa6876cd9d4ef296" args="(U16 block_addr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> nf_block_2_page           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>block_addr</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l00306">306</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00162.html#l00413">G_SHIFT_BLOCK_PAGE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00307"></a>00307 {
<a name="l00308"></a>00308    <span class="keywordflow">return</span> (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)block_addr&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>;
<a name="l00309"></a>00309 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="ae85309c46a253ef08a961b99657ede0"></a><!-- doxytag: member="nf_mngt.h::nf_ecc_mngt" ref="ae85309c46a253ef08a961b99657ede0" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_ecc_mngt           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f41b35e9c4b10553fb3877f8c394188c"></a><!-- doxytag: member="nf_mngt.h::nf_sync" ref="f41b35e9c4b10553fb3877f8c394188c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_sync           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="79e27718d9bc988607f630c2ff410848"></a><!-- doxytag: member="nf_mngt.h::nf_copy" ref="79e27718d9bc988607f630c2ff410848" args="(U32 copy_dst)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_copy           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td>
          <td class="paramname"> <em>copy_dst</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Copy a NF page to a new one. 
<p>
This function copies a NF page into a new page. It uses the copy-back command if it is possible.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>g_copy_src</em>&nbsp;</td><td>(global) Source page address </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>copy_dst</em>&nbsp;</td><td>Recipient page address </td></tr>
  </table>
</dl>

<p>Definition at line <a class="el" href="a00163.html#l01859">1859</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00162.html#l00385">G_COPY_BACK_CONT</a>, <a class="el" href="a00162.html#l00386">G_COPY_BACK_DISCONT</a>, <a class="el" href="a00162.html#l00384">G_N_ROW_CYCLES</a>, <a class="el" href="a00162.html#l00382">G_N_ZONES</a>, <a class="el" href="a00162.html#l00413">G_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00162.html#l00409">Is_nf_2k</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00207">LSB0</a>, <a class="el" href="a00133.html#l00208">LSB1</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00133.html#l00204">MSB1</a>, <a class="el" href="a00163.html#l01663">nf_download()</a>, <a class="el" href="a00162.html#l00299">NF_PAGE_PROGRAM_CMD</a>, <a class="el" href="a00162.html#l00301">NF_RANDOM_DATA_INPUT_CMD</a>, <a class="el" href="a00162.html#l00416">NF_SPARE_POS</a>, <a class="el" href="a00163.html#l01699">nf_upload()</a>, <a class="el" href="a00161.html#l00558">nfc_copy_back_init()</a>, <a class="el" href="a00162.html#l00355">NFC_OFST_3_DATA_DST</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00161.html#l00239">nfc_open_page_write()</a>, <a class="el" href="a00162.html#l00112">Nfc_set_adc</a>, <a class="el" href="a00162.html#l00113">Nfc_set_adr</a>, <a class="el" href="a00162.html#l00107">Nfc_set_cmd</a>, <a class="el" href="a00162.html#l00353">NFC_SPARE_OFST_3_BYTE_3</a>, <a class="el" href="a00162.html#l00363">NFC_SPARE_OFST_6_LBA</a>, <a class="el" href="a00162.html#l00114">Nfc_unprotect_all_flash</a>, and <a class="el" href="a00162.html#l00111">Nfc_wr_data</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01860"></a>01860 {
<a name="l01861"></a>01861    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> b_copy_fast;
<a name="l01862"></a>01862    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   zone_A, zone_B;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864    <span class="comment">// Compute the possibility of fast copy</span>
<a name="l01865"></a>01865    <span class="keywordflow">if</span>( 0 == <a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a> )
<a name="l01866"></a>01866    {
<a name="l01867"></a>01867       b_copy_fast = 0;     <span class="comment">// never possible</span>
<a name="l01868"></a>01868    }
<a name="l01869"></a>01869    <span class="keywordflow">else</span>
<a name="l01870"></a>01870    {
<a name="l01871"></a>01871       <span class="keywordflow">if</span>( (1 == <a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>) &amp;&amp; (1==<a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>) )
<a name="l01872"></a>01872       {
<a name="l01873"></a>01873          b_copy_fast = 1;  <span class="comment">// always possible</span>
<a name="l01874"></a>01874       }
<a name="l01875"></a>01875       <span class="keywordflow">else</span>
<a name="l01876"></a>01876       {
<a name="l01877"></a>01877          <span class="comment">// Check block address</span>
<a name="l01878"></a>01878          b_copy_fast = 1;  <span class="comment">// by default possible</span>
<a name="l01879"></a>01879          <span class="keywordflow">if</span>( 1 != <a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a> )
<a name="l01880"></a>01880          {
<a name="l01881"></a>01881 <span class="comment">/*</span>
<a name="l01882"></a>01882 <span class="comment">            zone_A = (g_copy_src&gt;&gt;G_SHIFT_BLOCK_PAGE) / ((U16)G_N_BLOCKS/G_COPY_BACK_CONT);</span>
<a name="l01883"></a>01883 <span class="comment">            zone_B = (copy_dst  &gt;&gt;G_SHIFT_BLOCK_PAGE) / ((U16)G_N_BLOCKS/G_COPY_BACK_CONT);</span>
<a name="l01884"></a>01884 <span class="comment">*/</span>
<a name="l01885"></a>01885             <span class="comment">// block_zone = page add / number of page / 1024</span>
<a name="l01886"></a>01886             <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l01887"></a>01887             {
<a name="l01888"></a>01888                <span class="comment">// block_zone = (page add &gt;&gt; (G_SHIFT_BLOCK_PAGE + 10)) / (G_N_ZONES/G_COPY_BACK_CONT);</span>
<a name="l01889"></a>01889                <span class="comment">// block_zone = ((page add &gt;&gt; 16) * G_COPY_BACK_CONT) / G_N_ZONES;</span>
<a name="l01890"></a>01890                zone_A = (<a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(<a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>)*<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>)/<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01891"></a>01891                zone_B = (<a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(copy_dst  )*<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>)/<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01892"></a>01892             }<span class="keywordflow">else</span>{
<a name="l01893"></a>01893                <span class="comment">// block_zone = page add &gt;&gt; (G_SHIFT_BLOCK_PAGE + 10) / (G_N_ZONES/G_COPY_BACK_CONT);</span>
<a name="l01894"></a>01894                zone_A = ((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(<a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>&gt;&gt;(<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> + 10)) *<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>) /<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01895"></a>01895                zone_B = ((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(copy_dst  &gt;&gt;(<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> + 10)) *<a class="code" href="a00061.html#7c58fe9f6485fa8f05d7198ab500179d">G_COPY_BACK_CONT</a>) /<a class="code" href="a00061.html#55533de21e4e26eacb813e07cb1150b0">G_N_ZONES</a>;
<a name="l01896"></a>01896             }
<a name="l01897"></a>01897             <span class="keywordflow">if</span>( zone_A != zone_B )
<a name="l01898"></a>01898                b_copy_fast = 0;     <span class="comment">// no possible</span>
<a name="l01899"></a>01899          }
<a name="l01900"></a>01900          <span class="keywordflow">if</span>( 1 != <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a> )
<a name="l01901"></a>01901          {
<a name="l01902"></a>01902 <span class="comment">// define mandatory to delete compile error on MODULO 0</span>
<a name="l01903"></a>01903 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE) || (NF_AUTO_DETECT_2KB==TRUE) || (NF_AUTO_DETECT_512B==TRUE)</span>
<a name="l01904"></a>01904 <span class="preprocessor"></span>            zone_A = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>&gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01905"></a>01905             zone_B = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)copy_dst  &gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01906"></a>01906 <span class="preprocessor">#elif ( G_COPY_BACK_DISCONT != 0 )</span>
<a name="l01907"></a>01907 <span class="preprocessor"></span>            zone_A = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>&gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01908"></a>01908             zone_B = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)copy_dst  &gt;&gt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>) % <a class="code" href="a00061.html#8ba6ce5d7c8560f7c591a66516e167ac">G_COPY_BACK_DISCONT</a>;
<a name="l01909"></a>01909 <span class="preprocessor">#endif</span>
<a name="l01910"></a>01910 <span class="preprocessor"></span>            <span class="keywordflow">if</span>( zone_A != zone_B )
<a name="l01911"></a>01911                b_copy_fast = 0;     <span class="comment">// no possible</span>
<a name="l01912"></a>01912          }
<a name="l01913"></a>01913       }
<a name="l01914"></a>01914    }
<a name="l01915"></a>01915       
<a name="l01916"></a>01916    <span class="comment">// Start copy</span>
<a name="l01917"></a>01917    <span class="keywordflow">if</span>( !b_copy_fast )
<a name="l01918"></a>01918    {
<a name="l01919"></a>01919       <span class="comment">// copy the page of the old block in buffer</span>
<a name="l01920"></a>01920       <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>, 0 );
<a name="l01921"></a>01921       <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(                                <span class="comment">// Works by packet of 16 bytes</span>
<a name="l01922"></a>01922          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>
<a name="l01923"></a>01923       ,     ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-4))     <span class="comment">// Data zone (Page size / 16)</span>
<a name="l01924"></a>01924          +  ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-5-4))); <span class="comment">// Spare zone (Page size / 32 / 16)</span>
<a name="l01925"></a>01925 
<a name="l01926"></a>01926       <span class="comment">// Add LBA markers to help recovery function</span>
<a name="l01927"></a>01927       <span class="comment">// Need to explain a bit why LBA are written: </span>
<a name="l01928"></a>01928       <span class="comment">// nf_copy is called from copy_head and copy_tail.</span>
<a name="l01929"></a>01929       <span class="comment">// - copy_head: need to write all the LBA of the pages to help recovery finding</span>
<a name="l01930"></a>01930       <span class="comment">//   where the last sector is written.</span>
<a name="l01931"></a>01931       <span class="comment">//   Moreover, in case that nf_copy is called from copy_head and source block at page 0</span>
<a name="l01932"></a>01932       <span class="comment">//   does not contain LBA.</span>
<a name="l01933"></a>01933       <span class="comment">// - copy_tail: no need to mark the last LBA of the last page to identify the source</span>
<a name="l01934"></a>01934       <span class="comment">//   block since we use another method</span>
<a name="l01935"></a>01935       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>] = <a class="code" href="a00061.html#98a49853a649a262cd8c415d568e92f3">NFC_OFST_3_DATA_DST</a>;  <span class="comment">// 3- [SW] Source block (recovery) (HW capability not used)</span>
<a name="l01936"></a>01936       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>   ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>);  <span class="comment">// 6- LBA</span>
<a name="l01937"></a>01937       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1 ] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>);  <span class="comment">// 7- LBA</span>
<a name="l01938"></a>01938       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l01939"></a>01939       {
<a name="l01940"></a>01940          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ] =
<a name="l01941"></a>01941          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ] =
<a name="l01942"></a>01942          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>  ] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>);  <span class="comment">// 6- LBA</span>
<a name="l01943"></a>01943          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1] =
<a name="l01944"></a>01944          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1] =
<a name="l01945"></a>01945          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> +16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>+1] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>);  <span class="comment">// 7- LBA</span>
<a name="l01946"></a>01946       }
<a name="l01947"></a>01947 
<a name="l01948"></a>01948       <span class="comment">// copy the buffer in the page of the new block</span>
<a name="l01949"></a>01949       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( copy_dst, 0 );
<a name="l01950"></a>01950       <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(                                <span class="comment">// Works by packet of 16 bytes</span>
<a name="l01951"></a>01951          <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>
<a name="l01952"></a>01952       ,     ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-4))       <span class="comment">// Data zone (Page size / 16)</span>
<a name="l01953"></a>01953          +  ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-5-4)));  <span class="comment">// Spare zone (Page size / 32 / 16)</span>
<a name="l01954"></a>01954       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l01955"></a>01955    }
<a name="l01956"></a>01956    <span class="keywordflow">else</span>
<a name="l01957"></a>01957    {
<a name="l01958"></a>01958       <a class="code" href="a00060.html#b9ba38cddb62690e76858546804fac2c" title="Prepare a copy-back session.">nfc_copy_back_init</a>( <a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a> );
<a name="l01959"></a>01959 
<a name="l01960"></a>01960       <a class="code" href="a00061.html#ac6eab632f7d904222094b7994cda033">Nfc_unprotect_all_flash</a>();                              <span class="comment">// WP may be actif due to block protection</span>
<a name="l01961"></a>01961       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01962"></a>01962       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>)%256 );
<a name="l01963"></a>01963       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#a21795d25cf7b6c5fe5d5e205cac92b2">NFC_SPARE_OFST_3_BYTE_3</a>)/256 );
<a name="l01964"></a>01964       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(copy_dst) );
<a name="l01965"></a>01965       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#2d1e45154b07481f0579ecc725e4edff">LSB1</a>(copy_dst) );
<a name="l01966"></a>01966       <span class="keywordflow">if</span> ( 3==<a class="code" href="a00061.html#26193f60c442075fc7fdf8022b04c489">G_N_ROW_CYCLES</a> )
<a name="l01967"></a>01967       {
<a name="l01968"></a>01968          <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(copy_dst) );
<a name="l01969"></a>01969       }
<a name="l01970"></a>01970 
<a name="l01971"></a>01971       <span class="comment">// Remove Source block mask</span>
<a name="l01972"></a>01972       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#98a49853a649a262cd8c415d568e92f3">NFC_OFST_3_DATA_DST</a> );
<a name="l01973"></a>01973 
<a name="l01974"></a>01974       <span class="comment">// Add LBA markers to help recovery function</span>
<a name="l01975"></a>01975       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01976"></a>01976       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01977"></a>01977       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>+<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01978"></a>01978       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01979"></a>01979       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01980"></a>01980 
<a name="l01981"></a>01981       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l01982"></a>01982       {
<a name="l01983"></a>01983          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01984"></a>01984          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01985"></a>01985          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*1 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01986"></a>01986          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01987"></a>01987          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01988"></a>01988 
<a name="l01989"></a>01989          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01990"></a>01990          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01991"></a>01991          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*2 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01992"></a>01992          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01993"></a>01993          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01994"></a>01994 
<a name="l01995"></a>01995          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01996"></a>01996          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)%256 );
<a name="l01997"></a>01997          <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + 16*3 +<a class="code" href="a00061.html#541bc42ea0ce5ece317663b6330270e1">NFC_SPARE_OFST_6_LBA</a>)/256 );
<a name="l01998"></a>01998          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l01999"></a>01999          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#5e2bdb520dead632ea38327b3ce2d876">g_log_block_id</a>) );
<a name="l02000"></a>02000       }
<a name="l02001"></a>02001       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l02002"></a>02002    }
<a name="l02003"></a>02003 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="4033ef04a3cbd39dc9d6071c6d7c2a9b"></a><!-- doxytag: member="nf_mngt.h::nf_write_lut" ref="4033ef04a3cbd39dc9d6071c6d7c2a9b" args="(U8 pos, U8 i_sub_lut, U16 sub_lut_log_sz)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_write_lut           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>pos</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>i_sub_lut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>sub_lut_log_sz</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Writes a LUT in memory from a buffer. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pos</em>&nbsp;</td><td>offset of the lub-lut in the buffer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>i_sub_lut</em>&nbsp;</td><td>id of the sub-LUT </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sub_lut_log_sz</em>&nbsp;</td><td>Size of the sub-LUT, in logical block unit</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>nothing </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l01213">1213</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00164.html#l00118">_debug</a>, <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00133.html#l00067">FAIL</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00164.html#l00077">NF_PAGE_BUFFER_SIZE</a>, <a class="el" href="a00162.html#l00299">NF_PAGE_PROGRAM_CMD</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00346">NFC_BLK_ID_SUBLUT</a>, <a class="el" href="a00161.html#l00203">nfc_check_status()</a>, <a class="el" href="a00161.html#l00239">nfc_open_page_write()</a>, <a class="el" href="a00162.html#l00107">Nfc_set_cmd</a>, <a class="el" href="a00162.html#l00111">Nfc_wr_data</a>, <a class="el" href="a00133.html#l00066">PASS</a>, <a class="el" href="a00164.html#l00115">S_MNGT_DEV</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00102">trace_hex()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, and <a class="el" href="a00144.html#l00131">trace_nl()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01217"></a>01217 {
<a name="l01218"></a>01218    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  block_addr; <span class="comment">// Physical block number</span>
<a name="l01219"></a>01219    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * p_buf=<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a> + (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)pos*((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>));
<a name="l01220"></a>01220 
<a name="l01221"></a>01221    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01222"></a>01222    <span class="comment">// The buffer is built as:</span>
<a name="l01223"></a>01223    <span class="comment">// |    512    |    512    |    512    |    512    |</span>
<a name="l01224"></a>01224    <span class="comment">//</span>
<a name="l01225"></a>01225    <span class="comment">// The page is built as:</span>
<a name="l01226"></a>01226    <span class="comment">// |    512    |    512    |    512    |    512    |SZ|</span>
<a name="l01227"></a>01227    <span class="comment">//</span>
<a name="l01228"></a>01228    <span class="comment">// The LUT fits in a physical page.</span>
<a name="l01229"></a>01229    <span class="comment">//</span>
<a name="l01230"></a>01230    <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>(
<a name="l01231"></a>01231       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a>[i_sub_lut] ) <span class="comment">// base address</span>
<a name="l01232"></a>01232    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)(<a class="code" href="a00062.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[i_sub_lut])            <span class="comment">// offset to sub-LUT</span>
<a name="l01233"></a>01233    ,  0 );
<a name="l01234"></a>01234 
<a name="l01235"></a>01235    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_write_lut;"</span>);<a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#d7432ad6a5432e1eaab6ec356ea36595">g_lut_block_addr</a>[i_sub_lut]); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#97866e5e933474938c38cd599ee85d3c">g_lut_block_index</a>[i_sub_lut]);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01236"></a>01236    <span class="keywordflow">for</span>( block_addr=0 ; block_addr&lt;((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-1)) ; block_addr+=1 )
<a name="l01237"></a>01237    {
<a name="l01238"></a>01238       <span class="keywordflow">if</span> ( block_addr&lt;(sub_lut_log_sz*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>) )
<a name="l01239"></a>01239       {
<a name="l01240"></a>01240 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01241"></a>01241 <span class="preprocessor"></span>         <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(           ( block_addr*2)&lt;(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>-1) );
<a name="l01242"></a>01242          <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= p_buf[ block_addr*2   ] ;
<a name="l01243"></a>01243          <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= p_buf[ block_addr*2 +1] ;
<a name="l01244"></a>01244          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l01245"></a>01245          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01246"></a>01246 <span class="preprocessor">#endif</span>
<a name="l01247"></a>01247 <span class="preprocessor"></span>         <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( p_buf[ block_addr*2   ] );
<a name="l01248"></a>01248          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( p_buf[ block_addr*2 +1] );
<a name="l01249"></a>01249          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(p_buf[ block_addr*2   ]);
<a name="l01250"></a>01250          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>(p_buf[ block_addr*2 +1]);
<a name="l01251"></a>01251          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"-"</span>);
<a name="l01252"></a>01252       }
<a name="l01253"></a>01253       <span class="keywordflow">else</span>
<a name="l01254"></a>01254       {
<a name="l01255"></a>01255          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01256"></a>01256          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01257"></a>01257          <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"FFFF-"</span>);
<a name="l01258"></a>01258       }
<a name="l01259"></a>01259    }
<a name="l01260"></a>01260    <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01261"></a>01261 
<a name="l01262"></a>01262    <span class="comment">// Write the spare information</span>
<a name="l01263"></a>01263    <span class="comment">//</span>
<a name="l01264"></a>01264    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF              );                              <span class="comment">// 0- block is valid (for 2048 compatibility)</span>
<a name="l01265"></a>01265    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#974cae7c6c942b71e22d685bdb3c2107">NFC_BLK_ID_SUBLUT</a> );                              <span class="comment">// 1- sub-LUT</span>
<a name="l01266"></a>01266    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( i_sub_lut         );                              <span class="comment">// 2- sub-LUT id</span>
<a name="l01267"></a>01267    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF              );                              <span class="comment">// 3- unused</span>
<a name="l01268"></a>01268    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00062.html#b0117365e494c0e841a78464f9d26db3">g_n_sub_lut</a>       );                              <span class="comment">// 4- number of sub-LUT</span>
<a name="l01269"></a>01269    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF              );                              <span class="comment">// 5- block is valid (for 512 compatibility)</span>
<a name="l01270"></a>01270    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(sub_lut_log_sz) );                            <span class="comment">// 6-7 Number of log blocks in sub-LUT</span>
<a name="l01271"></a>01271    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(sub_lut_log_sz) );
<a name="l01272"></a>01272    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 8-9-10-   ECC2</span>
<a name="l01273"></a>01273    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                      <span class="comment">// 11-12-    LBA</span>
<a name="l01274"></a>01274    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 13-14-15- ECC1</span>
<a name="l01275"></a>01275 
<a name="l01276"></a>01276    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a> );
<a name="l01277"></a>01277    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>==<a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>; }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l01280"></a>01280 } <span class="comment">// end of nf_write_lut</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="020f4fb7d7d55f3fad9c368ac04cabf3"></a><!-- doxytag: member="nf_mngt.h::nf_write_fbb" ref="020f4fb7d7d55f3fad9c368ac04cabf3" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> nf_write_fbb           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Writes the Free-blocks block into the Nand Flash. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>nothing </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l01417">1417</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00067">FAIL</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00162.html#l00299">NF_PAGE_PROGRAM_CMD</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00348">NFC_BLK_ID_FBB</a>, <a class="el" href="a00161.html#l00203">nfc_check_status()</a>, <a class="el" href="a00162.html#l00358">NFC_OFST_4_FBB_DRIVER_RELEASE</a>, <a class="el" href="a00162.html#l00364">NFC_OFST_6_FBB_VALID</a>, <a class="el" href="a00161.html#l00239">nfc_open_page_write()</a>, <a class="el" href="a00162.html#l00107">Nfc_set_cmd</a>, <a class="el" href="a00162.html#l00111">Nfc_wr_data</a>, <a class="el" href="a00133.html#l00066">PASS</a>, and <a class="el" href="a00164.html#l00115">S_MNGT_DEV</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01418"></a>01418 {
<a name="l01419"></a>01419    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01422"></a>01422    <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>(
<a name="l01423"></a>01423       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a> )  <span class="comment">// base address</span>
<a name="l01424"></a>01424    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)<a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>               <span class="comment">// offset to Free-blocks block entry</span>
<a name="l01425"></a>01425    , 0 );
<a name="l01426"></a>01426    <span class="keywordflow">for</span> ( u16_tmp=0 ; u16_tmp&lt;((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a>-1)) ; )
<a name="l01427"></a>01427    {
<a name="l01428"></a>01428       <span class="keywordflow">if</span> ( u16_tmp&lt;<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a> )
<a name="l01429"></a>01429       {
<a name="l01430"></a>01430          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[2*u16_tmp   ] );
<a name="l01431"></a>01431          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[2*u16_tmp +1] );
<a name="l01432"></a>01432       }
<a name="l01433"></a>01433       <span class="keywordflow">else</span>
<a name="l01434"></a>01434       {
<a name="l01435"></a>01435          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01436"></a>01436          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );
<a name="l01437"></a>01437       }
<a name="l01438"></a>01438       u16_tmp++;
<a name="l01439"></a>01439    }
<a name="l01440"></a>01440    <span class="comment">// Write the spare information</span>
<a name="l01441"></a>01441    <span class="comment">//</span>
<a name="l01442"></a>01442    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                                           <span class="comment">// 0- block is valid (for 2048 compatibility)</span>
<a name="l01443"></a>01443    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#c025edc74717298e57de75859117dc1e">NFC_BLK_ID_FBB</a> );                                 <span class="comment">// 1- Free-blocks block</span>
<a name="l01444"></a>01444    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>));                            <span class="comment">// 2-3 Number of free blocks</span>
<a name="l01445"></a>01445    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>));
<a name="l01446"></a>01446    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#5df984b9f7ef87bb85401f4fb7978908">NFC_OFST_4_FBB_DRIVER_RELEASE</a> );                  <span class="comment">// 4- Nand-Flash driver ID</span>
<a name="l01447"></a>01447    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                                           <span class="comment">// 5- block is valid (for 512 compatibility)</span>
<a name="l01448"></a>01448    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00061.html#6fd751d12dbd6e385f256152224b6635">NFC_OFST_6_FBB_VALID</a> );                           <span class="comment">// 6- FBB-LUTs valid</span>
<a name="l01449"></a>01449    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF );                                           <span class="comment">// 7- Unused</span>
<a name="l01450"></a>01450    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 8-9-10-   Unused</span>
<a name="l01451"></a>01451    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>));                          <span class="comment">// 11-12- Number of exported blocks</span>
<a name="l01452"></a>01452    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#b81e89341b6c9fc2a9c43f2d15f58f3d">g_n_export_blocks</a>));
<a name="l01453"></a>01453    <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>( 0xFF ); <span class="comment">// 13-14-15- Unused</span>
<a name="l01454"></a>01454 
<a name="l01455"></a>01455    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a> );
<a name="l01456"></a>01456    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>==<a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>; }
<a name="l01457"></a>01457    <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>;
<a name="l01458"></a>01458 } <span class="comment">// end of nf_write_fbb</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="524dde7169bece3f9ce79e1c56d7412b"></a><!-- doxytag: member="nf_mngt.h::nf_cache_fbb_refill" ref="524dde7169bece3f9ce79e1c56d7412b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_cache_fbb_refill           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Reload the FBB cache memory, starting from 0. 
<p>
The cache is filled with physical blocks.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>nothing </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l01049">1049</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00164.html#l00150">CACHE_FBB_SIZE</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00288">Min</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00136.html#l00103">NF_CACHE_FBB_LOG_SZ</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00162.html#l00110">Nfc_rd_data_fetch_next</a>, <a class="el" href="a00164.html#l00115">S_MNGT_DEV</a>, <a class="el" href="a00162.html#l00335">SIZE_PAGE_BYTE</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01050"></a>01050 {
<a name="l01051"></a>01051    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp;
<a name="l01052"></a>01052    <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr;
<a name="l01053"></a>01053    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8435e2b050da6630b6f0798591d1501f">dirty</a>==<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>); <span class="comment">// No refill if the cache is dirty</span>
<a name="l01056"></a>01056    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#bbfbdec71ac19ebd0a651bc24f4fd3a4">p</a>   = 0;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_fbb_refill;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01059"></a>01059 
<a name="l01060"></a>01060    <span class="comment">// Ensure that the cache is bigger than the real number of free blocks</span>
<a name="l01061"></a>01061    <span class="comment">//</span>
<a name="l01062"></a>01062    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#b185b551daa6cbea86c6b06fec920762">max</a> = <a class="code" href="a00032.html#9e04209162ea72f9985338596262b657">Min</a>(<a class="code" href="a00035.html#0ce1ce03181970b15e3d306dd9e827bb">NF_CACHE_FBB_LOG_SZ</a>, (<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>&gt;&gt;NF_SHIFT_N_DEVICES) ); <span class="comment">// Last included</span>
<a name="l01063"></a>01063 
<a name="l01064"></a>01064    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066    page_addr =
<a name="l01067"></a>01067       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>  ) <span class="comment">// base address</span>
<a name="l01068"></a>01068    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)<a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>               <span class="comment">// offset to Free-blocks block entry</span>
<a name="l01069"></a>01069    ;
<a name="l01070"></a>01070    byte_addr=0;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(page_addr, 0);
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#b185b551daa6cbea86c6b06fec920762">max</a>*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01075"></a>01075    { <span class="comment">// fill the cache buffer</span>
<a name="l01076"></a>01076       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_tmp&lt;<a class="code" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a>);
<a name="l01077"></a>01077       <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]) = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01078"></a>01078       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]) = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01079"></a>01079       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l01080"></a>01080       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01081"></a>01081       byte_addr+=2;
<a name="l01082"></a>01082       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;<a class="code" href="a00061.html#d68699283962590b223fb226e78739c5">SIZE_PAGE_BYTE</a>); <span class="comment">// Should stay in the page. Algo limitation.</span>
<a name="l01083"></a>01083    }
<a name="l01084"></a>01084    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8a52216548fb199e1956d27fcf999427">valid</a> = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01085"></a>01085 } <span class="comment">// end of nf_cache_fbb_refill</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="1a579e74d337851734361358c99c603e"></a><!-- doxytag: member="nf_mngt.h::nf_swap" ref="1a579e74d337851734361358c99c603e" args="(U8 dev_id, U8 u8_ofst_lut, U8 u8_ofst_fbb)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_swap           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>dev_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>u8_ofst_lut</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>u8_ofst_fbb</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Swap 2 blocks from the LUT and the FBB. 
<p>
This function swaps 2 blocks: one taken into the LUT according to the LBA, and one from the FBB. This is used when modifying a block. The g_block_to_kill[] holds the block address source (LUT) that will be erased after processing.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>dev_id</em>&nbsp;</td><td>Device Id of recipient page </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>u8_ofst_lut</em>&nbsp;</td><td>block offset in LUT </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>u8_ofst_fbb</em>&nbsp;</td><td>block offset in FBB</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l02021">2021</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00164.html#l00150">CACHE_FBB_SIZE</a>, <a class="el" href="a00164.html#l00137">CACHE_LUT_SIZE</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00126">trace_hex32()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, <a class="el" href="a00144.html#l00092">trace_u8()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l02022"></a>02022 {
<a name="l02023"></a>02023    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( dev_id      &lt; <a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>  );
<a name="l02024"></a>02024    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_ofst_lut &lt; <a class="code" href="a00063.html#2df50aa01ce5b4700edbd9d48534d662">CACHE_LUT_SIZE</a>);
<a name="l02025"></a>02025    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_ofst_fbb &lt; <a class="code" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a>);
<a name="l02026"></a>02026    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#3cd2f9a20eddc59b8f7dead8ea956643">mem</a>[u8_ofst_lut]  &gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l02027"></a>02027    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#3cd2f9a20eddc59b8f7dead8ea956643">mem</a>[u8_ofst_lut]  &lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l02028"></a>02028    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_ofst_fbb]  &gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l02029"></a>02029    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_ofst_fbb]  &lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l02030"></a>02030    <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[dev_id     ] = <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#3cd2f9a20eddc59b8f7dead8ea956643">mem</a>[u8_ofst_lut] ;
<a name="l02031"></a>02031    <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#3cd2f9a20eddc59b8f7dead8ea956643">mem</a>[u8_ofst_lut] = <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_ofst_fbb] ;
<a name="l02032"></a>02032    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_ofst_fbb] = <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[dev_id]      ;
<a name="l02033"></a>02033    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_cache_lut.mem["</span>); <a class="code" href="a00043.html#d4bede103a48a856e8360af858be6c7a" title="Fonction used to display a byte value in the decimal form on OCD/Serial Debug Interface...">trace_u8</a>(u8_ofst_lut); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"] = "</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#3cd2f9a20eddc59b8f7dead8ea956643">mem</a>[u8_ofst_lut]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l02034"></a>02034    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"g_cache_fbb.mem["</span>); <a class="code" href="a00043.html#d4bede103a48a856e8360af858be6c7a" title="Fonction used to display a byte value in the decimal form on OCD/Serial Debug Interface...">trace_u8</a>(u8_ofst_fbb); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"] = "</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_ofst_fbb]); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l02035"></a>02035 
<a name="l02036"></a>02036    <span class="comment">// both FBB and LUT caches becomes invalid</span>
<a name="l02037"></a>02037    <a class="code" href="a00062.html#34b0c74ff891c7c0b314cc27a7fb1307">g_cache_lut</a>.<a class="code" href="a00002.html#afb99de7ef6fcb1b033ecda78ea6de3d">ctrl</a>.<a class="code" href="a00002.html#437f7770ddf9f42e886ac70d2d4febdd">dirty</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02038"></a>02038    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8435e2b050da6630b6f0798591d1501f">dirty</a>=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02039"></a>02039 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="5fb0e3f2e7220e43f6185c10231d09c8"></a><!-- doxytag: member="nf_mngt.h::nf_cache_fbb_flush" ref="5fb0e3f2e7220e43f6185c10231d09c8" args="(Bool)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_cache_fbb_flush           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td>
          <td class="paramname"> <em>b_ecc_err</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Flushes the FBB cache into a new FBB entry. 
<p>
A copy of the current FBB is made in a new page, taking into account the last FBB modification in its cache. If the block containing the FBB is full, a new block is taken from the FBB itself.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>b_ecc_err</em>&nbsp;</td><td>FALSE: normal operation, b_ecc_err TRUE: remove a block from list (p)</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>nothing </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l01295">1295</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00164.html#l00118">_debug</a>, <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00145.html#l00076">Assert</a>, <a class="el" href="a00164.html#l00150">CACHE_FBB_SIZE</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00383">G_N_BLOCKS</a>, <a class="el" href="a00162.html#l00413">G_SHIFT_BLOCK_PAGE</a>, <a class="el" href="a00133.html#l00200">LSB</a>, <a class="el" href="a00133.html#l00199">MSB</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00164.html#l00121">Nf_check_fbb</a>, <a class="el" href="a00164.html#l00122">Nf_check_lut</a>, <a class="el" href="a00164.html#l00082">NF_FULL_PAGE_BUFFER_SIZE</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00164.html#l00077">NF_PAGE_BUFFER_SIZE</a>, <a class="el" href="a00163.html#l01417">nf_write_fbb()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00161.html#l00302">nfc_erase_block()</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00162.html#l00110">Nfc_rd_data_fetch_next</a>, <a class="el" href="a00164.html#l00115">S_MNGT_DEV</a>, <a class="el" href="a00162.html#l00335">SIZE_PAGE_BYTE</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01296"></a>01296 {
<a name="l01297"></a>01297    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  page_addr;
<a name="l01298"></a>01298    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  byte_addr;
<a name="l01299"></a>01299    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_delete=0;
<a name="l01300"></a>01300    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  u16_tmp;
<a name="l01301"></a>01301    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   u8_tmp;
<a name="l01302"></a>01302    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   u8_pos;
<a name="l01303"></a>01303    <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> bool_delete=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8a52216548fb199e1956d27fcf999427">valid</a>);
<a name="l01306"></a>01306    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8435e2b050da6630b6f0798591d1501f">dirty</a>);
<a name="l01307"></a>01307    <span class="comment">// Assert(g_cache_fbb.p==(g_cache_fbb.max-1)); This is no more the case for ECC error not correctable</span>
<a name="l01308"></a>01308 
<a name="l01309"></a>01309    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_fbb_flush;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01312"></a>01312 
<a name="l01313"></a>01313    page_addr=
<a name="l01314"></a>01314       <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>  )  <span class="comment">// base address</span>
<a name="l01315"></a>01315    +  (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)<a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>                <span class="comment">// offset to page</span>
<a name="l01316"></a>01316    ;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a>++;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320    <span class="keywordflow">if</span> ( <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a> ==  (1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>)/(1&lt;&lt;0) )
<a name="l01321"></a>01321    {  <span class="comment">// Need to recycle the FBB block itself, using a free-block ! This is always possible</span>
<a name="l01322"></a>01322       <span class="comment">// since there is always a free block (.p=.max-1) specially for that purpose.</span>
<a name="l01323"></a>01323       byte_addr = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#bbfbdec71ac19ebd0a651bc24f4fd3a4">p</a> + <a class="code" href="a00063.html#85f227c39b86316cd59782313371c343">S_MNGT_DEV</a>);
<a name="l01324"></a>01324 
<a name="l01325"></a>01325       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[byte_addr]&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l01326"></a>01326       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[byte_addr]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01327"></a>01327       u16_delete                 = <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>           ;
<a name="l01328"></a>01328       <a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>           = <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[byte_addr] ;
<a name="l01329"></a>01329       <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[byte_addr] = u16_delete;
<a name="l01330"></a>01330       <a class="code" href="a00062.html#3703ab21f7019db569a8e08575e55670">g_fbb_block_index</a> = 0;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_cache_fbb_flush;swap;"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#6e9c9f3ede7e115a0c22ab8c0b315590">g_fbb_block_addr</a>);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01333"></a>01333       
<a name="l01334"></a>01334       <span class="comment">// g_cache_fbb.ctrl.dirty=TRUE; This is already the case !</span>
<a name="l01335"></a>01335 
<a name="l01336"></a>01336       <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#bbfbdec71ac19ebd0a651bc24f4fd3a4">p</a>++;
<a name="l01337"></a>01337       bool_delete=<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01338"></a>01338    }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340    <span class="keywordflow">if</span>( !b_ecc_err )  { u8_pos = <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#bbfbdec71ac19ebd0a651bc24f4fd3a4">p</a>;   }
<a name="l01341"></a>01341    <span class="keywordflow">else</span>              { u8_pos = <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#b185b551daa6cbea86c6b06fec920762">max</a>; }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343    byte_addr = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*2*u8_pos);
<a name="l01344"></a>01344 
<a name="l01345"></a>01345    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( byte_addr&lt;<a class="code" href="a00061.html#d68699283962590b223fb226e78739c5">SIZE_PAGE_BYTE</a> );
<a name="l01346"></a>01346 
<a name="l01347"></a>01347    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, byte_addr);
<a name="l01348"></a>01348 
<a name="l01349"></a>01349    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#bbfbdec71ac19ebd0a651bc24f4fd3a4">p</a>&lt;=(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>/<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>) );
<a name="l01350"></a>01350    <span class="keywordflow">for</span> (
<a name="l01351"></a>01351       u16_tmp=0
<a name="l01352"></a>01352    ;  u16_tmp&lt;((<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>/<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>)-u8_pos)*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>*2
<a name="l01353"></a>01353    ; )
<a name="l01354"></a>01354    {  <span class="comment">// Move the free-blocks after &lt;pos&gt; to the beginning of the buffer.</span>
<a name="l01355"></a>01355       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp&lt;(<a class="code" href="a00063.html#274b9bbe013bba444abdaed38d651735">NF_PAGE_BUFFER_SIZE</a>-3) );
<a name="l01356"></a>01356       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp++] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01357"></a>01357       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp++] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l01358"></a>01358 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span>      <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp-2];
<a name="l01360"></a>01360       <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp-1];
<a name="l01361"></a>01361       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l01362"></a>01362       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01363"></a>01363 <span class="preprocessor">#endif</span>
<a name="l01364"></a>01364 <span class="preprocessor"></span>   }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366    <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;(u8_pos*<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a>); u8_tmp++ )
<a name="l01367"></a>01367    {  <span class="comment">// Then add the cache content</span>
<a name="l01368"></a>01368       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u8_tmp &lt; <a class="code" href="a00063.html#4385406f8199c1f4bc1db06d58e4bf6e">CACHE_FBB_SIZE</a> );
<a name="l01369"></a>01369       <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp&lt; <a class="code" href="a00063.html#f80c4ce07be5eb80f1fa7e96dd19aa8a">NF_FULL_PAGE_BUFFER_SIZE</a> );
<a name="l01370"></a>01370 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span>      <span class="comment">// When coming from ECC 2-bits error, an entry has been removed</span>
<a name="l01372"></a>01372       <span class="comment">// from the cache, so the last entry is 0xffff</span>
<a name="l01373"></a>01373       <span class="keywordflow">if</span>( !b_ecc_err )
<a name="l01374"></a>01374       {
<a name="l01375"></a>01375          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]&gt;=<a class="code" href="a00062.html#0a552b7ccb9f33999ade419ec56f6f6b">g_nf_first_block</a> );
<a name="l01376"></a>01376          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]&lt; <a class="code" href="a00061.html#21e40fac2f3e76ae00f24b91301882c6">G_N_BLOCKS</a>       );
<a name="l01377"></a>01377       }
<a name="l01378"></a>01378 <span class="preprocessor">#endif</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>      <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp++] = <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]);
<a name="l01380"></a>01380       <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u16_tmp++] = <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[u8_tmp]);
<a name="l01381"></a>01381    }
<a name="l01382"></a>01382 <span class="preprocessor">#if (_ASSERT_==ENABLE)</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span>   <span class="comment">// Ensure that, when there is no fbb recycle, the blocks in the cache at</span>
<a name="l01384"></a>01384    <span class="comment">// position p are identical to the blocks in the beginning of the new line.</span>
<a name="l01385"></a>01385    <span class="keywordflow">if</span>( (<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>==bool_delete) &amp;&amp; ( !b_ecc_err ))
<a name="l01386"></a>01386    {
<a name="l01387"></a>01387       <span class="keywordflow">for</span> ( u8_tmp=0 ; u8_tmp&lt;<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ; u8_tmp++ )
<a name="l01388"></a>01388       {
<a name="l01389"></a>01389          <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u8_tmp*2   ];
<a name="l01390"></a>01390          <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(<a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>)= <a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>[u8_tmp*2 +1];
<a name="l01391"></a>01391          <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( <a class="code" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>==<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#3f573f15bc7d4791fef7662cb87256b7">mem</a>[(<a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#bbfbdec71ac19ebd0a651bc24f4fd3a4">p</a>)*NF_N_DEVICES + u8_tmp] );
<a name="l01392"></a>01392       }
<a name="l01393"></a>01393    }
<a name="l01394"></a>01394 <span class="preprocessor">#endif</span>
<a name="l01395"></a>01395 <span class="preprocessor"></span>
<a name="l01396"></a>01396    <a class="code" href="a00062.html#020f4fb7d7d55f3fad9c368ac04cabf3" title="Writes the Free-blocks block into the Nand Flash.">nf_write_fbb</a>(); <span class="comment">// Should test the result</span>
<a name="l01397"></a>01397    <a class="code" href="a00063.html#3a7e8fdae8fd67e400d1e05c4c40610f">Nf_check_fbb</a>( b_ecc_err );
<a name="l01398"></a>01398    <a class="code" href="a00063.html#d57b5bafad3a69fe6f786312acd3d0f1">Nf_check_lut</a>();
<a name="l01399"></a>01399 
<a name="l01400"></a>01400    <span class="keywordflow">if</span>( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>==bool_delete )
<a name="l01401"></a>01401    {
<a name="l01402"></a>01402       <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( u16_delete ), <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l01403"></a>01403    }
<a name="l01404"></a>01404 
<a name="l01405"></a>01405    <a class="code" href="a00044.html#ab1e54dcc40192f9704e8b252635450f" title="This macro is used to test fatal errors which may be caused by software or hardware...">Assert</a>( u16_tmp==(<a class="code" href="a00062.html#c7986c38b60264dc6123cc4e2923680c">g_n_free_blocks</a>*2) ); <span class="comment">// All the list should have been processed</span>
<a name="l01406"></a>01406    <a class="code" href="a00062.html#7a88492231eef53d1724201b68b964bd">g_cache_fbb</a>.<a class="code" href="a00001.html#a5e466ecf8a6e66c3ba4aa6228eccbd5">ctrl</a>.<a class="code" href="a00001.html#8435e2b050da6630b6f0798591d1501f">dirty</a>=<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01407"></a>01407 } <span class="comment">// end of nf_cache_fbb_flush</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="8a8cd7007fd3561ea61f83641f7d3278"></a><!-- doxytag: member="nf_mngt.h::nf_recovery" ref="8a8cd7007fd3561ea61f83641f7d3278" args="(U16 block_1, U16 block_2)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_recovery           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>block_1</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>block_2</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="a38cbc2641b27ca8fe33b40dbfdd7486"></a><!-- doxytag: member="nf_mngt.h::nf_copy_tail" ref="a38cbc2641b27ca8fe33b40dbfdd7486" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nf_copy_tail           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00163.html#l01558">1558</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00082">_MEM_TYPE_SLOW_</a>, <a class="el" href="a00162.html#l00412">Is_not_nf_512</a>, <a class="el" href="a00133.html#l00207">LSB0</a>, <a class="el" href="a00163.html#l00306">nf_block_2_page()</a>, <a class="el" href="a00163.html#l01859">nf_copy()</a>, <a class="el" href="a00163.html#l01663">nf_download()</a>, <a class="el" href="a00163.html#l00819">nf_erase_old_blocks()</a>, <a class="el" href="a00136.html#l00076">NF_N_DEVICES</a>, <a class="el" href="a00162.html#l00299">NF_PAGE_PROGRAM_CMD</a>, <a class="el" href="a00162.html#l00301">NF_RANDOM_DATA_INPUT_CMD</a>, <a class="el" href="a00162.html#l00416">NF_SPARE_POS</a>, <a class="el" href="a00163.html#l01699">nf_upload()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00161.html#l00239">nfc_open_page_write()</a>, <a class="el" href="a00162.html#l00112">Nfc_set_adc</a>, <a class="el" href="a00162.html#l00107">Nfc_set_cmd</a>, <a class="el" href="a00164.html#l00106">S_SHIFT_LOG_BLOCK_SECTOR</a>, <a class="el" href="a00162.html#l00337">SIZE_BLOCK_PAGE</a>, <a class="el" href="a00162.html#l00338">SIZE_PAGE_SECTOR</a>, <a class="el" href="a00162.html#l00336">SIZE_SECTOR_BYTE</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00126">trace_hex32()</a>, and <a class="el" href="a00144.html#l00131">trace_nl()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01559"></a>01559 {
<a name="l01560"></a>01560    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp;
<a name="l01561"></a>01561                    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  u8_tmp2;
<a name="l01562"></a>01562    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> u16_tmp;
<a name="l01563"></a>01563    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565    <span class="comment">// Test if we do not reach the end of the logical block</span>
<a name="l01566"></a>01566    <span class="comment">//</span>
<a name="l01567"></a>01567    <span class="keywordflow">if</span>( 0!=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> &amp; ( ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>)) -1)) )
<a name="l01568"></a>01568    {
<a name="l01569"></a>01569       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_copy_tail;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01570"></a>01570       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#1807031055d9d07f3229cb8d826d3ffc">Is_not_nf_512</a>() )
<a name="l01571"></a>01571       {  <span class="comment">// Following is not possible on 512B Nand</span>
<a name="l01572"></a>01572 
<a name="l01573"></a>01573          u8_tmp = <span class="comment">// current offset sector in the current page</span>
<a name="l01574"></a>01574             <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>)
<a name="l01575"></a>01575          &amp;  ( <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>-1 )
<a name="l01576"></a>01576          ;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578          u8_tmp2 = <a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a> -u8_tmp;
<a name="l01579"></a>01579          <span class="keywordflow">if</span>( 0!=u8_tmp )
<a name="l01580"></a>01580          {  <span class="comment">// Copy the rest of the current line</span>
<a name="l01581"></a>01581 
<a name="l01582"></a>01582             byte_addr=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp) * (<a class="code" href="a00061.html#eb269843d27f183677d85ee457233918">SIZE_SECTOR_BYTE</a>);
<a name="l01583"></a>01583             <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);  <span class="comment">// open the current device</span>
<a name="l01584"></a>01584             <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(                                                       <span class="comment">// Open the old block at :</span>
<a name="l01585"></a>01585                   <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>] )                   <span class="comment">// adresse of the beginning of the old block</span>
<a name="l01586"></a>01586                +  (<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id])&amp;(<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1))        <span class="comment">// current offset page in the old and new block</span>
<a name="l01587"></a>01587             ,  byte_addr );                                                           <span class="comment">// current offset sector in the current page</span>
<a name="l01588"></a>01588             <span class="comment">// for each sector in the physical page</span>
<a name="l01589"></a>01589             u16_tmp = u8_tmp2 * <a class="code" href="a00061.html#eb269843d27f183677d85ee457233918">SIZE_SECTOR_BYTE</a>;
<a name="l01590"></a>01590             <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> += u8_tmp2;                                             <span class="comment">// update the current logical sector</span>
<a name="l01591"></a>01591 
<a name="l01592"></a>01592             <span class="comment">// read the sector of the old page</span>
<a name="l01593"></a>01593             <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>+byte_addr, u16_tmp/16 );
<a name="l01594"></a>01594 
<a name="l01595"></a>01595             <span class="comment">// Read the associated spare zone</span>
<a name="l01596"></a>01596             byte_addr= <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp)*16);
<a name="l01597"></a>01597             <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>(                                                       <span class="comment">// Open the old block at :</span>
<a name="l01598"></a>01598                   <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>( <a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[g_curr_dev_id] )                   <span class="comment">// adresse of the beginning of the old block</span>
<a name="l01599"></a>01599                +  (<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id])&amp;(<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1))        <span class="comment">// current offset page in the old and new block</span>
<a name="l01600"></a>01600             ,  byte_addr );                                                           <span class="comment">// current offset sector in the current page</span>
<a name="l01601"></a>01601             <a class="code" href="a00062.html#d530651d772a5d7f5c1ff3bf91eda4c2" title="Upload packets of 16 bytes from the NAND Flash to RAM.">nf_upload</a>(<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>+byte_addr, u8_tmp2 );
<a name="l01602"></a>01602 
<a name="l01603"></a>01603             byte_addr=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp) * (<a class="code" href="a00061.html#eb269843d27f183677d85ee457233918">SIZE_SECTOR_BYTE</a>);
<a name="l01604"></a>01604             <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( <span class="comment">// Open the new block at the current position</span>
<a name="l01605"></a>01605                <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]
<a name="l01606"></a>01606             ,  byte_addr );
<a name="l01607"></a>01607 
<a name="l01608"></a>01608             <span class="comment">// write the sector in the new page</span>
<a name="l01609"></a>01609             <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>+byte_addr, (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(u16_tmp/16) );
<a name="l01610"></a>01610 
<a name="l01611"></a>01611             <span class="comment">// write the associated spare zone</span>
<a name="l01612"></a>01612             byte_addr=<a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)u8_tmp)*16);
<a name="l01613"></a>01613             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l01614"></a>01614             <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (byte_addr)%256 );
<a name="l01615"></a>01615             <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( (byte_addr)/256 );
<a name="l01616"></a>01616             <a class="code" href="a00062.html#b7f3d7c1f70d339f8613aaaeb4262959" title="Download packets of 16 bytes from RAM to the NAND Flash.">nf_download</a>(<a class="code" href="a00062.html#1caaea08067b99087b57de6ede8dc1d4">g_page_buffer</a>+byte_addr, u8_tmp2 );
<a name="l01617"></a>01617             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l01618"></a>01618 
<a name="l01619"></a>01619             <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]++;                                                   <span class="comment">// update the current physical page of the current device</span>
<a name="l01620"></a>01620             g_curr_dev_id++;                                                                     <span class="comment">// update the current device</span>
<a name="l01621"></a>01621             <span class="keywordflow">if</span>( g_curr_dev_id==<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ) { g_curr_dev_id=0; }
<a name="l01622"></a>01622          }
<a name="l01623"></a>01623       }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625       <span class="comment">// then copy the rest of the logical block</span>
<a name="l01626"></a>01626       <span class="comment">//</span>
<a name="l01627"></a>01627       <span class="keywordflow">while</span>( 0!=((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> &amp; (((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>))-1)) )
<a name="l01628"></a>01628       {
<a name="l01629"></a>01629          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, g_curr_dev_id);  <span class="comment">// open the current device</span>
<a name="l01630"></a>01630 
<a name="l01631"></a>01631          <a class="code" href="a00062.html#f4ca354f5f4da2cf8714d86c99840fa7">g_copy_src</a>=
<a name="l01632"></a>01632             <a class="code" href="a00062.html#f713bee0ed464d2bfa6876cd9d4ef296">nf_block_2_page</a>(<a class="code" href="a00062.html#94ac20e6203a5a5cd4af24cc2b84879f">g_block_to_kill</a>[g_curr_dev_id])                     <span class="comment">// adresse of the beginning of the old block</span>
<a name="l01633"></a>01633          +  (<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id])&amp;(<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a> -1))        <span class="comment">// current offset page in the old and new block</span>
<a name="l01634"></a>01634          ;
<a name="l01635"></a>01635          <a class="code" href="a00062.html#79e27718d9bc988607f630c2ff410848" title="Copy a NF page to a new one.">nf_copy</a>(<a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]);
<a name="l01636"></a>01636          <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[g_curr_dev_id]++;
<a name="l01637"></a>01637 
<a name="l01638"></a>01638          <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>+=<a class="code" href="a00061.html#ab9745c0e67c22216932ef3333cc9e52">SIZE_PAGE_SECTOR</a>;                            <span class="comment">// update the current logical sector</span>
<a name="l01639"></a>01639          g_curr_dev_id++;                                                          <span class="comment">// update the current device</span>
<a name="l01640"></a>01640          <span class="keywordflow">if</span>( g_curr_dev_id==<a class="code" href="a00035.html#6dd220ac4f6b4c416d848f6e2241ace4" title="************ For all mode Define the number of NandFlash connected (= number of Chip...">NF_N_DEVICES</a> ) { g_curr_dev_id=0; }
<a name="l01641"></a>01641       }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643       <span class="comment">// Delete old blocks</span>
<a name="l01644"></a>01644       <span class="comment">//</span>
<a name="l01645"></a>01645       <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>();
<a name="l01646"></a>01646    }<span class="keywordflow">else</span>{
<a name="l01647"></a>01647       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"nf_copy_tail empty??;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l01648"></a>01648    }
<a name="l01649"></a>01649    <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>= 0xFFFFFFFF;
<a name="l01650"></a>01650 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="1c583c1d616f3af3e57ebe914cf747e9"></a><!-- doxytag: member="nf_mngt.h::nf_read_10" ref="1c583c1d616f3af3e57ebe914cf747e9" args="(U32 log_sector, U16 n_sectors)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_read_10           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td>
          <td class="paramname"> <em>log_sector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>n_sectors</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function initializes the Nand Flash for a read operation. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>log_sector</em>&nbsp;</td><td>Logical sector address to start read </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>Number of sectors to transfer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>CTRL_GOOD if ok, CTRL_FAIL if read outside memory </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00320">320</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00143.html#l00062">CTRL_FAIL</a>, <a class="el" href="a00143.html#l00061">CTRL_GOOD</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00133.html#l00207">LSB0</a>, <a class="el" href="a00136.html#l00112">Nf_access_signal_off</a>, <a class="el" href="a00136.html#l00111">Nf_access_signal_on</a>, <a class="el" href="a00163.html#l00296">nf_get_sectors_number()</a>, <a class="el" href="a00163.html#l00847">nf_open_read()</a>, <a class="el" href="a00163.html#l00540">nf_read_sector_to_usb()</a>, <a class="el" href="a00163.html#l00490">nf_xfer_update_vars()</a>, <a class="el" href="a00161.html#l00185">nf_XMCR_disable()</a>, <a class="el" href="a00161.html#l00172">nf_XMCR_enable()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00132">Nfc_open_page_read</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00162.html#l00337">SIZE_BLOCK_PAGE</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, <a class="el" href="a00144.html#l00126">trace_hex32()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00321"></a>00321 {
<a name="l00322"></a>00322   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  status;
<a name="l00323"></a>00323   
<a name="l00324"></a>00324    <span class="keywordflow">if</span> ( !<a class="code" href="a00062.html#26346bee46d0d3fc1cda3b51ccefea3c">g_nf_init</a> )
<a name="l00325"></a>00325       <span class="keywordflow">while</span>(1);   <span class="comment">// You shall call once mem_test_unit_ready() before.</span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <span class="comment">// Test that the logical sector address is valid</span>
<a name="l00328"></a>00328    <span class="comment">//</span>
<a name="l00329"></a>00329    <span class="keywordflow">if</span> ( 0==n_sectors )                                   { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>; }
<a name="l00330"></a>00330    <span class="keywordflow">if</span> ( (log_sector+n_sectors)&gt;<a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>; }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00334"></a>00334 <span class="preprocessor">#endif</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span>
<a name="l00336"></a>00336    <a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>       = n_sectors;
<a name="l00337"></a>00337    <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> = log_sector;
<a name="l00338"></a>00338    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"rd;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a>); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00339"></a>00339    <a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">s_save_log_addr</a>   = log_sector + n_sectors;
<a name="l00340"></a>00340    <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00341"></a>00341    <a class="code" href="a00062.html#20874a420e6102174c88e80522624a22">s_mem</a>             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00342"></a>00342    <a class="code" href="a00062.html#f373954acd1f3cc6e5394c0e6fa4d642">s_start</a>           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="comment">// First read operation</span>
<a name="l00345"></a>00345    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l00346"></a>00346    <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00347"></a>00347    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);
<a name="l00348"></a>00348    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>], <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> );
<a name="l00349"></a>00349    <a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8" title="This function transfers a page content (NF) to the USB macro The number of sectors...">nf_read_sector_to_usb</a>(<a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>);
<a name="l00350"></a>00350    status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l00351"></a>00351 
<a name="l00352"></a>00352    <span class="comment">// Next read operations</span>
<a name="l00353"></a>00353    <span class="keywordflow">while</span> (status == <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)    <span class="comment">// exit when last page read</span>
<a name="l00354"></a>00354    {
<a name="l00355"></a>00355       <span class="keywordflow">if</span> (!(<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>-1))    <span class="comment">// new block</span>
<a name="l00356"></a>00356       &amp;&amp; (<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>==0                                  ))    <span class="comment">// on device 0. Should this case be implicit ? If yes, we can remove it.</span>
<a name="l00357"></a>00357       {
<a name="l00358"></a>00358          <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00359"></a>00359       }
<a name="l00360"></a>00360       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);
<a name="l00361"></a>00361       <a class="code" href="a00061.html#c8447f3352f9d30b0a9eb506378d3cc9" title="Opens a page for read.">Nfc_open_page_read</a>( <a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>, <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> ); <span class="comment">// Use macro for fast execution</span>
<a name="l00362"></a>00362       <a class="code" href="a00062.html#cdf11d95306546b44630abeed06250d8" title="This function transfers a page content (NF) to the USB macro The number of sectors...">nf_read_sector_to_usb</a>(<a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>);                   <span class="comment">// read the concerned sectors of the selected page</span>
<a name="l00363"></a>00363       status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();                             <span class="comment">// check if last page or not</span>
<a name="l00364"></a>00364    }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00370"></a>00370 <span class="preprocessor">#endif</span>
<a name="l00371"></a>00371 <span class="preprocessor"></span>
<a name="l00372"></a>00372    <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>;
<a name="l00373"></a>00373 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="fd80e982702f51b6ad94632856b980e1"></a><!-- doxytag: member="nf_mngt.h::nf_write_10" ref="fd80e982702f51b6ad94632856b980e1" args="(U32 log_sector, U16 n_sectors)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_write_10           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td>
          <td class="paramname"> <em>log_sector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>&nbsp;</td>
          <td class="paramname"> <em>n_sectors</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function initializes the Nand Flash for a write operation. 
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>log_sector</em>&nbsp;</td><td>Logical sector address to start read </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>Number of sectors to transfer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>CTRL_GOOD if ok, CTRL_FAIL if read outside memory </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l00384">384</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00143.html#l00062">CTRL_FAIL</a>, <a class="el" href="a00143.html#l00061">CTRL_GOOD</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00387">G_CACHE_PROG</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00162.html#l00409">Is_nf_2k</a>, <a class="el" href="a00133.html#l00207">LSB0</a>, <a class="el" href="a00136.html#l00112">Nf_access_signal_off</a>, <a class="el" href="a00136.html#l00111">Nf_access_signal_on</a>, <a class="el" href="a00162.html#l00303">NF_CACHE_PROGRAM_CMD</a>, <a class="el" href="a00163.html#l00770">nf_dfc_write_stop()</a>, <a class="el" href="a00163.html#l00819">nf_erase_old_blocks()</a>, <a class="el" href="a00163.html#l00296">nf_get_sectors_number()</a>, <a class="el" href="a00163.html#l00880">nf_open_write()</a>, <a class="el" href="a00162.html#l00299">NF_PAGE_PROGRAM_CMD</a>, <a class="el" href="a00163.html#l00171">NF_TRANS_NORMAL</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, <a class="el" href="a00163.html#l00724">nf_update_spare_zone()</a>, <a class="el" href="a00163.html#l00632">nf_write_sector_from_usb()</a>, <a class="el" href="a00163.html#l00490">nf_xfer_update_vars()</a>, <a class="el" href="a00161.html#l00185">nf_XMCR_disable()</a>, <a class="el" href="a00161.html#l00172">nf_XMCR_enable()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00162.html#l00211">Nfc_open_page_write</a>, <a class="el" href="a00161.html#l00239">nfc_open_page_write()</a>, <a class="el" href="a00162.html#l00107">Nfc_set_cmd</a>, <a class="el" href="a00164.html#l00106">S_SHIFT_LOG_BLOCK_SECTOR</a>, <a class="el" href="a00164.html#l00104">S_SHIFT_SECTOR_BYTE</a>, <a class="el" href="a00162.html#l00337">SIZE_BLOCK_PAGE</a>, <a class="el" href="a00144.html#l00114">trace()</a>, <a class="el" href="a00144.html#l00121">trace_hex16()</a>, <a class="el" href="a00144.html#l00126">trace_hex32()</a>, <a class="el" href="a00144.html#l00131">trace_nl()</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00385"></a>00385 {
<a name="l00386"></a>00386   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> status;
<a name="l00387"></a>00387   <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> tmp_bool;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    <span class="comment">// Test that the logical sector address is valid</span>
<a name="l00390"></a>00390    <span class="keywordflow">if</span> ( 0==n_sectors )                                   { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>; }
<a name="l00391"></a>00391    <span class="keywordflow">if</span> ( (log_sector+n_sectors)&gt;<a class="code" href="a00062.html#f935b5cf31febdb455f0b157944ae27b" title="Returns a pointer on the internal buffer address.">nf_get_sectors_number</a>() ) { <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e29187a15d70a7619b7e4aa918f7a0d953ea">CTRL_FAIL</a>; }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00395"></a>00395 <span class="preprocessor">#endif</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>
<a name="l00397"></a>00397    <a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>       = n_sectors;
<a name="l00398"></a>00398    <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> = log_sector;
<a name="l00399"></a>00399    <a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">s_save_log_addr</a>   = log_sector + n_sectors;
<a name="l00400"></a>00400    <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00401"></a>00401    <a class="code" href="a00062.html#20874a420e6102174c88e80522624a22">s_mem</a>             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00402"></a>00402    <a class="code" href="a00062.html#f373954acd1f3cc6e5394c0e6fa4d642">s_start</a>           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"wr;"</span>); <a class="code" href="a00043.html#1f752dbcd0990c4943d2a3e6cb757748">trace_hex32</a>(<a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a>); <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">";"</span>); <a class="code" href="a00043.html#b2fa7a964f1f12c6d41357ac95c452a9">trace_hex16</a>(<a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>); <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00405"></a>00405    
<a name="l00406"></a>00406    <span class="comment">// First write operation</span>
<a name="l00407"></a>00407    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l00408"></a>00408    <span class="keywordflow">if</span>(( <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a>==<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> )                                           <span class="comment">// New write is just after to the last write</span>
<a name="l00409"></a>00409    &amp;&amp; (!(  ( 0==((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> &amp; ( ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>)) -1)))   <span class="comment">// Not on a logical block boundary</span>
<a name="l00410"></a>00410       &amp;&amp; ( <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>==0                                                        ))))
<a name="l00411"></a>00411    {
<a name="l00412"></a>00412       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"continue"</span>);<a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00413"></a>00413       <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a> );
<a name="l00414"></a>00414       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);  <span class="comment">// open the current device</span>
<a name="l00415"></a>00415       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( <a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>, <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> );
<a name="l00416"></a>00416    }
<a name="l00417"></a>00417    <span class="keywordflow">else</span>
<a name="l00418"></a>00418    {      
<a name="l00419"></a>00419       <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421    <a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015" title="This function transfers USB data to the NF page The number of sectors to be read...">nf_write_sector_from_usb</a>(<a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>);    <span class="comment">// s_nb_sectors_step has been calculated in nf_translate()</span>
<a name="l00422"></a>00422    <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l00423"></a>00423    {
<a name="l00424"></a>00424       <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>))-<a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>, <a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l00425"></a>00425    }
<a name="l00426"></a>00426    <span class="keywordflow">else</span>
<a name="l00427"></a>00427    {
<a name="l00428"></a>00428      <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, 1);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l00429"></a>00429    }
<a name="l00430"></a>00430    <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>  = <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> + <a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>;    <span class="comment">// Memorize next logical sector to be managed</span>
<a name="l00431"></a>00431    status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l00432"></a>00432 
<a name="l00433"></a>00433    <span class="comment">// Next write operations</span>
<a name="l00434"></a>00434    <span class="keywordflow">while</span> (status == <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)    <span class="comment">// exit when operation finished</span>
<a name="l00435"></a>00435    {
<a name="l00436"></a>00436       <span class="keywordflow">if</span>(!(<a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(<a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>) &amp; (<a class="code" href="a00061.html#668da83f591b67adc32d57080a5afa2c">SIZE_BLOCK_PAGE</a>-1))  <span class="comment">// new block</span>
<a name="l00437"></a>00437       &amp;&amp; (<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>==0                                  )) <span class="comment">// on device 0.</span>
<a name="l00438"></a>00438       {
<a name="l00439"></a>00439          <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>); <span class="comment">// Program the page</span>
<a name="l00440"></a>00440          <a class="code" href="a00062.html#2c6a8d4ffdfab1c8062c4909cf19c563" title="Erase the source blocks.">nf_erase_old_blocks</a>();
<a name="l00441"></a>00441          <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> );
<a name="l00442"></a>00442       }
<a name="l00443"></a>00443       <span class="keywordflow">else</span>
<a name="l00444"></a>00444       {
<a name="l00445"></a>00445          <span class="keywordflow">if</span>( <a class="code" href="a00061.html#b4233cf2358424060e6586b4ca401213">G_CACHE_PROG</a> )
<a name="l00446"></a>00446          {
<a name="l00447"></a>00447             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g4bd39b96f3be4d842abc784c09b16659" title="Cache program (fast) command (2KB).">NF_CACHE_PROGRAM_CMD</a>);
<a name="l00448"></a>00448          }<span class="keywordflow">else</span>{
<a name="l00449"></a>00449             <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l00450"></a>00450          }
<a name="l00451"></a>00451          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);
<a name="l00452"></a>00452          <a class="code" href="a00061.html#74dba9394ac015f89cb1c42131a239b5" title="Opens a page for write.">Nfc_open_page_write</a>( <a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>, <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> ); <span class="comment">// Use macro for fast execution</span>
<a name="l00453"></a>00453       }
<a name="l00454"></a>00454       <a class="code" href="a00062.html#32369acfcdfc9fef083b5978936dc015" title="This function transfers USB data to the NF page The number of sectors to be read...">nf_write_sector_from_usb</a>(s_nb_sectors_step);
<a name="l00455"></a>00455       <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l00456"></a>00456       {
<a name="l00457"></a>00457          <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, s_nb_sectors_step);
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459       <span class="keywordflow">else</span>
<a name="l00460"></a>00460       {
<a name="l00461"></a>00461          <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, 1);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l00462"></a>00462       }
<a name="l00463"></a>00463       <a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a>  = <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> + s_nb_sectors_step;    <span class="comment">// Memorize next logical sector to be managed</span>
<a name="l00464"></a>00464       status = <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();  <span class="comment">// check if last block or not</span>
<a name="l00465"></a>00465    }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    tmp_bool = <a class="code" href="a00062.html#d45465832eded4b9de5dfa9b095482bd" title="This function must be called when a write10 operation (from USB) is finished Last...">nf_dfc_write_stop</a>(0);   <span class="comment">// ends write operations with "nf_dfc_write_stop(0)" that save the current environnement</span>
<a name="l00468"></a>00468    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00472"></a>00472 <span class="preprocessor">#endif</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span>
<a name="l00474"></a>00474    <span class="keywordflow">return</span> tmp_bool;
<a name="l00475"></a>00475 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="c0569fdce920e24874d30f1b25dfe3c8"></a><!-- doxytag: member="nf_mngt.h::nf_ram_2_nf" ref="c0569fdce920e24874d30f1b25dfe3c8" args="(U32 addr, U8 *ram)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_ram_2_nf           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td>
          <td class="paramname"> <em>addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *&nbsp;</td>
          <td class="paramname"> <em>ram</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction initialise the memory for a write operation from ram buffer. 
<p>
DATA FLOW is: RAM =&gt; NF<p>
(sector = 512B) <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>addr</em>&nbsp;</td><td>Sector address to write </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ram</em>&nbsp;</td><td>Ram buffer pointer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Ctrl_status It is ready -&gt; CTRL_GOOD A error occur -&gt; CTRL_FAIL </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l02117">2117</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00162.html#l00409">Is_nf_2k</a>, <a class="el" href="a00136.html#l00112">Nf_access_signal_off</a>, <a class="el" href="a00136.html#l00111">Nf_access_signal_on</a>, <a class="el" href="a00163.html#l00770">nf_dfc_write_stop()</a>, <a class="el" href="a00163.html#l00880">nf_open_write()</a>, <a class="el" href="a00163.html#l00171">NF_TRANS_NORMAL</a>, <a class="el" href="a00163.html#l01743">nf_translate()</a>, <a class="el" href="a00163.html#l00724">nf_update_spare_zone()</a>, <a class="el" href="a00162.html#l00096">Nf_wr_byte</a>, <a class="el" href="a00163.html#l00490">nf_xfer_update_vars()</a>, <a class="el" href="a00161.html#l00185">nf_XMCR_disable()</a>, <a class="el" href="a00161.html#l00172">nf_XMCR_enable()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00161.html#l00239">nfc_open_page_write()</a>, <a class="el" href="a00164.html#l00106">S_SHIFT_LOG_BLOCK_SECTOR</a>, <a class="el" href="a00164.html#l00104">S_SHIFT_SECTOR_BYTE</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l02118"></a>02118 {
<a name="l02119"></a>02119   <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291" title="Define control status.">Ctrl_status</a> tmp_bool;
<a name="l02120"></a>02120   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l02121"></a>02121 
<a name="l02122"></a>02122 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02123"></a>02123 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l02124"></a>02124 <span class="preprocessor">#endif</span>
<a name="l02125"></a>02125 <span class="preprocessor"></span>
<a name="l02126"></a>02126    <a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>       = 1;
<a name="l02127"></a>02127    <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> = addr;
<a name="l02128"></a>02128    <a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">s_save_log_addr</a>   = addr + 1;
<a name="l02129"></a>02129    <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02130"></a>02130    <a class="code" href="a00062.html#20874a420e6102174c88e80522624a22">s_mem</a>             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02131"></a>02131    <a class="code" href="a00062.html#f373954acd1f3cc6e5394c0e6fa4d642">s_start</a>           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02132"></a>02132 
<a name="l02133"></a>02133    <span class="comment">// First write operation</span>
<a name="l02134"></a>02134    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l02135"></a>02135    <span class="keywordflow">if</span>(( <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a>==<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> )                                           <span class="comment">// New write is just after to the last write</span>
<a name="l02136"></a>02136    &amp;&amp; (!(  ( 0==((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00062.html#2bc0562eb7d70332b01be5df48432466">g_last_log_sector</a> &amp; ( ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)1&lt;&lt;(<a class="code" href="a00063.html#fdb4a2af55e4352eff66adadabebac1d">S_SHIFT_LOG_BLOCK_SECTOR</a>)) -1)))   <span class="comment">// Not on a logical block boundary</span>
<a name="l02137"></a>02137       &amp;&amp; ( <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>==0                                                        ))))
<a name="l02138"></a>02138    {
<a name="l02139"></a>02139       <a class="code" href="a00062.html#4a1dd64acf67b8ab91e9ea1c0b976c4f" title="Translate a logical sector to physical parameters.">nf_translate</a>( <a class="code" href="a00062.html#6ef016e005d5e9eb60a91f1d0dc3e2f123ed74ffbf6457b886c24ea985fa1af9">NF_TRANS_NORMAL</a> );
<a name="l02140"></a>02140       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);  <span class="comment">// open the current device</span>
<a name="l02141"></a>02141       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( <a class="code" href="a00062.html#25a9498c5e36a37c6216ccc5077edd9d">g_next_phys_page_addr</a>, <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> );
<a name="l02142"></a>02142    }
<a name="l02143"></a>02143    <span class="keywordflow">else</span>
<a name="l02144"></a>02144    {      
<a name="l02145"></a>02145       <a class="code" href="a00062.html#470f7324aee0b5c64aec2c8ec7f35e3f" title="Prepare a write session on the flash memory.">nf_open_write</a>( <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l02146"></a>02146    }
<a name="l02147"></a>02147    
<a name="l02148"></a>02148    <span class="keywordflow">for</span>(i=0;i&lt;512;i++)
<a name="l02149"></a>02149    {
<a name="l02150"></a>02150       <a class="code" href="a00061.html#85fc4d411042026af1416b523e51470f">Nf_wr_byte</a>(*ram);
<a name="l02151"></a>02151       ram++;
<a name="l02152"></a>02152    }
<a name="l02153"></a>02153 
<a name="l02154"></a>02154    <span class="keywordflow">if</span> (<a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>())
<a name="l02155"></a>02155    {
<a name="l02156"></a>02156       <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)(1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>))-<a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>, <a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a>);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l02157"></a>02157    }
<a name="l02158"></a>02158    <span class="keywordflow">else</span>
<a name="l02159"></a>02159    {
<a name="l02160"></a>02160      <a class="code" href="a00062.html#95ece8cf373b67f3f55f1733a0822463" title="This function updates the spare zone of each page that has been finished to be written...">nf_update_spare_zone</a>(0, 1);    <span class="comment">// update the spare zone once the page has been filled in</span>
<a name="l02161"></a>02161    }
<a name="l02162"></a>02162    <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l02163"></a>02163 
<a name="l02164"></a>02164    tmp_bool = <a class="code" href="a00062.html#d45465832eded4b9de5dfa9b095482bd" title="This function must be called when a write10 operation (from USB) is finished Last...">nf_dfc_write_stop</a>(0);   <span class="comment">// ends write operations with "nf_dfc_write_stop(0)" that save the current environnement</span>
<a name="l02165"></a>02165    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02168"></a>02168 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l02169"></a>02169 <span class="preprocessor">#endif</span>
<a name="l02170"></a>02170 <span class="preprocessor"></span>
<a name="l02171"></a>02171    <span class="keywordflow">return</span> tmp_bool;
<a name="l02172"></a>02172 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="18cf312e26c74a2f8ff049bf172a56d4"></a><!-- doxytag: member="nf_mngt.h::nf_nf_2_ram" ref="18cf312e26c74a2f8ff049bf172a56d4" args="(U32 addr, U8 *ram)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00042.html#910a0fdf1e7a70b08981dce14e86e291">Ctrl_status</a> nf_nf_2_ram           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td>
          <td class="paramname"> <em>addr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *&nbsp;</td>
          <td class="paramname"> <em>ram</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This fonction read 1 sector from NF to ram buffer. 
<p>
DATA FLOW is: NF =&gt; RAM<p>
(sector = 512B) <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>addr</em>&nbsp;</td><td>Sector address to read </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ram</em>&nbsp;</td><td>Ram buffer pointer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>Ctrl_status It is ready -&gt; CTRL_GOOD A error occur -&gt; CTRL_FAIL </dd></dl>

<p>Definition at line <a class="el" href="a00163.html#l02186">2186</a> of file <a class="el" href="a00163.html">nf_mngt.c</a>.</p>

<p>References <a class="el" href="a00143.html#l00061">CTRL_GOOD</a>, <a class="el" href="a00133.html#l00260">FALSE</a>, <a class="el" href="a00162.html#l00414">G_SHIFT_PAGE_BYTE</a>, <a class="el" href="a00133.html#l00288">Min</a>, <a class="el" href="a00136.html#l00112">Nf_access_signal_off</a>, <a class="el" href="a00136.html#l00111">Nf_access_signal_on</a>, <a class="el" href="a00163.html#l00847">nf_open_read()</a>, <a class="el" href="a00162.html#l00095">Nf_rd_byte</a>, <a class="el" href="a00163.html#l00490">nf_xfer_update_vars()</a>, <a class="el" href="a00161.html#l00185">nf_XMCR_disable()</a>, <a class="el" href="a00161.html#l00172">nf_XMCR_enable()</a>, <a class="el" href="a00162.html#l00067">NFC_ACT_DEV_SELECT</a>, <a class="el" href="a00162.html#l00116">Nfc_action</a>, <a class="el" href="a00161.html#l00221">nfc_open_page_read()</a>, <a class="el" href="a00164.html#l00104">S_SHIFT_SECTOR_BYTE</a>, and <a class="el" href="a00133.html#l00261">TRUE</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l02187"></a>02187 {
<a name="l02188"></a>02188   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l02189"></a>02189 
<a name="l02190"></a>02190 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02191"></a>02191 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l02192"></a>02192 <span class="preprocessor">#endif</span>
<a name="l02193"></a>02193 <span class="preprocessor"></span>
<a name="l02194"></a>02194    <a class="code" href="a00062.html#08aabf6e718d8efd5ba356650182835c">s_n_sectors</a>       = 1;
<a name="l02195"></a>02195    <a class="code" href="a00062.html#14e8be5c22beb5ea3f9c3828e0930783">s_curr_log_sector</a> = addr;
<a name="l02196"></a>02196    <a class="code" href="a00062.html#2032fe73dd1c3c501e94cde3ef90f127">s_save_log_addr</a>   = addr + 1;
<a name="l02197"></a>02197    <a class="code" href="a00062.html#62179699f6fc4d72c57daeab0e6d93b4">g_fatal</a>           = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02198"></a>02198    <a class="code" href="a00062.html#20874a420e6102174c88e80522624a22">s_mem</a>             = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02199"></a>02199    <a class="code" href="a00062.html#f373954acd1f3cc6e5394c0e6fa4d642">s_start</a>           = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02200"></a>02200 
<a name="l02201"></a>02201    <span class="comment">// First read operation</span>
<a name="l02202"></a>02202    <a class="code" href="a00035.html#7910d3cc3f9fafe153dc5a7c9b93b114" title="Function linker for NF access indications.">Nf_access_signal_on</a>();
<a name="l02203"></a>02203    <a class="code" href="a00062.html#e55b89875aaa8140a7cba32fa683671a" title="Prepare a read session on the flash memory.">nf_open_read</a>(<a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l02204"></a>02204    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, <a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>);
<a name="l02205"></a>02205    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00062.html#3bf34b5d35614f365127da4dbab52998">g_phys_page_addr</a>[<a class="code" href="a00062.html#a94e9abd9d0bc654cff101b858b05b3d">g_curr_dev_id</a>], <a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> );
<a name="l02206"></a>02206    <a class="code" href="a00062.html#a55119431dbad3db10c2c43216696aba">s_nb_sectors_step</a> = (<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)                              <span class="comment">// determine number of sectors to be read</span>
<a name="l02207"></a>02207                        (<a class="code" href="a00032.html#9e04209162ea72f9985338596262b657">Min</a>(                             <span class="comment">// on this first page</span>
<a name="l02208"></a>02208                              1,
<a name="l02209"></a>02209                              ((1&lt;&lt;(<a class="code" href="a00061.html#bff7cf7d50c8eed7cb6122155aed8f3b">G_SHIFT_PAGE_BYTE</a> - <a class="code" href="a00063.html#b7b418925e68e7dc40aa9a74613cb6ee">S_SHIFT_SECTOR_BYTE</a>))-(<a class="code" href="a00062.html#a058c9a7a8bdbb0df01e8bf083f91ce5">s_curr_n_byte</a> &gt;&gt; 9))
<a name="l02210"></a>02210                            )
<a name="l02211"></a>02211                        );
<a name="l02212"></a>02212    
<a name="l02213"></a>02213    Disable_interrupt();  
<a name="l02214"></a>02214    <span class="keywordflow">for</span>(i=0;i&lt;512;i++)
<a name="l02215"></a>02215    {
<a name="l02216"></a>02216       *ram=<a class="code" href="a00061.html#6a8a6e712a6de87b4b0a4ab60882ddbe">Nf_rd_byte</a>();
<a name="l02217"></a>02217       ram++;
<a name="l02218"></a>02218    }
<a name="l02219"></a>02219    Enable_interrupt();  
<a name="l02220"></a>02220    <a class="code" href="a00062.html#dffd0ae3871f945b0c9ec4fcdc45ee82" title="This function update transfer variables, check if operation (read/write) is finished...">nf_xfer_update_vars</a>();
<a name="l02221"></a>02221    <a class="code" href="a00035.html#e0aa07db9a17dbf56fd7c287c9a4aeac">Nf_access_signal_off</a>();
<a name="l02222"></a>02222 
<a name="l02223"></a>02223 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l02224"></a>02224 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l02225"></a>02225 <span class="preprocessor">#endif</span>
<a name="l02226"></a>02226 <span class="preprocessor"></span>
<a name="l02227"></a>02227    <span class="keywordflow">return</span> <a class="code" href="a00042.html#910a0fdf1e7a70b08981dce14e86e2918cc674c935507be438bb2d9b6e70d6b8">CTRL_GOOD</a>;   
<a name="l02228"></a>02228 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="6b50ad24827c3400322c54374b047221"></a><!-- doxytag: member="nf_mngt.h::_debug" ref="6b50ad24827c3400322c54374b047221" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">_MEM_TYPE_SLOW_ <a class="el" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="el" href="a00063.html#6b50ad24827c3400322c54374b047221">_debug</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00164.html#l00118">118</a> of file <a class="el" href="a00164.html">nf_mngt.h</a>.</p>

<p>Referenced by <a class="el" href="a00163.html#l01295">nf_cache_fbb_flush()</a>, <a class="el" href="a00163.html#l01099">nf_cache_lut_flush()</a>, <a class="el" href="a00163.html#l01463">nf_check_fbb()</a>, <a class="el" href="a00163.html#l01514">nf_check_lut()</a>, and <a class="el" href="a00163.html#l01213">nf_write_lut()</a>.</p>

</div>
</div><p>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 14 13:14:22 2009 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
