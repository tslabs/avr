<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: mmc_sd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>mmc_sd.c</h1><a href="a00053.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file is prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">/* Copyright (c) 2009 Atmel Corporation. All rights reserved.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00017"></a>00017 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
<a name="l00020"></a>00020 <span class="comment"> * this list of conditions and the following disclaimer.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00023"></a>00023 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00024"></a>00024 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * 3. The name of Atmel may not be used to endorse or promote products derived</span>
<a name="l00027"></a>00027 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * 4. This software may only be redistributed and used in connection with an Atmel</span>
<a name="l00030"></a>00030 <span class="comment"> * AVR product.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED</span>
<a name="l00033"></a>00033 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00034"></a>00034 <span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE EXPRESSLY AND</span>
<a name="l00035"></a>00035 <span class="comment"> * SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT,</span>
<a name="l00036"></a>00036 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00038"></a>00038 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00039"></a>00039 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00040"></a>00040 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00041"></a>00041 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00042"></a>00042 <span class="comment"> */</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/*_____ I N C L U D E S ____________________________________________________*/</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="a00039.html">config.h</a>"</span>                         <span class="comment">/* system configuration */</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="a00037.html">conf_sdmmc.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="a00087.html">lib_mcu/usb/usb_drv.h</a>"</span>            <span class="comment">/* usb driver definition */</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="a00072.html" title="SPI Low level drivers access.">lib_mcu/spi/spi_drv.h</a>"</span>            <span class="comment">/* spi driver definition */</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="a00054.html">mmc_sd.h</a>"</span>                         <span class="comment">/* MMC SD definition */</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">/*_____ D E F I N I T I O N ________________________________________________*/</span>
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="a00053.html#a73e3f4f0baa520941bc1145cfd9b034">00055</a> <span class="keyword">static</span>   <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>   <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>;                   <span class="comment">// memory data pointer</span>
<a name="l00056"></a>00056 
<a name="l00057"></a><a class="code" href="a00055.html#158e5b64ed278e0b8b063c9af05694c4">00057</a> bit  <a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00058"></a><a class="code" href="a00054.html#61f9bcbc16792de72e6e81845639df48">00058</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>;
<a name="l00059"></a><a class="code" href="a00054.html#9558a869846dac22da723081ea0792b0">00059</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  <a class="code" href="a00053.html#9558a869846dac22da723081ea0792b0">r2</a>;
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="a00054.html#da075df9d52cfc9c0a34885234938f61">00061</a>           <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[16];                     <span class="comment">// stores the Card Specific Data</span>
<a name="l00062"></a><a class="code" href="a00054.html#db0f9d91aed791a1402b20e1e2274e3e">00062</a> <span class="keyword">volatile</span>  <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  <a class="code" href="a00053.html#db0f9d91aed791a1402b20e1e2274e3e">capacity</a>;                    <span class="comment">// stores the capacity in bytes</span>
<a name="l00063"></a><a class="code" href="a00054.html#3018533c69dc6d2688672666433bae38">00063</a> <span class="keyword">volatile</span>  <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>  <a class="code" href="a00053.html#3018533c69dc6d2688672666433bae38">mmc_sd_last_block_address</a>;   <span class="comment">// stores the address of the last block (sector)</span>
<a name="l00064"></a><a class="code" href="a00054.html#acdf747ad4ef1aa39993227458be7c83">00064</a>           <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  <a class="code" href="a00053.html#acdf747ad4ef1aa39993227458be7c83">erase_group_size</a>;            <span class="comment">// stores the number of blocks concerned by an erase command</span>
<a name="l00065"></a><a class="code" href="a00054.html#9d2977983304d800cbceba3aeef133a0">00065</a>           <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a>;                   <span class="comment">// stores SD_CARD or MMC_CARD type card</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#if       (MMC_SD_RAM == ENABLED)</span>
<a name="l00069"></a><a class="code" href="a00053.html#83c05ea8ab5cdcaba87692167100b9e1">00069</a> <span class="preprocessor"></span>          <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00053.html#83c05ea8ab5cdcaba87692167100b9e1">data_mem</a>[513]; <span class="comment">// data buffer</span>
<a name="l00070"></a>00070 <span class="preprocessor">#endif</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#if      (MMC_SD_READ_CID == ENABLED)</span>
<a name="l00072"></a><a class="code" href="a00053.html#03c71be37b4156a9bcb0c7757a339509">00072</a> <span class="preprocessor"></span>          <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>   <a class="code" href="a00053.html#03c71be37b4156a9bcb0c7757a339509">cid</a>[16];
<a name="l00073"></a>00073 <span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/*_____ D E C L A R A T I O N ______________________________________________*/</span>
<a name="l00077"></a>00077 
<a name="l00088"></a><a class="code" href="a00056.html#8f34bf94c74324816ba970d3e229b62c">00088</a> <span class="keywordtype">void</span> <a class="code" href="a00053.html#8f34bf94c74324816ba970d3e229b62c" title="Low-level functions (basic management).">mmc_sd_spi_init</a>(<span class="keywordtype">void</span>)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090    <a class="code" href="a00072.html#49d47418ae74e184fcaf75ff01f72192">Spi_select_master</a>();
<a name="l00091"></a>00091    <a class="code" href="a00072.html#e376e9566842eee97134c973b46c4e19">Spi_set_mode</a>(<a class="code" href="a00072.html#1ec07ad94d5f6276c1c0b41d0550fe52">SPI_MODE_0</a>);
<a name="l00092"></a>00092    <a class="code" href="a00072.html#28826d8905e9c9eb49f260d2fba4d588">Spi_init_bus</a>();
<a name="l00093"></a>00093    <a class="code" href="a00072.html#adb0cf7b9c4910655082f4f2abc9e7fe">Spi_set_rate</a>(<a class="code" href="a00072.html#794870725abd9d2ed6e6f497690a82f3">SPI_RATE_0</a>);  <span class="comment">// SCK freq == fosc/2.</span>
<a name="l00094"></a>00094    <a class="code" href="a00072.html#b163b6dfa1bcf4b8aa8160f21964ed39">Spi_disable_ss</a>();
<a name="l00095"></a>00095    <a class="code" href="a00072.html#c8234d59f9ec0048276dfcdfd70e6479">Spi_enable</a>();
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00110"></a><a class="code" href="a00054.html#d4d542de1d406f3194f8a321e4700fdd">00110</a> bit <a class="code" href="a00053.html#d4d542de1d406f3194f8a321e4700fdd">mmc_sd_init</a> (<span class="keywordtype">void</span>)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> retry;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   <span class="comment">// INIT HARDWARE</span>
<a name="l00115"></a>00115   <a class="code" href="a00053.html#8f34bf94c74324816ba970d3e229b62c" title="Low-level functions (basic management).">mmc_sd_spi_init</a>();
<a name="l00116"></a>00116 
<a name="l00117"></a>00117   <span class="comment">// RESET THE MEMORY CARD</span>
<a name="l00118"></a>00118   <a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00119"></a>00119   <a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> = <a class="code" href="a00054.html#8a2031a4cd1b409046872b92c3097496">MMC_CARD</a>;
<a name="l00120"></a>00120   retry = 0;
<a name="l00121"></a>00121   <span class="keywordflow">do</span>
<a name="l00122"></a>00122   {
<a name="l00123"></a>00123     <span class="comment">// reset card and go to SPI mode</span>
<a name="l00124"></a>00124     <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#8cf3224a23122ebda44e49c946adfd04" title="initialize card to SPI-type access">MMC_GO_IDLE_STATE</a>, 0);
<a name="l00125"></a>00125     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00126"></a>00126     <span class="comment">// do retry counter</span>
<a name="l00127"></a>00127     retry++;
<a name="l00128"></a>00128     <span class="keywordflow">if</span>(retry &gt; 100)
<a name="l00129"></a>00129       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00130"></a>00130   }
<a name="l00131"></a>00131   <span class="keywordflow">while</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x01);   <span class="comment">// check memory enters idle_state</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="comment">// IDENTIFICATION OF THE CARD TYPE (SD or MMC)</span>
<a name="l00134"></a>00134   <span class="comment">// Both cards will accept CMD55 command but only the SD card will respond to ACMD41</span>
<a name="l00135"></a>00135   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#11c3490d3463c1671fd27a4780d8e3d4" title="Use before any specific command (type ACMD).">SD_APP_CMD55</a>,0);
<a name="l00136"></a>00136   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);  <span class="comment">// write dummy byte</span>
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#0170fbdafe027e46fdb5f57153176734" title="Same as MMC_SEND_OP_COND but specific to SD (must be preceeded by CMD55).">SD_SEND_OP_COND_ACMD</a>, 0);
<a name="l00139"></a>00139   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);  <span class="comment">// write dummy byte</span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>&amp;0xFE) == 0)   <span class="comment">// ignore "in_idle_state" flag bit</span>
<a name="l00142"></a>00142   {
<a name="l00143"></a>00143     <a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> = <a class="code" href="a00054.html#76180f44d6e7cb89e7458652f0abf88f">SD_CARD</a>;    <span class="comment">// card has accepted the command, this is a SD card</span>
<a name="l00144"></a>00144   }
<a name="l00145"></a>00145   <span class="keywordflow">else</span>
<a name="l00146"></a>00146   {
<a name="l00147"></a>00147     <a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> = <a class="code" href="a00054.html#8a2031a4cd1b409046872b92c3097496">MMC_CARD</a>;   <span class="comment">// card has not responded, this is a MMC card</span>
<a name="l00148"></a>00148     <span class="comment">// reset card again</span>
<a name="l00149"></a>00149     retry = 0;
<a name="l00150"></a>00150     <span class="keywordflow">do</span>
<a name="l00151"></a>00151     {
<a name="l00152"></a>00152       <span class="comment">// reset card again</span>
<a name="l00153"></a>00153       <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#8cf3224a23122ebda44e49c946adfd04" title="initialize card to SPI-type access">MMC_GO_IDLE_STATE</a>, 0);
<a name="l00154"></a>00154       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00155"></a>00155       <span class="comment">// do retry counter</span>
<a name="l00156"></a>00156       retry++;
<a name="l00157"></a>00157       <span class="keywordflow">if</span>(retry &gt; 100)
<a name="l00158"></a>00158         <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     <span class="keywordflow">while</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x01);   <span class="comment">// check memory enters idle_state</span>
<a name="l00161"></a>00161   }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   <span class="comment">// CONTINUE INTERNAL INITIALIZATION OF THE CARD</span>
<a name="l00164"></a>00164   <span class="comment">// Continue sending CMD1 while memory card is in idle state</span>
<a name="l00165"></a>00165   retry = 0;
<a name="l00166"></a>00166   <span class="keywordflow">do</span>
<a name="l00167"></a>00167   {
<a name="l00168"></a>00168      <span class="comment">// initializing card for operation</span>
<a name="l00169"></a>00169      <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#84fa553012e25291f05e4c4be438d78a" title="set card operational mode">MMC_SEND_OP_COND</a>, 0);
<a name="l00170"></a>00170      <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00171"></a>00171      <span class="comment">// do retry counter</span>
<a name="l00172"></a>00172      retry++;
<a name="l00173"></a>00173      <span class="keywordflow">if</span>(retry == 50000)    <span class="comment">// measured approx. 500 on several cards</span>
<a name="l00174"></a>00174         <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176   <span class="keywordflow">while</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="comment">// DISABLE CRC TO SIMPLIFY AND SPEED UP COMMUNICATIONS</span>
<a name="l00179"></a>00179   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#9ee47dbf3e70e302322862e1ed16eafb" title="Turns CRC check on/off.">MMC_CRC_ON_OFF</a>, 0);  <span class="comment">// disable CRC (should be already initialized on SPI init)</span>
<a name="l00180"></a>00180   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00181"></a>00181 
<a name="l00182"></a>00182   <span class="comment">// SET BLOCK LENGTH TO 512 BYTES</span>
<a name="l00183"></a>00183   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#b1142dc0b5000334f36fff50f7866b72" title="Set number of bytes to transfer per block.">MMC_SET_BLOCKLEN</a>, 512);
<a name="l00184"></a>00184   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00185"></a>00185   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00186"></a>00186     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;    <span class="comment">// card unsupported if block length of 512b is not accepted</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <span class="comment">// GET CARD SPECIFIC DATA</span>
<a name="l00189"></a>00189   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> ==  <a class="code" href="a00053.html#4d5750b93c848823f89bc799ba94901a">mmc_sd_get_csd</a>(<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>))
<a name="l00190"></a>00190     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <span class="comment">// GET CARD CAPACITY and NUMBER OF SECTORS</span>
<a name="l00193"></a>00193   <a class="code" href="a00053.html#9fae25068ae838f03775eee557170056">mmc_sd_get_capacity</a>();
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   <span class="comment">// GET CARD IDENTIFICATION DATA IF REQUIRED</span>
<a name="l00196"></a>00196 <span class="preprocessor">#if (MMC_SD_READ_CID == ENABLED)</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> ==  <a class="code" href="a00053.html#0ea51affc747ca1e812406c13cb0d2d4">mmc_sd_get_cid</a>(<a class="code" href="a00053.html#03c71be37b4156a9bcb0c7757a339509">cid</a>))
<a name="l00198"></a>00198     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00199"></a>00199 <span class="preprocessor">#endif</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>
<a name="l00201"></a>00201   <a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> = <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   <span class="keywordflow">return</span>(<a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>);
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="a00054.html#affc5d5f9e141cedbdbe4caaa32886d9">00220</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> command, <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> arg)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                    <span class="comment">// select MMC_SD</span>
<a name="l00223"></a>00223   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(command, arg);
<a name="l00224"></a>00224   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l00225"></a>00225   <span class="keywordflow">return</span> <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>;
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00240"></a><a class="code" href="a00054.html#f97cddeafe57ccc6c321195b9ebd14bf">00240</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> command, <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> arg)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242 <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> retry;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00245"></a>00245   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(command | 0x40);  <span class="comment">// send command</span>
<a name="l00246"></a>00246   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(arg&gt;&gt;24);         <span class="comment">// send parameter</span>
<a name="l00247"></a>00247   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(arg&gt;&gt;16);
<a name="l00248"></a>00248   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(arg&gt;&gt;8 );
<a name="l00249"></a>00249   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(arg    );
<a name="l00250"></a>00250   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0x95);            <span class="comment">// correct CRC for first command in SPI (CMD0)</span>
<a name="l00251"></a>00251                                   <span class="comment">// after, the CRC is ignored</span>
<a name="l00252"></a>00252   <span class="comment">// end command</span>
<a name="l00253"></a>00253   <span class="comment">// wait for response</span>
<a name="l00254"></a>00254   <span class="comment">// if more than 8 retries, card has timed-out and return the received 0xFF</span>
<a name="l00255"></a>00255   retry = 0;
<a name="l00256"></a>00256   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>    = 0xFF;
<a name="l00257"></a>00257   <span class="keywordflow">while</span>((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) == 0xFF)
<a name="l00258"></a>00258   {
<a name="l00259"></a>00259     retry++;
<a name="l00260"></a>00260     <span class="keywordflow">if</span>(retry &gt; 10) <span class="keywordflow">break</span>;
<a name="l00261"></a>00261   }
<a name="l00262"></a>00262   <span class="keywordflow">return</span> <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>;
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 
<a name="l00278"></a><a class="code" href="a00054.html#2de785445d37919bb3bb9663d89893cb">00278</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> data_to_send)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280    <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(data_to_send);
<a name="l00281"></a>00281    <span class="keywordflow">return</span> (<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 
<a name="l00296"></a><a class="code" href="a00054.html#da198b30238a135ff97343861185e12a">00296</a> bit <a class="code" href="a00053.html#4d5750b93c848823f89bc799ba94901a">mmc_sd_get_csd</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *buffer)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298 <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> retry;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="comment">// wait for MMC not busy</span>
<a name="l00301"></a>00301   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l00302"></a>00302     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                  <span class="comment">// select MMC_SD</span>
<a name="l00305"></a>00305   <span class="comment">// issue command</span>
<a name="l00306"></a>00306   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#76d5895ad414df4f3f9c0b63825c6dd6" title="get card&amp;#39;s CSD">MMC_SEND_CSD</a>, 0);
<a name="l00307"></a>00307   <span class="comment">// check for valid response</span>
<a name="l00308"></a>00308   <span class="keywordflow">if</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00309"></a>00309   {
<a name="l00310"></a>00310     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00311"></a>00311     <a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00312"></a>00312     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00313"></a>00313   }
<a name="l00314"></a>00314   <span class="comment">// wait for block start</span>
<a name="l00315"></a>00315   retry = 0;
<a name="l00316"></a>00316   <span class="keywordflow">while</span>((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) != <a class="code" href="a00054.html#e9c8fadc636715f02aaec6f4d05b3c8f" title="when received from card, indicates that a block of data will follow">MMC_STARTBLOCK_READ</a>)
<a name="l00317"></a>00317   {
<a name="l00318"></a>00318     <span class="keywordflow">if</span> (retry &gt; 8)
<a name="l00319"></a>00319     {
<a name="l00320"></a>00320       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00321"></a>00321       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323     retry++;
<a name="l00324"></a>00324   }
<a name="l00325"></a>00325   <span class="keywordflow">for</span> (retry = 0; retry &lt;16; retry++)
<a name="l00326"></a>00326   {
<a name="l00327"></a>00327     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00328"></a>00328     buffer[retry] = <a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>();
<a name="l00329"></a>00329   }
<a name="l00330"></a>00330   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// load CRC (not used)</span>
<a name="l00331"></a>00331   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00332"></a>00332   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// give clock again to end transaction</span>
<a name="l00333"></a>00333   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00334"></a>00334   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 
<a name="l00349"></a><a class="code" href="a00054.html#8408d512adadff7f27c0d3b3a92bd12d">00349</a> bit <a class="code" href="a00053.html#0ea51affc747ca1e812406c13cb0d2d4">mmc_sd_get_cid</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *buffer)
<a name="l00350"></a>00350 {
<a name="l00351"></a>00351 <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> retry;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="comment">// wait for MMC not busy</span>
<a name="l00354"></a>00354   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l00355"></a>00355     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                  <span class="comment">// select MMC_SD</span>
<a name="l00358"></a>00358   <span class="comment">// issue command</span>
<a name="l00359"></a>00359   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#e70ae6dafa85fb8db2dea99b90982bba" title="get card&amp;#39;s CID">MMC_SEND_CID</a>, 0);
<a name="l00360"></a>00360   <span class="comment">// check for valid response</span>
<a name="l00361"></a>00361   <span class="keywordflow">if</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00362"></a>00362   {
<a name="l00363"></a>00363     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00364"></a>00364     <a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00365"></a>00365     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00366"></a>00366   }
<a name="l00367"></a>00367   <span class="comment">// wait for data block start</span>
<a name="l00368"></a>00368   retry = 0;
<a name="l00369"></a>00369   <span class="keywordflow">while</span>((<a class="code" href="a00053.html#9558a869846dac22da723081ea0792b0">r2</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) != <a class="code" href="a00054.html#e9c8fadc636715f02aaec6f4d05b3c8f" title="when received from card, indicates that a block of data will follow">MMC_STARTBLOCK_READ</a>)
<a name="l00370"></a>00370   {
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (retry &gt; 8)
<a name="l00372"></a>00372     {
<a name="l00373"></a>00373       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00374"></a>00374       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376     retry++;
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378   <span class="comment">// store valid data block</span>
<a name="l00379"></a>00379   <span class="keywordflow">for</span> (retry = 0; retry &lt;16; retry++)
<a name="l00380"></a>00380   {
<a name="l00381"></a>00381     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00382"></a>00382     buffer[retry] = <a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>();
<a name="l00383"></a>00383   }
<a name="l00384"></a>00384   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// load CRC (not used)</span>
<a name="l00385"></a>00385   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00386"></a>00386   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// give clock again to end transaction</span>
<a name="l00387"></a>00387   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00388"></a>00388   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 
<a name="l00392"></a>00392 
<a name="l00424"></a><a class="code" href="a00054.html#9fae25068ae838f03775eee557170056">00424</a> <span class="keywordtype">void</span> <a class="code" href="a00053.html#9fae25068ae838f03775eee557170056">mmc_sd_get_capacity</a>(<span class="keywordtype">void</span>)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> c_size;
<a name="l00427"></a>00427   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  c_size_mult;
<a name="l00428"></a>00428   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  read_bl_len;
<a name="l00429"></a>00429   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  erase_grp_size;
<a name="l00430"></a>00430   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  erase_grp_mult;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432   <span class="comment">// extract variables from CSD array</span>
<a name="l00433"></a>00433   c_size      = ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[6] &amp; 0x03) &lt;&lt; 10) + (<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[7] &lt;&lt; 2) + ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[8] &amp; 0xC0) &gt;&gt; 6);
<a name="l00434"></a>00434   c_size_mult = ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[9] &amp; 0x03) &lt;&lt; 1) + ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[10] &amp; 0x80) &gt;&gt; 7);
<a name="l00435"></a>00435   read_bl_len = <a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[5] &amp; 0x0F;
<a name="l00436"></a>00436   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> == <a class="code" href="a00054.html#8a2031a4cd1b409046872b92c3097496">MMC_CARD</a>)
<a name="l00437"></a>00437   {
<a name="l00438"></a>00438     erase_grp_size = ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[10] &amp; 0x7C) &gt;&gt; 2);
<a name="l00439"></a>00439     erase_grp_mult = ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[10] &amp; 0x03) &lt;&lt; 3) | ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[11] &amp; 0xE0) &gt;&gt; 5);
<a name="l00440"></a>00440   }
<a name="l00441"></a>00441   <span class="keywordflow">else</span>
<a name="l00442"></a>00442   {
<a name="l00443"></a>00443     erase_grp_size = ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[10] &amp; 0x3F) &lt;&lt; 1) + ((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[11] &amp; 0x80) &gt;&gt; 7);
<a name="l00444"></a>00444     erase_grp_mult = 0;
<a name="l00445"></a>00445   }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447   <span class="comment">// compute last block addr</span>
<a name="l00448"></a>00448   <a class="code" href="a00053.html#3018533c69dc6d2688672666433bae38">mmc_sd_last_block_address</a> = ((<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)(c_size + 1) * (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)((1 &lt;&lt; (c_size_mult + 2)))) - 1;
<a name="l00449"></a>00449   <span class="keywordflow">if</span> (read_bl_len &gt; 9)  <span class="comment">// 9 means 2^9 = 512b</span>
<a name="l00450"></a>00450     <a class="code" href="a00053.html#3018533c69dc6d2688672666433bae38">mmc_sd_last_block_address</a> &lt;&lt;= (read_bl_len - 9);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="comment">// compute card capacity in bytes</span>
<a name="l00453"></a>00453   <a class="code" href="a00053.html#db0f9d91aed791a1402b20e1e2274e3e">capacity</a> = (1 &lt;&lt; read_bl_len) * (<a class="code" href="a00053.html#3018533c69dc6d2688672666433bae38">mmc_sd_last_block_address</a> + 1);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <span class="comment">// compute block group size for erase operation</span>
<a name="l00456"></a>00456   <a class="code" href="a00053.html#acdf747ad4ef1aa39993227458be7c83">erase_group_size</a> = (erase_grp_size + 1) * (erase_grp_mult + 1);
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 
<a name="l00472"></a><a class="code" href="a00054.html#be42ef551da85c659240ebe5df2009f5">00472</a> bit     <a class="code" href="a00053.html#be42ef551da85c659240ebe5df2009f5">mmc_sd_get_status</a>(<span class="keywordtype">void</span>)
<a name="l00473"></a>00473 {
<a name="l00474"></a>00474   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> retry, spireg;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   <span class="comment">// wait for MMC not busy</span>
<a name="l00477"></a>00477   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l00478"></a>00478     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00479"></a>00479 
<a name="l00480"></a>00480   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();       <span class="comment">// select MMC_SD</span>
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="comment">// send command</span>
<a name="l00483"></a>00483   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00054.html#ccf43154387f91ebfb4bc63b96fcb1bf">MMC_SEND_STATUS</a> | 0x40);  <span class="comment">// send command</span>
<a name="l00484"></a>00484   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);                       <span class="comment">// send parameter</span>
<a name="l00485"></a>00485   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);
<a name="l00486"></a>00486   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);
<a name="l00487"></a>00487   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);
<a name="l00488"></a>00488   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0x95);            <span class="comment">// correct CRC for first command in SPI (CMD0)</span>
<a name="l00489"></a>00489                                   <span class="comment">// after, the CRC is ignored</span>
<a name="l00490"></a>00490   <span class="comment">// end command</span>
<a name="l00491"></a>00491   <span class="comment">// wait for response</span>
<a name="l00492"></a>00492   <span class="comment">// if more than 8 retries, card has timed-out and return the received 0xFF</span>
<a name="l00493"></a>00493   retry = 0;
<a name="l00494"></a>00494   <a class="code" href="a00053.html#9558a869846dac22da723081ea0792b0">r2</a> = 0xFFFF;
<a name="l00495"></a>00495   spireg = 0xFF;
<a name="l00496"></a>00496   <span class="keywordflow">while</span>((spireg = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) == 0xFF)
<a name="l00497"></a>00497   {
<a name="l00498"></a>00498     retry++;
<a name="l00499"></a>00499     <span class="keywordflow">if</span>(retry &gt; 10)
<a name="l00500"></a>00500     {
<a name="l00501"></a>00501       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l00502"></a>00502       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00503"></a>00503     }
<a name="l00504"></a>00504   }
<a name="l00505"></a>00505   <a class="code" href="a00053.html#9558a869846dac22da723081ea0792b0">r2</a> = ((<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>)(spireg) &lt;&lt; 8) + <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF);    <span class="comment">// first byte is MSb</span>
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// give clock again to end transaction</span>
<a name="l00508"></a>00508   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l00509"></a>00509 
<a name="l00510"></a>00510   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 
<a name="l00524"></a><a class="code" href="a00054.html#b8c6dec121c640e11375ffe22264dd52">00524</a> bit <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>(<span class="keywordtype">void</span>)
<a name="l00525"></a>00525 {
<a name="l00526"></a>00526   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> retry;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528   <span class="comment">// Select the MMC_SD memory gl_ptr_mem points to</span>
<a name="l00529"></a>00529   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();
<a name="l00530"></a>00530   retry = 0;
<a name="l00531"></a>00531   <span class="keywordflow">while</span>((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) != 0xFF)
<a name="l00532"></a>00532   {
<a name="l00533"></a>00533     retry++;
<a name="l00534"></a>00534     <span class="keywordflow">if</span> (retry == 50000)
<a name="l00535"></a>00535     {
<a name="l00536"></a>00536       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l00537"></a>00537       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539   }
<a name="l00540"></a>00540   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l00541"></a>00541   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 
<a name="l00559"></a><a class="code" href="a00054.html#9f924a04278a3ee67e02c4ef3390ce1a">00559</a> bit <a class="code" href="a00053.html#9f924a04278a3ee67e02c4ef3390ce1a">mmc_sd_check_presence</a>(<span class="keywordtype">void</span>)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> retry;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   retry = 0;
<a name="l00564"></a>00564   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> == <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l00565"></a>00565   {
<a name="l00566"></a>00566     <span class="comment">// If memory is not initialized, try to initialize it (CMD0)</span>
<a name="l00567"></a>00567     <span class="comment">// If no valid response, there is no card</span>
<a name="l00568"></a>00568     <span class="keywordflow">while</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#8cf3224a23122ebda44e49c946adfd04" title="initialize card to SPI-type access">MMC_GO_IDLE_STATE</a>, 0)) != 0x01)
<a name="l00569"></a>00569     {
<a name="l00570"></a>00570       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00571"></a>00571       retry++;
<a name="l00572"></a>00572       <span class="keywordflow">if</span> (retry &gt; 10)
<a name="l00573"></a>00573         <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00576"></a>00576   }
<a name="l00577"></a>00577   <span class="keywordflow">else</span>
<a name="l00578"></a>00578   {
<a name="l00579"></a>00579     <span class="comment">// If memory already initialized, send a CRC command (CMD59) (supported only if card is initialized)</span>
<a name="l00580"></a>00580     <span class="comment">/*</span>
<a name="l00581"></a>00581 <span class="comment">    retry = 0;</span>
<a name="l00582"></a>00582 <span class="comment">    while (retry != 50000)</span>
<a name="l00583"></a>00583 <span class="comment">    {</span>
<a name="l00584"></a>00584 <span class="comment">      r1 = mmc_sd_send_command(MMC_CMD2,0);   // unsupported command in SPI mode</span>
<a name="l00585"></a>00585 <span class="comment">      Spi_write_data(0xFF);            // write dummy byte</span>
<a name="l00586"></a>00586 <span class="comment">      if (r1 != 0)    // memory must answer with an error code (with bit7=0)</span>
<a name="l00587"></a>00587 <span class="comment">      {</span>
<a name="l00588"></a>00588 <span class="comment">        if (r1 &lt; 0x80)</span>
<a name="l00589"></a>00589 <span class="comment">          return OK;</span>
<a name="l00590"></a>00590 <span class="comment">        else</span>
<a name="l00591"></a>00591 <span class="comment">        {</span>
<a name="l00592"></a>00592 <span class="comment">          mmc_sd_init_done = FALSE;</span>
<a name="l00593"></a>00593 <span class="comment">          return KO;</span>
<a name="l00594"></a>00594 <span class="comment">        }</span>
<a name="l00595"></a>00595 <span class="comment">      }</span>
<a name="l00596"></a>00596 <span class="comment">      retry++;</span>
<a name="l00597"></a>00597 <span class="comment">    }</span>
<a name="l00598"></a>00598 <span class="comment">    */</span>
<a name="l00599"></a>00599     <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#9ee47dbf3e70e302322862e1ed16eafb" title="Turns CRC check on/off.">MMC_CRC_ON_OFF</a>,0)) == 0x00)
<a name="l00600"></a>00600       <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00601"></a>00601     <a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> = <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00602"></a>00602     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00603"></a>00603   }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605   <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 
<a name="l00621"></a><a class="code" href="a00054.html#a109168018a3a1d1e201f915f7fc89d4">00621</a> bit <a class="code" href="a00053.html#a109168018a3a1d1e201f915f7fc89d4">mmc_sd_mem_check</a>(<span class="keywordtype">void</span>)
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#9f924a04278a3ee67e02c4ef3390ce1a">mmc_sd_check_presence</a>() == <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>)
<a name="l00624"></a>00624   {
<a name="l00625"></a>00625     <span class="keywordflow">if</span> (<a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> == <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l00626"></a>00626     {
<a name="l00627"></a>00627       <a class="code" href="a00053.html#d4d542de1d406f3194f8a321e4700fdd">mmc_sd_init</a>();
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629     <span class="keywordflow">if</span> (<a class="code" href="a00053.html#158e5b64ed278e0b8b063c9af05694c4">mmc_sd_init_done</a> == <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)
<a name="l00630"></a>00630       <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00631"></a>00631     <span class="keywordflow">else</span>
<a name="l00632"></a>00632       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00633"></a>00633   }
<a name="l00634"></a>00634   <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 
<a name="l00653"></a><a class="code" href="a00054.html#a3cc10e77038abea696ccce4ad41c195">00653</a> bit <a class="code" href="a00053.html#a3cc10e77038abea696ccce4ad41c195" title="Protection functions (optionnal).">is_mmc_sd_write_pwd_locked</a>(<span class="keywordtype">void</span>)
<a name="l00654"></a>00654 {
<a name="l00655"></a>00655   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> == <a class="code" href="a00054.html#8a2031a4cd1b409046872b92c3097496">MMC_CARD</a>)
<a name="l00656"></a>00656   {
<a name="l00657"></a>00657     <span class="keywordflow">if</span> (((<a class="code" href="a00053.html#da075df9d52cfc9c0a34885234938f61">csd</a>[0] &gt;&gt; 2) &amp; 0x0F) &lt; 2) <span class="comment">// lock feature is not present on the card since the MMC is v1.x released !</span>
<a name="l00658"></a>00658       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00659"></a>00659   }
<a name="l00660"></a>00660   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#be42ef551da85c659240ebe5df2009f5">mmc_sd_get_status</a>())    <span class="comment">// get STATUS response</span>
<a name="l00661"></a>00661     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00662"></a>00662   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#9558a869846dac22da723081ea0792b0">r2</a>&amp;0x0001) != 0)             <span class="comment">// check "card is locked" flag in R2 response</span>
<a name="l00663"></a>00663     <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 
<a name="l00698"></a><a class="code" href="a00054.html#b2c42ab031dd3300bc3f9dd20e10a8b9">00698</a> bit <a class="code" href="a00053.html#3dace5e46b46051f59fd97c197c3c5cd">mmc_sd_lock_operation</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> operation, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> pwd_lg, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> * pwd)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700   bit status = <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00701"></a>00701   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> retry;
<a name="l00702"></a>00702 
<a name="l00703"></a>00703   <span class="comment">// check parameters validity</span>
<a name="l00704"></a>00704   <span class="keywordflow">if</span> ((operation != <a class="code" href="a00054.html#1836be7d18d043be23492257f445b876">OP_FORCED_ERASE</a>) &amp;&amp; (pwd_lg == 0))  <span class="comment">// password length must be &gt; 0</span>
<a name="l00705"></a>00705     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   <span class="comment">// wait card not busy</span>
<a name="l00708"></a>00708   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>() == <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>)
<a name="l00709"></a>00709     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711   <span class="comment">// set block length</span>
<a name="l00712"></a>00712   <span class="keywordflow">if</span> (operation == <a class="code" href="a00054.html#1836be7d18d043be23492257f445b876">OP_FORCED_ERASE</a>)
<a name="l00713"></a>00713     <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#b1142dc0b5000334f36fff50f7866b72" title="Set number of bytes to transfer per block.">MMC_SET_BLOCKLEN</a>, 1);   <span class="comment">// CMD</span>
<a name="l00714"></a>00714   <span class="keywordflow">else</span>
<a name="l00715"></a>00715     <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#b1142dc0b5000334f36fff50f7866b72" title="Set number of bytes to transfer per block.">MMC_SET_BLOCKLEN</a>, pwd_lg+2);   <span class="comment">// CMD + PWDSLEN + PWD</span>
<a name="l00716"></a>00716   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00717"></a>00717   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00718"></a>00718   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00719"></a>00719   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00720"></a>00720     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722   <span class="comment">// send the lock command to the card</span>
<a name="l00723"></a>00723   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                <span class="comment">// select MMC_SD</span>
<a name="l00724"></a>00724 
<a name="l00725"></a>00725   <span class="comment">// issue command</span>
<a name="l00726"></a>00726   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#c0af7cea1fbd34dec23065eb262f32d1" title="To start a lock/unlock/pwd operation.">MMC_LOCK_UNLOCK</a>, 0);
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="comment">// check for valid response</span>
<a name="l00729"></a>00729   <span class="keywordflow">if</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00730"></a>00730   {
<a name="l00731"></a>00731     status = <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00732"></a>00732   }
<a name="l00733"></a>00733   <span class="comment">// send dummy</span>
<a name="l00734"></a>00734   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// give clock again to end transaction</span>
<a name="l00735"></a>00735 
<a name="l00736"></a>00736   <span class="comment">// send data start token</span>
<a name="l00737"></a>00737   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00054.html#dc1c7a27cf22e2a626a47cba533fb511" title="when sent to card, indicates that a block of data will follow">MMC_STARTBLOCK_WRITE</a>);
<a name="l00738"></a>00738   <span class="comment">// write data</span>
<a name="l00739"></a>00739   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(operation);
<a name="l00740"></a>00740   <span class="keywordflow">if</span> (operation != <a class="code" href="a00054.html#1836be7d18d043be23492257f445b876">OP_FORCED_ERASE</a>)
<a name="l00741"></a>00741   {
<a name="l00742"></a>00742     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(pwd_lg);
<a name="l00743"></a>00743     <span class="keywordflow">for</span>(retry=0 ; retry&lt;pwd_lg ; retry++)
<a name="l00744"></a>00744     {
<a name="l00745"></a>00745       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(*(pwd+retry));
<a name="l00746"></a>00746     }
<a name="l00747"></a>00747   }
<a name="l00748"></a>00748   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);    <span class="comment">// send CRC (field required but value ignored)</span>
<a name="l00749"></a>00749   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   <span class="comment">// check data response token</span>
<a name="l00752"></a>00752   retry = 0;
<a name="l00753"></a>00753   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF);
<a name="l00754"></a>00754   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> &amp; <a class="code" href="a00054.html#46c1a8415ae80aee30e3b6b00a3f90a8">MMC_DR_MASK</a>) != <a class="code" href="a00054.html#a21c6cd7b46ce7100527eeea4f661b4b">MMC_DR_ACCEPT</a>)
<a name="l00755"></a>00755     status = <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);    <span class="comment">// dummy byte</span>
<a name="l00758"></a>00758   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l00759"></a>00759 
<a name="l00760"></a>00760   <span class="comment">// wait card not busy</span>
<a name="l00761"></a>00761   <span class="keywordflow">if</span> (operation == <a class="code" href="a00054.html#1836be7d18d043be23492257f445b876">OP_FORCED_ERASE</a>)
<a name="l00762"></a>00762     retry = 100;
<a name="l00763"></a>00763   <span class="keywordflow">else</span>
<a name="l00764"></a>00764     retry = 10;
<a name="l00765"></a>00765   <span class="keywordflow">while</span> (<a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>() == <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>)
<a name="l00766"></a>00766   {
<a name="l00767"></a>00767     retry--;
<a name="l00768"></a>00768     <span class="keywordflow">if</span> (retry == 0)
<a name="l00769"></a>00769     {
<a name="l00770"></a>00770       status = <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00771"></a>00771       <span class="keywordflow">break</span>;
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775   <span class="comment">// get and check status of the operation</span>
<a name="l00776"></a>00776   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#be42ef551da85c659240ebe5df2009f5">mmc_sd_get_status</a>())    <span class="comment">// get STATUS response</span>
<a name="l00777"></a>00777     status = <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00778"></a>00778   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#9558a869846dac22da723081ea0792b0">r2</a>&amp;0x0002) != 0)   <span class="comment">// check "lock/unlock cmd failed" flag in R2 response</span>
<a name="l00779"></a>00779     status = <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781   <span class="comment">// set original block length</span>
<a name="l00782"></a>00782   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#a70aab6711f6c7fc7f4a8bd9f3c2355c">mmc_sd_send_command</a>(<a class="code" href="a00054.html#b1142dc0b5000334f36fff50f7866b72" title="Set number of bytes to transfer per block.">MMC_SET_BLOCKLEN</a>, 512);
<a name="l00783"></a>00783   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);            <span class="comment">// write dummy byte</span>
<a name="l00784"></a>00784   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00785"></a>00785     status = <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787   <span class="keywordflow">return</span> status;
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 
<a name="l00802"></a><a class="code" href="a00054.html#c238535ea18f7e00f9c7c3b098d33914">00802</a> bit <a class="code" href="a00053.html#d8cf80c9a8b7b907aed581d16a44365e" title="Functions for preparing block read/write.">mmc_sd_read_open</a> (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> pos)
<a name="l00803"></a>00803 {
<a name="l00804"></a>00804   <span class="comment">// Set the global memory ptr at a Byte address.</span>
<a name="l00805"></a>00805   <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> = pos &lt;&lt; 9;        <span class="comment">// gl_ptr_mem = pos * 512</span>
<a name="l00806"></a>00806 
<a name="l00807"></a>00807   <span class="comment">// wait for MMC not busy</span>
<a name="l00808"></a>00808   <span class="keywordflow">return</span> <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>();
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 
<a name="l00821"></a><a class="code" href="a00054.html#c9ac50b353ad95dceb98f8116f6b08bb">00821</a> <span class="keywordtype">void</span> <a class="code" href="a00053.html#c9ac50b353ad95dceb98f8116f6b08bb">mmc_sd_read_close</a> (<span class="keywordtype">void</span>)
<a name="l00822"></a>00822 {
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 
<a name="l00841"></a><a class="code" href="a00054.html#5e139ebdbdf16267dfacf965017083b7">00841</a> bit <a class="code" href="a00053.html#223e252273a01d658e3cee43ba0bcc41">mmc_sd_write_open</a> (<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> pos)
<a name="l00842"></a>00842 {
<a name="l00843"></a>00843   <span class="comment">// Set the global memory ptr at a Byte address.</span>
<a name="l00844"></a>00844   <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> = pos &lt;&lt; 9;                    <span class="comment">// gl_ptr_mem = pos * 512</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846   <span class="comment">// wait for MMC not busy</span>
<a name="l00847"></a>00847   <span class="keywordflow">return</span> <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>();
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a>00850 
<a name="l00861"></a><a class="code" href="a00054.html#c779a4bf4037a08f3f1f2481c8224c77">00861</a> <span class="keywordtype">void</span> <a class="code" href="a00053.html#c779a4bf4037a08f3f1f2481c8224c77">mmc_sd_write_close</a> (<span class="keywordtype">void</span>)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863 
<a name="l00864"></a>00864 }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 <span class="preprocessor">#if (MMC_SD_USB == ENABLE)</span>
<a name="l00869"></a>00869 <span class="preprocessor"></span>
<a name="l00894"></a><a class="code" href="a00054.html#e5b02af47ff0ae1465b870d78d91cad8">00894</a> bit <a class="code" href="a00053.html#b0f854f072a125bbeb9b66002da38aa6">mmc_sd_read_sector</a>(<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> nb_sector)
<a name="l00895"></a>00895 {
<a name="l00896"></a>00896   <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> i;
<a name="l00897"></a>00897   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  read_time_out;
<a name="l00898"></a>00898 
<a name="l00899"></a>00899   <span class="keywordflow">do</span>
<a name="l00900"></a>00900   {
<a name="l00901"></a>00901     <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                  <span class="comment">// select MMC_SD</span>
<a name="l00902"></a>00902     <span class="comment">// issue command</span>
<a name="l00903"></a>00903     <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#a79d6d187ee2becb90a44ff70914acb8" title="read a block">MMC_READ_SINGLE_BLOCK</a>, <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>);
<a name="l00904"></a>00904     <span class="comment">// check for valid response</span>
<a name="l00905"></a>00905     <span class="keywordflow">if</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l00906"></a>00906     {
<a name="l00907"></a>00907        <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l00908"></a>00908        <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     <span class="comment">// wait for token (may be a datablock start token OR a data error token !)</span>
<a name="l00912"></a>00912     read_time_out = 30000;
<a name="l00913"></a>00913     <span class="keywordflow">while</span>((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) == 0xFF)
<a name="l00914"></a>00914     {
<a name="l00915"></a>00915        read_time_out--;
<a name="l00916"></a>00916        <span class="keywordflow">if</span> (read_time_out == 0)   <span class="comment">// TIME-OUT</span>
<a name="l00917"></a>00917        {
<a name="l00918"></a>00918          <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();               <span class="comment">// unselect MMC_SD</span>
<a name="l00919"></a>00919          <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00920"></a>00920        }
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <span class="comment">// check token</span>
<a name="l00924"></a>00924     <span class="keywordflow">if</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != <a class="code" href="a00054.html#e9c8fadc636715f02aaec6f4d05b3c8f" title="when received from card, indicates that a block of data will follow">MMC_STARTBLOCK_READ</a>)
<a name="l00925"></a>00925     {
<a name="l00926"></a>00926       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00927"></a>00927       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l00928"></a>00928       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l00929"></a>00929     }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931     <span class="comment">//#</span>
<a name="l00932"></a>00932     <span class="comment">//# Read 8x64b = 512b, put them in the USB FIFO IN.</span>
<a name="l00933"></a>00933     <span class="comment">//#</span>
<a name="l00934"></a>00934     <span class="keywordflow">for</span> (i = 8; i != 0; i--)
<a name="l00935"></a>00935     {
<a name="l00936"></a>00936        Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l00937"></a>00937 
<a name="l00938"></a>00938        <span class="comment">// Principle: send any Byte to get a Byte.</span>
<a name="l00939"></a>00939        <span class="comment">// Spi_write_data(0): send any Byte + 1st step to clear the SPIF bit.</span>
<a name="l00940"></a>00940        <span class="comment">// Spi_read_data(): get the Byte + final step to clear the SPIF bit.</span>
<a name="l00941"></a>00941        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00942"></a>00942        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00943"></a>00943        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00944"></a>00944        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00945"></a>00945        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00946"></a>00946        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00947"></a>00947        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00948"></a>00948        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00949"></a>00949        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00950"></a>00950        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00951"></a>00951        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00952"></a>00952        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00953"></a>00953        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00954"></a>00954        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00955"></a>00955        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00956"></a>00956        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00957"></a>00957        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00958"></a>00958        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00959"></a>00959        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00960"></a>00960        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00961"></a>00961        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00962"></a>00962        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00963"></a>00963        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00964"></a>00964        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00965"></a>00965        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00966"></a>00966        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00967"></a>00967        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00968"></a>00968        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00969"></a>00969        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00970"></a>00970        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00971"></a>00971        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00972"></a>00972        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00973"></a>00973        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00974"></a>00974        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00975"></a>00975        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00976"></a>00976        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00977"></a>00977        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00978"></a>00978        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00979"></a>00979        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00980"></a>00980        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00981"></a>00981        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00982"></a>00982        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00983"></a>00983        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00984"></a>00984        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00985"></a>00985        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00986"></a>00986        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00987"></a>00987        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00988"></a>00988        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00989"></a>00989        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00990"></a>00990        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00991"></a>00991        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00992"></a>00992        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00993"></a>00993        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00994"></a>00994        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00995"></a>00995        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00996"></a>00996        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00997"></a>00997        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00998"></a>00998        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00999"></a>00999        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l01000"></a>01000        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l01001"></a>01001        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l01002"></a>01002        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l01003"></a>01003        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l01004"></a>01004        <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <a class="code" href="a00118.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l01005"></a>01005        Enable_interrupt();     <span class="comment">// Global re-enable.</span>
<a name="l01006"></a>01006 
<a name="l01007"></a>01007        <span class="comment">//#</span>
<a name="l01008"></a>01008        <span class="comment">//# Send the USB FIFO IN content to the USB Host.</span>
<a name="l01009"></a>01009        <span class="comment">//#</span>
<a name="l01010"></a>01010        <a class="code" href="a00118.html#g5369d57fde2684237cc527f6b555ebf5" title="sends IN">Usb_send_in</a>();       <span class="comment">// Send the FIFO IN content to the USB Host.</span>
<a name="l01011"></a>01011        <span class="comment">// Wait until the tx is done so that we may write to the FIFO IN again.</span>
<a name="l01012"></a>01012        <span class="keywordflow">while</span>(<a class="code" href="a00118.html#g1b470916df610d8750a5a5916976e687" title="tests if endpoint write allowed">Is_usb_write_enabled</a>()==<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l01013"></a>01013        {
<a name="l01014"></a>01014           <span class="keywordflow">if</span>(!<a class="code" href="a00118.html#g0f52bbafba70190a44a789befbc82a46" title="tests if the current endpoint is enabled">Is_usb_endpoint_enabled</a>())
<a name="l01015"></a>01015              <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>; <span class="comment">// USB Reset</span>
<a name="l01016"></a>01016        }
<a name="l01017"></a>01017     } <span class="comment">// for (i = 8; i != 0; i--)</span>
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;     <span class="comment">// Update the memory pointer.</span>
<a name="l01020"></a>01020     nb_sector--;           <span class="comment">// 1 more sector read</span>
<a name="l01021"></a>01021     <span class="comment">// read 16-bit CRC</span>
<a name="l01022"></a>01022     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01023"></a>01023     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01024"></a>01024     <span class="comment">// dummy bytes</span>
<a name="l01025"></a>01025     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01026"></a>01026     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01027"></a>01027     <span class="comment">// release chip select</span>
<a name="l01028"></a>01028     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01029"></a>01029   }
<a name="l01030"></a>01030   <span class="keywordflow">while</span> (nb_sector != 0);
<a name="l01031"></a>01031 
<a name="l01032"></a>01032   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;   <span class="comment">// Read done.</span>
<a name="l01033"></a>01033 }
<a name="l01034"></a>01034 
<a name="l01035"></a>01035 
<a name="l01059"></a><a class="code" href="a00054.html#9e62fdf9e4f3ca7f2a81c55bb9834511">01059</a> bit <a class="code" href="a00053.html#0f141a1dd3ccefd988b47040eee6cf96" title="Funtions to link USB DEVICE flow with MMC.">mmc_sd_write_sector</a> (<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> nb_sector)
<a name="l01060"></a>01060 {
<a name="l01061"></a>01061 <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i;
<a name="l01062"></a>01062 
<a name="l01063"></a>01063   <span class="keywordflow">do</span>
<a name="l01064"></a>01064   {
<a name="l01065"></a>01065     <span class="comment">// wait card not busy</span>
<a name="l01066"></a>01066     i=0;
<a name="l01067"></a>01067     <span class="keywordflow">while</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l01068"></a>01068     {
<a name="l01069"></a>01069       i++;
<a name="l01070"></a>01070       <span class="keywordflow">if</span> (i == 10)
<a name="l01071"></a>01071         <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074     <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                  <span class="comment">// select MMC_SD</span>
<a name="l01075"></a>01075     <span class="comment">// issue command</span>
<a name="l01076"></a>01076     <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#991d94c3be5fd4548d5bb222d03500f9" title="write a block">MMC_WRITE_BLOCK</a>, <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>);
<a name="l01077"></a>01077     <span class="comment">// check for valid response</span>
<a name="l01078"></a>01078     <span class="keywordflow">if</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l01079"></a>01079     {
<a name="l01080"></a>01080       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01081"></a>01081       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083     <span class="comment">// send dummy</span>
<a name="l01084"></a>01084     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// give clock again to end transaction</span>
<a name="l01085"></a>01085     <span class="comment">// send data start token</span>
<a name="l01086"></a>01086     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00054.html#dc1c7a27cf22e2a626a47cba533fb511" title="when sent to card, indicates that a block of data will follow">MMC_STARTBLOCK_WRITE</a>);
<a name="l01087"></a>01087       <span class="comment">// write data</span>
<a name="l01088"></a>01088   <span class="comment">//#</span>
<a name="l01089"></a>01089   <span class="comment">//# Write 8x64b = 512b from the USB FIFO OUT.</span>
<a name="l01090"></a>01090   <span class="comment">//#</span>
<a name="l01091"></a>01091     <span class="keywordflow">for</span> (i = 8; i != 0; i--)
<a name="l01092"></a>01092     {
<a name="l01093"></a>01093       <span class="comment">// Wait end of rx in USB EPOUT.</span>
<a name="l01094"></a>01094       <span class="keywordflow">while</span>(!<a class="code" href="a00118.html#g8e3f7189783aa06dacc91d232ab94afb" title="tests if endpoint read allowed">Is_usb_read_enabled</a>())
<a name="l01095"></a>01095       {
<a name="l01096"></a>01096          <span class="keywordflow">if</span>(!<a class="code" href="a00118.html#g0f52bbafba70190a44a789befbc82a46" title="tests if the current endpoint is enabled">Is_usb_endpoint_enabled</a>())
<a name="l01097"></a>01097            <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>; <span class="comment">// USB Reset</span>
<a name="l01098"></a>01098       }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100       Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l01101"></a>01101 
<a name="l01102"></a>01102       <span class="comment">// SPI write principle: send a Byte then clear the SPIF flag.</span>
<a name="l01103"></a>01103       <span class="comment">// Spi_write_data(Usb_read_byte()): (.) Final step to clear the SPIF bit,</span>
<a name="l01104"></a>01104       <span class="comment">//                                  (.) send a Byte read from USB,</span>
<a name="l01105"></a>01105       <span class="comment">//                                  (.) 1st step to clear the SPIF bit.</span>
<a name="l01106"></a>01106       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01107"></a>01107       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01108"></a>01108       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01109"></a>01109       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01110"></a>01110       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01111"></a>01111       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01112"></a>01112       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01113"></a>01113       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01114"></a>01114       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01115"></a>01115       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01116"></a>01116       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01117"></a>01117       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01118"></a>01118       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01119"></a>01119       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01120"></a>01120       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01121"></a>01121       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01122"></a>01122       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01123"></a>01123       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01124"></a>01124       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01125"></a>01125       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01126"></a>01126       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01127"></a>01127       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01128"></a>01128       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01129"></a>01129       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01130"></a>01130       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01131"></a>01131       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01132"></a>01132       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01133"></a>01133       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01134"></a>01134       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01135"></a>01135       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01136"></a>01136       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01137"></a>01137       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01138"></a>01138       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01139"></a>01139       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01140"></a>01140       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01141"></a>01141       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01142"></a>01142       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01143"></a>01143       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01144"></a>01144       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01145"></a>01145       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01146"></a>01146       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01147"></a>01147       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01148"></a>01148       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01149"></a>01149       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01150"></a>01150       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01151"></a>01151       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01152"></a>01152       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01153"></a>01153       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01154"></a>01154       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01155"></a>01155       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01156"></a>01156       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01157"></a>01157       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01158"></a>01158       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01159"></a>01159       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01160"></a>01160       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01161"></a>01161       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01162"></a>01162       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01163"></a>01163       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01164"></a>01164       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01165"></a>01165       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01166"></a>01166       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01167"></a>01167       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01168"></a>01168       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01169"></a>01169       <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00118.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l01170"></a>01170       <a class="code" href="a00072.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();        <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l01171"></a>01171 
<a name="l01172"></a>01172       <a class="code" href="a00118.html#g2bcdff32843bb358fa2f99d3d98452cd" title="acks reveive OUT">Usb_ack_receive_out</a>();  <span class="comment">// USB EPOUT read acknowledgement.</span>
<a name="l01173"></a>01173 
<a name="l01174"></a>01174       Enable_interrupt();     <span class="comment">// Global re-enable.</span>
<a name="l01175"></a>01175     } <span class="comment">// for (i = 8; i != 0; i--)</span>
<a name="l01176"></a>01176 
<a name="l01177"></a>01177     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);    <span class="comment">// send dummy CRC</span>
<a name="l01178"></a>01178     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01179"></a>01179 
<a name="l01180"></a>01180     <span class="comment">// read data response token</span>
<a name="l01181"></a>01181     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01182"></a>01182     <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>();
<a name="l01183"></a>01183     <span class="keywordflow">if</span>( (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>&amp;<a class="code" href="a00054.html#46c1a8415ae80aee30e3b6b00a3f90a8">MMC_DR_MASK</a>) != <a class="code" href="a00054.html#a21c6cd7b46ce7100527eeea4f661b4b">MMC_DR_ACCEPT</a>)
<a name="l01184"></a>01184     {
<a name="l01185"></a>01185       <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01186"></a>01186       <span class="keywordflow">return</span> <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>;
<a name="l01187"></a>01187     }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     <span class="comment">// send dummy byte</span>
<a name="l01190"></a>01190     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <span class="comment">// release chip select</span>
<a name="l01193"></a>01193     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01194"></a>01194     <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;        <span class="comment">// Update the memory pointer.</span>
<a name="l01195"></a>01195     nb_sector--;              <span class="comment">// 1 more sector written</span>
<a name="l01196"></a>01196   }
<a name="l01197"></a>01197   <span class="keywordflow">while</span> (nb_sector != 0);
<a name="l01198"></a>01198 
<a name="l01199"></a>01199   <span class="comment">// wait card not busy after last programming operation</span>
<a name="l01200"></a>01200   i=0;
<a name="l01201"></a>01201   <span class="keywordflow">while</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l01202"></a>01202   {
<a name="l01203"></a>01203     i++;
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (i == 10)
<a name="l01205"></a>01205       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01206"></a>01206   }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;                  <span class="comment">// Write done</span>
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 <span class="preprocessor">#endif      // (MMC_SD_USB == ENABLE)</span>
<a name="l01211"></a>01211 <span class="preprocessor"></span>
<a name="l01212"></a>01212 <span class="comment">/*</span>
<a name="l01237"></a>01237 <span class="comment">bit mmc_sd_host_write_sector (U16 nb_sector)</span>
<a name="l01238"></a>01238 <span class="comment">{</span>
<a name="l01239"></a>01239 <span class="comment"></span>
<a name="l01240"></a>01240 <span class="comment">  return OK;                  // Write done</span>
<a name="l01241"></a>01241 <span class="comment">}</span>
<a name="l01242"></a>01242 <span class="comment">*/</span>
<a name="l01243"></a>01243 
<a name="l01244"></a>01244 <span class="comment">/*</span>
<a name="l01270"></a>01270 <span class="comment">bit mmc_sd_host_read_sector (U16 nb_sector)</span>
<a name="l01271"></a>01271 <span class="comment">{</span>
<a name="l01272"></a>01272 <span class="comment"></span>
<a name="l01273"></a>01273 <span class="comment">  return OK;   // Read done.</span>
<a name="l01274"></a>01274 <span class="comment">}</span>
<a name="l01275"></a>01275 <span class="comment">*/</span>
<a name="l01276"></a>01276 
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 
<a name="l01298"></a><a class="code" href="a00054.html#bf0c367dc8625b13c1a20c33b28ec216">01298</a> bit <a class="code" href="a00053.html#c44ff29a6ccb4bdacce87b52a36fe8dd">mmc_sd_erase_sector_group</a>(<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> adr_start, <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> adr_end)
<a name="l01299"></a>01299 {
<a name="l01300"></a>01300   <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> cmd;
<a name="l01301"></a>01301 
<a name="l01302"></a>01302   <span class="comment">// wait for MMC not busy</span>
<a name="l01303"></a>01303   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l01304"></a>01304     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01305"></a>01305 
<a name="l01306"></a>01306   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();          <span class="comment">// select MMC_SD</span>
<a name="l01307"></a>01307 
<a name="l01308"></a>01308   <span class="comment">// send address of 1st group</span>
<a name="l01309"></a>01309   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> == <a class="code" href="a00054.html#8a2031a4cd1b409046872b92c3097496">MMC_CARD</a>)
<a name="l01310"></a>01310   { cmd = <a class="code" href="a00054.html#4f56fea30e7a1685b3cb40d1a015b4b9" title="Sets beginning of erase group (mass erase).">MMC_TAG_ERASE_GROUP_START</a>; }
<a name="l01311"></a>01311   <span class="keywordflow">else</span>
<a name="l01312"></a>01312   { cmd = <a class="code" href="a00054.html#298c23ab7aefaabaf48d5a0d167b94e1">SD_TAG_WR_ERASE_GROUP_START</a>; }
<a name="l01313"></a>01313   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(cmd,(adr_start &lt;&lt; 9))) != 0)
<a name="l01314"></a>01314   {
<a name="l01315"></a>01315     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l01316"></a>01316     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01317"></a>01317   }
<a name="l01318"></a>01318   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01319"></a>01319 
<a name="l01320"></a>01320   <span class="comment">// send address of last group</span>
<a name="l01321"></a>01321   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#9d2977983304d800cbceba3aeef133a0">card_type</a> == <a class="code" href="a00054.html#8a2031a4cd1b409046872b92c3097496">MMC_CARD</a>)
<a name="l01322"></a>01322   { cmd = <a class="code" href="a00054.html#d9a5c9fb68d6d5750f1223b47e98b7c4" title="Sets end of erase group (mass erase).">MMC_TAG_ERASE_GROUP_END</a>; }
<a name="l01323"></a>01323   <span class="keywordflow">else</span>
<a name="l01324"></a>01324   { cmd = <a class="code" href="a00054.html#714249949b9ed222f16b8f1350c38452">SD_TAG_WR_ERASE_GROUP_END</a>; }
<a name="l01325"></a>01325   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(cmd,(adr_end &lt;&lt; 9))) != 0)
<a name="l01326"></a>01326   {
<a name="l01327"></a>01327     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l01328"></a>01328     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01329"></a>01329   }
<a name="l01330"></a>01330   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332   <span class="comment">// send erase command</span>
<a name="l01333"></a>01333   <span class="keywordflow">if</span> ((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#4e5a18015a01bc99ea6af998a2d71728" title="Perform block/mass erase.">MMC_ERASE</a>,0)) != 0)
<a name="l01334"></a>01334   {
<a name="l01335"></a>01335     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l01336"></a>01336     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01337"></a>01337   }
<a name="l01338"></a>01338   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01339"></a>01339 
<a name="l01340"></a>01340   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l01341"></a>01341 
<a name="l01342"></a>01342   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01343"></a>01343 }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 
<a name="l01347"></a>01347 <span class="preprocessor">#if (MMC_SD_RAM == ENABLED)</span>
<a name="l01348"></a>01348 <span class="preprocessor"></span>
<a name="l01363"></a><a class="code" href="a00054.html#52b3124aa44523c90def3c9df5f09be6">01363</a> bit <a class="code" href="a00053.html#52b3124aa44523c90def3c9df5f09be6" title="Functions to read/write one sector (512btes) with ram buffer pointer.">mmc_sd_read_sector_to_ram</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)
<a name="l01364"></a>01364 {
<a name="l01365"></a>01365   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  i;
<a name="l01366"></a>01366   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a>  read_time_out;
<a name="l01367"></a>01367 
<a name="l01368"></a>01368   <span class="comment">// wait for MMC not busy</span>
<a name="l01369"></a>01369   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l01370"></a>01370     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();          <span class="comment">// select MMC_SD</span>
<a name="l01373"></a>01373   <span class="comment">// issue command</span>
<a name="l01374"></a>01374   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#a79d6d187ee2becb90a44ff70914acb8" title="read a block">MMC_READ_SINGLE_BLOCK</a>, <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>);
<a name="l01375"></a>01375 
<a name="l01376"></a>01376   <span class="comment">// check for valid response</span>
<a name="l01377"></a>01377   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l01378"></a>01378   {
<a name="l01379"></a>01379     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();     <span class="comment">// unselect MMC_SD</span>
<a name="l01380"></a>01380     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01381"></a>01381   }
<a name="l01382"></a>01382 
<a name="l01383"></a>01383   <span class="comment">// wait for token (may be a datablock start token OR a data error token !)</span>
<a name="l01384"></a>01384   read_time_out = 30000;
<a name="l01385"></a>01385   <span class="keywordflow">while</span>((<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF)) == 0xFF)
<a name="l01386"></a>01386   {
<a name="l01387"></a>01387      read_time_out--;
<a name="l01388"></a>01388      <span class="keywordflow">if</span> (read_time_out == 0)   <span class="comment">// TIME-OUT</span>
<a name="l01389"></a>01389      {
<a name="l01390"></a>01390        <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();               <span class="comment">// unselect MMC_SD</span>
<a name="l01391"></a>01391        <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01392"></a>01392      }
<a name="l01393"></a>01393   }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395   <span class="comment">// check token</span>
<a name="l01396"></a>01396   <span class="keywordflow">if</span> (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != <a class="code" href="a00054.html#e9c8fadc636715f02aaec6f4d05b3c8f" title="when received from card, indicates that a block of data will follow">MMC_STARTBLOCK_READ</a>)
<a name="l01397"></a>01397   {
<a name="l01398"></a>01398     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01399"></a>01399     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01400"></a>01400     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01401"></a>01401   }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403   <span class="comment">// store datablock</span>
<a name="l01404"></a>01404   Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l01405"></a>01405   <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="a00054.html#502a0143be4c303f3006c0888e1cec82" title="/ 1 2 3 4 5 6 78 | &amp;lt;- view of MMC/SD card looking at contacts / 9 | Pins 8 and...">MMC_SECTOR_SIZE</a>;i++)
<a name="l01406"></a>01406   {
<a name="l01407"></a>01407     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01408"></a>01408     *ram=<a class="code" href="a00072.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>();
<a name="l01409"></a>01409     ram++;
<a name="l01410"></a>01410   }
<a name="l01411"></a>01411   Enable_interrupt();     <span class="comment">// Global re-enable.</span>
<a name="l01412"></a>01412   <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;     <span class="comment">// Update the memory pointer.</span>
<a name="l01413"></a>01413 
<a name="l01414"></a>01414   <span class="comment">// load 16-bit CRC (ignored)</span>
<a name="l01415"></a>01415   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01416"></a>01416   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01417"></a>01417 
<a name="l01418"></a>01418   <span class="comment">// continue delivering some clock cycles</span>
<a name="l01419"></a>01419   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01420"></a>01420   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01421"></a>01421 
<a name="l01422"></a>01422   <span class="comment">// release chip select</span>
<a name="l01423"></a>01423   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01424"></a>01424 
<a name="l01425"></a>01425   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;   <span class="comment">// Read done.</span>
<a name="l01426"></a>01426 }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428 
<a name="l01429"></a>01429 
<a name="l01446"></a><a class="code" href="a00054.html#498ede87744d283825253501b87fd37a">01446</a> bit <a class="code" href="a00053.html#498ede87744d283825253501b87fd37a">mmc_sd_write_sector_from_ram</a>(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)
<a name="l01447"></a>01447 {
<a name="l01448"></a>01448   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450   <span class="comment">// wait for MMC not busy</span>
<a name="l01451"></a>01451   <span class="keywordflow">if</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l01452"></a>01452     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01453"></a>01453 
<a name="l01454"></a>01454   <a class="code" href="a00029.html#14f4d15cce61a587fc8c5d87ad64646a">Mmc_sd_select</a>();                  <span class="comment">// select MMC_SD</span>
<a name="l01455"></a>01455   <span class="comment">// issue command</span>
<a name="l01456"></a>01456   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#d44c557819de442a38af1a63af2b7eb6">mmc_sd_command</a>(<a class="code" href="a00054.html#991d94c3be5fd4548d5bb222d03500f9" title="write a block">MMC_WRITE_BLOCK</a>, <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>);
<a name="l01457"></a>01457   <span class="comment">// check for valid response</span>
<a name="l01458"></a>01458   <span class="keywordflow">if</span>(<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> != 0x00)
<a name="l01459"></a>01459   {
<a name="l01460"></a>01460     <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l01461"></a>01461     <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01462"></a>01462   }
<a name="l01463"></a>01463   <span class="comment">// send dummy</span>
<a name="l01464"></a>01464   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);   <span class="comment">// give clock again to end transaction</span>
<a name="l01465"></a>01465 
<a name="l01466"></a>01466   <span class="comment">// send data start token</span>
<a name="l01467"></a>01467   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00054.html#dc1c7a27cf22e2a626a47cba533fb511" title="when sent to card, indicates that a block of data will follow">MMC_STARTBLOCK_WRITE</a>);
<a name="l01468"></a>01468   <span class="comment">// write data</span>
<a name="l01469"></a>01469   <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="a00054.html#502a0143be4c303f3006c0888e1cec82" title="/ 1 2 3 4 5 6 78 | &amp;lt;- view of MMC/SD card looking at contacts / 9 | Pins 8 and...">MMC_SECTOR_SIZE</a>;i++)
<a name="l01470"></a>01470   {
<a name="l01471"></a>01471     <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(*ram);
<a name="l01472"></a>01472     ram++;
<a name="l01473"></a>01473   }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);    <span class="comment">// send CRC (field required but value ignored)</span>
<a name="l01476"></a>01476   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01477"></a>01477 
<a name="l01478"></a>01478   <span class="comment">// read data response token</span>
<a name="l01479"></a>01479   <a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a> = <a class="code" href="a00053.html#5dd1159797d002ed8fa7344e4d661bbb">mmc_sd_send_and_read</a>(0xFF);
<a name="l01480"></a>01480   <span class="keywordflow">if</span>( (<a class="code" href="a00053.html#61f9bcbc16792de72e6e81845639df48">r1</a>&amp;<a class="code" href="a00054.html#46c1a8415ae80aee30e3b6b00a3f90a8">MMC_DR_MASK</a>) != <a class="code" href="a00054.html#a21c6cd7b46ce7100527eeea4f661b4b">MMC_DR_ACCEPT</a>)
<a name="l01481"></a>01481   {
<a name="l01482"></a>01482      <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);    <span class="comment">// send dummy bytes</span>
<a name="l01483"></a>01483      <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01484"></a>01484      <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();
<a name="l01485"></a>01485      <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01486"></a>01486 <span class="comment">//     return r1;             // return ERROR byte</span>
<a name="l01487"></a>01487   }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);    <span class="comment">// send dummy bytes</span>
<a name="l01490"></a>01490   <a class="code" href="a00072.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l01491"></a>01491 
<a name="l01492"></a>01492   <span class="comment">// release chip select</span>
<a name="l01493"></a>01493   <a class="code" href="a00029.html#f9ba3f7e2d43096c1e3938a9e3d0f2b1">Mmc_sd_unselect</a>();                  <span class="comment">// unselect MMC_SD</span>
<a name="l01494"></a>01494   <a class="code" href="a00045.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;        <span class="comment">// Update the memory pointer.</span>
<a name="l01495"></a>01495 
<a name="l01496"></a>01496   <span class="comment">// wait card not busy after last programming operation</span>
<a name="l01497"></a>01497   i=0;
<a name="l01498"></a>01498   <span class="keywordflow">while</span> (<a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a> == <a class="code" href="a00053.html#b8c6dec121c640e11375ffe22264dd52">mmc_sd_wait_not_busy</a>())
<a name="l01499"></a>01499   {
<a name="l01500"></a>01500     i++;
<a name="l01501"></a>01501     <span class="keywordflow">if</span> (i == 10)
<a name="l01502"></a>01502       <span class="keywordflow">return</span> <a class="code" href="a00032.html#cb00992efca56626cdf0907e5edb5b51">KO</a>;
<a name="l01503"></a>01503   }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505   <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;                  <span class="comment">// Write done</span>
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="preprocessor">#endif      // (MMC_SD_RAM == ENABLE)</span>
<a name="l01509"></a>01509 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 14 13:14:17 2009 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
