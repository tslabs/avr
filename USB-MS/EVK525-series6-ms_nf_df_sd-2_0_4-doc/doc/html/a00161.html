<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: nf_drv.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>nf_drv.c</h1><a href="a00060.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file is prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">/* Copyright (c) 2009 Atmel Corporation. All rights reserved.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00017"></a>00017 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
<a name="l00020"></a>00020 <span class="comment"> * this list of conditions and the following disclaimer.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00023"></a>00023 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00024"></a>00024 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * 3. The name of Atmel may not be used to endorse or promote products derived</span>
<a name="l00027"></a>00027 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * 4. This software may only be redistributed and used in connection with an Atmel</span>
<a name="l00030"></a>00030 <span class="comment"> * AVR product.</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR IMPLIED</span>
<a name="l00033"></a>00033 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00034"></a>00034 <span class="comment"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE EXPRESSLY AND</span>
<a name="l00035"></a>00035 <span class="comment"> * SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT,</span>
<a name="l00036"></a>00036 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00038"></a>00038 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00039"></a>00039 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00040"></a>00040 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00041"></a>00041 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00042"></a>00042 <span class="comment"> */</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">//_____  I N C L U D E S ___________________________________________________</span>
<a name="l00046"></a><a class="code" href="a00060.html#4550c0c5aac7ad7d7af0e2dac56efe77">00046</a> <span class="preprocessor">#define  _nfc_drv_c_</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="preprocessor">#include  "<a class="code" href="a00039.html">config.h</a>"</span>          <span class="comment">// general project configuration file</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include  "<a class="code" href="a00035.html">conf_nf.h</a>"</span>         <span class="comment">// global NAND Flash configuration file</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include  "<a class="code" href="a00057.html">nf.h</a>"</span>              <span class="comment">// NAND Flash informations (structure, parameters)</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include  "<a class="code" href="a00061.html">nf_drv.h</a>"</span>          <span class="comment">// declarations of constants, low levels routines, public prototypes</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">//_____ D E C L A R A T I O N ______________________________________________</span>
<a name="l00054"></a>00054 <span class="comment">//</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#ifndef __GNUC__</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>  __no_init <span class="keyword">volatile</span> xdata <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_send_cmd  <a class="code" href="a00060.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a>(<a class="code" href="a00061.html#b25def4db76056c0fb628017a8745cb9">NF_CMD_LATCH_ENABLE_ADD</a>);  <span class="comment">// Command</span>
<a name="l00058"></a>00058   __no_init <span class="keyword">volatile</span> xdata <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_send_add  <a class="code" href="a00060.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a>(<a class="code" href="a00061.html#52171333a19206727fd5cf8dd22764a1">NF_ADD_LATCH_ENABLE_ADD</a>);  <span class="comment">// Address</span>
<a name="l00059"></a>00059   __no_init <span class="keyword">volatile</span> xdata <a class="code" href="a00032.html#e3a497195d617519e5353ea7b417940f">Byte</a> nf_data      <a class="code" href="a00060.html#59f6771bf0f4ec58f6e75d456625a3a3">At</a>(<a class="code" href="a00061.html#2c64a0b3ce78ea21cc2b1a6d1c881011">NF_ADDRESS_CMD_DATA</a>);      <span class="comment">// Data</span>
<a name="l00060"></a>00060 <span class="preprocessor">#else</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>  <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nf_send_cmd  __attribute__ ((section (<span class="stringliteral">".nf_cmd"</span>)));
<a name="l00062"></a>00062   <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nf_send_add  __attribute__ ((section (<span class="stringliteral">".nf_add"</span>)));
<a name="l00063"></a>00063   <span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> nf_data      __attribute__ ((section (<span class="stringliteral">".nf_dat"</span>)));
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="preprocessor">#ifndef NF_XMCR_MODULE_SHARED</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">   #warning NF_XMCR_MODULE_SHARED must be defined to ENABLE if XMCR module is shared with other hardware peripherals</span>
<a name="l00068"></a><a class="code" href="a00060.html#51b667e81e90435ed8ce204932c43440">00068</a> <span class="preprocessor"></span><span class="preprocessor">   #define NF_XMCR_MODULE_SHARED       DISABLED</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a><a class="code" href="a00060.html#653e658c71333c2d20dd28d60e779d55">00071</a> <span class="preprocessor">#define     BAD_BLOCK_OFFSET     0</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#ifndef __GNUC__</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>  <span class="keyword">extern</span>   <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="code" href="a00060.html#3c209d09dbf858cac151e05a6e506081">bad_block_table</a>[100];
<a name="l00074"></a>00074 <span class="preprocessor">#else</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>  <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> bad_block_table[100];
<a name="l00076"></a>00076 <span class="preprocessor">#endif</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="preprocessor">#if( NF_BAD_CONFIG==(FALSE) )</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="comment">//_____ D E C L A R A T I O N ______________________________________________</span>
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="a00061.html#2bd4c6ceb672b91624859e1f4bec04ac">00083</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#2bd4c6ceb672b91624859e1f4bec04ac">nfc_select_dev</a>( <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> dev )
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085    <span class="keywordflow">if</span>(0==dev)
<a name="l00086"></a>00086    {
<a name="l00087"></a>00087       <a class="code" href="a00029.html#889f117ea2876850629e734d16ae6582">Nandflash1_unselect</a>();
<a name="l00088"></a>00088       <a class="code" href="a00029.html#c7d10ce399e3d07c61a6395fa801c9ef">Nandflash0_select</a>();
<a name="l00089"></a>00089    }<span class="keywordflow">else</span>{
<a name="l00090"></a>00090       <a class="code" href="a00029.html#f432627dbe8700038462fd300e96a956">Nandflash0_unselect</a>();
<a name="l00091"></a>00091       <a class="code" href="a00029.html#7219fa6191a93660329fdaa737e63bf9">Nandflash1_select</a>();
<a name="l00092"></a>00092    }
<a name="l00093"></a>00093 }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 
<a name="l00106"></a>00106 <span class="preprocessor">#if (NF_AUTO_DETECT_2KB==FALSE) &amp;&amp; (NF_AUTO_DETECT_512B==FALSE)</span>
<a name="l00107"></a><a class="code" href="a00061.html#455d3b498da0863662f3309643c2b719">00107</a> <span class="preprocessor"></span><a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00060.html#455d3b498da0863662f3309643c2b719" title="Tests the Nand Flash configuration.">nfc_check_type</a>( <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_dev )
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i_dev;
<a name="l00110"></a>00110    <span class="keywordflow">if</span>( 2 &lt; nb_dev )
<a name="l00111"></a>00111       nb_dev = 2; <span class="comment">// Only 1 or 2 for this driver</span>
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00115"></a>00115 <span class="preprocessor">#endif</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>   <a class="code" href="a00061.html#0d84ba3390ed57d612c9b3cbc6c04286">nfc_init</a>(        nb_dev, 0 );
<a name="l00117"></a>00117    <a class="code" href="a00060.html#ec96d29ad256f2dfc2ebfceddf08d6a9" title="Reset all the NF devices.">nfc_reset_nands</a>( nb_dev ); <span class="comment">// Reset all the NF devices</span>
<a name="l00118"></a>00118 
<a name="l00119"></a>00119    <span class="comment">// Test NF configuration</span>
<a name="l00120"></a>00120    <span class="comment">//</span>
<a name="l00121"></a>00121    <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;nb_dev ; i_dev++ )
<a name="l00122"></a>00122    {
<a name="l00123"></a>00123       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>( <a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00124"></a>00124       <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00125"></a>00125       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>( <a class="code" href="a00121.html#g5f95acd6c54e424dfa198abf6eedb8bd" title="Assert the CE pad of the last selected device.">NFC_ACT_ASSERT_CE</a>, <a class="code" href="a00121.html#g7fbd6608a2f650f008c0bc0bfdfe29df">NFC_EXT_CELOW</a>);
<a name="l00126"></a>00126       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g501ac26cbe74623f2be4889e79ae38d1" title="Read ID Command.">NF_READ_ID_CMD</a>);
<a name="l00127"></a>00127       <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( 0 );
<a name="l00128"></a>00128       <span class="keywordflow">if</span>(( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>()!=<a class="code" href="a00061.html#8fe0d788080aeed45f883b09ab26c2d4">G_DEV_MAKER</a>  )
<a name="l00129"></a>00129       || ( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>()!=<a class="code" href="a00061.html#fe78dc9100a7cabc360db6885f1daaec">G_DEV_ID</a>     ))
<a name="l00130"></a>00130       {
<a name="l00131"></a>00131          <span class="keywordflow">return</span> i_dev;
<a name="l00132"></a>00132       }
<a name="l00133"></a>00133       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#1294603227ee6dda5d13ee630f7b7415">G_CE_TOGGLE</a> )
<a name="l00134"></a>00134       {
<a name="l00135"></a>00135          <span class="comment">// disable CE Low</span>
<a name="l00136"></a>00136          <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>( <a class="code" href="a00121.html#g5f95acd6c54e424dfa198abf6eedb8bd" title="Assert the CE pad of the last selected device.">NFC_ACT_ASSERT_CE</a>, <a class="code" href="a00121.html#g7adf6f14ec58a9b01e5cdbd9c2692c07">NFC_EXT_NOP</a>);
<a name="l00137"></a>00137       }
<a name="l00138"></a>00138    }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00142"></a>00142 <span class="preprocessor">#endif</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>   <span class="keywordflow">return</span> nb_dev;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 <span class="preprocessor">#endif</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>
<a name="l00147"></a>00147 
<a name="l00152"></a><a class="code" href="a00061.html#ec96d29ad256f2dfc2ebfceddf08d6a9">00152</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#ec96d29ad256f2dfc2ebfceddf08d6a9" title="Reset all the NF devices.">nfc_reset_nands</a>( <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_dev )
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i_dev;
<a name="l00155"></a>00155    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00156"></a>00156    <span class="keywordflow">for</span>( i_dev=0 ; i_dev&lt;nb_dev ; i_dev++ )
<a name="l00157"></a>00157    {
<a name="l00158"></a>00158       <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, i_dev);
<a name="l00159"></a>00159       <span class="comment">// The wait is mandatory here since the function is used to wait any</span>
<a name="l00160"></a>00160       <span class="comment">// pending internal programmation (Cache Program cmd).</span>
<a name="l00161"></a>00161       <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00162"></a>00162       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g5ff4dc8af5fcac6e451765fbb857129d" title="Reset command.">NF_RESET_CMD</a>);
<a name="l00163"></a>00163       <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00164"></a>00164    }
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 
<a name="l00172"></a><a class="code" href="a00061.html#2888ee8b7b2aad2f3e86eeff599729ca">00172</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>( <span class="keywordtype">void</span> )
<a name="l00173"></a>00173 {
<a name="l00174"></a>00174 <span class="preprocessor">#if (NF_CLE_ALE_MANUAL == ENABLED)</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>  XMCRB |= ((1&lt;&lt;XMM2) | (1&lt;&lt;XMM1) | (1&lt;&lt;XMM0));   <span class="comment">// limit XRAM interface to A7 (release PC0..7)</span>
<a name="l00176"></a>00176 <span class="preprocessor">#else</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>  XMCRB |= ((1&lt;&lt;XMM2) | (1&lt;&lt;XMM1));                <span class="comment">// limit XRAM interface to A9 (release PC2..7)</span>
<a name="l00178"></a>00178 <span class="preprocessor">#endif  </span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>  XMCRA |= (1&lt;&lt;SRE);                  <span class="comment">// enable the external memory</span>
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 
<a name="l00185"></a><a class="code" href="a00061.html#6008aafe936bca7bfc39a8db231c1e7b">00185</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>( <span class="keywordtype">void</span> )
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187   <a class="code" href="a00029.html#f432627dbe8700038462fd300e96a956">Nandflash0_unselect</a>();
<a name="l00188"></a>00188   <a class="code" href="a00029.html#889f117ea2876850629e734d16ae6582">Nandflash1_unselect</a>();
<a name="l00189"></a>00189   XMCRA &amp;= ~(1&lt;&lt;SRE);  <span class="comment">// disable the external memory</span>
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00203"></a><a class="code" href="a00061.html#ef97b996828cba45aa7ee961af28e036">00203</a> <a class="code" href="a00032.html#a95502d3ad090c7564841b21b6aedcee">Status_bool</a> <a class="code" href="a00060.html#ef97b996828cba45aa7ee961af28e036" title="Check the status of the selected device.">nfc_check_status</a>( <span class="keywordtype">void</span> )
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00206"></a>00206    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>(); <span class="comment">// Send a status command and wait the completion of the last command</span>
<a name="l00207"></a>00207    <span class="keywordflow">if</span> ( (<a class="code" href="a00061.html#3a9602476f480441b912a7de88d440ed">Nfc_rd_data</a>()&amp;<a class="code" href="a00123.html#gb02ffb6b5c399ba4afebedb99aa0691d" title="Fail.">NF_MASK_STATUS_FAIL</a>)==0 ) { <span class="keywordflow">return</span> <a class="code" href="a00032.html#ba5c54fadff8d880b1945dde87496e31">PASS</a>; } <span class="comment">// I/O 0   Pass:0  Fail:1</span>
<a name="l00208"></a>00208    <span class="keywordflow">else</span>                                          { <span class="keywordflow">return</span> <a class="code" href="a00032.html#bb508ea8227673f419e9fe3a86c30d8e">FAIL</a>; }
<a name="l00209"></a>00209 }
<a name="l00210"></a>00210 
<a name="l00220"></a>00220 <span class="comment">// TODO: Improve the argument list: 6 bytes are needed</span>
<a name="l00221"></a><a class="code" href="a00061.html#a0a322a0237ff247248591adb2b10fab">00221</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr, <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00224"></a>00224    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00225"></a>00225    <a class="code" href="a00061.html#c8447f3352f9d30b0a9eb506378d3cc9" title="Opens a page for read.">Nfc_open_page_read</a>( page_addr, byte_addr);
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 
<a name="l00239"></a><a class="code" href="a00061.html#856b5ae1fade14e11da35fd5109fda8c">00239</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr, <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> byte_addr)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00242"></a>00242    <a class="code" href="a00061.html#74dba9394ac015f89cb1c42131a239b5" title="Opens a page for write.">Nfc_open_page_write</a>( page_addr, byte_addr);
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 
<a name="l00246"></a>00246 
<a name="l00255"></a><a class="code" href="a00061.html#baa6a09d1819325c231e3735177a2179">00255</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#baa6a09d1819325c231e3735177a2179" title="Mark a block as &amp;#39;invalid&amp;#39; by clearing it entirely.">nfc_mark_bad_block</a>(<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  n_bytes;
<a name="l00258"></a>00258    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  i_byte;
<a name="l00259"></a>00259    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  i_page;
<a name="l00260"></a>00260 
<a name="l00261"></a>00261    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00262"></a>00262 
<a name="l00263"></a>00263    n_bytes= ( <a class="code" href="a00061.html#d1213b7a82a55a9d9addaef5cd33ee69">Is_nf_512</a>() )
<a name="l00264"></a>00264    ?  16  <span class="comment">// 512B page access</span>
<a name="l00265"></a>00265    :  64  <span class="comment">// 2KB  page access</span>
<a name="l00266"></a>00266    ;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268    <span class="comment">// Erasing the block is mandatory to prevent partial programming</span>
<a name="l00269"></a>00269    <span class="comment">// (some 512B NF does support partial prog, but not after a copy back command).</span>
<a name="l00270"></a>00270    <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( page_addr, <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a> );
<a name="l00271"></a>00271    <span class="keywordflow">for</span> ( i_page=(<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a> ; i_page!=0 ; i_page--, page_addr++ )
<a name="l00272"></a>00272    {
<a name="l00273"></a>00273       <a class="code" href="a00060.html#856b5ae1fade14e11da35fd5109fda8c" title="Opens a page for write.">nfc_open_page_write</a>( page_addr, <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>-8 );
<a name="l00274"></a>00274       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">'A'</span>); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">'t'</span>);
<a name="l00275"></a>00275       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">'m'</span>); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">'e'</span>);
<a name="l00276"></a>00276       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">'l'</span>); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">' '</span>);
<a name="l00277"></a>00277       <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">' '</span>); <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(<span class="charliteral">' '</span>);
<a name="l00278"></a>00278       <span class="keywordflow">for</span> ( i_byte=n_bytes ; i_byte!=0 ; i_byte-=4 )
<a name="l00279"></a>00279       {
<a name="l00280"></a>00280          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(0);
<a name="l00281"></a>00281          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(0);
<a name="l00282"></a>00282          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(0);
<a name="l00283"></a>00283          <a class="code" href="a00061.html#a2f2068df9c25227a31bce91dabfcaa2">Nfc_wr_data</a>(0);
<a name="l00284"></a>00284       }
<a name="l00285"></a>00285       <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>); <span class="comment">// Confirm programmation</span>
<a name="l00286"></a>00286    }
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 
<a name="l00302"></a><a class="code" href="a00061.html#4a7f7eed66f5eb678e4a96ae5dc32486">00302</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#4a7f7eed66f5eb678e4a96ae5dc32486" title="Erases a block.">nfc_erase_block</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> force_erase )
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00305"></a>00305    <span class="keywordflow">if</span> (<a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> == force_erase)
<a name="l00306"></a>00306    {
<a name="l00307"></a>00307       <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> + <a class="code" href="a00061.html#e0e77dabaa2dc4bdde63fa552f44e745">G_OFST_BLK_STATUS</a> );
<a name="l00308"></a>00308       <span class="keywordflow">if</span>( (<a class="code" href="a00061.html#3a9602476f480441b912a7de88d440ed">Nfc_rd_data</a>() != 0xFF) ) <span class="keywordflow">return</span>;    <span class="comment">// The block is bad. We can not erase it</span>
<a name="l00309"></a>00309    }
<a name="l00310"></a>00310    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00311"></a>00311    <a class="code" href="a00061.html#ac6eab632f7d904222094b7994cda033">Nfc_unprotect_all_flash</a>();                    <span class="comment">// WP may be actif due to block protection</span>
<a name="l00312"></a>00312    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a> (<a class="code" href="a00122.html#gac29402cb01e7f1b3bfde047d1d578fa" title="Erase command.">NF_BLOCK_ERASE_CMD</a>);             <span class="comment">// Auto Block Erase Setup</span>
<a name="l00313"></a>00313    <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(page_addr) );
<a name="l00314"></a>00314    <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#2d1e45154b07481f0579ecc725e4edff">LSB1</a>(page_addr) );
<a name="l00315"></a>00315    <span class="keywordflow">if</span> (3 == <a class="code" href="a00061.html#26193f60c442075fc7fdf8022b04c489">G_N_ROW_CYCLES</a>)
<a name="l00316"></a>00316    {
<a name="l00317"></a>00317       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(page_addr) );
<a name="l00318"></a>00318    }
<a name="l00319"></a>00319    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g43f524c57b3ba4c51c9f6bbf92ff90b0" title="Confirm erase command.">NF_BLOCK_ERASE_CONFIRM_CMD</a>);      <span class="comment">// Erase command</span>
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 
<a name="l00333"></a><a class="code" href="a00061.html#37641716cd31a827e214a2d0ec1f5c66">00333</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#37641716cd31a827e214a2d0ec1f5c66" title="Reads the number spare bytes specified and stores them in a array.">nfc_read_spare_byte</a>(
<a name="l00334"></a>00334    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> * p_byte
<a name="l00335"></a>00335 ,  <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  n_byte
<a name="l00336"></a>00336 ,  <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  i;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00341"></a>00341    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a>);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343    <span class="keywordflow">for</span> ( i=0 ; i!=n_byte ; i++ )
<a name="l00344"></a>00344    {
<a name="l00345"></a>00345       p_byte[i] = <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l00346"></a>00346    }
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00353"></a><a class="code" href="a00061.html#479efac38d042c2f27684ec8087da576">00353</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>( <span class="keywordtype">void</span> )
<a name="l00354"></a>00354 {
<a name="l00355"></a>00355    <span class="keyword">register</span> <span class="keywordtype">int</span> Reg;
<a name="l00356"></a>00356    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g783e21781a180e0fb6ebba10209d6833" title="Read Status command.">NF_READ_STATUS_CMD</a>);
<a name="l00357"></a>00357    Reg = <a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>();
<a name="l00358"></a>00358    <span class="keywordflow">if</span>( <a class="code" href="a00061.html#db2af259f2983b78d8cf4fac62afaf7d">Is_nf_2k</a>() )
<a name="l00359"></a>00359    {
<a name="l00360"></a>00360       <span class="keywordflow">if</span>( <a class="code" href="a00061.html#b4233cf2358424060e6586b4ca401213">G_CACHE_PROG</a> )
<a name="l00361"></a>00361       {
<a name="l00362"></a>00362          <span class="keywordflow">while</span>( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#g54968ef06beb1735571aa86940b5e24b" title="True Ready.">NF_MASK_STATUS_T_RDY_2KB</a> )==0 );
<a name="l00363"></a>00363          <span class="keywordflow">while</span>( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#g54968ef06beb1735571aa86940b5e24b" title="True Ready.">NF_MASK_STATUS_T_RDY_2KB</a> )==0 );
<a name="l00364"></a>00364       }
<a name="l00365"></a>00365       <span class="keywordflow">else</span>
<a name="l00366"></a>00366       {
<a name="l00367"></a>00367          <span class="keywordflow">while</span>( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#gc0f4b42f5c5e79d042e6253733a3e2e5" title="Ready.">NF_MASK_STATUS_READY</a>     )==0 );
<a name="l00368"></a>00368          <span class="keywordflow">while</span>( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#gc0f4b42f5c5e79d042e6253733a3e2e5" title="Ready.">NF_MASK_STATUS_READY</a>     )==0 );
<a name="l00369"></a>00369       }
<a name="l00370"></a>00370    }
<a name="l00371"></a>00371    <span class="keywordflow">if</span>( <a class="code" href="a00061.html#d1213b7a82a55a9d9addaef5cd33ee69">Is_nf_512</a>() )
<a name="l00372"></a>00372    {
<a name="l00373"></a>00373       <span class="keywordflow">while</span>( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#g67bd7320150ac34c7500aa2933928617" title="True Ready.">NF_MASK_STATUS_T_RDY_512B</a> )==0 );
<a name="l00374"></a>00374       <span class="keywordflow">while</span>( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#g67bd7320150ac34c7500aa2933928617" title="True Ready.">NF_MASK_STATUS_T_RDY_512B</a> )==0 );
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="preprocessor">#if (NF_DETECTION_ID==ENABLE) || (NF_AUTO_DETECT_2KB==TRUE) || (NF_AUTO_DETECT_512B==TRUE)</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>
<a name="l00397"></a><a class="code" href="a00061.html#2d5cf1d9c2243be1a253d5b0fd9147dd">00397</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> <a class="code" href="a00060.html#2d5cf1d9c2243be1a253d5b0fd9147dd" title="Read the ID of the Nand-Flash.">nfc_read_id</a>( <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> read_id_cmd, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nf_num )
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> ret;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00402"></a>00402    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, nf_num);
<a name="l00403"></a>00403    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00404"></a>00404    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>( <a class="code" href="a00121.html#g5f95acd6c54e424dfa198abf6eedb8bd" title="Assert the CE pad of the last selected device.">NFC_ACT_ASSERT_CE</a>, <a class="code" href="a00121.html#g7fbd6608a2f650f008c0bc0bfdfe29df">NFC_EXT_CELOW</a>);
<a name="l00405"></a>00405    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a> (read_id_cmd);
<a name="l00406"></a>00406    <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( 0 );
<a name="l00407"></a>00407 
<a name="l00408"></a>00408    <a class="code" href="a00032.html#fb81783b8186acd7182a971048b0c6b3">MSB0</a>(ret)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>(); <span class="comment">// Maker Code</span>
<a name="l00409"></a>00409    <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(ret)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>(); <span class="comment">// Device Id</span>
<a name="l00410"></a>00410    <a class="code" href="a00032.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(ret)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>(); <span class="comment">// extra</span>
<a name="l00411"></a>00411    <a class="code" href="a00032.html#eeb8918fc580ce01d45f71863eebff90">MSB3</a>(ret)= <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>(); <span class="comment">// extra (Multi Plane Support)</span>
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>( <a class="code" href="a00121.html#g5f95acd6c54e424dfa198abf6eedb8bd" title="Assert the CE pad of the last selected device.">NFC_ACT_ASSERT_CE</a>, <a class="code" href="a00121.html#g7adf6f14ec58a9b01e5cdbd9c2692c07">NFC_EXT_NOP</a>);
<a name="l00414"></a>00414    <span class="keywordflow">return</span> ret;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 
<a name="l00423"></a><a class="code" href="a00060.html#23257b9ef0081e82db5b955ffe5f348a">00423</a> <span class="keyword">static</span> <a class="code" href="a00032.html#253b248072cfc8bd812c69acd0046eed">Bool</a> <a class="code" href="a00060.html#23257b9ef0081e82db5b955ffe5f348a" title="Check the status Ready/Busy of the Nand Flash.">nfc_nf_is_ready</a>( <span class="keywordtype">void</span> )
<a name="l00424"></a>00424 {
<a name="l00425"></a>00425    <span class="keyword">register</span> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> Reg;
<a name="l00426"></a>00426    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> u8_timeout;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>( <a class="code" href="a00122.html#g783e21781a180e0fb6ebba10209d6833" title="Read Status command.">NF_READ_STATUS_CMD</a> );  <span class="comment">// send status for each read, because the NF must be in reset sequence</span>
<a name="l00429"></a>00429    Reg = <a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>();            <span class="comment">// active first read</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    <span class="keywordflow">for</span> (u8_timeout=<a class="code" href="a00061.html#83d1efcae1aa727613d7a3cbc642ab5b" title="Define here the number of NF connected to the microcontroller For AVR8 the number...">NF_MAX_RB_TIMEOUT</a> ; u8_timeout!=0 ; u8_timeout--)
<a name="l00432"></a>00432    {
<a name="l00433"></a>00433       <span class="keywordflow">if</span>(( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#gc0f4b42f5c5e79d042e6253733a3e2e5" title="Ready.">NF_MASK_STATUS_READY</a>) !=0 )    <span class="comment">// the busy pin is not tested, and the bit ready may be wrong penddind the rise of busy pin</span>
<a name="l00434"></a>00434       &amp;&amp; ( (<a class="code" href="a00061.html#ce78f62128d4b37a7cdf14a58fd4606a">Nfc_rd_status</a>() &amp; <a class="code" href="a00123.html#gc0f4b42f5c5e79d042e6253733a3e2e5" title="Ready.">NF_MASK_STATUS_READY</a>) !=0 ) )  <span class="comment">// To not read a wrong status, we check the status after 6 cycles (300ns)</span>
<a name="l00435"></a>00435       {
<a name="l00436"></a>00436             <span class="keywordflow">return</span> <a class="code" href="a00032.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;  <span class="comment">// NF READY</span>
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438    }
<a name="l00439"></a>00439    <span class="keywordflow">return</span> <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>;          <span class="comment">// TIMEOUT</span>
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 
<a name="l00449"></a><a class="code" href="a00061.html#257fa3cbd1bd671a438dad76c52d4365">00449</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  <a class="code" href="a00060.html#257fa3cbd1bd671a438dad76c52d4365" title="Read the ID of the Nand-Flash and update the global variable.">nfc_detect</a>( <span class="keywordtype">void</span> )
<a name="l00450"></a>00450 {
<a name="l00451"></a>00451    <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>   u32_nf_ids;
<a name="l00452"></a>00452    <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>    u8_i, u8_conf;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>   <a class="code" href="a00060.html#2888ee8b7b2aad2f3e86eeff599729ca" title="Enable the XMCR (Extending Memory Module) of the AVR to drive the NAND Flash.">nf_XMCR_enable</a>();
<a name="l00456"></a>00456 <span class="preprocessor">#endif</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span>
<a name="l00458"></a>00458    <span class="comment">// Init the Nand Flash Controller</span>
<a name="l00459"></a>00459    <a class="code" href="a00061.html#0d84ba3390ed57d612c9b3cbc6c04286">nfc_init</a>(        <a class="code" href="a00061.html#b55f5bf79b94687e007eeacb266062fa">NF_MAX_DEVICES</a>, 0 );
<a name="l00460"></a>00460    <a class="code" href="a00060.html#ec96d29ad256f2dfc2ebfceddf08d6a9" title="Reset all the NF devices.">nfc_reset_nands</a>( <a class="code" href="a00061.html#b55f5bf79b94687e007eeacb266062fa">NF_MAX_DEVICES</a> ); <span class="comment">// Reset all the NF devices</span>
<a name="l00461"></a>00461 
<a name="l00462"></a>00462    <span class="comment">// Check the presence of device 0</span>
<a name="l00463"></a>00463    <span class="keywordflow">if</span> ( <a class="code" href="a00032.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a> == <a class="code" href="a00060.html#23257b9ef0081e82db5b955ffe5f348a" title="Check the status Ready/Busy of the Nand Flash.">nfc_nf_is_ready</a>() )
<a name="l00464"></a>00464    {
<a name="l00465"></a>00465 <span class="preprocessor">      #if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>         <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00467"></a>00467 <span class="preprocessor">      #endif</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span>      <span class="keywordflow">return</span> <a class="code" href="a00061.html#56789fa8d78f2dc5fc1c2c95d7f9fb83">NO_NF_CONNECTED</a>;
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="comment">// Read the Nand Flash IDs of device 0</span>
<a name="l00472"></a>00472    u32_nf_ids = <a class="code" href="a00060.html#2d5cf1d9c2243be1a253d5b0fd9147dd" title="Read the ID of the Nand-Flash.">nfc_read_id</a>( <a class="code" href="a00122.html#g501ac26cbe74623f2be4889e79ae38d1" title="Read ID Command.">NF_READ_ID_CMD</a>, 0 );
<a name="l00473"></a>00473 
<a name="l00474"></a>00474    <span class="comment">// Identify the Nand Flash (device 0)</span>
<a name="l00475"></a>00475    <span class="keywordflow">for</span>( u8_i=0 ; u8_i &lt; (<span class="keyword">sizeof</span>(<a class="code" href="a00058.html#844219af07411c32e6a63199b0f6f16e" title="List of Nand Flash 2KB.">nf_list_id</a>)/<span class="keyword">sizeof</span>(<a class="code" href="a00025.html">St_nf_id</a>)) ; u8_i++)
<a name="l00476"></a>00476    {
<a name="l00477"></a>00477       <span class="keywordflow">if</span>((<a class="code" href="a00058.html#844219af07411c32e6a63199b0f6f16e" title="List of Nand Flash 2KB.">nf_list_id</a>[u8_i].manuf == <a class="code" href="a00032.html#fb81783b8186acd7182a971048b0c6b3">MSB0</a>(u32_nf_ids))
<a name="l00478"></a>00478       &amp;&amp; (<a class="code" href="a00058.html#844219af07411c32e6a63199b0f6f16e" title="List of Nand Flash 2KB.">nf_list_id</a>[u8_i].dev   == <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(u32_nf_ids)))
<a name="l00479"></a>00479          <span class="keywordflow">break</span>; <span class="comment">// here, ID is know</span>
<a name="l00480"></a>00480    }
<a name="l00481"></a>00481    <span class="keywordflow">if</span>( u8_i == (<span class="keyword">sizeof</span>(<a class="code" href="a00058.html#844219af07411c32e6a63199b0f6f16e" title="List of Nand Flash 2KB.">nf_list_id</a>)/<span class="keyword">sizeof</span>(<a class="code" href="a00025.html">St_nf_id</a>)) )
<a name="l00482"></a>00482    {
<a name="l00483"></a>00483 <span class="preprocessor">      #if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>         <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00485"></a>00485 <span class="preprocessor">      #endif</span>
<a name="l00486"></a>00486 <span class="preprocessor"></span>      <span class="keywordflow">return</span> <a class="code" href="a00061.html#d86057b9c0e0585bc03215515ce28f5f">NF_UNKNOW</a>;
<a name="l00487"></a>00487    }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489    <span class="comment">// Set NF configuration parameters for initialisation and access</span>
<a name="l00490"></a>00490 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE)</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span><span class="preprocessor">#  error Test me...</span>
<a name="l00492"></a>00492 <span class="preprocessor"></span>   <a class="code" href="a00061.html#12e3a20682ed5032e788a57882f8256f">g_shift_page_byte</a>    =;
<a name="l00493"></a>00493    <a class="code" href="a00061.html#be82d871b5e412806adb94589b4b7f2e">g_shift_block_page</a>   =;
<a name="l00494"></a>00494 <span class="preprocessor">#endif</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span>
<a name="l00496"></a>00496 <span class="preprocessor">#if (NF_GENERIC_DRIVER==TRUE) || (NF_AUTO_DETECT_2KB==TRUE) ||(NF_AUTO_DETECT_512B==TRUE)</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span>
<a name="l00498"></a>00498    <span class="comment">// Record info</span>
<a name="l00499"></a>00499    u8_conf     =  <a class="code" href="a00058.html#844219af07411c32e6a63199b0f6f16e" title="List of Nand Flash 2KB.">nf_list_id</a>[u8_i].<a class="code" href="a00025.html#29914bfbb66c667ad11daace4a70e28e">conf</a>;
<a name="l00500"></a>00500    <a class="code" href="a00061.html#f1988bb3020968301cdb41696b569c0c">g_dev_maker</a> =  <a class="code" href="a00032.html#fb81783b8186acd7182a971048b0c6b3">MSB0</a>(u32_nf_ids); <span class="comment">// Device maker</span>
<a name="l00501"></a>00501    <a class="code" href="a00061.html#a18d841aa5fc7d3706489403ad06529a">g_dev_id</a>    =  <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(u32_nf_ids); <span class="comment">// Device ID</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    <span class="comment">// Search the number of block of device</span>
<a name="l00504"></a>00504    <span class="keywordflow">for</span>( u8_i=0 ; u8_i &lt; (<span class="keyword">sizeof</span>(<a class="code" href="a00058.html#b685b78bc0e67a9bbdb1e884e4c0cdb7" title="List of link between device ID and number of block.">nf_list_link_id_block</a>)/<span class="keyword">sizeof</span>(<a class="code" href="a00026.html">St_nf_link_id_block</a>)) ; u8_i++)
<a name="l00505"></a>00505    {
<a name="l00506"></a>00506       <span class="keywordflow">if</span>( <a class="code" href="a00058.html#b685b78bc0e67a9bbdb1e884e4c0cdb7" title="List of link between device ID and number of block.">nf_list_link_id_block</a>[u8_i].dev_id == <a class="code" href="a00061.html#a18d841aa5fc7d3706489403ad06529a">g_dev_id</a> )
<a name="l00507"></a>00507          <span class="keywordflow">break</span>; <span class="comment">// ID found</span>
<a name="l00508"></a>00508    }
<a name="l00509"></a>00509    <span class="keywordflow">if</span>( u8_i == (<span class="keyword">sizeof</span>(<a class="code" href="a00058.html#b685b78bc0e67a9bbdb1e884e4c0cdb7" title="List of link between device ID and number of block.">nf_list_link_id_block</a>)/<span class="keyword">sizeof</span>(<a class="code" href="a00026.html">St_nf_link_id_block</a>)) )
<a name="l00510"></a>00510       <span class="keywordflow">while</span>(1);   <span class="comment">// Error in NF definition</span>
<a name="l00511"></a>00511 
<a name="l00512"></a>00512    <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a>            =  <a class="code" href="a00058.html#b685b78bc0e67a9bbdb1e884e4c0cdb7" title="List of link between device ID and number of block.">nf_list_link_id_block</a>[u8_i].<a class="code" href="a00026.html#983529fa93766ff18f62aa028f07a778">nb_zones</a>;
<a name="l00513"></a>00513 <span class="preprocessor">#if (NF_AUTO_DETECT_2KB==TRUE)</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>   <span class="keywordflow">if</span>( 1 == <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a> )
<a name="l00515"></a>00515       <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>    =  2;
<a name="l00516"></a>00516    <span class="keywordflow">else</span>
<a name="l00517"></a>00517       <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>    =  3;
<a name="l00518"></a>00518 <span class="preprocessor">#endif</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span><span class="preprocessor">#if (NF_AUTO_DETECT_512B==TRUE)</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>   <span class="keywordflow">if</span>( 2 &gt;= <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a> )
<a name="l00521"></a>00521       <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>    =  2;
<a name="l00522"></a>00522    <span class="keywordflow">else</span>
<a name="l00523"></a>00523       <a class="code" href="a00061.html#4d7c730b3cd399426d94328236980166">g_n_row_cycles</a>    =  3;
<a name="l00524"></a>00524 <span class="preprocessor">#endif</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span>   <a class="code" href="a00061.html#a77d29865677c8e97bbd578eac48be3f">g_n_blocks</a>           =  <a class="code" href="a00061.html#61fea0ce6f891274490f59384e7a21de">g_n_zones</a>*1024L;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <a class="code" href="a00061.html#704f58e28283f1a6539d4ebcf52d2be8">g_copy_back_cont</a>     = <a class="code" href="a00058.html#638d2c27ba48ca3f1c27efdef2ee7101" title="List of configuration.">nf_list_conf</a>[u8_conf].<a class="code" href="a00024.html#5bd39ae24f25320ef2e649ee9bfbca0c">copy_back_cont</a>   ;
<a name="l00528"></a>00528    <a class="code" href="a00061.html#ccd4688c7bedb0ceeb4b3b4d4a78c92a">g_copy_back_discont</a>  = <a class="code" href="a00058.html#638d2c27ba48ca3f1c27efdef2ee7101" title="List of configuration.">nf_list_conf</a>[u8_conf].<a class="code" href="a00024.html#133767ff27f513dc1d500d75edeab3df">copy_back_discont</a>;
<a name="l00529"></a>00529    <a class="code" href="a00061.html#7e776f74effed1ef2372393ca5cded60">g_cache_program</a>      = <a class="code" href="a00058.html#638d2c27ba48ca3f1c27efdef2ee7101" title="List of configuration.">nf_list_conf</a>[u8_conf].<a class="code" href="a00024.html#51b70a77855907a1e141a420d9b0963d">cache_program</a>    ;
<a name="l00530"></a>00530    <a class="code" href="a00061.html#4f97a48cb3ad4cb94aa358a5e5201b76">g_ce_toggle</a>             = <a class="code" href="a00058.html#638d2c27ba48ca3f1c27efdef2ee7101" title="List of configuration.">nf_list_conf</a>[u8_conf].<a class="code" href="a00024.html#34e8492df4646cf29aa5b4e1b57fb266">ce_toggle</a>;
<a name="l00531"></a>00531 <span class="comment">/*   </span>
<a name="l00532"></a>00532 <span class="comment">   g_clock_dfc_nfc      = (nf_list_conf[u8_conf].dfc_nfc_clock&lt;&lt;5) &amp; MSK_DNFCKS;</span>
<a name="l00533"></a>00533 <span class="comment"></span>
<a name="l00534"></a>00534 <span class="comment">   Mcu_set_sfr_page_nfc();</span>
<a name="l00535"></a>00535 <span class="comment">   Nfc_set_read_timing((U8)nf_list_conf[u8_conf].timing_read );</span>
<a name="l00536"></a>00536 <span class="comment">   if( !g_ce_toggle )</span>
<a name="l00537"></a>00537 <span class="comment">   {</span>
<a name="l00538"></a>00538 <span class="comment">      // Enable CE low</span>
<a name="l00539"></a>00539 <span class="comment">      Nfc_action( NFC_ACT_ASSERT_CE, NFC_EXT_CELOW);</span>
<a name="l00540"></a>00540 <span class="comment">   }</span>
<a name="l00541"></a>00541 <span class="comment">*/</span>
<a name="l00542"></a>00542 <span class="preprocessor">#endif</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>
<a name="l00544"></a>00544 <span class="preprocessor">#if (NF_XMCR_MODULE_SHARED == ENABLED)</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>   <a class="code" href="a00060.html#6008aafe936bca7bfc39a8db231c1e7b" title="Disable the XMCR module of the AVR, to allow access to others peripherals that may...">nf_XMCR_disable</a>();
<a name="l00546"></a>00546 <span class="preprocessor">#endif</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span>   <span class="keywordflow">return</span> u8_i;
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <span class="preprocessor">#endif</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>
<a name="l00558"></a><a class="code" href="a00061.html#b9ba38cddb62690e76858546804fac2c">00558</a> <span class="keywordtype">void</span> <a class="code" href="a00060.html#b9ba38cddb62690e76858546804fac2c" title="Prepare a copy-back session.">nfc_copy_back_init</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr )
<a name="l00559"></a>00559 {
<a name="l00560"></a>00560    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00561"></a>00561    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00562"></a>00562    <a class="code" href="a00061.html#ac6eab632f7d904222094b7994cda033">Nfc_unprotect_all_flash</a>(); <span class="comment">// WP may be actif due to block protection</span>
<a name="l00563"></a>00563    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#geba99dc96d78f777d7977d9e635a486d" title="Read Command (2KB).">NF_READ_CMD</a>);
<a name="l00564"></a>00564    <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( 0 );
<a name="l00565"></a>00565    <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( 0 );
<a name="l00566"></a>00566    <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(page_addr) );
<a name="l00567"></a>00567    <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#2d1e45154b07481f0579ecc725e4edff">LSB1</a>(page_addr) );
<a name="l00568"></a>00568    <span class="keywordflow">if</span> ( 3==<a class="code" href="a00061.html#26193f60c442075fc7fdf8022b04c489">G_N_ROW_CYCLES</a> )
<a name="l00569"></a>00569    {
<a name="l00570"></a>00570       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(page_addr) );
<a name="l00571"></a>00571    }
<a name="l00572"></a>00572    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g604b8b2d96b64df0d8a4e15dcb574abc" title="Copy-back command (2KB).">NF_COPY_BACK_CMD</a>);
<a name="l00573"></a>00573    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576 
<a name="l00583"></a>00583 <span class="preprocessor">#if (0)</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="a00061.html#f172475aee374f6742159a2bfb9b333b">nfc_copy_back_conf</a>( <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr )
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00587"></a>00587    <a class="code" href="a00060.html#479efac38d042c2f27684ec8087da576" title="Tests the true busy.">nfc_wait_busy</a>();
<a name="l00588"></a>00588    <a class="code" href="a00061.html#ac6eab632f7d904222094b7994cda033">Nfc_unprotect_all_flash</a>();                              <span class="comment">// WP may be actif due to block protection</span>
<a name="l00589"></a>00589    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#g135bceb08b1260b0b07f97bc0596528b" title="Random data input command (2KB).">NF_RANDOM_DATA_INPUT_CMD</a>);
<a name="l00590"></a>00590    <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( 0 );
<a name="l00591"></a>00591    <a class="code" href="a00061.html#97ed1acd5b7fe680c9516a9b282e723b">Nfc_set_adc</a>( 0 );
<a name="l00592"></a>00592    <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#844ec34df36feb927dc92007af14674a">LSB0</a>(page_addr) );
<a name="l00593"></a>00593    <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#2d1e45154b07481f0579ecc725e4edff">LSB1</a>(page_addr) );
<a name="l00594"></a>00594    <span class="keywordflow">if</span> ( 3==<a class="code" href="a00061.html#26193f60c442075fc7fdf8022b04c489">G_N_ROW_CYCLES</a> )
<a name="l00595"></a>00595    {
<a name="l00596"></a>00596       <a class="code" href="a00061.html#214acfde9f6acc02adb0bb06e2c28a80">Nfc_set_adr</a>( <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(page_addr) );
<a name="l00597"></a>00597    }
<a name="l00598"></a>00598    <a class="code" href="a00061.html#50a2c8add5233b65d9c537baf4fe5be0">Nfc_set_cmd</a>(<a class="code" href="a00122.html#gcb67f1eda6e20910614d4ee4e5f16b94" title="Page Program command.">NF_PAGE_PROGRAM_CMD</a>);
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 <span class="preprocessor">#endif</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>
<a name="l00602"></a>00602 <span class="preprocessor">#endif // NF_BAD_CONFIG</span>
<a name="l00603"></a>00603 <span class="preprocessor"></span>
<a name="l00611"></a>00611 <span class="preprocessor">#if 0</span>
<a name="l00612"></a>00612 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="a00061.html#fc4fa239b80b2467d96653e379f2c473">nfc_print_block</a>(<a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> block_addr, <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> dev_id)
<a name="l00613"></a>00613 {
<a name="l00614"></a>00614    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a> page_addr=(<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)block_addr*((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>);
<a name="l00615"></a>00615    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> n_bytes;
<a name="l00616"></a>00616    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#df928e51a60dba0df29d615401cc55a8">U16</a> i_byte;
<a name="l00617"></a>00617    <a class="code" href="a00032.html#35d552e8456cfb2b810baa0a9212c98e">_MEM_TYPE_SLOW_</a> <a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  i_page;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619    <a class="code" href="a00061.html#91d42d1de5452067661da571363724c8">Mcu_set_sfr_page_nfc</a>();
<a name="l00620"></a>00620    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\rDisplay block 0x"</span>);
<a name="l00621"></a>00621    <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(block_addr) );
<a name="l00622"></a>00622    <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(block_addr) );
<a name="l00623"></a>00623 
<a name="l00624"></a>00624    n_bytes= ( <a class="code" href="a00061.html#d1213b7a82a55a9d9addaef5cd33ee69">Is_nf_512</a>() )
<a name="l00625"></a>00625    ?  512   <span class="comment">// 512B page access</span>
<a name="l00626"></a>00626    :  2048  <span class="comment">// 2KB  page access</span>
<a name="l00627"></a>00627    ;
<a name="l00628"></a>00628    <a class="code" href="a00061.html#929956d7ddddc291d7af26dea3159401">Nfc_action</a>(<a class="code" href="a00121.html#g7fac080c5cd6ef2e4488ccabd602dc29" title="Device selection. The number is given by the extension.">NFC_ACT_DEV_SELECT</a>, dev_id);
<a name="l00629"></a>00629    <span class="comment">//for ( i_page=(U8)1&lt;&lt;G_SHIFT_BLOCK_PAGE ; i_page!=0 ; i_page--, page_addr++ )</span>
<a name="l00630"></a>00630    <span class="keywordflow">for</span> ( i_page=0 ; i_page&lt;64 ; i_page++, page_addr++ )
<a name="l00631"></a>00631    {
<a name="l00632"></a>00632       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\rOpening page 0x"</span>);
<a name="l00633"></a>00633       <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#fb81783b8186acd7182a971048b0c6b3">MSB0</a>(page_addr) );
<a name="l00634"></a>00634       <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(page_addr) );
<a name="l00635"></a>00635       <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(page_addr) );
<a name="l00636"></a>00636       <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#eeb8918fc580ce01d45f71863eebff90">MSB3</a>(page_addr) );
<a name="l00637"></a>00637 <span class="preprocessor">      #if 0</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span>      <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, 0 );
<a name="l00639"></a>00639       i_byte=<a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l00640"></a>00640       <span class="keywordflow">for</span> ( i_byte=0 ; i_byte&lt;n_bytes ; )
<a name="l00641"></a>00641       {
<a name="l00642"></a>00642          <span class="keywordflow">if</span>      ( !(i_byte%32) )
<a name="l00643"></a>00643          {
<a name="l00644"></a>00644             <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\r0x"</span>);
<a name="l00645"></a>00645             <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(i_byte) );
<a name="l00646"></a>00646             <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00032.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(i_byte) );
<a name="l00647"></a>00647             <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" 0x"</span>);
<a name="l00648"></a>00648          }
<a name="l00649"></a>00649          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !(i_byte%16) ) <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"   "</span>);
<a name="l00650"></a>00650          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !(i_byte% 8) ) <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">" "</span>);
<a name="l00651"></a>00651          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00652"></a>00652          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00653"></a>00653          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00654"></a>00654          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00655"></a>00655          i_byte+=4;
<a name="l00656"></a>00656       }
<a name="l00657"></a>00657 <span class="preprocessor">      #else</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span>      <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, n_bytes );
<a name="l00659"></a>00659       i_byte=<a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l00660"></a>00660 <span class="preprocessor">      #endif</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span>      <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\rSpare zone: 0x"</span>);
<a name="l00662"></a>00662       <span class="keywordflow">for</span> ( i_byte=4*4 ; i_byte!=0 ; i_byte-- )
<a name="l00663"></a>00663       { <span class="comment">// discard spare zone</span>
<a name="l00664"></a>00664          <span class="keywordflow">if</span>( i_byte%4==0 ) <a class="code" href="a00043.html#9b606c2b7ffbe1b46600f9719fc6caa6">trace_nl</a>();
<a name="l00665"></a>00665          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00666"></a>00666          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00667"></a>00667          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00668"></a>00668          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00669"></a>00669       }
<a name="l00670"></a>00670       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\r"</span>);
<a name="l00671"></a>00671    }
<a name="l00672"></a>00672    <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\rOther way to access spare zone: 0x"</span>);
<a name="l00673"></a>00673    page_addr=(<a class="code" href="a00032.html#811024d35b9b8a41095b1f583b649e56">U32</a>)block_addr*((<a class="code" href="a00032.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)1&lt;&lt;<a class="code" href="a00061.html#0bc54ae60cf42f5064c0a90cfca229cf">G_SHIFT_BLOCK_PAGE</a>);
<a name="l00674"></a>00674    <a class="code" href="a00060.html#a0a322a0237ff247248591adb2b10fab" title="Opens a page for read.">nfc_open_page_read</a>( page_addr, <a class="code" href="a00061.html#c0f49b3b35f158892b2d8695c1d1f705">NF_SPARE_POS</a> );
<a name="l00675"></a>00675    i_byte=<a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>();
<a name="l00676"></a>00676    {
<a name="l00677"></a>00677       <span class="keywordflow">for</span> ( i_byte=4*4 ; i_byte!=0 ; i_byte-- )
<a name="l00678"></a>00678       { <span class="comment">// discard spare zone</span>
<a name="l00679"></a>00679          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00680"></a>00680          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00681"></a>00681          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00682"></a>00682          <a class="code" href="a00043.html#bbfb5f9378070c8db4ea4fda3df5cce5" title="Fonction used to display a byte value in the hex form on OCD/Serial Debug Interface...">trace_hex</a>( <a class="code" href="a00061.html#e7884626d24995c0dcf00140639cd6d4">Nfc_rd_data_fetch_next</a>() );
<a name="l00683"></a>00683       }
<a name="l00684"></a>00684       <a class="code" href="a00043.html#33937de27cd71c4dab3027caaae4fdf9" title="Fonction used for send a texte on OCD/Serial Debug Interface.">trace</a>(<span class="stringliteral">"\n\r"</span>);
<a name="l00685"></a>00685    }
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 14 13:14:17 2009 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
