<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: df.c File Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>df.c File Reference</h1><code>#include &quot;<a class="el" href="a00106.html">config.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00136.html">lib_mcu/usb/usb_drv.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00125.html">lib_mcu/spi/spi_drv.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="a00111.html">df.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Include dependency graph for df.c:</div>
<div class="dynsection">
</div>

<p>
<a href="a00110.html">Go to the source code of this file.</a><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#58303393c416a654cfc0e2e0422a795a">df_wait_busy</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function waits until the DataFlash is not busy.  <a href="#58303393c416a654cfc0e2e0422a795a"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#a5ce3b7c55df296782fa748c782c70cf">df_chipselect_current</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function physically selects the current addressed memory.  <a href="#a5ce3b7c55df296782fa748c782c70cf"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#bf30dd172074db720c558b04764ff117">df_init</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function initializes the SPI bus over which the DF is controlled.  <a href="#bf30dd172074db720c558b04764ff117"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#e29a521e9a1ec9ea380a6c41a25383d9">df_chipselect_memzone</a> (<a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> memzone)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function selects a DF memory according to the sector pointer.  <a href="#e29a521e9a1ec9ea380a6c41a25383d9"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00026.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#4b342016a045dc46831fecaca66afda0">df_translate_addr</a> (<a class="el" href="a00026.html#c978057e4cdffa92fc7120b5d5c69f15">Uint32</a> log_sect_addr)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function translates the logical sector address to the physical byte address (1 logical sector = 512 bytes) In function of the memory configuration (number 1x/2x/4x, pages 512b/1024b) :.  <a href="#4b342016a045dc46831fecaca66afda0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#140e522da74a8d217efb15bc2e5192df">df_mem_check</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function performs a memory check on all DF.  <a href="#140e522da74a8d217efb15bc2e5192df"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#d4091a322e41042b846029ed3679d138">df_read_open</a> (<a class="el" href="a00026.html#c978057e4cdffa92fc7120b5d5c69f15">Uint32</a> pos)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function opens a DF memory in read mode at a given sector address.  <a href="#d4091a322e41042b846029ed3679d138"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#76d9114087dc496dcb6e7441abfbfc68">df_read_close</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function unselects the current DF memory.  <a href="#76d9114087dc496dcb6e7441abfbfc68"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#15e5c8b748263a2f9c5d2a972896c09d">df_read_sector</a> (<a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a> nb_sector)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function is optimized and writes nb-sector * 512 Bytes from DataFlash memory to USB controller.  <a href="#15e5c8b748263a2f9c5d2a972896c09d"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#ff167c7f03438afd57e148a2d12ade41">df_write_open</a> (<a class="el" href="a00026.html#c978057e4cdffa92fc7120b5d5c69f15">Uint32</a> pos)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function opens a DF memory in write mode at a given sector address.  <a href="#ff167c7f03438afd57e148a2d12ade41"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#0ab831b820f2a30a2e273a7e7e820252">df_write_close</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function fills the end of the logical sector (512B) and launch page programming.  <a href="#0ab831b820f2a30a2e273a7e7e820252"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#2241c23b970d692b0698dd7d75eb41b5">df_write_sector</a> (<a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a> nb_sector)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function is optimized and writes nb-sector * 512 Bytes from USB controller to DataFlash memory.  <a href="#2241c23b970d692b0698dd7d75eb41b5"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bit&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#b8bd6f5ee9927d19affa150142d25ece">df_host_write_sector</a> (<a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a> nb_sector)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Funtions to link USB HOST flow with data flash.  <a href="#b8bd6f5ee9927d19affa150142d25ece"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">bit&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#4625f9b4b8ca7dd8ee09bf804de26d81">df_host_read_sector</a> (<a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a> nb_sector)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#4cf6abce91d472c104171a6e9cf4ecf0">df_read_sector_2_ram</a> (<a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function read one DF sector and load it into a ram buffer.  <a href="#4cf6abce91d472c104171a6e9cf4ecf0"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#459f780ad78b2d33e5f434af1f89a24e">df_write_sector_from_ram</a> (<a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *ram)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">This function write one DF sector from a ram buffer.  <a href="#459f780ad78b2d33e5f434af1f89a24e"></a><br></td></tr>
<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00026.html#811024d35b9b8a41095b1f583b649e56">U32</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#eae6165473a95bf601eb77b386b87711">df_mem_busy</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">static <a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a></td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This file contains the low-level dataflash routines - Compiler: IAR EWAVR and GNU GCC for AVR<ul>
<li>Supported devices: AT90USB1287, AT90USB1286, AT90USB647, AT90USB646 <dl class="author" compact><dt><b>Author:</b></dt><dd>Atmel Corporation: <a href="http://www.atmel.com">http://www.atmel.com</a> <br>
 Support and FAQ: <a href="http://support.atmel.no/">http://support.atmel.no/</a> </dd></dl>
</li></ul>

<p>Definition in file <a class="el" href="a00110.html">df.c</a>.</p>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="58303393c416a654cfc0e2e0422a795a"></a><!-- doxytag: member="df.c::df_wait_busy" ref="58303393c416a654cfc0e2e0422a795a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void df_wait_busy           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function waits until the DataFlash is not busy. 
<p>

<p>Definition at line <a class="el" href="a00110.html#l00225">225</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>References <a class="el" href="a00110.html#l00115">df_chipselect_current()</a>, <a class="el" href="a00126.html#l00166">Df_desel_all</a>, <a class="el" href="a00111.html#l00061">DF_MEM_BUSY</a>, <a class="el" href="a00111.html#l00060">DF_MSK_BIT_BUSY</a>, <a class="el" href="a00111.html#l00063">DF_RD_STATUS</a>, <a class="el" href="a00125.html#l00112">Spi_ack_write</a>, <a class="el" href="a00125.html#l00116">Spi_read_data</a>, and <a class="el" href="a00125.html#l00117">Spi_write_data</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00255">df_read_open()</a>, and <a class="el" href="a00110.html#l00455">df_write_open()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00226"></a>00226 {
<a name="l00227"></a>00227    <span class="comment">// Read the status register until the DataFlash is not busy.</span>
<a name="l00228"></a>00228    <a class="code" href="a00034.html#a5ce3b7c55df296782fa748c782c70cf" title="This function physically selects the current addressed memory.">df_chipselect_current</a>();
<a name="l00229"></a>00229    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00035.html#674620d11f1f59fb9fa238685753cccf">DF_RD_STATUS</a>); <span class="comment">// Send the read status register cmd</span>
<a name="l00230"></a>00230                                  <span class="comment">// + 1st step to clear the SPIF bit</span>
<a name="l00231"></a>00231    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);            <span class="comment">// dummy write that:</span>
<a name="l00232"></a>00232                                  <span class="comment">// - finalize the clear of the SPIF bit (access to SPDR)</span>
<a name="l00233"></a>00233                                  <span class="comment">// - get status register</span>
<a name="l00234"></a>00234                                  <span class="comment">// - does the 1st step to clear the SPIF bit</span>
<a name="l00235"></a>00235    <span class="comment">// Following Spi_read_data() finalize the clear of SPIF by accessing SPDR</span>
<a name="l00236"></a>00236    <span class="keywordflow">while</span> ((<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>() &amp; <a class="code" href="a00035.html#00fedf616a8a2d46e3536bc37d3e5108">DF_MSK_BIT_BUSY</a>) == <a class="code" href="a00035.html#fbbc2ed48fd554682d6ac946cbec7a52">DF_MEM_BUSY</a>)
<a name="l00237"></a>00237    {
<a name="l00238"></a>00238       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);         <span class="comment">// dummy write to get new status</span>
<a name="l00239"></a>00239                                  <span class="comment">// + 1st step to clear the SPIF bit</span>
<a name="l00240"></a>00240    }
<a name="l00241"></a>00241    <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();               <span class="comment">// unselect memory to leave STATUS request mode</span>
<a name="l00242"></a>00242    <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();              <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00243"></a>00243 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dynsection">
</div>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="a5ce3b7c55df296782fa748c782c70cf"></a><!-- doxytag: member="df.c::df_chipselect_current" ref="a5ce3b7c55df296782fa748c782c70cf" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void df_chipselect_current           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function physically selects the current addressed memory. 
<p>

<p>Definition at line <a class="el" href="a00110.html#l00115">115</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>References <a class="el" href="a00126.html#l00166">Df_desel_all</a>, <a class="el" href="a00110.html#l00056">df_select</a>, and <a class="el" href="a00126.html#l00165">Df_select_0</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00197">df_mem_check()</a>, <a class="el" href="a00110.html#l00255">df_read_open()</a>, <a class="el" href="a00110.html#l00225">df_wait_busy()</a>, and <a class="el" href="a00110.html#l00455">df_write_open()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00116"></a>00116 {
<a name="l00117"></a>00117    <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00118"></a>00118    <span class="keywordflow">switch</span> (<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>)
<a name="l00119"></a>00119    {
<a name="l00120"></a>00120       <span class="keywordflow">case</span> 0:
<a name="l00121"></a>00121       <a class="code" href="a00082.html#gce42adc7811c441c1ccc4e489d21ee98">Df_select_0</a>();
<a name="l00122"></a>00122       <span class="keywordflow">break</span>;
<a name="l00123"></a>00123 <span class="preprocessor">#if (DF_NB_MEM &gt; 1)</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>      <span class="keywordflow">case</span> 1:
<a name="l00125"></a>00125       Df_select_1();
<a name="l00126"></a>00126       <span class="keywordflow">break</span>;
<a name="l00127"></a>00127 <span class="preprocessor">#endif</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span><span class="preprocessor">#if (DF_NB_MEM &gt; 2)</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>      <span class="keywordflow">case</span> 2:
<a name="l00130"></a>00130       Df_select_2();
<a name="l00131"></a>00131       <span class="keywordflow">break</span>;
<a name="l00132"></a>00132       <span class="keywordflow">case</span> 3:
<a name="l00133"></a>00133       Df_select_3();
<a name="l00134"></a>00134       <span class="keywordflow">break</span>;
<a name="l00135"></a>00135 <span class="preprocessor">#endif</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>   }
<a name="l00137"></a>00137 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="bf30dd172074db720c558b04764ff117"></a><!-- doxytag: member="df.c::df_init" ref="bf30dd172074db720c558b04764ff117" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void df_init           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function initializes the SPI bus over which the DF is controlled. 
<p>

<p>Definition at line <a class="el" href="a00110.html#l00067">67</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00064">df_mem_init()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00068"></a>00068 {
<a name="l00069"></a>00069    <span class="comment">// Init the SPI communication link between the DF and the DF driver.</span>
<a name="l00070"></a>00070    <a class="code" href="a00082.html#g06bc224e0a8c8a16815995e522d22d2a">Df_init_spi</a>();
<a name="l00071"></a>00071    <a class="code" href="a00049.html#49d47418ae74e184fcaf75ff01f72192">Spi_select_master</a>();
<a name="l00072"></a>00072    <a class="code" href="a00049.html#e376e9566842eee97134c973b46c4e19">Spi_set_mode</a>(<a class="code" href="a00049.html#6a091da9f9011457fe28ab25f64c858d">SPI_MODE_3</a>);
<a name="l00073"></a>00073    <a class="code" href="a00049.html#28826d8905e9c9eb49f260d2fba4d588">Spi_init_bus</a>();
<a name="l00074"></a>00074    <a class="code" href="a00049.html#adb0cf7b9c4910655082f4f2abc9e7fe">Spi_set_rate</a>(<a class="code" href="a00049.html#794870725abd9d2ed6e6f497690a82f3">SPI_RATE_0</a>);  <span class="comment">// SCK freq == fosc/2.</span>
<a name="l00075"></a>00075    <a class="code" href="a00049.html#b163b6dfa1bcf4b8aa8160f21964ed39">Spi_disable_ss</a>();
<a name="l00076"></a>00076    <a class="code" href="a00049.html#c8234d59f9ec0048276dfcdfd70e6479">Spi_enable</a>();
<a name="l00077"></a>00077 
<a name="l00078"></a>00078    <span class="comment">// Data Flash Controller init.</span>
<a name="l00079"></a>00079    <a class="code" href="a00034.html#eae6165473a95bf601eb77b386b87711">df_mem_busy</a> = 0;           <span class="comment">// all memories ready</span>
<a name="l00080"></a>00080    <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a> = 0;
<a name="l00081"></a>00081 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="e29a521e9a1ec9ea380a6c41a25383d9"></a><!-- doxytag: member="df.c::df_chipselect_memzone" ref="e29a521e9a1ec9ea380a6c41a25383d9" args="(U8 memzone)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void df_chipselect_memzone           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>&nbsp;</td>
          <td class="paramname"> <em>memzone</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function selects a DF memory according to the sector pointer. 
<p>
<div class="fragment"><pre class="fragment">
//! The "df_select" variable contains the current memory addressed
//! Refer to the documentation of the function df_translate_addr() for more information about zones management
//! </pre></div> 
<p>Definition at line <a class="el" href="a00110.html#l00091">91</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>References <a class="el" href="a00110.html#l00056">df_select</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00255">df_read_open()</a>, and <a class="el" href="a00110.html#l00455">df_write_open()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00092"></a>00092 {
<a name="l00093"></a>00093 <span class="preprocessor">#if (DF_NB_MEM == 1)</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>   <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a> = 0;
<a name="l00095"></a>00095 <span class="preprocessor">#else</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="preprocessor">   #if (DF_NB_MEM == 2)</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">      #if (DF_PAGE_SIZE == 512)</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>   <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a> = (memzone&gt;&gt;0)&amp;0x01;
<a name="l00099"></a>00099 <span class="preprocessor">      #else</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>   <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a> = (memzone&gt;&gt;1)&amp;0x01;
<a name="l00101"></a>00101 <span class="preprocessor">      #endif</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">   #else</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">      #if (DF_PAGE_SIZE == 512)</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>   <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a> = (memzone&gt;&gt;0)&amp;0x03;
<a name="l00105"></a>00105 <span class="preprocessor">      #else</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>   <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a> = (memzone&gt;&gt;1)&amp;0x03;
<a name="l00107"></a>00107 <span class="preprocessor">      #endif</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span><span class="preprocessor">   #endif</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>}
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="4b342016a045dc46831fecaca66afda0"></a><!-- doxytag: member="df.c::df_translate_addr" ref="4b342016a045dc46831fecaca66afda0" args="(Uint32 log_sect_addr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static <a class="el" href="a00026.html#811024d35b9b8a41095b1f583b649e56">U32</a> df_translate_addr           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#c978057e4cdffa92fc7120b5d5c69f15">Uint32</a>&nbsp;</td>
          <td class="paramname"> <em>log_sect_addr</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function translates the logical sector address to the physical byte address (1 logical sector = 512 bytes) In function of the memory configuration (number 1x/2x/4x, pages 512b/1024b) :. 
<p>
MEMORIES WITH PAGES OF 512 BYTES : ================================== Consider the logical sector address as "xx..xxba", where 'b' and 'a' are the two last bits, and "xx..xx" an undefined number of more significant bits<ul>
<li>If 1 memory is used, this logical sector address directly matches with the physical sector address So the physical sector address is "xx..xxba"</li><li>If 2 memories are used, the bit 'a' indicates the memory concerned, and the rest of the address indicates the physical address So the physical sector address is "xx...xxb"</li><li>If 4 memories are used, the bits 'ba' indicates the memory concerned, and the rest of the address indicates the physical address So the physical sector address is "xx....xx"</li></ul>
<p>
MEMORIES WITH PAGES OF 1024 BYTES : ================================== Consider the logical sector address as "xx..xxcba", where 'c', 'b' and 'a' are the three last bits, and "xx..xx" an undefined number of more significant bits<ul>
<li>If 1 memory is used, this logical sector address directly matches with the physical sector address So the physical sector address is "xx..xxcba"</li><li>If 2 memories are used, the bit 'b' indicates the memory concerned, and the rest of the address indicates the physical address So the physical sector address is "xx...xxca"</li><li>If 4 memories are used, the bits 'cb' indicates the memory concerned, and the rest of the address indicates the physical address So the physical sector address is "xx....xxa"</li></ul>
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>log_sect_addr</em>&nbsp;</td><td>logical sector address</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>U32 physical byte address </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00168">168</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00255">df_read_open()</a>, and <a class="el" href="a00110.html#l00455">df_write_open()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00169"></a>00169 {
<a name="l00170"></a>00170 <span class="preprocessor">#if (DF_NB_MEM == 1)</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (log_sect_addr &lt;&lt; 9);  <span class="comment">// this case if only one memory...</span>
<a name="l00172"></a>00172 <span class="preprocessor">#else</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span><span class="preprocessor">   #if (DF_NB_MEM == 2)</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span><span class="preprocessor">      #if (DF_PAGE_SIZE == 512)</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>   <span class="keywordflow">return</span> ((log_sect_addr&amp;0xFFFFFFFE) &lt;&lt; 8);
<a name="l00176"></a>00176 <span class="preprocessor">      #else</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (((log_sect_addr&amp;0xFFFFFFFC) &lt;&lt; 8) | ((log_sect_addr&amp;0x00000001) &lt;&lt; 9));
<a name="l00178"></a>00178 <span class="preprocessor">      #endif</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor">   #else</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">      #if (DF_PAGE_SIZE == 512)</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>   <span class="keywordflow">return</span> ((log_sect_addr&amp;0xFFFFFFFC) &lt;&lt; 7);
<a name="l00182"></a>00182 <span class="preprocessor">      #else</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>   <span class="keywordflow">return</span> (((log_sect_addr&amp;0xFFFFFFF8) &lt;&lt; 7) | ((log_sect_addr&amp;0x00000001) &lt;&lt; 9));
<a name="l00184"></a>00184 <span class="preprocessor">      #endif</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span><span class="preprocessor">   #endif</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>}
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="140e522da74a8d217efb15bc2e5192df"></a><!-- doxytag: member="df.c::df_mem_check" ref="140e522da74a8d217efb15bc2e5192df" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_mem_check           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function performs a memory check on all DF. 
<p>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>bit The memory is ready -&gt; OK The memory check failed -&gt; KO </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00197">197</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00077">df_test_unit_ready()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00198"></a>00198 {
<a name="l00199"></a>00199    <span class="comment">// DF memory check.</span>
<a name="l00200"></a>00200    <span class="keywordflow">for</span>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>=0; <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>&lt;<a class="code" href="a00082.html#gf5b94210c5080d06bd655ca51a2edd1c">DF_NB_MEM</a>; <a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>++)
<a name="l00201"></a>00201    {
<a name="l00202"></a>00202       <a class="code" href="a00034.html#a5ce3b7c55df296782fa748c782c70cf" title="This function physically selects the current addressed memory.">df_chipselect_current</a>();
<a name="l00203"></a>00203       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00035.html#674620d11f1f59fb9fa238685753cccf">DF_RD_STATUS</a>); <span class="comment">// Send the read status register cmd</span>
<a name="l00204"></a>00204                                     <span class="comment">// + 1st step to clear the SPIF bit</span>
<a name="l00205"></a>00205       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);            <span class="comment">// dummy write that:</span>
<a name="l00206"></a>00206                                     <span class="comment">// - finalize the clear of the SPIF bit (access to SPDR)</span>
<a name="l00207"></a>00207                                     <span class="comment">// - get status register</span>
<a name="l00208"></a>00208                                     <span class="comment">// - does the 1st step to clear the SPIF bit </span>
<a name="l00209"></a>00209       <span class="comment">// Following Spi_read_data() finalize the clear of SPIF by accessing SPDR.</span>
<a name="l00210"></a>00210       <span class="comment">// Check the DF density.</span>
<a name="l00211"></a>00211       <span class="keywordflow">if</span> ((<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>() &amp; <a class="code" href="a00035.html#e5609cd7d912a8c27bd2c524995d65a4">DF_MSK_DENSITY</a>) != DF_DENSITY)
<a name="l00212"></a>00212       {   
<a name="l00213"></a>00213         <span class="comment">// Unexpected value.</span>
<a name="l00214"></a>00214         <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00215"></a>00215         <span class="keywordflow">return</span> (<a class="code" href="a00026.html#cb00992efca56626cdf0907e5edb5b51">KO</a>);
<a name="l00216"></a>00216       }
<a name="l00217"></a>00217       <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00218"></a>00218    }
<a name="l00219"></a>00219    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00220"></a>00220 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="d4091a322e41042b846029ed3679d138"></a><!-- doxytag: member="df.c::df_read_open" ref="d4091a322e41042b846029ed3679d138" args="(Uint32 pos)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_read_open           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#c978057e4cdffa92fc7120b5d5c69f15">Uint32</a>&nbsp;</td>
          <td class="paramname"> <em>pos</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function opens a DF memory in read mode at a given sector address. 
<p>
NOTE: Address may not be synchronized on the beginning of a page (depending on the DF page size).<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pos</em>&nbsp;</td><td>Logical sector address</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>bit The open succeeded -&gt; OK </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00255">255</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00446">df_df_2_ram()</a>, <a class="el" href="a00110.html#l00864">df_host_read_sector()</a>, <a class="el" href="a00112.html#l00145">df_read_10()</a>, and <a class="el" href="a00110.html#l00326">df_read_sector()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00256"></a>00256 {
<a name="l00257"></a>00257    <span class="comment">// Set the global memory ptr at a Byte address.</span>
<a name="l00258"></a>00258    <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> = <a class="code" href="a00034.html#4b342016a045dc46831fecaca66afda0" title="This function translates the logical sector address to the physical byte address...">df_translate_addr</a>(pos);
<a name="l00259"></a>00259    
<a name="l00260"></a>00260    <span class="comment">// Select the DF that memory "pos" points to (the "df_select" variable will be updated)</span>
<a name="l00261"></a>00261    <a class="code" href="a00034.html#e29a521e9a1ec9ea380a6c41a25383d9" title="This function selects a DF memory according to the sector pointer.">df_chipselect_memzone</a>(<a class="code" href="a00026.html#844ec34df36feb927dc92007af14674a">LSB0</a>(pos));
<a name="l00262"></a>00262    
<a name="l00263"></a>00263    <span class="comment">// If the DF memory is busy, wait until it's not.</span>
<a name="l00264"></a>00264    <span class="keywordflow">if</span> (<a class="code" href="a00035.html#b8228b7612a61822a74e06f1313f61e6">is_df_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>))
<a name="l00265"></a>00265    {
<a name="l00266"></a>00266     <a class="code" href="a00035.html#6d76b85a4d4c1cbc31e4c3a48b9bada3">df_release_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);
<a name="l00267"></a>00267     <a class="code" href="a00034.html#58303393c416a654cfc0e2e0422a795a" title="This function waits until the DataFlash is not busy.">df_wait_busy</a>();                              <span class="comment">// wait end of programming</span>
<a name="l00268"></a>00268    }
<a name="l00269"></a>00269    
<a name="l00270"></a>00270    <span class="comment">// Physically assert the selected dataflash</span>
<a name="l00271"></a>00271    <a class="code" href="a00034.html#a5ce3b7c55df296782fa748c782c70cf" title="This function physically selects the current addressed memory.">df_chipselect_current</a>();
<a name="l00272"></a>00272    
<a name="l00273"></a>00273    <span class="comment">//#</span>
<a name="l00274"></a>00274    <span class="comment">//# Initiate a page read at a given sector address.</span>
<a name="l00275"></a>00275    <span class="comment">//#</span>
<a name="l00276"></a>00276    <span class="comment">// Send read main command, + first step to clear the SPIF bit</span>
<a name="l00277"></a>00277    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00035.html#1dad1a827e9bf8d3feeb61a5fc1a0f7b">DF_RD_MAIN</a>);
<a name="l00278"></a>00278    <span class="comment">// Final step to clear the SPIF bit will be done on the next write</span>
<a name="l00279"></a>00279    
<a name="l00280"></a>00280    <span class="comment">// Send the three address Bytes made of:</span>
<a name="l00281"></a>00281    <span class="comment">// - the page-address(first xbits),</span>
<a name="l00282"></a>00282    <span class="comment">// - the Byte-address within the page(last ybits).</span>
<a name="l00283"></a>00283    <span class="comment">// (x and y depending on the DF type).</span>
<a name="l00284"></a>00284    <span class="comment">// NOTE: the bits of gl_ptr_mem above the 24bits are not useful for the local</span>
<a name="l00285"></a>00285    <span class="comment">// DF addressing. They are used for DF discrimination when there are several</span>
<a name="l00286"></a>00286    <span class="comment">// DFs.</span>
<a name="l00287"></a>00287    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>((<a class="code" href="a00026.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &lt;&lt; DF_SHFT_B1) | (<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &gt;&gt; DF_SHFT_B2));
<a name="l00288"></a>00288    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; ~DF_PAGE_MASK) &lt;&lt; DF_SHFT_B1) | (<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; DF_PAGE_MASK));
<a name="l00289"></a>00289    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00026.html#eeb8918fc580ce01d45f71863eebff90">MSB3</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>));
<a name="l00290"></a>00290    <span class="comment">// Final step to clear the SPIF bit will be done on the next write</span>
<a name="l00291"></a>00291    
<a name="l00292"></a>00292    <span class="comment">// 4 dummy writes for reading delay</span>
<a name="l00293"></a>00293    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00294"></a>00294    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00295"></a>00295    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF);
<a name="l00296"></a>00296    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0xFF); <span class="comment">// Tx 0xFF, first step to clear the SPIF bit</span>
<a name="l00297"></a>00297    <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();      <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00298"></a>00298    
<a name="l00299"></a>00299    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00300"></a>00300 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="76d9114087dc496dcb6e7441abfbfc68"></a><!-- doxytag: member="df.c::df_read_close" ref="76d9114087dc496dcb6e7441abfbfc68" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void df_read_close           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function unselects the current DF memory. 
<p>

<p>Definition at line <a class="el" href="a00110.html#l00305">305</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00446">df_df_2_ram()</a>, and <a class="el" href="a00112.html#l00145">df_read_10()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00306"></a>00306 {
<a name="l00307"></a>00307   <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();   <span class="comment">// Unselect memory</span>
<a name="l00308"></a>00308 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="15e5c8b748263a2f9c5d2a972896c09d"></a><!-- doxytag: member="df.c::df_read_sector" ref="15e5c8b748263a2f9c5d2a972896c09d" args="(Uint16 nb_sector)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_read_sector           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a>&nbsp;</td>
          <td class="paramname"> <em>nb_sector</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function is optimized and writes nb-sector * 512 Bytes from DataFlash memory to USB controller. 
<p>
NOTE:<ul>
<li>First call must be preceded by a call to the <a class="el" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open()</a> function,</li><li>The USB EPIN must have been previously selected,</li><li>USB ping-pong buffers are free,</li><li>As 512 is always a sub-multiple of page size, there is no need to check page end for each Bytes,</li><li>Interrupts are disabled during transfer to avoid timer interrupt,</li><li>nb_sector always &gt;= 1, cannot be zero.</li></ul>
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>number of contiguous sectors to read [IN]</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The read succeeded -&gt; OK </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00326">326</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00145">df_read_10()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00327"></a>00327 {
<a name="l00328"></a>00328    <a class="code" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i;
<a name="l00329"></a>00329 <span class="preprocessor">#ifdef DF_CODE_SIZE_OPTIMIZATION   </span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>   <a class="code" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> j;
<a name="l00331"></a>00331 <span class="preprocessor">#endif</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span>   <span class="keywordflow">do</span>
<a name="l00333"></a>00333    {
<a name="l00334"></a>00334       <span class="keywordflow">for</span> (i = 8; i != 0; i--)
<a name="l00335"></a>00335       {
<a name="l00336"></a>00336          Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l00337"></a>00337          
<a name="l00338"></a>00338          <span class="comment">// Principle: send any Byte to get a Byte.</span>
<a name="l00339"></a>00339          <span class="comment">// Spi_write_data(0): send any Byte + 1st step to clear the SPIF bit.</span>
<a name="l00340"></a>00340          <span class="comment">// Spi_read_data(): get the Byte + final step to clear the SPIF bit.         </span>
<a name="l00341"></a>00341 <span class="preprocessor">#ifdef DF_CODE_SIZE_OPTIMIZATION</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span>         <span class="keywordflow">for</span>(j=0;j&lt;64;j++)
<a name="l00343"></a>00343          {
<a name="l00344"></a>00344             <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00345"></a>00345          }
<a name="l00346"></a>00346 <span class="preprocessor">#else         </span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>         <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00348"></a>00348          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00349"></a>00349          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00350"></a>00350          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00351"></a>00351          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00352"></a>00352          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00353"></a>00353          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00354"></a>00354          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00355"></a>00355          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00356"></a>00356          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00357"></a>00357          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00358"></a>00358          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00359"></a>00359          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00360"></a>00360          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00361"></a>00361          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00362"></a>00362          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00363"></a>00363          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00364"></a>00364          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00365"></a>00365          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00366"></a>00366          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00367"></a>00367          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00368"></a>00368          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00369"></a>00369          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00370"></a>00370          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00371"></a>00371          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00372"></a>00372          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00373"></a>00373          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00374"></a>00374          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00375"></a>00375          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00376"></a>00376          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00377"></a>00377          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00378"></a>00378          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00379"></a>00379          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00380"></a>00380          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00381"></a>00381          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00382"></a>00382          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00383"></a>00383          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00384"></a>00384          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00385"></a>00385          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00386"></a>00386          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00387"></a>00387          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00388"></a>00388          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00389"></a>00389          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00390"></a>00390          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00391"></a>00391          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00392"></a>00392          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00393"></a>00393          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00394"></a>00394          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00395"></a>00395          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00396"></a>00396          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00397"></a>00397          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00398"></a>00398          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00399"></a>00399          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00400"></a>00400          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00401"></a>00401          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00402"></a>00402          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00403"></a>00403          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00404"></a>00404          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00405"></a>00405          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00406"></a>00406          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00407"></a>00407          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00408"></a>00408          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00409"></a>00409          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00410"></a>00410          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00411"></a>00411 <span class="preprocessor">#endif</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>         <a class="code" href="a00091.html#g5369d57fde2684237cc527f6b555ebf5" title="sends IN">Usb_send_in</a>();          <span class="comment">// Send the FIFO IN content to the USB Host.</span>
<a name="l00413"></a>00413 
<a name="l00414"></a>00414          Enable_interrupt();     <span class="comment">// Global interrupt re-enable.</span>
<a name="l00415"></a>00415 
<a name="l00416"></a>00416          <span class="comment">// Wait until the tx is done so that we may write to the FIFO IN again.</span>
<a name="l00417"></a>00417          <span class="keywordflow">while</span>(<a class="code" href="a00091.html#g1b470916df610d8750a5a5916976e687" title="tests if endpoint write allowed">Is_usb_write_enabled</a>()==<a class="code" href="a00026.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l00418"></a>00418          {
<a name="l00419"></a>00419             <span class="keywordflow">if</span>(!<a class="code" href="a00091.html#g0f52bbafba70190a44a789befbc82a46" title="tests if the current endpoint is enabled">Is_usb_endpoint_enabled</a>())
<a name="l00420"></a>00420                <span class="keywordflow">return</span> <a class="code" href="a00026.html#cb00992efca56626cdf0907e5edb5b51">KO</a>; <span class="comment">// USB Reset</span>
<a name="l00421"></a>00421          }         
<a name="l00422"></a>00422       }
<a name="l00423"></a>00423       <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;         <span class="comment">// increment global address pointer</span>
<a name="l00424"></a>00424       nb_sector--;               <span class="comment">// 1 more sector read</span>
<a name="l00425"></a>00425 <span class="preprocessor">      #if (DF_NB_MEM == 1)       // end of page ?</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span><span class="preprocessor">         #if (DF_PAGE_SIZE == 512)</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span>            <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00428"></a>00428             <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00429"></a>00429               <a class="code" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00430"></a>00430 <span class="preprocessor">         #else</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; DF_PAGE_MASK) == 0x00)
<a name="l00432"></a>00432             {
<a name="l00433"></a>00433                <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00434"></a>00434                <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00435"></a>00435                  <a class="code" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00436"></a>00436             }
<a name="l00437"></a>00437 <span class="preprocessor">         #endif</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span><span class="preprocessor">      #endif</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span>   }
<a name="l00440"></a>00440    <span class="keywordflow">while</span> (nb_sector != 0);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00443"></a>00443 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="ff167c7f03438afd57e148a2d12ade41"></a><!-- doxytag: member="df.c::df_write_open" ref="ff167c7f03438afd57e148a2d12ade41" args="(Uint32 pos)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_write_open           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#c978057e4cdffa92fc7120b5d5c69f15">Uint32</a>&nbsp;</td>
          <td class="paramname"> <em>pos</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function opens a DF memory in write mode at a given sector address. 
<p>
NOTE: If page buffer &gt; 512 bytes, page content is first loaded in buffer to be partially updated by write_byte or write64 functions.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>pos</em>&nbsp;</td><td>Sector address</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The open succeeded -&gt; OK </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00455">455</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00377">df_host_read_10()</a>, <a class="el" href="a00110.html#l00720">df_host_write_sector()</a>, <a class="el" href="a00112.html#l00464">df_ram_2_df()</a>, <a class="el" href="a00112.html#l00213">df_write_10()</a>, and <a class="el" href="a00110.html#l00562">df_write_sector()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00456"></a>00456 {
<a name="l00457"></a>00457    <span class="comment">// Set the global memory ptr at a Byte address.</span>
<a name="l00458"></a>00458    <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> = <a class="code" href="a00034.html#4b342016a045dc46831fecaca66afda0" title="This function translates the logical sector address to the physical byte address...">df_translate_addr</a>(pos);
<a name="l00459"></a>00459    
<a name="l00460"></a>00460    <span class="comment">// Select the DF that memory "pos" points to</span>
<a name="l00461"></a>00461    <a class="code" href="a00034.html#e29a521e9a1ec9ea380a6c41a25383d9" title="This function selects a DF memory according to the sector pointer.">df_chipselect_memzone</a>(<a class="code" href="a00026.html#844ec34df36feb927dc92007af14674a">LSB0</a>(pos));
<a name="l00462"></a>00462    
<a name="l00463"></a>00463    <span class="comment">// If the DF memory is busy, wait until it's not.</span>
<a name="l00464"></a>00464    <span class="keywordflow">if</span> (<a class="code" href="a00035.html#b8228b7612a61822a74e06f1313f61e6">is_df_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>))
<a name="l00465"></a>00465    {
<a name="l00466"></a>00466     <a class="code" href="a00035.html#6d76b85a4d4c1cbc31e4c3a48b9bada3">df_release_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);
<a name="l00467"></a>00467     <a class="code" href="a00034.html#58303393c416a654cfc0e2e0422a795a" title="This function waits until the DataFlash is not busy.">df_wait_busy</a>();                              <span class="comment">// wait end of programming</span>
<a name="l00468"></a>00468    }
<a name="l00469"></a>00469    
<a name="l00470"></a>00470 <span class="preprocessor">#if DF_PAGE_SIZE &gt; 512</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>   <span class="comment">// Physically assert the selected dataflash</span>
<a name="l00472"></a>00472    <a class="code" href="a00034.html#a5ce3b7c55df296782fa748c782c70cf" title="This function physically selects the current addressed memory.">df_chipselect_current</a>();
<a name="l00473"></a>00473    
<a name="l00474"></a>00474    <span class="comment">//#</span>
<a name="l00475"></a>00475    <span class="comment">//# Transfer the current page content in buffer1.</span>
<a name="l00476"></a>00476    <span class="comment">//#</span>
<a name="l00477"></a>00477    <span class="comment">// Send Main Mem page to Buffer1 command, + first step to clear the SPIF bit</span>
<a name="l00478"></a>00478    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00035.html#08475a75beb40151ea1fd17427c769f0">DF_TF_BUF_1</a>);
<a name="l00479"></a>00479    <span class="comment">// Final step to clear the SPIF bit will be done on the next write</span>
<a name="l00480"></a>00480    
<a name="l00481"></a>00481    <span class="comment">// Send the three address Bytes made of:</span>
<a name="l00482"></a>00482    <span class="comment">// - the page-address(first xbits),</span>
<a name="l00483"></a>00483    <span class="comment">// - remaining don't care bits(last ybits).</span>
<a name="l00484"></a>00484    <span class="comment">// (x and y depending on the DF type).</span>
<a name="l00485"></a>00485    <span class="comment">// NOTE: the bits of gl_ptr_mem above the 24bits are not useful for the local</span>
<a name="l00486"></a>00486    <span class="comment">// DF addressing. They are used for DF discrimination when there are several</span>
<a name="l00487"></a>00487    <span class="comment">// DFs.</span>
<a name="l00488"></a>00488    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>((<a class="code" href="a00026.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &lt;&lt; DF_SHFT_B1) | (<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &gt;&gt; DF_SHFT_B2));
<a name="l00489"></a>00489    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &lt;&lt; DF_SHFT_B1);
<a name="l00490"></a>00490    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);       <span class="comment">// Remaining don't care bits.</span>
<a name="l00491"></a>00491    <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();         <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00492"></a>00492    
<a name="l00493"></a>00493    <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();          <span class="comment">// Unselect memory to validate the command</span>
<a name="l00494"></a>00494    
<a name="l00495"></a>00495    <a class="code" href="a00034.html#58303393c416a654cfc0e2e0422a795a" title="This function waits until the DataFlash is not busy.">df_wait_busy</a>();               <span class="comment">// Wait end of page transfer</span>
<a name="l00496"></a>00496 <span class="preprocessor">#endif</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span>   
<a name="l00498"></a>00498    <span class="comment">// Physically assert the selected dataflash</span>
<a name="l00499"></a>00499    <a class="code" href="a00034.html#a5ce3b7c55df296782fa748c782c70cf" title="This function physically selects the current addressed memory.">df_chipselect_current</a>();
<a name="l00500"></a>00500    
<a name="l00501"></a>00501    <span class="comment">//#</span>
<a name="l00502"></a>00502    <span class="comment">//# Initiate a page write at a given sector address.</span>
<a name="l00503"></a>00503    <span class="comment">//#</span>
<a name="l00504"></a>00504    <span class="comment">// Send Main Memory Page Program Through Buffer1 command,</span>
<a name="l00505"></a>00505    <span class="comment">// + first step to clear the SPIF bit</span>
<a name="l00506"></a>00506    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(DF_PG_BUF_1);
<a name="l00507"></a>00507    <span class="comment">// Final step to clear the SPIF bit will be done on the next write</span>
<a name="l00508"></a>00508    
<a name="l00509"></a>00509    <span class="comment">// Send the three address Bytes made of:</span>
<a name="l00510"></a>00510    <span class="comment">//  (.) the page-address(first xbits),</span>
<a name="l00511"></a>00511    <span class="comment">//  (.) the Byte-address within the page(last ybits).</span>
<a name="l00512"></a>00512    <span class="comment">// (x and y depending on the DF type).</span>
<a name="l00513"></a>00513    <span class="comment">// NOTE: the bits of gl_ptr_mem above the 24bits are not useful for the local</span>
<a name="l00514"></a>00514    <span class="comment">// DF addressing. They are used for DF discrimination when there are several</span>
<a name="l00515"></a>00515    <span class="comment">// DFs.</span>
<a name="l00516"></a>00516    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>((<a class="code" href="a00026.html#3facab9f8ebf70ad6e16038465e2bedc">MSB1</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &lt;&lt; DF_SHFT_B1) | (<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &gt;&gt; DF_SHFT_B2));
<a name="l00517"></a>00517    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; ~DF_PAGE_MASK) &lt;&lt; DF_SHFT_B1) | (<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; DF_PAGE_MASK));
<a name="l00518"></a>00518    <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00026.html#eeb8918fc580ce01d45f71863eebff90">MSB3</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>));
<a name="l00519"></a>00519    <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();         <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00520"></a>00520    
<a name="l00521"></a>00521    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00522"></a>00522 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="0ab831b820f2a30a2e273a7e7e820252"></a><!-- doxytag: member="df.c::df_write_close" ref="0ab831b820f2a30a2e273a7e7e820252" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void df_write_close           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function fills the end of the logical sector (512B) and launch page programming. 
<p>

<p>Definition at line <a class="el" href="a00110.html#l00527">527</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00377">df_host_read_10()</a>, <a class="el" href="a00112.html#l00464">df_ram_2_df()</a>, and <a class="el" href="a00112.html#l00213">df_write_10()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00528"></a>00528 {
<a name="l00529"></a>00529    <span class="comment">//#</span>
<a name="l00530"></a>00530    <span class="comment">//# While end of logical sector (512B) not reached, zero-fill the remaining</span>
<a name="l00531"></a>00531    <span class="comment">//# memory Bytes.</span>
<a name="l00532"></a>00532    <span class="comment">//#</span>
<a name="l00533"></a>00533    <span class="keywordflow">while</span> ((<a class="code" href="a00026.html#eeb8918fc580ce01d45f71863eebff90">MSB3</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) != 0x00) || ((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; 0x01) != 0x00))
<a name="l00534"></a>00534    {
<a name="l00535"></a>00535       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0x00);   <span class="comment">// - Final step to clear the SPIF bit,</span>
<a name="l00536"></a>00536                               <span class="comment">// - Write 0x00</span>
<a name="l00537"></a>00537                               <span class="comment">// - first step to clear the SPIF bit.</span>
<a name="l00538"></a>00538       <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>++;
<a name="l00539"></a>00539    }
<a name="l00540"></a>00540    <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();           <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00541"></a>00541    
<a name="l00542"></a>00542    <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();            <span class="comment">// Launch page programming (or simply unselect memory</span>
<a name="l00543"></a>00543                               <span class="comment">// if the while loop was not performed).</span>
<a name="l00544"></a>00544    <a class="code" href="a00035.html#580f6dd7f024ae7299ff506159b3ef02">df_set_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);    <span class="comment">// Current memory is busy</span>
<a name="l00545"></a>00545 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="2241c23b970d692b0698dd7d75eb41b5"></a><!-- doxytag: member="df.c::df_write_sector" ref="2241c23b970d692b0698dd7d75eb41b5" args="(Uint16 nb_sector)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_write_sector           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a>&nbsp;</td>
          <td class="paramname"> <em>nb_sector</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function is optimized and writes nb-sector * 512 Bytes from USB controller to DataFlash memory. 
<p>
Funtions to link USB DEVICE flow with data flash.<p>
NOTE:<ul>
<li>First call must be preceded by a call to the <a class="el" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open()</a> function,</li><li>As 512 is always a sub-multiple of page size, there is no need to check page end for each Bytes,</li><li>The USB EPOUT must have been previously selected,</li><li>Interrupts are disabled during transfer to avoid timer interrupt,</li><li>nb_sector always &gt;= 1, cannot be zero.</li></ul>
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>number of contiguous sectors to write [IN]</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The write succeeded -&gt; OK </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00562">562</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00213">df_write_10()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00563"></a>00563 {
<a name="l00564"></a>00564    <a class="code" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i;
<a name="l00565"></a>00565 <span class="preprocessor">#ifdef DF_CODE_SIZE_OPTIMIZATION   </span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>   <a class="code" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> j;
<a name="l00567"></a>00567 <span class="preprocessor">#endif</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>   <span class="keywordflow">do</span>
<a name="l00569"></a>00569    {
<a name="l00570"></a>00570       <span class="comment">//# Write 8x64b = 512b from the USB FIFO OUT.</span>
<a name="l00571"></a>00571       <span class="keywordflow">for</span> (i = 8; i != 0; i--)
<a name="l00572"></a>00572       {
<a name="l00573"></a>00573          <span class="comment">// Wait end of rx in USB EPOUT.</span>
<a name="l00574"></a>00574          <span class="keywordflow">while</span>(!<a class="code" href="a00091.html#g8e3f7189783aa06dacc91d232ab94afb" title="tests if endpoint read allowed">Is_usb_read_enabled</a>())
<a name="l00575"></a>00575          {
<a name="l00576"></a>00576             <span class="keywordflow">if</span>(!<a class="code" href="a00091.html#g0f52bbafba70190a44a789befbc82a46" title="tests if the current endpoint is enabled">Is_usb_endpoint_enabled</a>())
<a name="l00577"></a>00577               <span class="keywordflow">return</span> <a class="code" href="a00026.html#cb00992efca56626cdf0907e5edb5b51">KO</a>; <span class="comment">// USB Reset</span>
<a name="l00578"></a>00578          }
<a name="l00579"></a>00579    
<a name="l00580"></a>00580          Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l00581"></a>00581 
<a name="l00582"></a>00582          <span class="comment">// SPI write principle: send a Byte then clear the SPIF flag.</span>
<a name="l00583"></a>00583          <span class="comment">// Spi_write_data(Usb_read_byte()): (.) Final step to clear the SPIF bit,</span>
<a name="l00584"></a>00584          <span class="comment">//                                  (.) send a Byte read from USB,</span>
<a name="l00585"></a>00585          <span class="comment">//                                  (.) 1st step to clear the SPIF bit.</span>
<a name="l00586"></a>00586 <span class="preprocessor">#ifdef DF_CODE_SIZE_OPTIMIZATION</span>
<a name="l00587"></a>00587 <span class="preprocessor"></span>         <span class="keywordflow">for</span>(j=0;j&lt;64;j++)
<a name="l00588"></a>00588          {
<a name="l00589"></a>00589             <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00590"></a>00590          }
<a name="l00591"></a>00591 <span class="preprocessor">#else</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span>         <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00593"></a>00593          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00594"></a>00594          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00595"></a>00595          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00596"></a>00596          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00597"></a>00597          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00598"></a>00598          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00599"></a>00599          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00600"></a>00600          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00601"></a>00601          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00602"></a>00602          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00603"></a>00603          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00604"></a>00604          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00605"></a>00605          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00606"></a>00606          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00607"></a>00607          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00608"></a>00608          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00609"></a>00609          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00610"></a>00610          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00611"></a>00611          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00612"></a>00612          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00613"></a>00613          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00614"></a>00614          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00615"></a>00615          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00616"></a>00616          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00617"></a>00617          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00618"></a>00618          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00619"></a>00619          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00620"></a>00620          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00621"></a>00621          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00622"></a>00622          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00623"></a>00623          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00624"></a>00624          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00625"></a>00625          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00626"></a>00626          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00627"></a>00627          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00628"></a>00628          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00629"></a>00629          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00630"></a>00630          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00631"></a>00631          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00632"></a>00632          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00633"></a>00633          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00634"></a>00634          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00635"></a>00635          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00636"></a>00636          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00637"></a>00637          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00638"></a>00638          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00639"></a>00639          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00640"></a>00640          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00641"></a>00641          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00642"></a>00642          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00643"></a>00643          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00644"></a>00644          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00645"></a>00645          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00646"></a>00646          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00647"></a>00647          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00648"></a>00648          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00649"></a>00649          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00650"></a>00650          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00651"></a>00651          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00652"></a>00652          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00653"></a>00653          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00654"></a>00654          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00655"></a>00655          <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00656"></a>00656 <span class="preprocessor">#endif</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span>         <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();        <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00658"></a>00658    
<a name="l00659"></a>00659          <a class="code" href="a00091.html#g2bcdff32843bb358fa2f99d3d98452cd" title="acks reveive OUT">Usb_ack_receive_out</a>();  <span class="comment">// USB EPOUT read acknowledgement.</span>
<a name="l00660"></a>00660    
<a name="l00661"></a>00661          Enable_interrupt();     <span class="comment">// Global re-enable.</span>
<a name="l00662"></a>00662       } <span class="comment">// for (i = 8; i != 0; i--)</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664       <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;         <span class="comment">// Update the memory pointer.</span>
<a name="l00665"></a>00665       nb_sector--;               <span class="comment">// 1 more sector written</span>
<a name="l00666"></a>00666 
<a name="l00667"></a>00667       <span class="comment">//# Launch page programming if end of page.</span>
<a name="l00668"></a>00668       <span class="comment">//#</span>
<a name="l00669"></a>00669 <span class="preprocessor">      #if DF_PAGE_SIZE &gt; 512</span>
<a name="l00670"></a>00670 <span class="preprocessor"></span>         <span class="comment">// Check if end of 1024b page.</span>
<a name="l00671"></a>00671          <span class="keywordflow">if</span> ((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; DF_PAGE_MASK) == 0x00)
<a name="l00672"></a>00672          {
<a name="l00673"></a>00673             <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();               <span class="comment">// Launch page programming</span>
<a name="l00674"></a>00674             <a class="code" href="a00035.html#580f6dd7f024ae7299ff506159b3ef02">df_set_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);       <span class="comment">// memory is busy</span>
<a name="l00675"></a>00675 <span class="preprocessor">            #if (DF_NB_MEM == 1)</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00677"></a>00677                  <a class="code" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00678"></a>00678 <span class="preprocessor">            #endif</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>         }
<a name="l00680"></a>00680 <span class="preprocessor">      #else</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span>         <span class="comment">// Always end of page.</span>
<a name="l00682"></a>00682          <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();                  <span class="comment">// Launch page programming</span>
<a name="l00683"></a>00683          <a class="code" href="a00035.html#580f6dd7f024ae7299ff506159b3ef02">df_set_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);          <span class="comment">// memory is busy</span>
<a name="l00684"></a>00684 <span class="preprocessor">         #if (DF_NB_MEM == 1)</span>
<a name="l00685"></a>00685 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00686"></a>00686               <a class="code" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00687"></a>00687 <span class="preprocessor">         #endif</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span><span class="preprocessor">      #endif</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>   }
<a name="l00690"></a>00690    <span class="keywordflow">while</span> (nb_sector != 0);
<a name="l00691"></a>00691 
<a name="l00692"></a>00692    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;                  <span class="comment">// Write done</span>
<a name="l00693"></a>00693 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="b8bd6f5ee9927d19affa150142d25ece"></a><!-- doxytag: member="df.c::df_host_write_sector" ref="b8bd6f5ee9927d19affa150142d25ece" args="(Uint16 nb_sector)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bit df_host_write_sector           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a>&nbsp;</td>
          <td class="paramname"> <em>nb_sector</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
Funtions to link USB HOST flow with data flash. 
<p>
This function is optimized and writes nb-sector * 512 Bytes from USB HOST controller to DataFlash memory DATA FLOW is: USB =&gt; DF NOTE:<ul>
<li>This function should be used only when using the USB controller in HOST mode</li><li>First call must be preceded by a call to the <a class="el" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open()</a> function,</li><li>As 512 is always a sub-multiple of page size, there is no need to check page end for each Bytes,</li><li>The USB PIPE OUT must have been previously selected,</li><li>Interrupts are disabled during transfer to avoid timer interrupt,</li><li>nb_sector always &gt;= 1, cannot be zero.</li></ul>
<p>
<dl class="warning" compact><dt><b>Warning:</b></dt><dd>code:?? bytes (function code length)</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>number of contiguous sectors to write [IN]</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>bit The write succeeded -&gt; OK / </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00720">720</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00377">df_host_read_10()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00721"></a>00721 {
<a name="l00722"></a>00722   <a class="code" href="a00026.html#e3a497195d617519e5353ea7b417940f">Byte</a> i;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724    <span class="keywordflow">do</span>
<a name="l00725"></a>00725    {
<a name="l00726"></a>00726     <span class="comment">//# Write 8x64b = 512b from the USB FIFO OUT.</span>
<a name="l00727"></a>00727     <span class="keywordflow">for</span> (i = 8; i != 0; i--)
<a name="l00728"></a>00728     {
<a name="l00729"></a>00729       <span class="comment">// Wait end of rx in USB PIPE IN.</span>
<a name="l00730"></a>00730       <a class="code" href="a00093.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00731"></a>00731       <span class="keywordflow">while</span>(<a class="code" href="a00093.html#g0ea8d43c89d2c359de9fe254eec50376" title="tests if endpoint read allowed">Is_host_read_enabled</a>()==<a class="code" href="a00026.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733       Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l00734"></a>00734 
<a name="l00735"></a>00735       <span class="comment">// SPI write principle: send a Byte then clear the SPIF flag.</span>
<a name="l00736"></a>00736       <span class="comment">// Spi_write_data(Usb_read_byte()): (.) Final step to clear the SPIF bit,</span>
<a name="l00737"></a>00737       <span class="comment">//                                  (.) send a Byte read from USB,</span>
<a name="l00738"></a>00738       <span class="comment">//                                  (.) 1st step to clear the SPIF bit.</span>
<a name="l00739"></a>00739       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00740"></a>00740       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00741"></a>00741       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00742"></a>00742       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00743"></a>00743       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00744"></a>00744       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00745"></a>00745       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00746"></a>00746       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00747"></a>00747       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00748"></a>00748       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00749"></a>00749       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00750"></a>00750       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00751"></a>00751       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00752"></a>00752       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00753"></a>00753       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00754"></a>00754       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00755"></a>00755       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00756"></a>00756       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00757"></a>00757       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00758"></a>00758       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00759"></a>00759       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00760"></a>00760       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00761"></a>00761       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00762"></a>00762       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00763"></a>00763       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00764"></a>00764       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00765"></a>00765       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00766"></a>00766       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00767"></a>00767       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00768"></a>00768       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00769"></a>00769       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00770"></a>00770       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00771"></a>00771       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00772"></a>00772       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00773"></a>00773       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00774"></a>00774       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00775"></a>00775       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00776"></a>00776       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00777"></a>00777       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00778"></a>00778       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00779"></a>00779       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00780"></a>00780       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00781"></a>00781       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00782"></a>00782       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00783"></a>00783       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00784"></a>00784       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00785"></a>00785       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00786"></a>00786       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00787"></a>00787       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00788"></a>00788       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00789"></a>00789       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00790"></a>00790       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00791"></a>00791       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00792"></a>00792       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00793"></a>00793       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00794"></a>00794       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00795"></a>00795       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00796"></a>00796       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00797"></a>00797       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00798"></a>00798       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00799"></a>00799       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00800"></a>00800       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00801"></a>00801       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00802"></a>00802       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(<a class="code" href="a00091.html#gf3407eef62060301890f9129ab090bbd" title="returns FIFO byte for current endpoint">Usb_read_byte</a>());
<a name="l00803"></a>00803       <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();        <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l00804"></a>00804       <a class="code" href="a00093.html#gf85323d5b67b6b0f5706f60697f0bb97" title="acks IN reception">Host_ack_in_received</a>();  <span class="comment">// USB PIPE IN read acknowledgement.</span>
<a name="l00805"></a>00805 
<a name="l00806"></a>00806       Enable_interrupt();     <span class="comment">// Global re-enable.</span>
<a name="l00807"></a>00807     } <span class="comment">// for (i = 8; i != 0; i--)</span>
<a name="l00808"></a>00808 
<a name="l00809"></a>00809       <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;        <span class="comment">// Update the memory pointer.</span>
<a name="l00810"></a>00810       nb_sector--;              <span class="comment">// 1 more sector written</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812       <span class="comment">//# Launch page programming if end of page.</span>
<a name="l00813"></a>00813       <span class="comment">//#</span>
<a name="l00814"></a>00814 <span class="preprocessor">      #if DF_PAGE_SIZE &gt; 512</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>         <span class="comment">// Check if end of 1024b page.</span>
<a name="l00816"></a>00816          <span class="keywordflow">if</span> ((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; DF_PAGE_MASK) == 0x00)
<a name="l00817"></a>00817          {
<a name="l00818"></a>00818             <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();         <span class="comment">// Launch page programming</span>
<a name="l00819"></a>00819             <a class="code" href="a00035.html#580f6dd7f024ae7299ff506159b3ef02">df_set_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);     <span class="comment">// memory is busy</span>
<a name="l00820"></a>00820 <span class="preprocessor">            #if (DF_NB_MEM == 1)</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00822"></a>00822                  <a class="code" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00823"></a>00823 <span class="preprocessor">            #endif</span>
<a name="l00824"></a>00824 <span class="preprocessor"></span>         }
<a name="l00825"></a>00825 <span class="preprocessor">      #else</span>
<a name="l00826"></a>00826 <span class="preprocessor"></span>         <span class="comment">// Always end of page.</span>
<a name="l00827"></a>00827          <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();           <span class="comment">// Launch page programming</span>
<a name="l00828"></a>00828          <a class="code" href="a00035.html#580f6dd7f024ae7299ff506159b3ef02">df_set_busy</a>(<a class="code" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a>);     <span class="comment">// memory is busy</span>
<a name="l00829"></a>00829 <span class="preprocessor">         #if (DF_NB_MEM == 1)</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00831"></a>00831               <a class="code" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00832"></a>00832 <span class="preprocessor">         #endif</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span><span class="preprocessor">      #endif</span>
<a name="l00834"></a>00834 <span class="preprocessor"></span>   }
<a name="l00835"></a>00835    <span class="keywordflow">while</span> (nb_sector != 0);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837   <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;                  <span class="comment">// Write done</span>
<a name="l00838"></a>00838 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="4625f9b4b8ca7dd8ee09bf804de26d81"></a><!-- doxytag: member="df.c::df_host_read_sector" ref="4625f9b4b8ca7dd8ee09bf804de26d81" args="(Uint16 nb_sector)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bit df_host_read_sector           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#59a9f6be4562c327cbfb4f7e8e18f08b">Uint16</a>&nbsp;</td>
          <td class="paramname"> <em>nb_sector</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function is optimized and writes nb-sector * 512 Bytes from DataFlash memory to USB HOST controller DATA FLOW is: DF =&gt; USB NOTE:<ul>
<li>This function should ne used only when using the USB controller in HOST mode</li><li>First call must be preceded by a call to the <a class="el" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open()</a> function,</li><li>The USB PIPE IN must have been previously selected,</li><li>USB ping-pong buffers are free,</li><li>As 512 is always a sub-multiple of page size, there is no need to check page end for each Bytes,</li><li>Interrupts are disabled during transfer to avoid timer interrupt,</li><li>nb_sector always &gt;= 1, cannot be zero.</li></ul>
<p>
<dl class="warning" compact><dt><b>Warning:</b></dt><dd>code:?? bytes (function code length)</dd></dl>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>nb_sector</em>&nbsp;</td><td>number of contiguous sectors to read [IN]</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>bit The read succeeded -&gt; OK / </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00864">864</a> of file <a class="el" href="a00110.html">df.c</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00865"></a>00865 {
<a name="l00866"></a>00866    <a class="code" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> i;
<a name="l00867"></a>00867    <span class="keywordflow">do</span>
<a name="l00868"></a>00868    {
<a name="l00869"></a>00869       <span class="keywordflow">for</span> (i = 8; i != 0; i--)
<a name="l00870"></a>00870     {
<a name="l00871"></a>00871       Disable_interrupt();    <span class="comment">// Global disable.</span>
<a name="l00872"></a>00872 
<a name="l00873"></a>00873       <span class="comment">// Principle: send any Byte to get a Byte.</span>
<a name="l00874"></a>00874       <span class="comment">// Spi_write_data(0): send any Byte + 1st step to clear the SPIF bit.</span>
<a name="l00875"></a>00875       <span class="comment">// Spi_read_data(): get the Byte + final step to clear the SPIF bit.</span>
<a name="l00876"></a>00876       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00877"></a>00877       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00878"></a>00878       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00879"></a>00879       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00880"></a>00880       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00881"></a>00881       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00882"></a>00882       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00883"></a>00883       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00884"></a>00884       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00885"></a>00885       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00886"></a>00886       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00887"></a>00887       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00888"></a>00888       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00889"></a>00889       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00890"></a>00890       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00891"></a>00891       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00892"></a>00892       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00893"></a>00893       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00894"></a>00894       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00895"></a>00895       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00896"></a>00896       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00897"></a>00897       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00898"></a>00898       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00899"></a>00899       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00900"></a>00900       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00901"></a>00901       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00902"></a>00902       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00903"></a>00903       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00904"></a>00904       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00905"></a>00905       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00906"></a>00906       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00907"></a>00907       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00908"></a>00908       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00909"></a>00909       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00910"></a>00910       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00911"></a>00911       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00912"></a>00912       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00913"></a>00913       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00914"></a>00914       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00915"></a>00915       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00916"></a>00916       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00917"></a>00917       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00918"></a>00918       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00919"></a>00919       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00920"></a>00920       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00921"></a>00921       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00922"></a>00922       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00923"></a>00923       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00924"></a>00924       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00925"></a>00925       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00926"></a>00926       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00927"></a>00927       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00928"></a>00928       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00929"></a>00929       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00930"></a>00930       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00931"></a>00931       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00932"></a>00932       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00933"></a>00933       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00934"></a>00934       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00935"></a>00935       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00936"></a>00936       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00937"></a>00937       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00938"></a>00938       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00939"></a>00939       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0); <a class="code" href="a00091.html#g922407bbf41e71cb77d2af191c6f58b7" title="writes byte in FIFO for current endpoint">Usb_write_byte</a>(<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>());
<a name="l00940"></a>00940 
<a name="l00941"></a>00941       Enable_interrupt();     <span class="comment">// Global re-enable.</span>
<a name="l00942"></a>00942 
<a name="l00943"></a>00943       <span class="comment">//#</span>
<a name="l00944"></a>00944       <span class="comment">//# Send the USB FIFO IN content to the USB Host.</span>
<a name="l00945"></a>00945       <span class="comment">//#</span>
<a name="l00946"></a>00946       <a class="code" href="a00093.html#g6d441c0c3c4456ee6f4aba99f93e34b1" title="sends a OUT">Host_send_out</a>();       <span class="comment">// Send the FIFO from the USB Host.</span>
<a name="l00947"></a>00947       <a class="code" href="a00093.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00948"></a>00948       <span class="comment">// Wait until the tx is done so that we may write to the FIFO IN again.</span>
<a name="l00949"></a>00949       <span class="keywordflow">while</span>(<a class="code" href="a00093.html#ga929cfbc27f3b6c6f2a069f61042e26d" title="tests if OUT has been sent">Is_host_out_sent</a>()==<a class="code" href="a00026.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l00950"></a>00950       <a class="code" href="a00093.html#ge9b66ff73de67c53abc6ea2c4127a411" title="acks OUT sent">Host_ack_out_sent</a>();
<a name="l00951"></a>00951       }
<a name="l00952"></a>00952       <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;      <span class="comment">// increment global address pointer</span>
<a name="l00953"></a>00953       nb_sector--;            <span class="comment">// 1 more sector read</span>
<a name="l00954"></a>00954 <span class="preprocessor">      #if (DF_NB_MEM == 1)    // end of page ?</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span><span class="preprocessor">         #if (DF_PAGE_SIZE == 512)</span>
<a name="l00956"></a>00956 <span class="preprocessor"></span>            <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00957"></a>00957             <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00958"></a>00958               <a class="code" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00959"></a>00959 <span class="preprocessor">         #else</span>
<a name="l00960"></a>00960 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((<a class="code" href="a00026.html#8683254be29bcfe3cf2fa646890d3942">MSB2</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>) &amp; DF_PAGE_MASK) == 0x00)
<a name="l00961"></a>00961             {
<a name="l00962"></a>00962                <a class="code" href="a00082.html#ge54d758300738cbd121a93928b50b71a">Df_desel_all</a>();
<a name="l00963"></a>00963                <span class="keywordflow">if</span> (nb_sector != 0)
<a name="l00964"></a>00964                  <a class="code" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open</a>(<a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a>&gt;&gt;9);
<a name="l00965"></a>00965             }
<a name="l00966"></a>00966 <span class="preprocessor">         #endif</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span><span class="preprocessor">      #endif</span>
<a name="l00968"></a>00968 <span class="preprocessor"></span>   }
<a name="l00969"></a>00969    <span class="keywordflow">while</span> (nb_sector != 0);
<a name="l00970"></a>00970 
<a name="l00971"></a>00971   <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;   <span class="comment">// Read done.</span>
<a name="l00972"></a>00972 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4cf6abce91d472c104171a6e9cf4ecf0"></a><!-- doxytag: member="df.c::df_read_sector_2_ram" ref="4cf6abce91d472c104171a6e9cf4ecf0" args="(U8 *ram)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_read_sector_2_ram           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *&nbsp;</td>
          <td class="paramname"> <em>ram</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function read one DF sector and load it into a ram buffer. 
<p>
Functions to read/write one sector (512btes) with ram buffer pointer.<p>
NOTE:<ul>
<li>First call must be preceded by a call to the <a class="el" href="a00034.html#d4091a322e41042b846029ed3679d138" title="This function opens a DF memory in read mode at a given sector address.">df_read_open()</a> function,</li></ul>
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>*ram</em>&nbsp;</td><td>pointer to ram buffer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The read succeeded -&gt; OK </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l00984">984</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00446">df_df_2_ram()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l00985"></a>00985 {
<a name="l00986"></a>00986    <a class="code" href="a00026.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l00987"></a>00987    <span class="keywordflow">for</span>(i=0;i&lt;512;i++)
<a name="l00988"></a>00988    {
<a name="l00989"></a>00989       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(0);
<a name="l00990"></a>00990       *ram=<a class="code" href="a00049.html#610afced04d118dbedcaf5e1ff0055e1">Spi_read_data</a>();
<a name="l00991"></a>00991       ram++;
<a name="l00992"></a>00992    }
<a name="l00993"></a>00993    <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;     <span class="comment">// Update the memory pointer.</span>
<a name="l00994"></a>00994    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00995"></a>00995 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<a class="anchor" name="459f780ad78b2d33e5f434af1f89a24e"></a><!-- doxytag: member="df.c::df_write_sector_from_ram" ref="459f780ad78b2d33e5f434af1f89a24e" args="(U8 *ram)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#253b248072cfc8bd812c69acd0046eed">Bool</a> df_write_sector_from_ram           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> *&nbsp;</td>
          <td class="paramname"> <em>ram</em>          </td>
          <td>&nbsp;)&nbsp;</td>
          <td width="100%"></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
This function write one DF sector from a ram buffer. 
<p>
NOTE:<ul>
<li>First call must be preceded by a call to the <a class="el" href="a00034.html#ff167c7f03438afd57e148a2d12ade41" title="This function opens a DF memory in write mode at a given sector address.">df_write_open()</a> function,</li></ul>
<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>*ram</em>&nbsp;</td><td>pointer to ram buffer</td></tr>
  </table>
</dl>
<dl class="return" compact><dt><b>Returns:</b></dt><dd>The read succeeded -&gt; OK </dd></dl>

<p>Definition at line <a class="el" href="a00110.html#l01007">1007</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00112.html#l00464">df_ram_2_df()</a>.</p>
<div class="fragment"><pre class="fragment"><a name="l01008"></a>01008 {
<a name="l01009"></a>01009    <a class="code" href="a00026.html#df928e51a60dba0df29d615401cc55a8">U16</a> i;
<a name="l01010"></a>01010    <span class="keywordflow">for</span>(i=0;i&lt;512;i++)
<a name="l01011"></a>01011    {
<a name="l01012"></a>01012       <a class="code" href="a00049.html#1e74868dc962de8b9225aec1130d56b1">Spi_write_data</a>(*ram);
<a name="l01013"></a>01013       ram++;
<a name="l01014"></a>01014    }
<a name="l01015"></a>01015    <a class="code" href="a00049.html#2025d12bd5cc200f050b6c6468a238dd">Spi_ack_write</a>();        <span class="comment">// Final step to clear the SPIF bit.</span>
<a name="l01016"></a>01016    <a class="code" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a> += 512;      <span class="comment">// Update the memory pointer.</span>
<a name="l01017"></a>01017    <span class="keywordflow">return</span> <a class="code" href="a00026.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l01018"></a>01018 }
</pre></div>
<p>

<p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dynsection">
</div>

</div>
</div><p>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a73e3f4f0baa520941bc1145cfd9b034"></a><!-- doxytag: member="df.c::gl_ptr_mem" ref="a73e3f4f0baa520941bc1145cfd9b034" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#811024d35b9b8a41095b1f583b649e56">U32</a> <a class="el" href="a00034.html#a73e3f4f0baa520941bc1145cfd9b034">gl_ptr_mem</a><code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00110.html#l00054">54</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00864">df_host_read_sector()</a>, <a class="el" href="a00110.html#l00720">df_host_write_sector()</a>, <a class="el" href="a00110.html#l00255">df_read_open()</a>, <a class="el" href="a00110.html#l00326">df_read_sector()</a>, <a class="el" href="a00110.html#l00984">df_read_sector_2_ram()</a>, <a class="el" href="a00110.html#l00527">df_write_close()</a>, <a class="el" href="a00110.html#l00455">df_write_open()</a>, <a class="el" href="a00110.html#l00562">df_write_sector()</a>, and <a class="el" href="a00110.html#l01007">df_write_sector_from_ram()</a>.</p>

</div>
</div><p>
<a class="anchor" name="eae6165473a95bf601eb77b386b87711"></a><!-- doxytag: member="df.c::df_mem_busy" ref="eae6165473a95bf601eb77b386b87711" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00034.html#eae6165473a95bf601eb77b386b87711">df_mem_busy</a><code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00110.html#l00055">55</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00067">df_init()</a>.</p>

</div>
</div><p>
<a class="anchor" name="22e3488be18596d4a483cdae35a9ef90"></a><!-- doxytag: member="df.c::df_select" ref="22e3488be18596d4a483cdae35a9ef90" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="a00026.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="el" href="a00034.html#22e3488be18596d4a483cdae35a9ef90">df_select</a><code> [static]</code>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

<p>Definition at line <a class="el" href="a00110.html#l00056">56</a> of file <a class="el" href="a00110.html">df.c</a>.</p>

<p>Referenced by <a class="el" href="a00110.html#l00115">df_chipselect_current()</a>, <a class="el" href="a00110.html#l00091">df_chipselect_memzone()</a>, <a class="el" href="a00110.html#l00720">df_host_write_sector()</a>, <a class="el" href="a00110.html#l00067">df_init()</a>, <a class="el" href="a00110.html#l00197">df_mem_check()</a>, <a class="el" href="a00110.html#l00255">df_read_open()</a>, <a class="el" href="a00110.html#l00527">df_write_close()</a>, <a class="el" href="a00110.html#l00455">df_write_open()</a>, and <a class="el" href="a00110.html#l00562">df_write_sector()</a>.</p>

</div>
</div><p>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 14 13:26:39 2009 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
