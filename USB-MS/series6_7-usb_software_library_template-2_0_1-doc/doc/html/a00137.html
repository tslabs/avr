<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ATMEL: usb_host_enum.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="classes.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<h1>usb_host_enum.c</h1><a href="a00052.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*This file has been prepared for Doxygen automatic documentation generation.*/</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">/* Copyright (c) 2007, Atmel Corporation All rights reserved.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00017"></a>00017 <span class="comment"> * modification, are permitted provided that the following conditions are met:</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> * 1. Redistributions of source code must retain the above copyright notice,</span>
<a name="l00020"></a>00020 <span class="comment"> * this list of conditions and the following disclaimer.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<a name="l00023"></a>00023 <span class="comment"> * this list of conditions and the following disclaimer in the documentation</span>
<a name="l00024"></a>00024 <span class="comment"> * and/or other materials provided with the distribution.</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * 3. The name of ATMEL may not be used to endorse or promote products derived</span>
<a name="l00027"></a>00027 <span class="comment"> * from this software without specific prior written permission.</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ATMEL ``AS IS'' AND ANY EXPRESS OR IMPLIED</span>
<a name="l00030"></a>00030 <span class="comment"> * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF</span>
<a name="l00031"></a>00031 <span class="comment"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE EXPRESSLY AND</span>
<a name="l00032"></a>00032 <span class="comment"> * SPECIFICALLY DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT,</span>
<a name="l00033"></a>00033 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00034"></a>00034 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;</span>
<a name="l00035"></a>00035 <span class="comment"> * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<a name="l00036"></a>00036 <span class="comment"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<a name="l00038"></a>00038 <span class="comment"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">//_____ I N C L U D E S ____________________________________________________</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="a00024.html">config.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include "<a class="code" href="a00023.html">conf_usb.h</a>"</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include "<a class="code" href="a00051.html">lib_mcu/usb/usb_drv.h</a>"</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include "<a class="code" href="a00053.html">usb_host_enum.h</a>"</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "<a class="code" href="a00063.html">modules/usb/usb_task.h</a>"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="a00055.html">usb_host_task.h</a>"</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">//_____ M A C R O S ________________________________________________________</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">//_____ D E F I N I T I O N ________________________________________________</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">//_____ P R I V A T E   D E C L A R A T I O N ______________________________</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#if (USB_HOST_FEATURE == DISABLED)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">   #warning trying to compile a file used with the USB HOST without USB_HOST_FEATURE enabled</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#ifndef SAVE_INTERRUPT_PIPE_FOR_DMS_INTERFACE</span>
<a name="l00063"></a><a class="code" href="a00052.html#a1c6cec42021c70e92ce40cfb382de24">00063</a> <span class="preprocessor"></span><span class="preprocessor">   #define SAVE_INTERRUPT_PIPE_FOR_DMS_INTERFACE   ENABLE</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>      
<a name="l00066"></a>00066 <span class="preprocessor">#if (USB_HOST_FEATURE == ENABLED)</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="a00013.html" title="Usb Setup Data.">S_usb_setup_data</a> <a class="code" href="a00052.html#631e46fdd6514f9d83c7344a7e409744" title="For control requests management over pipe 0.">usb_request</a>;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">#ifndef VID_PID_TABLE</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">   #error VID_PID_TABLE shoud be defined somewhere (conf_usb.h)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>  <span class="comment">/*   VID_PID_TABLE format definition:</span>
<a name="l00074"></a>00074 <span class="comment">  //   #define VID_PID_TABLE      {VID1, number_of_pid_for_this_VID1, PID11_value,..., PID1X_Value \</span>
<a name="l00075"></a>00075 <span class="comment">  //                              ...\</span>
<a name="l00076"></a>00076 <span class="comment">  //                              ,VIDz, number_of_pid_for_this_VIDz, PIDz1_value,..., PIDzX_Value}</span>
<a name="l00077"></a>00077 <span class="comment">  */</span>
<a name="l00078"></a>00078 <span class="preprocessor">#endif</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>
<a name="l00080"></a>00080 <span class="preprocessor">#ifndef CLASS_SUBCLASS_PROTOCOL</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">   #error CLASS_SUBCLASS_PROTOCOL shoud be defined somewhere (conf_usb.h)</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>  <span class="comment">/*   CLASS_SUBCLASS_PROTOCOL format definition:</span>
<a name="l00083"></a>00083 <span class="comment">  //   #define CLASS_SUBCLASS_PROTOCOL  {CLASS1, SUB_CLASS1,PROTOCOL1, \</span>
<a name="l00084"></a>00084 <span class="comment">  //                                     ...\</span>
<a name="l00085"></a>00085 <span class="comment">  //                                     CLASSz, SUB_CLASSz,PROTOCOLz}</span>
<a name="l00086"></a>00086 <span class="comment">  */</span>
<a name="l00087"></a>00087 <span class="preprocessor">#endif</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>
<a name="l00089"></a>00089 
<a name="l00091"></a><a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78">00091</a> <a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a> <a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78" title="Const table of known devices (see conf_usb.h for table content).">registered_VID_PID</a>[]   = <a class="code" href="a00070.html#gdd0dfe8e35e6807b62afe4421f317ba5">VID_PID_TABLE</a>;
<a name="l00092"></a>00092 
<a name="l00094"></a><a class="code" href="a00052.html#708ae96ff01f864b6e8767b01a4ccad5">00094</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  <a class="code" href="a00052.html#708ae96ff01f864b6e8767b01a4ccad5" title="Const table of known class (see conf_usb.h for table content).">registered_class</a>[]     = <a class="code" href="a00070.html#gceb9062c84217b58944ec684d54fbfcd">CLASS_SUBCLASS_PROTOCOL</a>;
<a name="l00095"></a>00095 
<a name="l00097"></a><a class="code" href="a00097.html#g376b533ecdeb345533c7ce71a4e61591">00097</a> <a class="code" href="a00014.html">S_usb_tree</a> <a class="code" href="a00097.html#g376b533ecdeb345533c7ce71a4e61591" title="The main structure that represents the usb tree connected to the host controller...">usb_tree</a>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE &amp;&amp; USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00100"></a><a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">00100</a> <span class="preprocessor"></span><a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>=0;
<a name="l00101"></a><a class="code" href="a00052.html#9ca222b60d617f668361279b1f8b6582">00101</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00052.html#9ca222b60d617f668361279b1f8b6582">user_periodic_pipe_freeze_state</a>=0;
<a name="l00102"></a><a class="code" href="a00052.html#6054ba31109a97df97ad4d645d9911d9">00102</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00052.html#6054ba31109a97df97ad4d645d9911d9">user_periodic_pipe_device_index</a>=0;
<a name="l00103"></a>00103 <span class="preprocessor">#endif</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">00107</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>=0;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">//_____ D E C L A R A T I O N ______________________________________________</span>
<a name="l00112"></a>00112 
<a name="l00123"></a><a class="code" href="a00097.html#g08394bbb55b8aad2c2a53447b8718a6e">00123</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#g08394bbb55b8aad2c2a53447b8718a6e" title="host_check_VID_PID">host_check_VID_PID</a>(<span class="keywordtype">void</span>)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  <a class="code" href="a00054.html#59be438694d50e32414315b30318c0c8">c</a>,d;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127    <span class="comment">// Rebuild VID PID from data stage</span>
<a name="l00128"></a>00128    <a class="code" href="a00021.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#b5f92008ef3c2ae8e0ef7feb2a79156a">vid</a>) = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g49178815cfd1251d2a1f2a71b1ed9671">OFFSET_FIELD_LSB_VID</a>];
<a name="l00129"></a>00129    <a class="code" href="a00021.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#b5f92008ef3c2ae8e0ef7feb2a79156a">vid</a>) = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g479f99068daae4bdb482cfdd552784d5">OFFSET_FIELD_MSB_VID</a>];
<a name="l00130"></a>00130    <a class="code" href="a00021.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#1f321181eea8be28d7733b16db5b5442">pid</a>) = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g97da720c93be1e61c6ff30b2cb155030">OFFSET_FIELD_LSB_PID</a>];
<a name="l00131"></a>00131    <a class="code" href="a00021.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#1f321181eea8be28d7733b16db5b5442">pid</a>) = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g34cf8f0f3cf9486a0abfb4de841560ba">OFFSET_FIELD_MSB_PID</a>];
<a name="l00132"></a>00132 
<a name="l00133"></a>00133    <span class="comment">// Compare detected VID PID with supported table</span>
<a name="l00134"></a>00134    c=0;
<a name="l00135"></a>00135    <span class="keywordflow">while</span> (c&lt; <span class="keyword">sizeof</span>(<a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78" title="Const table of known devices (see conf_usb.h for table content).">registered_VID_PID</a>)/2)   <span class="comment">// /2 because registered_VID_PID table is U16...</span>
<a name="l00136"></a>00136    {
<a name="l00137"></a>00137       <span class="keywordflow">if</span> (<a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78" title="Const table of known devices (see conf_usb.h for table content).">registered_VID_PID</a>[c] == <a class="code" href="a00097.html#ge5562930eb4c259f82c782821e29e852" title="Get_VID.">Get_VID</a>())   <span class="comment">// VID is correct</span>
<a name="l00138"></a>00138       {
<a name="l00139"></a>00139          d = (<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)<a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78" title="Const table of known devices (see conf_usb.h for table content).">registered_VID_PID</a>[c+1];    <span class="comment">// store nb of PID for this VID</span>
<a name="l00140"></a>00140          <span class="keywordflow">while</span> (d != 0)
<a name="l00141"></a>00141          {
<a name="l00142"></a>00142             <span class="keywordflow">if</span> (<a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78" title="Const table of known devices (see conf_usb.h for table content).">registered_VID_PID</a>[c+d+1] == <a class="code" href="a00097.html#g0d5f201dd724de2a2eca4405ba84d340" title="Get_PID.">Get_PID</a>())
<a name="l00143"></a>00143             {
<a name="l00144"></a>00144                <span class="keywordflow">return</span> <a class="code" href="a00097.html#gb554978a75f075e4567322993fbba5b2">HOST_TRUE</a>;
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146             d--;
<a name="l00147"></a>00147          }
<a name="l00148"></a>00148       }
<a name="l00149"></a>00149       c+=<a class="code" href="a00052.html#fa30f42d57061253cd04fc081c02df78" title="Const table of known devices (see conf_usb.h for table content).">registered_VID_PID</a>[c+1]+2;
<a name="l00150"></a>00150    }
<a name="l00151"></a>00151    <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00165"></a><a class="code" href="a00097.html#gaaf832167b2cadf3eefabf30ce58dffb">00165</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#gaaf832167b2cadf3eefabf30ce58dffb" title="host_check_class">host_check_class</a>(<span class="keywordtype">void</span>)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  <a class="code" href="a00054.html#59be438694d50e32414315b30318c0c8">c</a>;
<a name="l00168"></a>00168 <a class="code" href="a00053.html#15f43a7a42588cf4d8e0155fd195e4b7" title="Optimize descriptor offset index according to data_stage[] size.">T_DESC_OFFSET</a>  descriptor_offset;
<a name="l00169"></a>00169 <a class="code" href="a00053.html#15f43a7a42588cf4d8e0155fd195e4b7" title="Optimize descriptor offset index according to data_stage[] size.">T_DESC_OFFSET</a>  conf_offset_end;
<a name="l00170"></a>00170 <a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a>  config_size;
<a name="l00171"></a>00171 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  device_class;
<a name="l00172"></a>00172 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  device_subclass;
<a name="l00173"></a>00173 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  device_protocol;
<a name="l00174"></a>00174 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  nb_interface_supported;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 
<a name="l00177"></a>00177    nb_interface_supported=0;   <span class="comment">//First asumes ,no interface is supported!</span>
<a name="l00178"></a>00178    <span class="keywordflow">if</span> (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#ge7f27d63cec79b20a67a17d587656790">OFFSET_FIELD_DESCRIPTOR_TYPE</a>] != <a class="code" href="a00041.html#58d90c3f856c15b309be5464f0d0ba01">DESCRIPTOR_CONFIGURATION</a>)           <span class="comment">// check if configuration descriptor</span>
<a name="l00179"></a>00179    { <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;}
<a name="l00180"></a>00180    <a class="code" href="a00021.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(config_size) = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g156413b2fac239190d7d7b9968cbd230">OFFSET_FIELD_TOTAL_LENGHT</a>];
<a name="l00181"></a>00181    <a class="code" href="a00021.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(config_size) = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g156413b2fac239190d7d7b9968cbd230">OFFSET_FIELD_TOTAL_LENGHT</a>+1];
<a name="l00182"></a>00182    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#6e97322a2e0a51aedcf43c643a7aae7d">bmattributes</a> = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#gb286e83bbe99c8fa9ccbaed4080494e4">OFFSET_FIELD_BMATTRIBUTES</a>];
<a name="l00183"></a>00183    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#f480af470702f6fb0545a57c84e746ab">maxpower</a> = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g61d63beabdf5375d599f3fe0dc3c325c">OFFSET_FIELD_MAXPOWER</a>];
<a name="l00184"></a>00184    descriptor_offset = 0;
<a name="l00185"></a>00185    conf_offset_end = descriptor_offset + config_size;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187    <span class="comment">// Look in all interfaces declared in the configuration</span>
<a name="l00188"></a>00188    <span class="keywordflow">while</span>(descriptor_offset &lt; conf_offset_end)
<a name="l00189"></a>00189    {
<a name="l00190"></a>00190       <span class="comment">// Find next interface descriptor</span>
<a name="l00191"></a>00191       <span class="keywordflow">while</span> (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#ge7f27d63cec79b20a67a17d587656790">OFFSET_FIELD_DESCRIPTOR_TYPE</a>] != <a class="code" href="a00041.html#9861aff4822127c97440bcd226b94477">DESCRIPTOR_INTERFACE</a>)
<a name="l00192"></a>00192       {
<a name="l00193"></a>00193          descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset];
<a name="l00194"></a>00194          <span class="keywordflow">if</span>(descriptor_offset &gt;= conf_offset_end)
<a name="l00195"></a>00195          {
<a name="l00196"></a>00196             <span class="keywordflow">if</span>(nb_interface_supported)
<a name="l00197"></a>00197             {
<a name="l00198"></a>00198                <span class="keywordflow">return</span> <a class="code" href="a00097.html#gb554978a75f075e4567322993fbba5b2">HOST_TRUE</a>;
<a name="l00199"></a>00199             }
<a name="l00200"></a>00200             <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;
<a name="l00201"></a>00201          }
<a name="l00202"></a>00202       }
<a name="l00203"></a>00203       <span class="comment">// Found an interface descriptor</span>
<a name="l00204"></a>00204       <span class="comment">// Get charateristics of this interface</span>
<a name="l00205"></a>00205       device_class    = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset + <a class="code" href="a00097.html#gf4b32f002bc9f9462126a8b0f5806c8b">OFFSET_FIELD_CLASS</a>];
<a name="l00206"></a>00206       device_subclass = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset + <a class="code" href="a00097.html#g6f0e71cc5be0dca91270b7cf3f065f40">OFFSET_FIELD_SUB_CLASS</a>];
<a name="l00207"></a>00207       device_protocol = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset + <a class="code" href="a00097.html#g82a7d75dfd8ccca877b315f5d86963bb">OFFSET_FIELD_PROTOCOL</a>];
<a name="l00208"></a>00208       <span class="comment">// Look in registered class table for match</span>
<a name="l00209"></a>00209       c=0;
<a name="l00210"></a>00210       <span class="keywordflow">while</span> (c&lt; <span class="keyword">sizeof</span>(<a class="code" href="a00052.html#708ae96ff01f864b6e8767b01a4ccad5" title="Const table of known class (see conf_usb.h for table content).">registered_class</a>))
<a name="l00211"></a>00211       {
<a name="l00212"></a>00212          <span class="keywordflow">if</span> (<a class="code" href="a00052.html#708ae96ff01f864b6e8767b01a4ccad5" title="Const table of known class (see conf_usb.h for table content).">registered_class</a>[c] == device_class)                 <span class="comment">// class is correct!</span>
<a name="l00213"></a>00213          {
<a name="l00214"></a>00214             <span class="keywordflow">if</span> (<a class="code" href="a00052.html#708ae96ff01f864b6e8767b01a4ccad5" title="Const table of known class (see conf_usb.h for table content).">registered_class</a>[c+1] == device_subclass)         <span class="comment">// sub class is correct!</span>
<a name="l00215"></a>00215             {
<a name="l00216"></a>00216                <span class="keywordflow">if</span> (<a class="code" href="a00052.html#708ae96ff01f864b6e8767b01a4ccad5" title="Const table of known class (see conf_usb.h for table content).">registered_class</a>[c+2] == device_protocol)      <span class="comment">// protocol is correct!</span>
<a name="l00217"></a>00217                {
<a name="l00218"></a>00218                   <span class="comment">// Prepare for another item CLASS/SUB_CLASS/PROTOCOL in table</span>
<a name="l00219"></a>00219                   c+=3;
<a name="l00220"></a>00220                   <span class="comment">// Store this interface as supported interface</span>
<a name="l00221"></a>00221                   <span class="comment">// Memorize its interface nb</span>
<a name="l00222"></a>00222                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[nb_interface_supported].<a class="code" href="a00007.html#d560cf0a694d32b46e8c4875f9f8dc5e">interface_nb</a>=<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gad194a2c122879dc9ad70f30d3ccae75">OFFSET_FIELD_INTERFACE_NB</a>];
<a name="l00223"></a>00223                   <span class="comment">//          its alternate setting</span>
<a name="l00224"></a>00224                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[nb_interface_supported].<a class="code" href="a00007.html#db860225fe053d199780a43d12e692fe">altset_nb</a>=<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g2240a2b7dde3ef59dcd963675adb55c3">OFFSET_FIELD_ALT</a>];
<a name="l00225"></a>00225                   <span class="comment">//          its USB class</span>
<a name="l00226"></a>00226                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[nb_interface_supported].<a class="code" href="a00007.html#c563065dd6e5c4526111a9a848fd3e2b">class</a>=device_class;
<a name="l00227"></a>00227                   <span class="comment">//          its USB subclass</span>
<a name="l00228"></a>00228                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[nb_interface_supported].<a class="code" href="a00007.html#c9edc644859ea2faf9925046182a2921">subclass</a>=device_subclass;
<a name="l00229"></a>00229                   <span class="comment">//          its USB protocol</span>
<a name="l00230"></a>00230                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[nb_interface_supported].<a class="code" href="a00007.html#b5475b8d38ee9a10b9283dba5144e6fe">protocol</a>=device_protocol;
<a name="l00231"></a>00231                   <span class="comment">//          the number of endpoints associated to this interface</span>
<a name="l00232"></a>00232                   <span class="comment">//          Note: The associated endpoints addresses are stored during pipe attribution...</span>
<a name="l00233"></a>00233                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[nb_interface_supported].<a class="code" href="a00007.html#4a3033c978c5cc847b209d05e71d94d7">nb_ep</a>=<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g5345fd6ed3fef5cc80c8c0a8a4d051c5">OFFSET_FIELS_NB_OF_EP</a>];
<a name="l00234"></a>00234                   <span class="comment">// Update the number of interface supported</span>
<a name="l00235"></a>00235                   nb_interface_supported++;
<a name="l00236"></a>00236                   <span class="comment">// Update the number of interface supported for the device</span>
<a name="l00237"></a>00237                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#d8af5613594354d9bbf1b862527f3194">nb_interface</a>++;
<a name="l00238"></a>00238                   <span class="comment">// Check the maximum number of interfaces we can support</span>
<a name="l00239"></a>00239                   <span class="keywordflow">if</span>(nb_interface_supported&gt;=<a class="code" href="a00070.html#gf555ac95cfc24daa44af760d0404518e" title="The maximum number of interface supported per device.">MAX_INTERFACE_FOR_DEVICE</a>)
<a name="l00240"></a>00240                   {
<a name="l00241"></a>00241                      <span class="keywordflow">return</span> <a class="code" href="a00097.html#gb554978a75f075e4567322993fbba5b2">HOST_TRUE</a>;
<a name="l00242"></a>00242                   }
<a name="l00243"></a>00243                }
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245          }
<a name="l00246"></a>00246          c+=3; <span class="comment">// Check other item CLASS/SUB_CLASS/PROTOCOL in table</span>
<a name="l00247"></a>00247       }
<a name="l00248"></a>00248       descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset]; <span class="comment">// Next descriptor</span>
<a name="l00249"></a>00249       <span class="keywordflow">if</span>(descriptor_offset &gt; <a class="code" href="a00070.html#g5b9eae1b7be09014673af472171c17d4" title="The size of RAM buffer reserved of descriptors manipulation.">SIZEOF_DATA_STAGE</a>)           <span class="comment">// Check overflow</span>
<a name="l00250"></a>00250       {
<a name="l00251"></a>00251          <span class="keywordflow">if</span>(nb_interface_supported)
<a name="l00252"></a>00252          {
<a name="l00253"></a>00253             <span class="keywordflow">return</span> <a class="code" href="a00097.html#gb554978a75f075e4567322993fbba5b2">HOST_TRUE</a>;
<a name="l00254"></a>00254          }
<a name="l00255"></a>00255          <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;
<a name="l00256"></a>00256       }
<a name="l00257"></a>00257    }
<a name="l00258"></a>00258    <span class="keywordflow">if</span>(nb_interface_supported)
<a name="l00259"></a>00259    { 
<a name="l00260"></a>00260       <span class="keywordflow">return</span> <a class="code" href="a00097.html#gb554978a75f075e4567322993fbba5b2">HOST_TRUE</a>; 
<a name="l00261"></a>00261    }
<a name="l00262"></a>00262    <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00272"></a><a class="code" href="a00097.html#gef82869f4fd052f7ca4b566937863070">00272</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#gef82869f4fd052f7ca4b566937863070">host_auto_configure_endpoint</a>()
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  nb_endpoint_to_configure;
<a name="l00275"></a>00275 <a class="code" href="a00053.html#15f43a7a42588cf4d8e0155fd195e4b7" title="Optimize descriptor offset index according to data_stage[] size.">T_DESC_OFFSET</a>  descriptor_offset;
<a name="l00276"></a>00276 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>  physical_pipe=1;   <span class="comment">// =1 cause lookup table assumes that physical pipe 0 is reserved for control</span>
<a name="l00277"></a>00277 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00054.html#a31f47cc4db2a583d432407361bc4bfb">i</a>;
<a name="l00278"></a>00278 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> ep_index;
<a name="l00279"></a>00279 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> device,interface,alt_interface;
<a name="l00280"></a>00280 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_interface;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282    <span class="comment">// Get the last device number to configure</span>
<a name="l00283"></a>00283    device = usb_tree.<a class="code" href="a00014.html#56188ed5b1d93dd3744d3302d803d82b">nb_device</a>-1;
<a name="l00284"></a>00284    
<a name="l00285"></a>00285    <span class="comment">// Get the nulber of interface to configure for the last device connected</span>
<a name="l00286"></a>00286    nb_interface = usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#d8af5613594354d9bbf1b862527f3194">nb_interface</a>;
<a name="l00287"></a>00287    
<a name="l00288"></a>00288    <span class="comment">// Look for first physical pipe free</span>
<a name="l00289"></a>00289    <span class="comment">// TODO improve allocation mechanism...</span>
<a name="l00290"></a>00290    i = <a class="code" href="a00094.html#ga602f18f3102551a390cab51280ca702" title="get the currently selected pipe number">Host_get_selected_pipe</a>();    <span class="comment">// Save current selected pipe</span>
<a name="l00291"></a>00291    <span class="keywordflow">for</span>(physical_pipe=1;physical_pipe&lt;<a class="code" href="a00087.html#gf2735f56ebd716202bc74c3e903f2807">MAX_EP_NB</a>-1;physical_pipe++)
<a name="l00292"></a>00292    {
<a name="l00293"></a>00293       <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(physical_pipe);
<a name="l00294"></a>00294       <span class="keywordflow">if</span>(<a class="code" href="a00093.html#g0cbe3f5e5966239697fdeb6043cc815d" title="Check if pipe memory is allocated.">Is_host_pipe_memory_allocated</a>()==<a class="code" href="a00021.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>) <span class="keywordflow">break</span>; <span class="comment">// Pipe already allocated try next one</span>
<a name="l00295"></a>00295    }
<a name="l00296"></a>00296    <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(i); <span class="comment">//Restore previous selected pipe</span>
<a name="l00297"></a>00297 
<a name="l00298"></a>00298    <span class="comment">// For all interfaces to configure...</span>
<a name="l00299"></a>00299    <span class="keywordflow">for</span>(i=0;i&lt;nb_interface;i++)
<a name="l00300"></a>00300    {
<a name="l00301"></a>00301       ep_index=0;
<a name="l00302"></a>00302       <span class="comment">// Look for the target interface descriptor offset</span>
<a name="l00303"></a>00303       interface = usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#d560cf0a694d32b46e8c4875f9f8dc5e">interface_nb</a>;
<a name="l00304"></a>00304       alt_interface = usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#db860225fe053d199780a43d12e692fe">altset_nb</a>;
<a name="l00305"></a>00305       descriptor_offset = <a class="code" href="a00097.html#g0d78118ad09c5d6679553d8b8b1bd84c" title="get_interface_descriptor_offset">get_interface_descriptor_offset</a>(interface,alt_interface);
<a name="l00306"></a>00306       <span class="comment">// Get the number of endpoint to configure for this interface</span>
<a name="l00307"></a>00307       nb_endpoint_to_configure = usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#4a3033c978c5cc847b209d05e71d94d7">nb_ep</a>;
<a name="l00308"></a>00308       <span class="comment">// Get the first Endpoint descriptor offset to configure</span>
<a name="l00309"></a>00309       descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g621c329f5149447fbdb3b0680c6ccd10">OFFSET_DESCRIPTOR_LENGHT</a>];  <span class="comment">// pointing on endpoint descriptor</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311       <span class="comment">// While there is at least one pipe to configure</span>
<a name="l00312"></a>00312       <span class="keywordflow">while</span> (nb_endpoint_to_configure)
<a name="l00313"></a>00313       {
<a name="l00314"></a>00314          <span class="comment">// Check and look for an Endpoint descriptor</span>
<a name="l00315"></a>00315          <span class="keywordflow">while</span> (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#ge7f27d63cec79b20a67a17d587656790">OFFSET_FIELD_DESCRIPTOR_TYPE</a>] != <a class="code" href="a00041.html#2bf44081031a2eaf2c5d23d1f3a73642">DESCRIPTOR_ENDPOINT</a>)
<a name="l00316"></a>00316          {
<a name="l00317"></a>00317             descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset];
<a name="l00318"></a>00318             <span class="keywordflow">if</span>(descriptor_offset &gt; <a class="code" href="a00070.html#g5b9eae1b7be09014673af472171c17d4" title="The size of RAM buffer reserved of descriptors manipulation.">SIZEOF_DATA_STAGE</a>)   <span class="comment">// No more endpoint descriptor found -&gt; Errror !</span>
<a name="l00319"></a>00319             {  <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>; }
<a name="l00320"></a>00320          }
<a name="l00321"></a>00321 <span class="preprocessor">#if (SAVE_INTERRUPT_PIPE_FOR_DMS_INTERFACE==ENABLE)</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span>         <span class="comment">// @TODO HUB support &amp; INTERRUPT PIPE No validated</span>
<a name="l00323"></a>00323          <span class="keywordflow">if</span>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>]==<a class="code" href="a00087.html#gb34d6f23ac074575b13729f4f0a418ae">TYPE_INTERRUPT</a> &amp;&amp; usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#c563065dd6e5c4526111a9a848fd3e2b">class</a>==0x08)
<a name="l00324"></a>00324          {
<a name="l00325"></a>00325             nb_endpoint_to_configure--;
<a name="l00326"></a>00326             usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#4a3033c978c5cc847b209d05e71d94d7">nb_ep</a>--;
<a name="l00327"></a>00327             <span class="keywordflow">continue</span>;
<a name="l00328"></a>00328          }
<a name="l00329"></a>00329 <span class="preprocessor">#endif         </span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>
<a name="l00331"></a>00331          <span class="comment">// Select the new physical pipe to configure and get ride of any previous configuration for this physical pipe</span>
<a name="l00332"></a>00332          <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(physical_pipe);
<a name="l00333"></a>00333          <a class="code" href="a00094.html#g24dc68cd6a9baed2f17e40b036be0824" title="disables pipe">Host_disable_pipe</a>();
<a name="l00334"></a>00334          <a class="code" href="a00093.html#g5df72c8139aadcda4d86261bf62696cf" title="un-allocates the current configuration in DPRAM memory">Host_unallocate_memory</a>();
<a name="l00335"></a>00335          <a class="code" href="a00094.html#g26ae9e6e50f7de7462df1abe3201e614" title="enables pipe">Host_enable_pipe</a>();
<a name="l00336"></a>00336 
<a name="l00337"></a>00337          <span class="comment">// Build the pipe configuration according to the endpoint descriptors fields received</span>
<a name="l00338"></a>00338          <span class="comment">//</span>
<a name="l00339"></a>00339          <span class="comment">// host_configure_pipe(</span>
<a name="l00340"></a>00340          <span class="comment">//    physical_pipe,                                                                    // pipe nb in USB interface</span>
<a name="l00341"></a>00341          <span class="comment">//    data_stage[descriptor_offset+OFFSET_FIELD_EP_TYPE],                               // pipe type (interrupt/BULK/ISO)</span>
<a name="l00342"></a>00342          <span class="comment">//    Get_pipe_token(data_stage[descriptor_offset+OFFSET_FIELD_EP_ADDR]),               // pipe addr</span>
<a name="l00343"></a>00343          <span class="comment">//    (data_stage[descriptor_offset+2] &amp; MSK_EP_DIR),                                   // pipe dir (IN/OUT)</span>
<a name="l00344"></a>00344          <span class="comment">//    host_determine_pipe_size((U16)data_stage[descriptor_offset+OFFSET_FIELD_EP_SIZE]),// pipe size</span>
<a name="l00345"></a>00345          <span class="comment">//    ONE_BANK,                                                                         // bumber of bank to allocate for pipe</span>
<a name="l00346"></a>00346          <span class="comment">//    data_stage[descriptor_offset+OFFSET_FIELD_EP_INTERVAL]                            // interrupt period (for interrupt pipe)</span>
<a name="l00347"></a>00347          <span class="comment">//  );</span>
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE)</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>         <span class="comment">// For USB hub move from interupt type to bulk type</span>
<a name="l00351"></a>00351          <span class="keywordflow">if</span>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>]==<a class="code" href="a00087.html#gb34d6f23ac074575b13729f4f0a418ae">TYPE_INTERRUPT</a> &amp;&amp; usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#c563065dd6e5c4526111a9a848fd3e2b">class</a>==0x09)
<a name="l00352"></a>00352          {
<a name="l00353"></a>00353                <a class="code" href="a00088.html#g69b1035875dea2558c650b221a6dbba7">host_configure_pipe</a>(physical_pipe, \
<a name="l00354"></a>00354                              <a class="code" href="a00087.html#gecf9984e4a03af2ce8b0a2367641cdb7">TYPE_BULK</a>, \
<a name="l00355"></a>00355                              <a class="code" href="a00087.html#g85c411b087c1466b130f5cce33bd4103">TOKEN_IN</a>,  \
<a name="l00356"></a>00356                              1,   \
<a name="l00357"></a>00357                              <a class="code" href="a00087.html#gffc575030c953e6ae116a07013b969dd">SIZE_8</a>,      \
<a name="l00358"></a>00358                              <a class="code" href="a00087.html#gdec7a5c1b9ed61af0268113a110bbf1f">ONE_BANK</a>,     \
<a name="l00359"></a>00359                              0             );  
<a name="l00360"></a>00360          }
<a name="l00361"></a>00361          <span class="keywordflow">else</span> <span class="comment">// The device connected is not a hub</span>
<a name="l00362"></a>00362          {
<a name="l00363"></a>00363             <span class="keywordflow">if</span>( nb_hub_present==0) <span class="comment">// No hub already exist in the USB tree</span>
<a name="l00364"></a>00364             {
<a name="l00365"></a>00365                <a class="code" href="a00088.html#g69b1035875dea2558c650b221a6dbba7">host_configure_pipe</a>(                                                          \
<a name="l00366"></a>00366                   physical_pipe,                                                             \
<a name="l00367"></a>00367                   <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>],                        \
<a name="l00368"></a>00368                   <a class="code" href="a00094.html#g91d8e39915c6983deaa976ff6b87d3c0">Get_pipe_token</a>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>]),        \
<a name="l00369"></a>00369                   (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>] &amp; <a class="code" href="a00087.html#g6b33e652b50d91dc0025fffe8c090a45">MSK_EP_DIR</a>),                            \
<a name="l00370"></a>00370                   <a class="code" href="a00050.html#5610958a0b4b34f2eafffba0fac8f960" title="host_determine_pipe_size.">host_determine_pipe_size</a>((<a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g6f301b2189b3f8221d09b3804b83dd17">OFFSET_FIELD_EP_SIZE</a>]),\
<a name="l00371"></a>00371                   <a class="code" href="a00087.html#gb8fdf29cd733b5873fcb8e68b7795913">TWO_BANKS</a>,                                                                  \
<a name="l00372"></a>00372                   <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g3ef3b57aba9185690d2256bf915a29b4">OFFSET_FIELD_EP_INTERVAL</a>]                     \
<a name="l00373"></a>00373                );
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375             <span class="keywordflow">else</span> <span class="comment">// At least one hub is present in the usb tree</span>
<a name="l00376"></a>00376             {
<a name="l00377"></a>00377                <span class="keywordflow">if</span>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>]==<a class="code" href="a00087.html#gecf9984e4a03af2ce8b0a2367641cdb7">TYPE_BULK</a> ) <span class="comment">// If BULK type : OK</span>
<a name="l00378"></a>00378                {
<a name="l00379"></a>00379                      <a class="code" href="a00088.html#g69b1035875dea2558c650b221a6dbba7">host_configure_pipe</a>(                                                          \
<a name="l00380"></a>00380                      physical_pipe,                                                             \
<a name="l00381"></a>00381                      <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>],                        \
<a name="l00382"></a>00382                      <a class="code" href="a00094.html#g91d8e39915c6983deaa976ff6b87d3c0">Get_pipe_token</a>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>]),        \
<a name="l00383"></a>00383                      (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>] &amp; <a class="code" href="a00087.html#g6b33e652b50d91dc0025fffe8c090a45">MSK_EP_DIR</a>),                            \
<a name="l00384"></a>00384                      <a class="code" href="a00050.html#5610958a0b4b34f2eafffba0fac8f960" title="host_determine_pipe_size.">host_determine_pipe_size</a>((<a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g6f301b2189b3f8221d09b3804b83dd17">OFFSET_FIELD_EP_SIZE</a>]),\
<a name="l00385"></a>00385                      <a class="code" href="a00087.html#gb8fdf29cd733b5873fcb8e68b7795913">TWO_BANKS</a>,                                                                  \
<a name="l00386"></a>00386                      <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g3ef3b57aba9185690d2256bf915a29b4">OFFSET_FIELD_EP_INTERVAL</a>]                     \
<a name="l00387"></a>00387                   ); 
<a name="l00388"></a>00388                }
<a name="l00389"></a>00389 <span class="preprocessor">               #if (USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>               <span class="keywordflow">else</span>
<a name="l00391"></a>00391                <span class="keywordflow">if</span>(<a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>==0 )                  
<a name="l00392"></a>00392                {
<a name="l00393"></a>00393                   <a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>=physical_pipe;
<a name="l00394"></a>00394                   <a class="code" href="a00052.html#6054ba31109a97df97ad4d645d9911d9">user_periodic_pipe_device_index</a>=device;
<a name="l00395"></a>00395                   <a class="code" href="a00088.html#g69b1035875dea2558c650b221a6dbba7">host_configure_pipe</a>(                                                          \
<a name="l00396"></a>00396                      physical_pipe,                                                             \
<a name="l00397"></a>00397                      <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>],                        \
<a name="l00398"></a>00398                      <a class="code" href="a00094.html#g91d8e39915c6983deaa976ff6b87d3c0">Get_pipe_token</a>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>]),        \
<a name="l00399"></a>00399                      (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>] &amp; <a class="code" href="a00087.html#g6b33e652b50d91dc0025fffe8c090a45">MSK_EP_DIR</a>),                            \
<a name="l00400"></a>00400                      <a class="code" href="a00050.html#5610958a0b4b34f2eafffba0fac8f960" title="host_determine_pipe_size.">host_determine_pipe_size</a>((<a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g6f301b2189b3f8221d09b3804b83dd17">OFFSET_FIELD_EP_SIZE</a>]),\
<a name="l00401"></a>00401                      <a class="code" href="a00087.html#gdec7a5c1b9ed61af0268113a110bbf1f">ONE_BANK</a>,                                                                  \
<a name="l00402"></a>00402                      <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g3ef3b57aba9185690d2256bf915a29b4">OFFSET_FIELD_EP_INTERVAL</a>]                     \
<a name="l00403"></a>00403                   );                  
<a name="l00404"></a>00404                }
<a name="l00405"></a>00405                <span class="keywordflow">else</span>
<a name="l00406"></a>00406                {
<a name="l00407"></a>00407                   nb_endpoint_to_configure--;
<a name="l00408"></a>00408                   usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#4a3033c978c5cc847b209d05e71d94d7">nb_ep</a>--;
<a name="l00409"></a>00409                   <span class="keywordflow">continue</span>;                  
<a name="l00410"></a>00410                }
<a name="l00411"></a>00411 <span class="preprocessor">               #endif</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>            }
<a name="l00413"></a>00413          }
<a name="l00414"></a>00414 <span class="preprocessor">#else // NO HUB SUPPORT</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>         <a class="code" href="a00088.html#g69b1035875dea2558c650b221a6dbba7">host_configure_pipe</a>(                                                          \
<a name="l00416"></a>00416             physical_pipe,                                                             \
<a name="l00417"></a>00417             <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>],                        \
<a name="l00418"></a>00418             <a class="code" href="a00094.html#g91d8e39915c6983deaa976ff6b87d3c0">Get_pipe_token</a>(<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>]),        \
<a name="l00419"></a>00419             (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>] &amp; <a class="code" href="a00087.html#g6b33e652b50d91dc0025fffe8c090a45">MSK_EP_DIR</a>),                            \
<a name="l00420"></a>00420             <a class="code" href="a00050.html#5610958a0b4b34f2eafffba0fac8f960" title="host_determine_pipe_size.">host_determine_pipe_size</a>((<a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a>)<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g6f301b2189b3f8221d09b3804b83dd17">OFFSET_FIELD_EP_SIZE</a>]),\
<a name="l00421"></a>00421             <a class="code" href="a00087.html#gb8fdf29cd733b5873fcb8e68b7795913">TWO_BANKS</a>,                                                                 \
<a name="l00422"></a>00422             <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g3ef3b57aba9185690d2256bf915a29b4">OFFSET_FIELD_EP_INTERVAL</a>]                     \
<a name="l00423"></a>00423          );
<a name="l00424"></a>00424 <span class="preprocessor">#endif          </span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>         
<a name="l00426"></a>00426          <span class="comment">// Update endpoint addr table in supported interface structure</span>
<a name="l00427"></a>00427          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[ep_index].<a class="code" href="a00005.html#a5cec91959f52766f2320388b71943c7">ep_addr</a> = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gb9aa68e98df84c1fd246179e6dc406fe">OFFSET_FIELD_EP_ADDR</a>];
<a name="l00428"></a>00428          <span class="comment">// Update physical pipe number used for this endpoint</span>
<a name="l00429"></a>00429          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[ep_index].<a class="code" href="a00005.html#f0cf12c2414a047379504283412d4889">pipe_number</a> = physical_pipe;
<a name="l00430"></a>00430          <span class="comment">// Update endpoint size in supported interface structure</span>
<a name="l00431"></a>00431          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[ep_index].<a class="code" href="a00005.html#b0ae7a1e387a68da2e516097d25de814">ep_size</a> = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g6f301b2189b3f8221d09b3804b83dd17">OFFSET_FIELD_EP_SIZE</a>];
<a name="l00432"></a>00432          <span class="comment">// Update endpoint type in supported interface structure</span>
<a name="l00433"></a>00433          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[i].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[ep_index].<a class="code" href="a00005.html#185452761f4aad66f709f6e7b51a1d24">ep_type</a> = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g12a92c851693a9a37b68133d4b3ddbdc">OFFSET_FIELD_EP_TYPE</a>];
<a name="l00434"></a>00434          <span class="comment">// point on next descriptor</span>
<a name="l00435"></a>00435          descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset];        
<a name="l00436"></a>00436          <span class="comment">// Use next physical pipe</span>
<a name="l00437"></a>00437          <span class="keywordflow">if</span> (physical_pipe++&gt;=MAX_EP_NB)
<a name="l00438"></a>00438          {
<a name="l00439"></a>00439              <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;
<a name="l00440"></a>00440          }
<a name="l00441"></a>00441          <span class="comment">// To configure next endpoint </span>
<a name="l00442"></a>00442          ep_index++;
<a name="l00443"></a>00443          <span class="comment">// All target endpoints configured ?</span>
<a name="l00444"></a>00444          nb_endpoint_to_configure--;
<a name="l00445"></a>00445       } <span class="comment">//for(i=0;i&lt;nb_interface;i++)</span>
<a name="l00446"></a>00446    }
<a name="l00447"></a>00447    <a class="code" href="a00099.html#gff66183f6aebf783b0e8a5251419be22">Host_set_configured</a>();
<a name="l00448"></a>00448    <span class="keywordflow">return</span> <a class="code" href="a00097.html#gb554978a75f075e4567322993fbba5b2">HOST_TRUE</a>;
<a name="l00449"></a>00449 }
<a name="l00450"></a>00450 
<a name="l00462"></a><a class="code" href="a00097.html#g0d78118ad09c5d6679553d8b8b1bd84c">00462</a> <a class="code" href="a00053.html#15f43a7a42588cf4d8e0155fd195e4b7" title="Optimize descriptor offset index according to data_stage[] size.">T_DESC_OFFSET</a> <a class="code" href="a00097.html#g0d78118ad09c5d6679553d8b8b1bd84c" title="get_interface_descriptor_offset">get_interface_descriptor_offset</a>(<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> interface, <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> alt)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464    <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> nb_interface;
<a name="l00465"></a>00465    <a class="code" href="a00053.html#15f43a7a42588cf4d8e0155fd195e4b7" title="Optimize descriptor offset index according to data_stage[] size.">T_DESC_OFFSET</a> descriptor_offset;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    nb_interface = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#gdabc897d74efeed7b91bfeb339e3d860" title="OFFSET for INTERFACE DESCRIPTORS.">OFFSET_FIELD_NB_INTERFACE</a>];      <span class="comment">// Detects the number of interfaces in this configuration</span>
<a name="l00468"></a>00468    descriptor_offset = <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[<a class="code" href="a00097.html#g621c329f5149447fbdb3b0680c6ccd10">OFFSET_DESCRIPTOR_LENGHT</a>];  <span class="comment">// now pointing on next descriptor</span>
<a name="l00469"></a>00469 
<a name="l00470"></a>00470    <span class="keywordflow">while</span>(descriptor_offset &lt; <a class="code" href="a00070.html#g5b9eae1b7be09014673af472171c17d4" title="The size of RAM buffer reserved of descriptors manipulation.">SIZEOF_DATA_STAGE</a>)            <span class="comment">// Look in all interfaces declared in the configuration</span>
<a name="l00471"></a>00471    {
<a name="l00472"></a>00472       <span class="keywordflow">while</span> (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#ge7f27d63cec79b20a67a17d587656790">OFFSET_FIELD_DESCRIPTOR_TYPE</a>] != <a class="code" href="a00041.html#9861aff4822127c97440bcd226b94477">DESCRIPTOR_INTERFACE</a>)
<a name="l00473"></a>00473       {
<a name="l00474"></a>00474          descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset];
<a name="l00475"></a>00475          <span class="keywordflow">if</span>(descriptor_offset &gt; <a class="code" href="a00070.html#g5b9eae1b7be09014673af472171c17d4" title="The size of RAM buffer reserved of descriptors manipulation.">SIZEOF_DATA_STAGE</a>)
<a name="l00476"></a>00476          {  <span class="keywordflow">return</span> <a class="code" href="a00097.html#g2fef2e8ffbca0a854266e52acc014123">HOST_FALSE</a>;  }
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478       <span class="keywordflow">if</span> (<a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#gad194a2c122879dc9ad70f30d3ccae75">OFFSET_FIELD_INTERFACE_NB</a>]==interface
<a name="l00479"></a>00479           &amp;&amp; <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset+<a class="code" href="a00097.html#g2240a2b7dde3ef59dcd963675adb55c3">OFFSET_FIELD_ALT</a>]==alt)
<a name="l00480"></a>00480       {
<a name="l00481"></a>00481         <span class="keywordflow">return</span>  descriptor_offset;
<a name="l00482"></a>00482       }
<a name="l00483"></a>00483       descriptor_offset += <a class="code" href="a00097.html#g5054e33a7748126ca115825ed53064f7" title="Public : U8 data_stage[SIZEOF_DATA_STAGE]; Internal RAM buffer for USB data stage...">data_stage</a>[descriptor_offset];
<a name="l00484"></a>00484    }
<a name="l00485"></a>00485    <span class="keywordflow">return</span> descriptor_offset;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00498"></a><a class="code" href="a00097.html#gd6950048d37767ee5e63c8c13875a1a5">00498</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#gd6950048d37767ee5e63c8c13875a1a5">host_get_hwd_pipe_nb</a>(<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> ep_addr)
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500    <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00054.html#a31f47cc4db2a583d432407361bc4bfb">i</a>,<a class="code" href="a00054.html#148c46b3e95d8fd60d712942e2a74888">j</a>;
<a name="l00501"></a>00501    <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="a00070.html#gf555ac95cfc24daa44af760d0404518e" title="The maximum number of interface supported per device.">MAX_INTERFACE_FOR_DEVICE</a>;j++)
<a name="l00502"></a>00502    {
<a name="l00503"></a>00503       <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="a00070.html#g13052bbddf65c51d419bac223613ccb9" title="The maximum number of endpoints per interface supported.">MAX_EP_PER_INTERFACE</a>;i++)
<a name="l00504"></a>00504       {
<a name="l00505"></a>00505          <span class="keywordflow">if</span>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[i].<a class="code" href="a00005.html#a5cec91959f52766f2320388b71943c7">ep_addr</a>==ep_addr)
<a name="l00506"></a>00506          { <span class="keywordflow">return</span> usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[i].<a class="code" href="a00005.html#f0cf12c2414a047379504283412d4889">pipe_number</a>; }
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508    }
<a name="l00509"></a>00509    <span class="keywordflow">return</span> 0;
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00528"></a><a class="code" href="a00097.html#g9ff536ca0eadd3afd14ec4c0510ad4ad">00528</a> <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00097.html#g9ff536ca0eadd3afd14ec4c0510ad4ad" title="host_send_control.">host_send_control</a>(<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>* data_pointer)
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530 <a class="code" href="a00021.html#df928e51a60dba0df29d615401cc55a8">U16</a> data_length;
<a name="l00531"></a>00531 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> sav_int_sof_enable;
<a name="l00532"></a>00532 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00054.html#59be438694d50e32414315b30318c0c8">c</a>;
<a name="l00533"></a>00533 <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> ep_size_max;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE &amp;&amp; USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>   <a class="code" href="a00097.html#gc49b53eb6d4c6229a1c997c976507d6b">freeze_user_periodic_pipe</a>();
<a name="l00537"></a>00537 <span class="preprocessor">#endif </span>
<a name="l00538"></a>00538 <span class="preprocessor"></span>
<a name="l00539"></a>00539    ep_size_max = usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#3a3a0fe5dec6bc56306dd0dc960544de">ep_ctrl_size</a>;
<a name="l00540"></a>00540    <a class="code" href="a00093.html#ge8c9ae465df355c21bd114a7ef8805d9" title="configures the address to use for the device">Host_configure_address</a>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[<a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>].<a class="code" href="a00003.html#dc8182c6fd5e7935b24f88b7d8a6894c">device_address</a>);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542    <a class="code" href="a00101.html#g41da8b1e05449acf720091b1cab8cb3f">Usb_ack_event</a>(<a class="code" href="a00101.html#gcfb019547665d9f082d732c37f4054ea">EVT_HOST_SOF</a>);
<a name="l00543"></a>00543    sav_int_sof_enable=<a class="code" href="a00093.html#gd9ea64840c5a27fe482dfd16d228fa0b">Is_host_sof_interrupt_enabled</a>();
<a name="l00544"></a>00544    <a class="code" href="a00093.html#g020c241f990a53f48a0dd3bd0f75d804" title="enables host start of frame interrupt">Host_enable_sof_interrupt</a>();                   <span class="comment">// SOF software detection is in interrupt sub-routine</span>
<a name="l00545"></a>00545    <span class="keywordflow">while</span>(<a class="code" href="a00101.html#g3da7d8904c82c9c2e4e8cd9f1bdb54e0">Is_not_usb_event</a>(<a class="code" href="a00101.html#gcfb019547665d9f082d732c37f4054ea">EVT_HOST_SOF</a>))          <span class="comment">// Wait 1 sof</span>
<a name="l00546"></a>00546    {
<a name="l00547"></a>00547       <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00548"></a>00548       {
<a name="l00549"></a>00549          c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00550"></a>00550          <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00551"></a>00551          <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00552"></a>00552          <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00553"></a>00553       }
<a name="l00554"></a>00554    }
<a name="l00555"></a>00555    <span class="keywordflow">if</span> (sav_int_sof_enable==<a class="code" href="a00021.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l00556"></a>00556    {
<a name="l00557"></a>00557       <a class="code" href="a00093.html#g42cc31cb98e8ced4cc2a3fabdd8161c6" title="enables host start of frame interrupt">Host_disable_sof_interrupt</a>();
<a name="l00558"></a>00558    }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560    <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(0);
<a name="l00561"></a>00561    <a class="code" href="a00094.html#gd745fd61550509d96f2d31fef33bffb7" title="sets SETUP token">Host_set_token_setup</a>();
<a name="l00562"></a>00562    <a class="code" href="a00094.html#g0993eaeb5238abb6d27e047784668066" title="acks setup">Host_ack_setup</a>();
<a name="l00563"></a>00563    <a class="code" href="a00094.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00564"></a>00564   <span class="comment">// Build the setup request fields</span>
<a name="l00565"></a>00565    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(usb_request.<a class="code" href="a00013.html#c1c6dcd77f8f01bddb35c4d2ce69ddba" title="Characteristics of the request.">bmRequestType</a>);
<a name="l00566"></a>00566    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(usb_request.<a class="code" href="a00013.html#4d4f900a4f73036a9e5251cf9d756c5c" title="Specific request.">bRequest</a>);
<a name="l00567"></a>00567    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(<a class="code" href="a00021.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(usb_request.<a class="code" href="a00013.html#8fa176d41d8412bae98d8f646cf01315" title="field that varies according to request">wValue</a>));
<a name="l00568"></a>00568    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(<a class="code" href="a00021.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(usb_request.<a class="code" href="a00013.html#8fa176d41d8412bae98d8f646cf01315" title="field that varies according to request">wValue</a>));
<a name="l00569"></a>00569    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(<a class="code" href="a00021.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(usb_request.<a class="code" href="a00013.html#dfd80e6664d550a4bd2b07e08f3032fc" title="field that varies according to request">wIndex</a>));
<a name="l00570"></a>00570    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(<a class="code" href="a00021.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(usb_request.<a class="code" href="a00013.html#dfd80e6664d550a4bd2b07e08f3032fc" title="field that varies according to request">wIndex</a>));
<a name="l00571"></a>00571    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(<a class="code" href="a00021.html#bd2fa7b756342ae251e3a7a66670c2fe">LSB</a>(usb_request.<a class="code" href="a00013.html#67faf4f5fdd5cb4ef1c569024dca9114" title="Number of bytes to transfer if Data.">wLength</a>));
<a name="l00572"></a>00572    <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(<a class="code" href="a00021.html#bee1b74eceef5a0cf26efbf3ff87ccbf">MSB</a>(usb_request.<a class="code" href="a00013.html#67faf4f5fdd5cb4ef1c569024dca9114" title="Number of bytes to transfer if Data.">wLength</a>));
<a name="l00573"></a>00573 
<a name="l00574"></a>00574    <a class="code" href="a00094.html#g5d1987ef47cc807905c344b57d16e0a8" title="sends a setup">Host_send_setup</a>();
<a name="l00575"></a>00575    <span class="keywordflow">while</span>(<a class="code" href="a00094.html#g206fdd77ac18f0049ef9953867e9d53e" title="tests if SETUP has been sent">Is_host_setup_sent</a>() == <a class="code" href="a00021.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)  <span class="comment">// wait for SETUP ack</span>
<a name="l00576"></a>00576    {
<a name="l00577"></a>00577       <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00578"></a>00578       {
<a name="l00579"></a>00579          c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00580"></a>00580          <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00581"></a>00581          <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00582"></a>00582          <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00583"></a>00583       }
<a name="l00584"></a>00584       <span class="keywordflow">if</span>(<a class="code" href="a00094.html#gdb6efa169d9cf437138886375dffd717" title="tests if an error occurs on current pipe">Is_host_pipe_error</a>())           <span class="comment">// Any error ?</span>
<a name="l00585"></a>00585       {
<a name="l00586"></a>00586          c = <a class="code" href="a00094.html#gfe5e2c3815d0f5e6fb6fa5e9d8f5ad5d" title="tests if error occurs on pipe">Host_error_status</a>();
<a name="l00587"></a>00587          <a class="code" href="a00094.html#g38a4fe69ac54cec03dbdea3a853d9133" title="acks all pipe error">Host_ack_all_errors</a>();
<a name="l00588"></a>00588          <span class="keywordflow">goto</span> host_send_control_end;     <span class="comment">// Send error status</span>
<a name="l00589"></a>00589       }
<a name="l00590"></a>00590    }
<a name="l00591"></a>00591   <span class="comment">// Setup token sent now send In or OUT token</span>
<a name="l00592"></a>00592   <span class="comment">// Before just wait one SOF</span>
<a name="l00593"></a>00593    <a class="code" href="a00101.html#g41da8b1e05449acf720091b1cab8cb3f">Usb_ack_event</a>(<a class="code" href="a00101.html#gcfb019547665d9f082d732c37f4054ea">EVT_HOST_SOF</a>);
<a name="l00594"></a>00594    sav_int_sof_enable=<a class="code" href="a00093.html#gd9ea64840c5a27fe482dfd16d228fa0b">Is_host_sof_interrupt_enabled</a>();
<a name="l00595"></a>00595    <a class="code" href="a00093.html#g020c241f990a53f48a0dd3bd0f75d804" title="enables host start of frame interrupt">Host_enable_sof_interrupt</a>();
<a name="l00596"></a>00596    <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00597"></a>00597    data_length = usb_request.<a class="code" href="a00013.html#67faf4f5fdd5cb4ef1c569024dca9114" title="Number of bytes to transfer if Data.">wLength</a>;
<a name="l00598"></a>00598    <span class="keywordflow">while</span>(<a class="code" href="a00101.html#g3da7d8904c82c9c2e4e8cd9f1bdb54e0">Is_not_usb_event</a>(<a class="code" href="a00101.html#gcfb019547665d9f082d732c37f4054ea">EVT_HOST_SOF</a>))         <span class="comment">// Wait 1 sof</span>
<a name="l00599"></a>00599    {
<a name="l00600"></a>00600       <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00601"></a>00601       {
<a name="l00602"></a>00602          c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00603"></a>00603          <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00604"></a>00604          <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00605"></a>00605          <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00606"></a>00606       }
<a name="l00607"></a>00607    }
<a name="l00608"></a>00608    <span class="keywordflow">if</span> (sav_int_sof_enable==<a class="code" href="a00021.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>)
<a name="l00609"></a>00609    {  <a class="code" href="a00093.html#g42cc31cb98e8ced4cc2a3fabdd8161c6" title="enables host start of frame interrupt">Host_disable_sof_interrupt</a>();  }   <span class="comment">// Restore SOF interrupt enable</span>
<a name="l00610"></a>00610 
<a name="l00611"></a>00611   <span class="comment">// IN request management ---------------------------------------------</span>
<a name="l00612"></a>00612    <span class="keywordflow">if</span>(usb_request.<a class="code" href="a00013.html#c1c6dcd77f8f01bddb35c4d2ce69ddba" title="Characteristics of the request.">bmRequestType</a> &amp; <a class="code" href="a00041.html#345989d2f1a7e6a60bf560b7920eaa7d">USB_SETUP_DIR_DEVICE_TO_HOST</a>)
<a name="l00613"></a>00613    {
<a name="l00614"></a>00614       <a class="code" href="a00094.html#gfa87f52529c5b911e22e3fce68ea50e5" title="sets IN in standard mode">Host_standard_in_mode</a>();
<a name="l00615"></a>00615       <a class="code" href="a00094.html#gad2775274ed99f26309d5377e53f2b74" title="sets IN token">Host_set_token_in</a>();
<a name="l00616"></a>00616       <span class="keywordflow">while</span>(data_length != 0)
<a name="l00617"></a>00617       {
<a name="l00618"></a>00618          <a class="code" href="a00094.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00619"></a>00619          <span class="keywordflow">while</span>(!<a class="code" href="a00094.html#g364bb30f8b7c970a4901d228c99969f0" title="tests if control IN has been received">Is_host_control_in_received</a>())
<a name="l00620"></a>00620          {
<a name="l00621"></a>00621             <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00622"></a>00622             {
<a name="l00623"></a>00623                c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00624"></a>00624                <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00625"></a>00625                <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00626"></a>00626                <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00627"></a>00627             }
<a name="l00628"></a>00628             <span class="keywordflow">if</span>(<a class="code" href="a00094.html#gdb6efa169d9cf437138886375dffd717" title="tests if an error occurs on current pipe">Is_host_pipe_error</a>())
<a name="l00629"></a>00629             {
<a name="l00630"></a>00630                c = <a class="code" href="a00094.html#gfe5e2c3815d0f5e6fb6fa5e9d8f5ad5d" title="tests if error occurs on pipe">Host_error_status</a>();
<a name="l00631"></a>00631                <a class="code" href="a00094.html#g38a4fe69ac54cec03dbdea3a853d9133" title="acks all pipe error">Host_ack_all_errors</a>();
<a name="l00632"></a>00632                <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00633"></a>00633             }
<a name="l00634"></a>00634             <span class="keywordflow">if</span>(<a class="code" href="a00094.html#g66efeecc2c1b771a09b6f7f61ea8ad0f" title="tests if a STALL has been received">Is_host_stall</a>())
<a name="l00635"></a>00635             {
<a name="l00636"></a>00636                c=<a class="code" href="a00097.html#g95ad8156c0a2f5f1cbf49b793f59a432">CONTROL_STALL</a>;
<a name="l00637"></a>00637                <a class="code" href="a00094.html#ge49501c68d910043ccecfd4bc91dd642" title="acks STALL reception">Host_ack_stall</a>();
<a name="l00638"></a>00638                <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00639"></a>00639             }
<a name="l00640"></a>00640          }
<a name="l00641"></a>00641          c = <a class="code" href="a00094.html#g7932238da10d7eddc35fe61f46be0e65" title="returns number of bytes (8 bits)">Host_data_length_U8</a>();
<a name="l00642"></a>00642          <span class="keywordflow">if</span> (c == ep_size_max)
<a name="l00643"></a>00643          {
<a name="l00644"></a>00644             data_length -= c;
<a name="l00645"></a>00645             <span class="keywordflow">if</span> (usb_request.<a class="code" href="a00013.html#f884800f35ae96670f6789b90544f9b3" title="1 = only one read">uncomplete_read</a> == <a class="code" href="a00021.html#a8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)           <span class="comment">// uncomplete_read</span>
<a name="l00646"></a>00646             {
<a name="l00647"></a>00647                data_length = 0;
<a name="l00648"></a>00648             }
<a name="l00649"></a>00649          }
<a name="l00650"></a>00650          <span class="keywordflow">else</span>
<a name="l00651"></a>00651          {
<a name="l00652"></a>00652             data_length = 0;
<a name="l00653"></a>00653          }
<a name="l00654"></a>00654          <span class="keywordflow">while</span> (c!=0)
<a name="l00655"></a>00655          {
<a name="l00656"></a>00656             *data_pointer = <a class="code" href="a00094.html#gf78a38ae2b9de6980dfa4028d6370f7d" title="reads a byte from the pipe FIFO">Host_read_byte</a>();
<a name="l00657"></a>00657             data_pointer++;
<a name="l00658"></a>00658             c--;
<a name="l00659"></a>00659          }
<a name="l00660"></a>00660          <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00661"></a>00661          <a class="code" href="a00094.html#g585dbe0562014120661d756a9cd28895" title="acks control IN">Host_ack_control_in</a>();
<a name="l00662"></a>00662          <a class="code" href="a00094.html#gddc360762c84170a49a7a085d3e72cec" title="sends a control IN">Host_send_control_in</a>();
<a name="l00663"></a>00663       }                                <span class="comment">// end of IN data stage</span>
<a name="l00664"></a>00664 
<a name="l00665"></a>00665       <a class="code" href="a00094.html#g54e5d0b2c9e76a2af10280b101efdd94" title="sets OUT token">Host_set_token_out</a>();
<a name="l00666"></a>00666       <a class="code" href="a00094.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00667"></a>00667       <a class="code" href="a00094.html#g821167ebb84df0abba0567bdc76e462d" title="acks control OUT">Host_ack_control_out</a>();
<a name="l00668"></a>00668       <a class="code" href="a00094.html#g5745c396634daa0ccc4c87c16744b008" title="sends a control OUT">Host_send_control_out</a>();
<a name="l00669"></a>00669       <span class="keywordflow">while</span>(!<a class="code" href="a00094.html#g31bb6ce755ad1c642fecbd04044da1f3" title="tests if control OUT has been sent">Is_host_control_out_sent</a>())
<a name="l00670"></a>00670       {
<a name="l00671"></a>00671          <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00672"></a>00672          {
<a name="l00673"></a>00673             c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00674"></a>00674             <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00675"></a>00675             <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00676"></a>00676             <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00677"></a>00677          }
<a name="l00678"></a>00678          <span class="keywordflow">if</span>(<a class="code" href="a00094.html#gdb6efa169d9cf437138886375dffd717" title="tests if an error occurs on current pipe">Is_host_pipe_error</a>())
<a name="l00679"></a>00679          {
<a name="l00680"></a>00680             c = <a class="code" href="a00094.html#gfe5e2c3815d0f5e6fb6fa5e9d8f5ad5d" title="tests if error occurs on pipe">Host_error_status</a>();
<a name="l00681"></a>00681             <a class="code" href="a00094.html#g38a4fe69ac54cec03dbdea3a853d9133" title="acks all pipe error">Host_ack_all_errors</a>();
<a name="l00682"></a>00682             <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00683"></a>00683          }
<a name="l00684"></a>00684          <span class="keywordflow">if</span>(<a class="code" href="a00094.html#g66efeecc2c1b771a09b6f7f61ea8ad0f" title="tests if a STALL has been received">Is_host_stall</a>())
<a name="l00685"></a>00685          {
<a name="l00686"></a>00686             c=<a class="code" href="a00097.html#g95ad8156c0a2f5f1cbf49b793f59a432">CONTROL_STALL</a>;
<a name="l00687"></a>00687             <a class="code" href="a00094.html#ge49501c68d910043ccecfd4bc91dd642" title="acks STALL reception">Host_ack_stall</a>();
<a name="l00688"></a>00688             <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00689"></a>00689          }
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691       <a class="code" href="a00094.html#g821167ebb84df0abba0567bdc76e462d" title="acks control OUT">Host_ack_control_out</a>();
<a name="l00692"></a>00692       c=(<a class="code" href="a00097.html#ge10d045f2f8ce5ae0d44f58e71980b55">CONTROL_GOOD</a>);
<a name="l00693"></a>00693       <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00694"></a>00694    }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696   <span class="comment">// OUT request management ---------------------------------------------</span>
<a name="l00697"></a>00697    <span class="keywordflow">else</span>                                 <span class="comment">// Data stage OUT (bmRequestType==0)</span>
<a name="l00698"></a>00698    {
<a name="l00699"></a>00699       <a class="code" href="a00094.html#g54e5d0b2c9e76a2af10280b101efdd94" title="sets OUT token">Host_set_token_out</a>();
<a name="l00700"></a>00700       <a class="code" href="a00094.html#g821167ebb84df0abba0567bdc76e462d" title="acks control OUT">Host_ack_control_out</a>();
<a name="l00701"></a>00701       <span class="keywordflow">while</span>(data_length != 0)
<a name="l00702"></a>00702       {
<a name="l00703"></a>00703          <a class="code" href="a00094.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00704"></a>00704          c = ep_size_max;
<a name="l00705"></a>00705          <span class="keywordflow">if</span> ( ep_size_max &gt; data_length)
<a name="l00706"></a>00706          {
<a name="l00707"></a>00707             c = (<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)data_length;
<a name="l00708"></a>00708             data_length = 0;
<a name="l00709"></a>00709          }
<a name="l00710"></a>00710          <span class="keywordflow">else</span>
<a name="l00711"></a>00711          {
<a name="l00712"></a>00712             data_length -= c;
<a name="l00713"></a>00713          }
<a name="l00714"></a>00714          <span class="keywordflow">while</span> (c!=0)
<a name="l00715"></a>00715          {
<a name="l00716"></a>00716             <a class="code" href="a00094.html#g19fa8b41fa04f581cb7dea7de778cd36" title="writes a byte into the pipe FIFO">Host_write_byte</a>(*data_pointer);
<a name="l00717"></a>00717             data_pointer++;
<a name="l00718"></a>00718             c--;
<a name="l00719"></a>00719          }
<a name="l00720"></a>00720          <a class="code" href="a00094.html#g5745c396634daa0ccc4c87c16744b008" title="sends a control OUT">Host_send_control_out</a>();
<a name="l00721"></a>00721          <span class="keywordflow">while</span> (!<a class="code" href="a00094.html#g31bb6ce755ad1c642fecbd04044da1f3" title="tests if control OUT has been sent">Is_host_control_out_sent</a>())
<a name="l00722"></a>00722          {
<a name="l00723"></a>00723             <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00724"></a>00724             {
<a name="l00725"></a>00725                c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00726"></a>00726                <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00727"></a>00727                <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00728"></a>00728                <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730             <span class="keywordflow">if</span>(<a class="code" href="a00094.html#gdb6efa169d9cf437138886375dffd717" title="tests if an error occurs on current pipe">Is_host_pipe_error</a>())
<a name="l00731"></a>00731             {
<a name="l00732"></a>00732                c = <a class="code" href="a00094.html#gfe5e2c3815d0f5e6fb6fa5e9d8f5ad5d" title="tests if error occurs on pipe">Host_error_status</a>();
<a name="l00733"></a>00733                <a class="code" href="a00094.html#g38a4fe69ac54cec03dbdea3a853d9133" title="acks all pipe error">Host_ack_all_errors</a>();
<a name="l00734"></a>00734                <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00735"></a>00735             }
<a name="l00736"></a>00736             <span class="keywordflow">if</span>(<a class="code" href="a00094.html#g66efeecc2c1b771a09b6f7f61ea8ad0f" title="tests if a STALL has been received">Is_host_stall</a>())
<a name="l00737"></a>00737             {
<a name="l00738"></a>00738                c=<a class="code" href="a00097.html#g95ad8156c0a2f5f1cbf49b793f59a432">CONTROL_STALL</a>;
<a name="l00739"></a>00739                <a class="code" href="a00094.html#ge49501c68d910043ccecfd4bc91dd642" title="acks STALL reception">Host_ack_stall</a>();
<a name="l00740"></a>00740                <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00741"></a>00741             }
<a name="l00742"></a>00742          }
<a name="l00743"></a>00743          <a class="code" href="a00094.html#g821167ebb84df0abba0567bdc76e462d" title="acks control OUT">Host_ack_control_out</a>();
<a name="l00744"></a>00744       }                                <span class="comment">// end of OUT data stage</span>
<a name="l00745"></a>00745       <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00746"></a>00746       <a class="code" href="a00094.html#gad2775274ed99f26309d5377e53f2b74" title="sets IN token">Host_set_token_in</a>();
<a name="l00747"></a>00747       <a class="code" href="a00094.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00748"></a>00748       <span class="keywordflow">while</span>(!<a class="code" href="a00094.html#g364bb30f8b7c970a4901d228c99969f0" title="tests if control IN has been received">Is_host_control_in_received</a>())
<a name="l00749"></a>00749       {
<a name="l00750"></a>00750          <span class="keywordflow">if</span> (<a class="code" href="a00101.html#gde6ea4e3f8d2a6300b584585b47a3515">Is_host_emergency_exit</a>())
<a name="l00751"></a>00751          {
<a name="l00752"></a>00752             c=<a class="code" href="a00097.html#g815800552f80a2b563a52162fa2f2353">CONTROL_TIMEOUT</a>;
<a name="l00753"></a>00753             <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00754"></a>00754             <a class="code" href="a00094.html#ge1999d2c665183b2ebff21e98abf5303" title="resets the pipe">Host_reset_pipe</a>(0);
<a name="l00755"></a>00755             <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00756"></a>00756          }
<a name="l00757"></a>00757          <span class="keywordflow">if</span>(<a class="code" href="a00094.html#gdb6efa169d9cf437138886375dffd717" title="tests if an error occurs on current pipe">Is_host_pipe_error</a>())
<a name="l00758"></a>00758          {
<a name="l00759"></a>00759             c = <a class="code" href="a00094.html#gfe5e2c3815d0f5e6fb6fa5e9d8f5ad5d" title="tests if error occurs on pipe">Host_error_status</a>();
<a name="l00760"></a>00760             <a class="code" href="a00094.html#g38a4fe69ac54cec03dbdea3a853d9133" title="acks all pipe error">Host_ack_all_errors</a>();
<a name="l00761"></a>00761             <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00762"></a>00762          }
<a name="l00763"></a>00763          <span class="keywordflow">if</span>(<a class="code" href="a00094.html#g66efeecc2c1b771a09b6f7f61ea8ad0f" title="tests if a STALL has been received">Is_host_stall</a>())
<a name="l00764"></a>00764          {
<a name="l00765"></a>00765             c=<a class="code" href="a00097.html#g95ad8156c0a2f5f1cbf49b793f59a432">CONTROL_STALL</a>;
<a name="l00766"></a>00766             <a class="code" href="a00094.html#ge49501c68d910043ccecfd4bc91dd642" title="acks STALL reception">Host_ack_stall</a>();
<a name="l00767"></a>00767             <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00768"></a>00768          }
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770       <a class="code" href="a00094.html#g585dbe0562014120661d756a9cd28895" title="acks control IN">Host_ack_control_in</a>();
<a name="l00771"></a>00771       <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00772"></a>00772       <a class="code" href="a00094.html#gddc360762c84170a49a7a085d3e72cec" title="sends a control IN">Host_send_control_in</a>();
<a name="l00773"></a>00773       c=(<a class="code" href="a00097.html#ge10d045f2f8ce5ae0d44f58e71980b55">CONTROL_GOOD</a>);
<a name="l00774"></a>00774       <span class="keywordflow">goto</span> host_send_control_end;
<a name="l00775"></a>00775    }
<a name="l00776"></a>00776 host_send_control_end:
<a name="l00777"></a>00777 <span class="preprocessor">#if(USB_HUB_SUPPORT==ENABLE &amp;&amp; USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span>   <a class="code" href="a00097.html#g7ec93e06da874bd5a114a1cd779a7b7b">unfreeze_user_periodic_pipe</a>();
<a name="l00779"></a>00779 <span class="preprocessor">#endif  </span>
<a name="l00780"></a>00780 <span class="preprocessor"></span>   <span class="keywordflow">return</span> ((<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a>)c);
<a name="l00781"></a>00781 }
<a name="l00782"></a>00782 
<a name="l00790"></a><a class="code" href="a00097.html#g261b0b0b4570f744f6607864fb1bc1c9">00790</a> <span class="keywordtype">void</span> <a class="code" href="a00097.html#g261b0b0b4570f744f6607864fb1bc1c9" title="init_usb_tree">init_usb_tree</a>(<span class="keywordtype">void</span>)
<a name="l00791"></a>00791 {
<a name="l00792"></a>00792    <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00054.html#a31f47cc4db2a583d432407361bc4bfb">i</a>;
<a name="l00793"></a>00793   
<a name="l00794"></a>00794    <span class="comment">// Clear all device entry</span>
<a name="l00795"></a>00795    <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="a00070.html#g2b143cb4cce82167939b22db63471d80" title="The maximum number of devices in the USB tree.">MAX_DEVICE_IN_USB_TREE</a>;i++)
<a name="l00796"></a>00796    {
<a name="l00797"></a>00797       <a class="code" href="a00097.html#g9888d76252d97b57557cbff3fbe68c25" title="remove_device_entry">remove_device_entry</a>(i);
<a name="l00798"></a>00798    }
<a name="l00799"></a>00799    <span class="comment">// By default select device 0 (connected to root port)</span>
<a name="l00800"></a>00800    <a class="code" href="a00097.html#g3c090bb44c15efdc1c0416f9e5d66483">Host_select_device</a>(0);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE)</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span><span class="preprocessor">   #if (USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>   <a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>=0;
<a name="l00805"></a>00805    <a class="code" href="a00052.html#6054ba31109a97df97ad4d645d9911d9">user_periodic_pipe_device_index</a>=0;
<a name="l00806"></a>00806 <span class="preprocessor">   #endif</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span>   <span class="keywordflow">for</span>(i=0;i&lt;HUB_MAX_NB_PORT;i++)
<a name="l00808"></a>00808    hub_init(i);
<a name="l00809"></a>00809    <span class="keywordflow">for</span>(i=0;i&lt;USB_MAX_HUB_NUMBER;i++)   
<a name="l00810"></a>00810    hub_device_address[i]=0;
<a name="l00811"></a>00811 <span class="preprocessor">#endif</span>
<a name="l00812"></a>00812 <span class="preprocessor"></span>
<a name="l00813"></a>00813    <span class="comment">// Clear the number of device in the tree</span>
<a name="l00814"></a>00814    usb_tree.<a class="code" href="a00014.html#56188ed5b1d93dd3744d3302d803d82b">nb_device</a>=0;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00831"></a><a class="code" href="a00097.html#g9888d76252d97b57557cbff3fbe68c25">00831</a> <span class="keywordtype">void</span> <a class="code" href="a00097.html#g9888d76252d97b57557cbff3fbe68c25" title="remove_device_entry">remove_device_entry</a>(<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> device_index)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833    <a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00054.html#a31f47cc4db2a583d432407361bc4bfb">i</a>,<a class="code" href="a00054.html#148c46b3e95d8fd60d712942e2a74888">j</a>,k,m;
<a name="l00834"></a>00834    
<a name="l00835"></a>00835 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE)   </span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>   <span class="comment">// Check if the disconnected device is a hub</span>
<a name="l00837"></a>00837    <span class="keywordflow">if</span>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[0].<a class="code" href="a00007.html#c563065dd6e5c4526111a9a848fd3e2b">class</a>==<a class="code" href="a00044.html#9923dde3f3e49671f435418314e99021">HUB_CLASS</a>)
<a name="l00838"></a>00838    {
<a name="l00839"></a>00839       nb_hub_present--; 
<a name="l00840"></a>00840       <span class="keywordflow">for</span>(i=0;i&lt;USB_MAX_HUB_NUMBER;i++)      <span class="comment">// For entire hub table</span>
<a name="l00841"></a>00841       {  <span class="comment">// Find the hub number that deconnects</span>
<a name="l00842"></a>00842          <span class="keywordflow">if</span>(hub_device_address[i]==usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#dc8182c6fd5e7935b24f88b7d8a6894c">device_address</a>)
<a name="l00843"></a>00843          {  <span class="comment">// Reset its port state machine</span>
<a name="l00844"></a>00844             <span class="keywordflow">for</span>(j=0;j&lt;HUB_MAX_NB_PORT;j++)  <span class="comment">// For all ports </span>
<a name="l00845"></a>00845             {         
<a name="l00846"></a>00846                hub_port_state[i][j]=HUB_DEVICE_POWERED; 
<a name="l00847"></a>00847             }
<a name="l00848"></a>00848             <span class="comment">// Look devices previously connected to this hub and remove ther entries</span>
<a name="l00849"></a>00849             <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="a00070.html#g2b143cb4cce82167939b22db63471d80" title="The maximum number of devices in the USB tree.">MAX_DEVICE_IN_USB_TREE</a>;j++)
<a name="l00850"></a>00850             {
<a name="l00851"></a>00851                <span class="keywordflow">if</span>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[j].<a class="code" href="a00003.html#9c4d4b4c7ec1f55cb6973374a70f0eeb">parent_hub_number</a>==(i+1))
<a name="l00852"></a>00852                {
<a name="l00853"></a>00853                   usb_tree.<a class="code" href="a00014.html#56188ed5b1d93dd3744d3302d803d82b">nb_device</a>--;
<a name="l00854"></a>00854                   <span class="comment">// Caution recursive function !!!!</span>
<a name="l00855"></a>00855                   <a class="code" href="a00097.html#g9888d76252d97b57557cbff3fbe68c25" title="remove_device_entry">remove_device_entry</a>(j);                  
<a name="l00856"></a>00856                }
<a name="l00857"></a>00857             }
<a name="l00858"></a>00858             hub_device_address[i]=0;
<a name="l00859"></a>00859             <span class="keywordflow">break</span>;
<a name="l00860"></a>00860          }
<a name="l00861"></a>00861       }
<a name="l00862"></a>00862    }
<a name="l00863"></a>00863 <span class="preprocessor">#endif   </span>
<a name="l00864"></a>00864 <span class="preprocessor"></span>
<a name="l00865"></a>00865    <span class="comment">// Unallocate USB pipe memory only if the device disconnection is the last device </span>
<a name="l00866"></a>00866    <span class="comment">// enumerated</span>
<a name="l00867"></a>00867    <span class="comment">// TODO: Improve it for devices removing from hub.</span>
<a name="l00868"></a>00868    <span class="comment">// But cannot unallocate USB DPRAM if there is an active pipe number &gt; current pipe for the removed device....</span>
<a name="l00869"></a>00869    <span class="keywordflow">if</span>(usb_tree.<a class="code" href="a00014.html#56188ed5b1d93dd3744d3302d803d82b">nb_device</a>==device_index+1)
<a name="l00870"></a>00870    {
<a name="l00871"></a>00871       <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="a00070.html#gf555ac95cfc24daa44af760d0404518e" title="The maximum number of interface supported per device.">MAX_INTERFACE_FOR_DEVICE</a>;j++)
<a name="l00872"></a>00872       {
<a name="l00873"></a>00873          <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="a00070.html#g13052bbddf65c51d419bac223613ccb9" title="The maximum number of endpoints per interface supported.">MAX_EP_PER_INTERFACE</a>;k++)
<a name="l00874"></a>00874          {
<a name="l00875"></a>00875             m=usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[k].<a class="code" href="a00005.html#f0cf12c2414a047379504283412d4889">pipe_number</a>;
<a name="l00876"></a>00876             <span class="keywordflow">if</span>(m!=0)
<a name="l00877"></a>00877             {
<a name="l00878"></a>00878                i = <a class="code" href="a00094.html#ga602f18f3102551a390cab51280ca702" title="get the currently selected pipe number">Host_get_selected_pipe</a>();
<a name="l00879"></a>00879                <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(m);
<a name="l00880"></a>00880                <a class="code" href="a00093.html#g5df72c8139aadcda4d86261bf62696cf" title="un-allocates the current configuration in DPRAM memory">Host_unallocate_memory</a>();
<a name="l00881"></a>00881                <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(i);
<a name="l00882"></a>00882             }
<a name="l00883"></a>00883          }
<a name="l00884"></a>00884       }
<a name="l00885"></a>00885    }
<a name="l00886"></a>00886    <span class="comment">// Reset device entry fields ...</span>
<a name="l00887"></a>00887    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#dc8182c6fd5e7935b24f88b7d8a6894c">device_address</a> = 0;
<a name="l00888"></a>00888    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#3a3a0fe5dec6bc56306dd0dc960544de">ep_ctrl_size</a> = 0;
<a name="l00889"></a>00889    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#b4afa99ac09ee5ca585079c025a68dbc">hub_port_nb</a> = 0;
<a name="l00890"></a>00890    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#9c4d4b4c7ec1f55cb6973374a70f0eeb">parent_hub_number</a> = 0;
<a name="l00891"></a>00891    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#d8af5613594354d9bbf1b862527f3194">nb_interface</a> = 0;
<a name="l00892"></a>00892    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#1f321181eea8be28d7733b16db5b5442">pid</a> = 0;
<a name="l00893"></a>00893    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#b5f92008ef3c2ae8e0ef7feb2a79156a">vid</a> = 0;
<a name="l00894"></a>00894    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#6e97322a2e0a51aedcf43c643a7aae7d">bmattributes</a> = 0;   
<a name="l00895"></a>00895    usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#f480af470702f6fb0545a57c84e746ab">maxpower</a> = 0;   
<a name="l00896"></a>00896    
<a name="l00897"></a>00897    <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="a00070.html#gf555ac95cfc24daa44af760d0404518e" title="The maximum number of interface supported per device.">MAX_INTERFACE_FOR_DEVICE</a>;j++)
<a name="l00898"></a>00898    {
<a name="l00899"></a>00899       usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#d560cf0a694d32b46e8c4875f9f8dc5e">interface_nb</a> = 0;
<a name="l00900"></a>00900       usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#db860225fe053d199780a43d12e692fe">altset_nb</a> = 0;
<a name="l00901"></a>00901       usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#c563065dd6e5c4526111a9a848fd3e2b">class</a> = 0;
<a name="l00902"></a>00902       usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#c9edc644859ea2faf9925046182a2921">subclass</a> = 0;
<a name="l00903"></a>00903       usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#b5475b8d38ee9a10b9283dba5144e6fe">protocol</a> = 0;
<a name="l00904"></a>00904       usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#4a3033c978c5cc847b209d05e71d94d7">nb_ep</a> = 0;
<a name="l00905"></a>00905       <span class="keywordflow">for</span>(k=0;k&lt;<a class="code" href="a00070.html#g13052bbddf65c51d419bac223613ccb9" title="The maximum number of endpoints per interface supported.">MAX_EP_PER_INTERFACE</a>;k++)
<a name="l00906"></a>00906       {
<a name="l00907"></a>00907          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[k].<a class="code" href="a00005.html#a5cec91959f52766f2320388b71943c7">ep_addr</a> = 0;
<a name="l00908"></a>00908          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[k].<a class="code" href="a00005.html#f0cf12c2414a047379504283412d4889">pipe_number</a> = 0;
<a name="l00909"></a>00909          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[k].<a class="code" href="a00005.html#b0ae7a1e387a68da2e516097d25de814">ep_size</a> = 0;
<a name="l00910"></a>00910          usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[device_index].<a class="code" href="a00003.html#be716796158b1a5f0d8f4132475d3a66">interface</a>[j].<a class="code" href="a00007.html#cd4434bd7064c054b4945b869678bfce">ep</a>[k].<a class="code" href="a00005.html#185452761f4aad66f709f6e7b51a1d24">ep_type</a> = 0;
<a name="l00911"></a>00911       }
<a name="l00912"></a>00912    }   
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 
<a name="l00916"></a>00916 <span class="comment">// @TODO USER_PERIODIC_PIPE==ENABLE not validated</span>
<a name="l00917"></a>00917 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE &amp;&amp; USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00918"></a><a class="code" href="a00097.html#gc49b53eb6d4c6229a1c997c976507d6b">00918</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="a00097.html#gc49b53eb6d4c6229a1c997c976507d6b">freeze_user_periodic_pipe</a>(<span class="keywordtype">void</span>)
<a name="l00919"></a>00919 {
<a name="l00920"></a>00920    <span class="keywordflow">if</span>(<a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>)
<a name="l00921"></a>00921    {
<a name="l00922"></a>00922       <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(<a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>);
<a name="l00923"></a>00923       <span class="keywordflow">if</span>(<a class="code" href="a00094.html#g28a96e67e4d87412b575401b0d286ab9" title="tests if the current pipe is frozen">Is_host_pipe_freeze</a>()) 
<a name="l00924"></a>00924       {
<a name="l00925"></a>00925          <a class="code" href="a00052.html#9ca222b60d617f668361279b1f8b6582">user_periodic_pipe_freeze_state</a>=0;
<a name="l00926"></a>00926       }
<a name="l00927"></a>00927       <span class="keywordflow">else</span>
<a name="l00928"></a>00928       {
<a name="l00929"></a>00929          <a class="code" href="a00052.html#9ca222b60d617f668361279b1f8b6582">user_periodic_pipe_freeze_state</a>=1;
<a name="l00930"></a>00930          <a class="code" href="a00094.html#g439e70e693f67491a1385aa6fe71b5f8" title="freezes the pipe">Host_freeze_pipe</a>();
<a name="l00931"></a>00931       }
<a name="l00932"></a>00932    } 
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 <span class="preprocessor">#endif</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span>
<a name="l00936"></a>00936 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE &amp;&amp; USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00937"></a><a class="code" href="a00097.html#g7ec93e06da874bd5a114a1cd779a7b7b">00937</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="a00097.html#g7ec93e06da874bd5a114a1cd779a7b7b">unfreeze_user_periodic_pipe</a>(<span class="keywordtype">void</span>)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939    <span class="keywordflow">if</span>(<a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>)
<a name="l00940"></a>00940    {
<a name="l00941"></a>00941       <span class="keywordflow">if</span>(<a class="code" href="a00052.html#9ca222b60d617f668361279b1f8b6582">user_periodic_pipe_freeze_state</a>)
<a name="l00942"></a>00942       {   
<a name="l00943"></a>00943          <a class="code" href="a00094.html#g9cef84edfb59cc5963bebddf55f367f6" title="selects pipe for CPU interface">Host_select_pipe</a>(<a class="code" href="a00097.html#gbebbb2ddeee8a9c633755dd528406c61">user_periodic_pipe</a>);
<a name="l00944"></a>00944          <a class="code" href="a00094.html#gd8a6bcf6161fa98b5f79a933cbe03094" title="un-freezees the pipe">Host_unfreeze_pipe</a>();
<a name="l00945"></a>00945       }
<a name="l00946"></a>00946       <a class="code" href="a00097.html#g3c090bb44c15efdc1c0416f9e5d66483">Host_select_device</a>(<a class="code" href="a00052.html#6054ba31109a97df97ad4d645d9911d9">user_periodic_pipe_device_index</a>);
<a name="l00947"></a>00947    }   
<a name="l00948"></a>00948 }
<a name="l00949"></a>00949 <span class="preprocessor">#endif</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span>
<a name="l00951"></a>00951 <span class="preprocessor">#if (USB_HUB_SUPPORT==ENABLE &amp;&amp; USER_PERIODIC_PIPE==ENABLE)</span>
<a name="l00952"></a><a class="code" href="a00097.html#g007939859d5a601e5edc389d47276a73">00952</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="a00097.html#g007939859d5a601e5edc389d47276a73">host_select_device</a>(<a class="code" href="a00021.html#3cb25ca6f51f003950f9625ff05536fc">U8</a> <a class="code" href="a00054.html#a31f47cc4db2a583d432407361bc4bfb">i</a>)
<a name="l00953"></a>00953 {
<a name="l00954"></a>00954    <a class="code" href="a00097.html#gc49b53eb6d4c6229a1c997c976507d6b">freeze_user_periodic_pipe</a>();
<a name="l00955"></a>00955    <a class="code" href="a00097.html#g44e5b0bdff899bc3dbc396cea8863a5a">selected_device</a>=i;
<a name="l00956"></a>00956    <a class="code" href="a00093.html#ge8c9ae465df355c21bd114a7ef8805d9" title="configures the address to use for the device">Host_configure_address</a>(usb_tree.<a class="code" href="a00014.html#07d8fcf7d396c9da92c282e6fb5a8a5c">device</a>[i].<a class="code" href="a00003.html#dc8182c6fd5e7935b24f88b7d8a6894c">device_address</a>);
<a name="l00957"></a>00957 }
<a name="l00958"></a>00958 <span class="preprocessor">#endif</span>
<a name="l00959"></a>00959 <span class="preprocessor"></span>
<a name="l00960"></a>00960 
<a name="l00961"></a>00961 <span class="preprocessor">#endif   //(USB_HOST_FEATURE == ENABLED)</span>
<a name="l00962"></a>00962 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Mon Nov 3 10:08:24 2008 for ATMEL by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
